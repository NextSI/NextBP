define([],function(){return function(e){"use strict";var a=this;this.html_id=e,this.dialog=$("#"+this.html_id),this.form_login_padrao=this.dialog.find(".form_login_padrao"),this.div_autenticacao=this.dialog.find(".div_autenticacao"),this.frm=this.dialog.find(".form-signin"),this.lbl_admin=this.dialog.find(".lbl_admin"),this.select_user=this.dialog.find("#select_user"),this.select_ldap_server=this.dialog.find("#select_ldap_server"),this.username=this.dialog.find("#username"),this.password=this.dialog.find("#password"),this.dxButtonEsqueciSenha=this.dialog.find("#dxButtonEsqueciSenha"),this.dxButtonCadastrarse=this.dialog.find("#dxButtonCadastrarse"),this.div_opcoes_usuario=this.dialog.find(".div_opcoes_usuario"),this.checkEntrarAutomaticamente=this.dialog.find("#checkEntrarAutomaticamente"),this.checkMemorizarSenha=this.dialog.find("#checkMemorizarSenha"),this.dxButtonEntrar=this.dialog.find("#dxButtonEntrar"),this.dxButtonEsquecerUsuario=this.dialog.find("#dxButtonEsquecerUsuario"),this.img_logo=this.dialog.find(".img_logo"),this.version=this.dialog.find("#version"),this.dx_popup_cadastrese=this.dialog.find(".dx_popup_cadastrese"),this.usuarios=[],this.usuario={},this.selectUserInstance=null,this.usernameInstance=null,this.passwordInstance=null,this.dxButtonEsquecerUsuarioInstance=null,this.dxButtonEntrarInstance=null,this.ldap_servers=[{id:0,nome:"Servidor Next BP"}],this.storageLdapServer=null,this.form_email=this.dialog.find(".form_email"),this.email_anonimo=this.dialog.find(".email_anonimo"),this.btnLoginAnonimo=this.dialog.find(".btnLoginAnonimo"),this.construct=function(){let e=window.location.hash,o=e.substr(window.location.hash.indexOf("/")+1).split("/");if(o.length>0&&""!==o[0].trim()&&"#"!==o[0].trim()&&"solicitacao_atividade"==o[0]&&"executar_externo"==o[1]){a.form_email.removeClass("hidden");let t=e.substring(e.indexOf("chave_acesso=")+13),n=o[2].substring(0,o[2].indexOf("?"));const i=s();function s(){return a.email_anonimo.dxTextBox({placeholder:"Digite seu e-mail",showClearButton:!0,onEnterKey:function(e){}}).dxTextBox("instance")}function r(){a.btnLoginAnonimo.dxButton({text:"Entrar",useSubmitBehavior:!0,hoverStateEnabled:!1,template:function(e,a){$("<i class='dx-icon dx-icon-chevronright pull-right' style='color: #FFF; font-size: xx-large; margin-top: 2px;'></i><span class='dx-button-text'>"+e.text+"</span>").appendTo(a),$(a).parent().addClass("btn-primary"),$(a).addClass("btn-primary")},onClick:function(e){let a=i.option("value");d(n,a,t)}})}function d(e,a,o){WS.get("/solicitacao/verificar_acesso_anonimo_atividade/",{solicitacao_atividade_id:e,email:a,chave_acesso:o},function(e){e?c(a,o):DevExpress.ui.dialog.alert("O e-mail informado não tem permissão para realizar a operação","Aviso")})}function c(e,a){WS.post("login/login_anonimo/",{email:e,permissoes:JSON.stringify(["gestao_processos"]),chaves_acesso:JSON.stringify({chave_acesso_solicitacao_atividade:a})},function(e){View.unload(),App.login_anonimo(e),View.load("solicitacao/detalhes",function(e,a){a.show(n,SOLICITACAO_TIPO_VISUALIZACAO.ATIVIDADE)},View.ABA.MULTIPLAS,null,null,{solicitacaoAtividadeId:n}),setTimeout(()=>{$("[aba-id-md5]").css({pointerEvents:"none",color:"rgba(0,0,0,0.3)"})},950)})}r()}else if(o.length>0&&""!==o[0].trim()&&"#"!==o[0].trim()&&"solicitacao_atividade"==o[0]&&"iniciar"==o[1]){a.form_email.removeClass("hidden");let l=o[2];const u=p();function p(){const e=a.email_anonimo,o=a.email_anonimo.dxTextBox({placeholder:"Digite seu e-mail",showClearButton:!0,onEnterKey:function(e){}}).dxTextBox("instance");return e.dxValidator({validationRules:[{type:"required",message:"O e-mail é obrigatório"},{type:"email",message:"Digite um e-mail válido"}]}),o}function _(){const e=a.email_anonimo;a.btnLoginAnonimo.dxButton({text:"Entrar",useSubmitBehavior:!0,hoverStateEnabled:!1,template:function(e,a){$("<i class='dx-icon dx-icon-chevronright pull-right' style='color: #FFF; font-size: xx-large; margin-top: 2px;'></i><span class='dx-button-text'>"+e.text+"</span>").appendTo(a),$(a).parent().addClass("btn-primary"),$(a).addClass("btn-primary")},onClick:function(a){let o=u.option("value");if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o))m(l,o);else{const a=e.dxValidator("instance");a&&a.validate(),u.focus()}}})}function m(e,a){WS.get("/solicitacao/verificar_acesso_anonimo_atividade_inicio/",{solicitacao_atividade_id:e},function(e){e?h(a,e.versao_processo_id,e.versao_processo_atividade_id):DevExpress.ui.dialog.alert("Solicitação com abertura anônima desabilitada!","Aviso")})}function h(e,a,o){WS.post("login/login_anonimo/",{email:e,permissoes:JSON.stringify(["gestao_processos"])},function(t){const n=t.token;View.unload(),App.login_anonimo(t),WS.post("solicitacao/nova/",{versao_processo_id:a,versao_processo_atividade_id:o},function(a){const o=a.id;WS.post("login/login_anonimo/",{email:e,permissoes:JSON.stringify(["gestao_processos"]),token:n,chaves_acesso:JSON.stringify({chave_acesso_solicitacao_atividade:a.chave_acesso})},function(e){View.load("solicitacao/detalhes",function(e,a){a.show(o,SOLICITACAO_TIPO_VISUALIZACAO.ATIVIDADE)},View.ABA.MULTIPLAS,null,null,{solicitacaoAtividadeId:o}),setTimeout(()=>{$("[aba-id-md5]").css({pointerEvents:"none",color:"rgba(0,0,0,0.3)"})},950)})})})}_()}else a.form_login_padrao.removeClass("hidden"),a.loadSelectUser(),a.loadButtonEsqueciSenha(),a.loadButtonCadastrarse(),a.loadCheckMemorizarSenha(),a.loadCheckEntrarAutomaticamente(),a.loadTextBoxUsername(),a.loadTextBoxPassword(),a.loadButtonEsquecerUsuario(),a.version.text(App.version),a.img_logo.attr("src","assets/img/logo_transp.png?anticache="+(new Date).getTime()).on("error",function(){$(this).hide()}),1==SYS_ADMIN?(a.checkMemorizarSenha.dxCheckBox("instance").option("visible",!1),a.checkEntrarAutomaticamente.dxCheckBox("instance").option("visible",!1),a.dxButtonEsqueciSenha.dxButton("instance").option("visible",!1),a.dxButtonCadastrarse.dxButton("instance").option("visible",!1),a.lbl_admin.show(),a.usernameInstance.focus(),a.autenticacao()):AUTH_TOKEN?a.entrar():a.list_ldap_servers()},this.listar_usuarios=function(){if(a.div_autenticacao.hide(),a.form_login_padrao.hide(),a.usernameInstance.option("value",null),a.passwordInstance.option("value",null),a.usuarios=[],"undefined"!=typeof Storage){if(void 0!==App.temp.login_exibir_opcao_salvar_usuario&&!0!==App.temp.login_exibir_opcao_salvar_usuario||!localStorage.getItem("bp_usuarios")||"undefined"==localStorage.getItem("bp_usuarios")||(a.usuarios=JSON.parse(localStorage.getItem("bp_usuarios"))),0==a.usuarios.length){var e=localStorage.getItem("bp_lg_u"),o=localStorage.getItem("bp_lg_p"),t=localStorage.getItem("bp_ws");e&&(a.salvar_usuario({nome:e,login:e,senha:o,entrar_automaticamente:o&&""!=o,webservice_nome:t,webservice_url:t}),localStorage.removeItem("bp_lg_u"),localStorage.removeItem("bp_lg_p"),localStorage.removeItem("bp_ws"))}a.selectUserInstance.option("dataSource",a.usuarios),a.autenticacao(),1===a.usuarios.length&&a.selectUserInstance.option("value",a.usuarios[0])}},this.entrar=function(){if("ie"==getBrowser())alert("Este navegador não é compatível com o Next BP. Recomenda-se usar os seguintes navegadores: \n- Google Chrome \n- Opera \n- Mozilla Firefox \n- Safari \n- Microsoft Edge \n");else if(1==SYS_ADMIN)WS.post("login/validar_admin/",{username:cripto(a.usernameInstance.option("value")),senha:cripto(a.passwordInstance.option("value"))},function(e){App.sessao=e.session_id,View.unload(),View.load("admin/painel",function(e){})},[a.dxButtonEntrar],null,!0,null,function(e){a.dxButtonEntrarInstance&&a.dxButtonEntrarInstance.option({text:"Por favor, aguarde..."})},a.html_id,function(){a.dxButtonEntrarInstance&&a.dxButtonEntrarInstance.option({text:"Entrar"})});else if(AUTH_TOKEN)WS.post("login/validar/",{token:AUTH_TOKEN},function(e){View.unload(),App.login(e)},[a.dxButtonEntrar],null,!0,null,function(e){a.dxButtonEntrarInstance&&a.dxButtonEntrarInstance.option({text:"Por favor, aguarde..."})},a.html_id,function(){a.dxButtonEntrarInstance&&a.dxButtonEntrarInstance.option({text:"Entrar"})});else{var e=new Validation;if(""!=a.usernameInstance.option("value")&&""!=a.passwordInstance.option("value")||e.add(new ValidationMessage(Validation.CODES.ERR,"Digite o usuário e senha")),!e.is_valid())return void alert_modal("Validação",e);WS.post("login/validar/",{username:a.usernameInstance.option("value")?cripto(a.usernameInstance.option("value")):null,senha:a.passwordInstance.option("value")?cripto(a.passwordInstance.option("value")):null,token:window.location.search.substring(1),servidor_ldap_id:a.select_ldap_server.dxSelectBox("instance").option("value")},function(e){var o=a.checkMemorizarSenha.dxCheckBox("instance").option("value"),t=a.checkEntrarAutomaticamente.dxCheckBox("instance").option("value");if(View.unload(),App.login(e),App.menu=e.menu_personalizado,"undefined"!=typeof Storage){var n=null;o&&(n=cripto(a.passwordInstance.option("value")));var i={nome:e.dados.nome,login:e.dados.username,ldap_login:e.dados.ldap_login,senha:n,entrar_automaticamente:t,time:(new Date).getTime(),servidor_ldap_id:null!==e.dados.servidor_ldap_id&&""!==e.dados.servidor_ldap_id?e.dados.servidor_ldap_id:0};App.temp.usuario=i,a.salvar_usuario(i)}},[a.dxButtonEntrar],null,!0,null,function(e){a.dxButtonEntrarInstance&&a.dxButtonEntrarInstance.option({text:"Por favor, aguarde..."})},a.html_id,function(){a.dxButtonEntrarInstance&&a.dxButtonEntrarInstance.option({text:"Entrar"})})}},this.salvar_usuario=function(e){var o=!1;a.usuarios.map(function(t,n){e.login==t.login&&e.webservice_url==t.webservice_url&&(o=!0,a.usuarios[n]=e)});o||a.usuarios.push(e),a.salvar_usuarios()},this.salvar_usuarios=function(){a.usuarios=a.usuarios.sort(function(e,a){return(e.time||0)-a.time}),a.usuarios.reverse(),"undefined"!=typeof Storage&&localStorage.setItem("bp_usuarios",JSON.stringify(a.usuarios))},this.autenticacao=function(e){if(a.usuario=e,a.div_autenticacao.show(),a.form_login_padrao.show(),a.usernameInstance.option("value",null),a.passwordInstance.option("value",null),1==SYS_ADMIN||void 0!==App.temp.login_exibir_opcao_salvar_usuario&&!1===App.temp.login_exibir_opcao_salvar_usuario?a.div_opcoes_usuario.hide():a.div_opcoes_usuario.show(),a.checkMemorizarSenha.dxCheckBox("instance").option("disabled",!1),a.checkEntrarAutomaticamente.dxCheckBox("instance").option("disabled",!1),a.checkMemorizarSenha.dxCheckBox("instance").option("value",!1),a.checkEntrarAutomaticamente.dxCheckBox("instance").option("value",!1),void 0!==e&&e)if(a.dxButtonEsquecerUsuarioInstance.option("visible",!0),a.usernameInstance.option("value",e.login?e.login:e.ldap_login),a.usernameInstance.option("readOnly",!0),e.senha&&a.passwordInstance.option("value",e.senha?base64_decode(e.senha):""),e.entrar_automaticamente&&a.checkEntrarAutomaticamente.dxCheckBox("instance").option("value",!0),e.senha&&a.checkMemorizarSenha.dxCheckBox("instance").option("value",!0),a.passwordInstance.focus(),null!==e.ldap_login&&""!=e.ldap_login)if(""==e.servidor_ldap_id||null==e.servidor_ldap_id){const e=a.ldap_servers.filter(e=>"S"==e.padrao);a.loadSelectLdap(e.length>0?e[0].id:void 0)}else a.loadSelectLdap(e.servidor_ldap_id);else a.loadSelectLdap(e.servidor_ldap_id);else{a.usernameInstance.option("readOnly",!1),a.dxButtonEsquecerUsuarioInstance.option("visible",!1),a.usuario=null,a.checkMemorizarSenha.dxCheckBox("instance").option("value",!0);const e=a.ldap_servers.filter(e=>"S"==e.padrao);a.loadSelectLdap(e.length>0?e[0].id:void 0)}},this.unload=function(){View.unload(this.html_id)},this.list_ldap_servers=function(){WS.get("/servidor_ldap/listar_basico/",null,function(e){if(e.map(function(e){a.ldap_servers.push(e)}),a.listar_usuarios(),a.usuarios&&!LOGOUT)for(var o=0;o<a.usuarios.length;o++)if(a.usuarios[o].entrar_automaticamente){a.autenticacao(a.usuarios[o]),a.entrar();break}})},this.loadSelectUser=function(){a.selectUserInstance=a.select_user.dxSelectBox({dataSource:[],displayExpr:"nome",onSelectionChanged:function(e){a.autenticacao(e.selectedItem),e.selectedItem||a.usernameInstance.focus()},placeholder:"Usuários salvos",showClearButton:!0}).dxSelectBox("instance")},this.loadSelectLdap=function(e){var o="";1==a.ldap_servers.length?o=a.ldap_servers[0].id:null!=e&&""!==e&&(o=e),a.select_ldap_server.dxSelectBox({dataSource:a.ldap_servers,visible:a.ldap_servers.length>1,displayExpr:"nome",valueExpr:"id",placeholder:"Servidor de autenticação",showClearButton:!0,value:1==a.ldap_servers.length?a.ldap_servers[0].id:o}).dxValidator({validationRules:[{type:"required",message:"Campo obrigatório"}]}),a.dxButtonEntrarInstance=a.dxButtonEntrar.dxButton({text:"Entrar",useSubmitBehavior:!0,hoverStateEnabled:!1,template:function(e,a){$("<i class='dx-icon dx-icon-chevronright pull-right' style='color: #FFF; font-size: xx-large; margin-top: 2px;'></i><span class='dx-button-text'>"+e.text+"</span>").appendTo(a),$(a).parent().addClass("btn-primary"),$(a).addClass("btn-primary")},onClick:function(e){SYS_ADMIN||AUTH_TOKEN?a.entrar():e.validationGroup.validate().isValid&&a.entrar()}}).dxButton("instance")},this.loadButtonEsqueciSenha=function(){a.dxButtonEsqueciSenha.dxButton({text:"Esqueceu a senha ?",stylingMode:"text",width:"auto",onClick:function(e){View.load("login/solicitar_senha",function(e,o){o.onclose=a.listar,o.show(a.usernameInstance.option("value"))})}})},this.loadButtonCadastrarse=function(){a.dxButtonCadastrarse.dxButton({text:"Cadastrar-se",visible:App.temp.usuario_cliente_cadastrese||!1,onClick:function(e){a.show_cadastrarse()}})},this.loadCheckMemorizarSenha=function(){a.checkMemorizarSenha.dxCheckBox({text:"Memorizar senha"})},this.loadCheckEntrarAutomaticamente=function(){a.checkEntrarAutomaticamente.dxCheckBox({text:"Entrar automaticamente",onValueChanged:function(e){e.component.option("value")?(a.checkMemorizarSenha.dxCheckBox("instance").option("value",!0),a.checkMemorizarSenha.dxCheckBox("instance").option("disabled",!0)):a.checkMemorizarSenha.dxCheckBox("instance").option("disabled",!1)}})},this.loadTextBoxUsername=function(){a.usernameInstance=a.username.dxTextBox({placeholder:"Nome de usuário",showClearButton:!0,onFocusIn:function(e){e.component.option("readOnly")||a.selectUserInstance.option("visible",!1)},onFocusOut:function(e){e.component.option("value")||a.selectUserInstance.option("visible",!0)},onEnterKey:function(e){a.dxButtonEntrar.trigger("click")}}).dxTextBox("instance")},this.loadTextBoxPassword=function(){a.passwordInstance=a.password.dxTextBox({placeholder:"senha",mode:"password",onEnterKey:function(e){a.dxButtonEntrar.trigger("click")},buttons:[{name:"password",location:"after",options:{width:"25px",icon:"fas fa-eye",type:"default",onClick:function(e){e.component.option("icon","text"===a.passwordInstance.option("mode")?"fas fa-eye":"fas fa-eye-slash"),a.passwordInstance.option("mode","text"===a.passwordInstance.option("mode")?"password":"text")}}}]}).dxTextBox("instance")},this.loadButtonEsquecerUsuario=function(){a.dxButtonEsquecerUsuarioInstance=a.dxButtonEsquecerUsuario.dxButton({visible:!1,text:"Esquecer usuário",onClick:function(e){alert_modal(App.lang.login.esquecer_conta,App.lang.login.esquecer_conta_pergunta,App.lang.login.sim_esquecer_agora,function(){a.usuarios.map(function(e,o){if(e==a.usuario)return a.usuarios.splice(o,1),a.salvar_usuarios(),void a.listar_usuarios()})},!0,App.lang.generico.cancelar,function(){})}}).dxButton("instance")},this.show_cadastrarse=()=>{a.cadastrese_etapa=0;a.popup_cadastrese=a.dx_popup_cadastrese.dxPopup({contentTemplate:function(){const e=$('<div class="row"><div class="col-md-12 div_nome"><div class="form-group"><div>Nome</div><div class="edt_nome"></div></div></div><div class="col-md-12 div_email"><div class="form-group"><div>E-mail</div><div class="edt_email"></div></div></div><div class="col-md-12 div_codigo" style="display: none;"><div class="form-group"><div>Foi enviado para <span class="div_codigo_email">seu e-mail</span> o código que deverá ser informado aqui:</div> <div class="edt_codigo"></div></div></div><div class="col-md-12 div_senha" style="display: none; padding-top: 10px;"><div class="form-group"><div>Crie uma senha</div><div class="edt_senha"></div></div></div><div class="col-md-12 div_senha" style="display: none;"><div class="form-group"><div>Repita a senha</div><div class="edt_senha2"></div></div></div></div>');return e.find(".edt_nome").dxTextBox({value:null,onValueChanged:function(e){a.popup_cadastrese_nome=e.value},onEnterKey:function(e){a.popup_cadastrese.dxPopup("instance").content().find(".edt_email").dxTextBox("instance").focus()}}).dxValidator({validationRules:[{type:"required",message:"Este campo é obrigatório"}]}),e.find(".edt_email").dxTextBox({value:null,onValueChanged:function(e){a.popup_cadastrese_email=e.value},onEnterKey:function(e){a.btn_continuar_click()}}).dxValidator({name:"E-mail",validationRules:[{type:"email",message:"O e-mail é inválido"},{type:"required",message:"Este campo é obrigatório"}]}),e.find(".edt_codigo").dxTextBox({value:null,mask:"0000",maxLength:4,onValueChanged:function(e){a.popup_cadastrese_codigo=e.value},onEnterKey:function(e){a.popup_cadastrese.dxPopup("instance").content().find(".edt_senha").dxTextBox("instance").focus()}}).dxValidator({validationRules:[{type:"required",message:"Este campo é obrigatório"}]}),e.find(".edt_senha").dxTextBox({mode:"password",value:null,onValueChanged:function(e){a.popup_cadastrese_senha=e.value,a.popup_cadastrese.dxPopup("instance").content().find(".edt_senha2").dxValidator("instance").validate()},onEnterKey:function(e){a.popup_cadastrese.dxPopup("instance").content().find(".edt_senha2").dxTextBox("instance").focus()}}).dxValidator({validationRules:[{type:"required",message:"Este campo é obrigatório"}]}),e.find(".edt_senha2").dxTextBox({mode:"password",value:null,onValueChanged:function(e){a.popup_cadastrese_senha2=e.value},onEnterKey:function(e){a.btn_continuar_click()}}).dxValidator({validationRules:[{type:"required",message:"Este campo é obrigatório"},{type:"compare",comparisonTarget:()=>a.popup_cadastrese_senha?a.popup_cadastrese_senha:null,message:"As senhas informadas não conferem."}]}),e},maxWidth:"350px",maxHeight:"300px",showTitle:!0,title:"Cadastre-se",visible:!1,dragEnabled:!1,hideOnOutsideClick:!0,showCloseButton:!0,toolbarItems:[{widget:"dxButton",toolbar:"bottom",location:"after",options:{text:"Continuar",onClick:a.btn_continuar_click}}],onShown:()=>{a.popup_cadastrese.dxPopup("instance").content().find(".edt_nome").dxTextBox("instance").focus()}}),a.popup_cadastrese.dxPopup("instance").content().find(".div_codigo").hide(),a.popup_cadastrese.dxPopup("instance").content().find(".div_senha").hide(),a.popup_cadastrese.dxPopup("instance").content().find(".div_nome").show(),a.popup_cadastrese.dxPopup("instance").content().find(".div_email").show(),a.popup_cadastrese.dxPopup("instance").show()},this.btn_continuar_click=()=>{if(0==a.cadastrese_etapa)WS.get({route:"usuario_cliente/validar_email_cadastro/",data:{email:a.popup_cadastrese_email,nome:a.popup_cadastrese_nome},func_response:e=>{!0===e.enviado&&(a.popup_cadastrese.dxPopup("instance").content().find(".div_codigo").show(),a.popup_cadastrese.dxPopup("instance").content().find(".div_senha").show(),a.popup_cadastrese.dxPopup("instance").content().find(".div_nome").hide(),a.popup_cadastrese.dxPopup("instance").content().find(".div_email").hide(),a.popup_cadastrese.dxPopup("instance").content().find(".div_codigo_email").text(a.popup_cadastrese_email),a.popup_cadastrese.dxPopup("instance").content().find(".edt_codigo").dxTextBox("instance").focus(),a.cadastrese_etapa=1)}});else if(1==a.cadastrese_etapa){if(a.popup_cadastrese.dxPopup("instance").content().find(".edt_senha2").dxValidator("instance").validate(),!a.popup_cadastrese_senha||""===a.popup_cadastrese_senha||a.popup_cadastrese_senha!==a.popup_cadastrese_senha2)return!1;WS.get({route:"usuario_cliente/validar_codigo/",data:{email:a.popup_cadastrese_email,codigo:a.popup_cadastrese_codigo||"",senha:a.popup_cadastrese_senha||""},func_response:e=>{!0===e.valido&&(a.popup_cadastrese.dxPopup("instance").hide(),a.select_ldap_server.dxSelectBox("instance").option("value",0),a.usernameInstance.option("value",a.popup_cadastrese_email),a.passwordInstance.option("value",a.popup_cadastrese_senha),a.dxButtonEntrar.trigger("click"))}})}},this.construct()}});