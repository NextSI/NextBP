on: 
  push:
    branches:
      - 24@8.2

name: üöÄ Deploy on push vers√£o 24 PHP 8.2

jobs:
  deploy_next_homolog:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - nome: PortalHomolog
            tipo: ftp
            username_secret: FTP_USERNAME_PORTALHOMOLOG
            password_secret: FTP_PASSWORD_PORTALPRODHOMOLOG
            dir: ./homolog/
            api: FTP_URL_DBU_HOMOLOG
            server: FTP_HOST_PORTALPRODHOMOLOG
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üìÇ Sync files ${{ matrix.nome }}
        if: matrix.tipo == 'ftp'
        uses: ghaithatfeh/FTP-Deploy-Action@master
        with:
          server: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          server-dir: ${{ matrix.dir }}
          exclude: |
            **/.git*
            **/.git*/**
            webservice/especificos_
            webservice/especificos_/**
            webservice/manual/php/**
        
      - name: üìÇ Sync via SFTP ${{ matrix.nome }}
        if: matrix.tipo == 'sftp'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          port: ${{ secrets[matrix.port] }}
          source: ./
          target: ${{ matrix.dir }}

      - name: üîó Call API after deploy ${{ matrix.nome }}
        run: |
          echo "üì° Chamando API para ${{ matrix.nome }}"

          RESPONSE_CODE=$(curl -X POST "${{ secrets[matrix.api] }}${{ secrets.SUFIXO_DBU_API }}&anticache=$(date +%s)" \
            -H "Content-Type: application/json" \
            -H "Dbutoken: ${{ secrets.DBU_API_TOKEN }}" \
            -d '{"status": "success", "message": "FTP deploy complete"}' \
            -w "%{http_code}" -o response.txt -s)

          echo "üîç HTTP Response Code: $RESPONSE_CODE"

          RESPONSE_BODY=$(cat response.txt)
          echo "üìÑ API Response:"
          echo "$RESPONSE_BODY"

          if [ "$RESPONSE_CODE" -ne 200 ]; then
            echo "‚ùå API call failed with status code $RESPONSE_CODE"
            exit 1
          fi

          if [[ "$RESPONSE_BODY" != *"Atualizacao de estrutura procedimentos e funcoes do banco de dados concluida"* ]]; then
            echo "‚ùå Resposta inesperada da API!"
            echo "üîé Esperado: 'Atualizacao de estrutura procedimentos e funcoes do banco de dados concluida'"
            exit 1
          fi

          echo "‚úÖ Deploy e atualiza√ß√£o do banco de dados realizados com sucesso para ${{ matrix.nome }}"

      - name: üìÇ PHPDoc ${{ matrix.nome }}
        if: matrix.tipo == 'ftp'
        uses: ghaithatfeh/FTP-Deploy-Action@master
        with:
          server: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          server-dir: ${{ matrix.dir }}/webservice/manual/php/
          local-dir: './webservice/manual/php/'
          
  deploy_next_prod:
    runs-on: ubuntu-latest
    needs: [deploy_next_homolog]
    strategy:
      matrix:
        include:
          - nome: PortalProd
            tipo: ftp
            username_secret: FTP_USERNAME_PORTALPROD
            password_secret: FTP_PASSWORD_PORTALPRODHOMOLOG
            dir: ./
            api: FTP_URL_DBU_PROD
            server: FTP_HOST_PORTALPRODHOMOLOG
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üìÇ Sync files ${{ matrix.nome }}
        if: matrix.tipo == 'ftp'
        uses: ghaithatfeh/FTP-Deploy-Action@master
        with:
          server: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          server-dir: ${{ matrix.dir }}
          exclude: |
            **/.git*
            **/.git*/**
            webservice/especificos_
            webservice/especificos_/**
            webservice/manual/php/**
        
      - name: üìÇ Sync via SFTP ${{ matrix.nome }}
        if: matrix.tipo == 'sftp'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          port: ${{ secrets[matrix.port] }}
          source: ./
          target: ${{ matrix.dir }}

      - name: üîó Call API after deploy ${{ matrix.nome }}
        run: |
          echo "üì° Chamando API para ${{ matrix.nome }}"

          RESPONSE_CODE=$(curl -X POST "${{ secrets[matrix.api] }}${{ secrets.SUFIXO_DBU_API }}&anticache=$(date +%s)" \
            -H "Content-Type: application/json" \
            -H "Dbutoken: ${{ secrets.DBU_API_TOKEN }}" \
            -d '{"status": "success", "message": "FTP deploy complete"}' \
            -w "%{http_code}" -o response.txt -s)

          echo "üîç HTTP Response Code: $RESPONSE_CODE"

          RESPONSE_BODY=$(cat response.txt)
          echo "üìÑ API Response:"
          echo "$RESPONSE_BODY"

          if [ "$RESPONSE_CODE" -ne 200 ]; then
            echo "‚ùå API call failed with status code $RESPONSE_CODE"
            exit 1
          fi

          if [[ "$RESPONSE_BODY" != *"Atualizacao de estrutura procedimentos e funcoes do banco de dados concluida"* ]]; then
            echo "‚ùå Resposta inesperada da API!"
            echo "üîé Esperado: 'Atualizacao de estrutura procedimentos e funcoes do banco de dados concluida'"
            exit 1
          fi

          echo "‚úÖ Deploy e atualiza√ß√£o do banco de dados realizados com sucesso para ${{ matrix.nome }}"

      - name: üìÇ PHPDoc ${{ matrix.nome }}
        if: matrix.tipo == 'ftp'
        uses: ghaithatfeh/FTP-Deploy-Action@master
        with:
          server: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          server-dir: ${{ matrix.dir }}/webservice/manual/php/
          local-dir: './webservice/manual/php/'

  deploy_homolog:
    runs-on: ubuntu-latest
    needs: [deploy_next_prod]
    strategy:
      matrix:
        include:
          - nome: 000205 Homolog
            tipo: ftp
            username_secret: FTP_USERNAME_000205
            password_secret: FTP_PASSWORD_000205
            dir: ./homolog/
            api: FTP_URL_DBU_000205_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000347 Homolog
            tipo: ftp
            username_secret: FTP_USERNAME_000347
            password_secret: FTP_PASSWORD_000347
            dir: ./homolog/
            api: FTP_URL_DBU_000347_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000348 Homolog
            tipo: ftp
            username_secret: FTP_USERNAME_000348
            password_secret: FTP_PASSWORD_000348
            dir: ./homolog/
            api: FTP_URL_DBU_000348_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          # - nome: 000353 Homolog
          #   tipo: ftp
          #   username_secret: FTP_USERNAME_000353
          #   password_secret: FTP_PASSWORD_000353
          #   dir: ./homolog/
          #   api: FTP_URL_DBU_000353_HLG
          #   server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000333 Homolog
            tipo: ftp
            username_secret: FTP_USERNAME_000333
            password_secret: FTP_PASSWORD_000333
            dir: ./homolog/
            api: FTP_URL_DBU_000333_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000335 Homolog
            tipo: ftp
            username_secret: FTP_USERNAME_000335
            password_secret: FTP_PASSWORD_000335
            dir: ./homolog/
            api: FTP_URL_DBU_000335_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000226 Homolog
            tipo: ftp
            username_secret: FTP_USERNAME_000226
            password_secret: FTP_PASSWORD_000226
            dir: ./homolog/
            api: FTP_URL_DBU_000226_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000234 Homolog
            tipo: ftp
            username_secret: FTP_USERNAME_000234_HLG
            password_secret: FTP_PASSWORD_000234_HLG
            dir: ./
            api: FTP_URL_DBU_000234_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          # - nome: 000355 Homolog
          #   tipo: ftp
          #   username_secret: FTP_USERNAME_000355_HLG
          #   password_secret: FTP_PASSWORD_000355_HLG
          #   dir: ./
          #   api: FTP_URL_DBU_000355_HLG
          #   server: FTP_HOST_PORTALPRODHOMOLOG
          
          - nome: 000361 Homolog
            tipo: ftp
            username_secret: FTP_USERNAME_000361_HLG
            password_secret: FTP_PASSWORD_000361_HLG
            dir: ./
            api: FTP_URL_DBU_000361_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          # - nome: 000240 Homolog
          #   tipo: sftp
          #   port: FTP_PORT_000240
          #   username_secret: FTP_USERNAME_000240
          #   password_secret: FTP_PASSWORD_000240
          #   dir: /var/www/html/homolog/
          #   api: FTP_URL_DBU_000240
          #   server: FTP_HOST_000240

    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üìÇ Sync files ${{ matrix.nome }}
        if: matrix.tipo == 'ftp'
        uses: ghaithatfeh/FTP-Deploy-Action@master
        with:
          server: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          server-dir: ${{ matrix.dir }}
          exclude: |
            **/.git*
            **/.git*/**
            webservice/especificos_
            webservice/especificos_/**
            webservice/manual/php/**
        
      - name: üìÇ Sync via SFTP ${{ matrix.nome }}
        if: matrix.tipo == 'sftp'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          port: ${{ secrets[matrix.port] }}
          source: ./
          target: ${{ matrix.dir }}

      - name: üîó Call API after deploy ${{ matrix.nome }}
        run: |
          echo "üì° Chamando API para ${{ matrix.nome }}"

          RESPONSE_CODE=$(curl -X POST "${{ secrets[matrix.api] }}${{ secrets.SUFIXO_DBU_API }}&anticache=$(date +%s)" \
            -H "Content-Type: application/json" \
            -H "Dbutoken: ${{ secrets.DBU_API_TOKEN }}" \
            -d '{"status": "success", "message": "FTP deploy complete"}' \
            -w "%{http_code}" -o response.txt -s)

          echo "üîç HTTP Response Code: $RESPONSE_CODE"

          RESPONSE_BODY=$(cat response.txt)
          echo "üìÑ API Response:"
          echo "$RESPONSE_BODY"

          if [ "$RESPONSE_CODE" -ne 200 ]; then
            echo "‚ùå API call failed with status code $RESPONSE_CODE"
            exit 1
          fi

          if [[ "$RESPONSE_BODY" != *"Atualizacao de estrutura procedimentos e funcoes do banco de dados concluida"* ]]; then
            echo "‚ùå Resposta inesperada da API!"
            echo "üîé Esperado: 'Atualizacao de estrutura procedimentos e funcoes do banco de dados concluida'"
            exit 1
          fi

          echo "‚úÖ Deploy e atualiza√ß√£o do banco de dados realizados com sucesso para ${{ matrix.nome }}"
  
      - name: üìÇ PHPDoc ${{ matrix.nome }}
        if: matrix.tipo == 'ftp'
        uses: ghaithatfeh/FTP-Deploy-Action@master
        with:
          server: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          server-dir: ${{ matrix.dir }}/webservice/manual/php/
          local-dir: './webservice/manual/php/'

  deploy_prod:
    runs-on: ubuntu-latest
    needs: [deploy_homolog]
    strategy:
      matrix:
        include:
          - nome: 000205 Prod
            tipo: ftp
            username_secret: FTP_USERNAME_000205
            password_secret: FTP_PASSWORD_000205
            dir: ./
            api: FTP_URL_DBU_000205
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000347 Prod
            tipo: ftp
            username_secret: FTP_USERNAME_000347
            password_secret: FTP_PASSWORD_000347
            dir: ./
            api: FTP_URL_DBU_000347
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000348 Prod
            tipo: ftp
            username_secret: FTP_USERNAME_000348
            password_secret: FTP_PASSWORD_000348
            dir: ./
            api: FTP_URL_DBU_000348
            server: FTP_HOST_PORTALPRODHOMOLOG

          # - nome: 000353 Prod
          #   tipo: ftp
          #   username_secret: FTP_USERNAME_000353
          #   password_secret: FTP_PASSWORD_000353
          #   dir: ./
          #   api: FTP_URL_DBU_000353
          #   server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000333 Prod
            tipo: ftp
            username_secret: FTP_USERNAME_000333
            password_secret: FTP_PASSWORD_000333
            dir: ./
            api: FTP_URL_DBU_000333
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000335 Prod
            tipo: ftp
            username_secret: FTP_USERNAME_000335
            password_secret: FTP_PASSWORD_000335
            dir: ./
            api: FTP_URL_DBU_000335
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000226 Prod
            tipo: ftp
            username_secret: FTP_USERNAME_000226
            password_secret: FTP_PASSWORD_000226
            dir: ./
            api: FTP_URL_DBU_000226
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000234 Prod
            tipo: ftp
            username_secret: FTP_USERNAME_000234
            password_secret: FTP_PASSWORD_000234
            dir: ./
            api: FTP_URL_DBU_000234
            server: FTP_HOST_PORTALPRODHOMOLOG

          #- nome: 000355 Prod
          #  tipo: ftp
          #  username_secret: FTP_USERNAME_000355
          #  password_secret: FTP_PASSWORD_000355
          #  dir: ./
          #  api: FTP_URL_DBU_000355
          #  server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000361 Prod
            tipo: ftp
            username_secret: FTP_USERNAME_000361
            password_secret: FTP_PASSWORD_000361
            dir: ./
            api: FTP_URL_DBU_000361
            server: FTP_HOST_PORTALPRODHOMOLOG

          # - nome: 000240 Homolog
          #   tipo: sftp
          #   port: FTP_PORT_000240
          #   username_secret: FTP_USERNAME_000240
          #   password_secret: FTP_PASSWORD_000240
          #   dir: /var/www/html/homolog/
          #   api: FTP_URL_DBU_000240
          #   server: FTP_HOST_000240

    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üìÇ Sync files ${{ matrix.nome }}
        if: matrix.tipo == 'ftp'
        uses: ghaithatfeh/FTP-Deploy-Action@master
        with:
          server: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          server-dir: ${{ matrix.dir }}
          exclude: |
            **/.git*
            **/.git*/**
            webservice/especificos_
            webservice/especificos_/**
            webservice/manual/php/**
        
      - name: üìÇ Sync via SFTP ${{ matrix.nome }}
        if: matrix.tipo == 'sftp'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          port: ${{ secrets[matrix.port] }}
          source: ./
          target: ${{ matrix.dir }}

      - name: üîó Call API after deploy ${{ matrix.nome }}
        run: |
          echo "üì° Chamando API para ${{ matrix.nome }}"

          RESPONSE_CODE=$(curl -X POST "${{ secrets[matrix.api] }}${{ secrets.SUFIXO_DBU_API }}&anticache=$(date +%s)" \
            -H "Content-Type: application/json" \
            -H "Dbutoken: ${{ secrets.DBU_API_TOKEN }}" \
            -d '{"status": "success", "message": "FTP deploy complete"}' \
            -w "%{http_code}" -o response.txt -s)

          echo "üîç HTTP Response Code: $RESPONSE_CODE"

          RESPONSE_BODY=$(cat response.txt)
          echo "üìÑ API Response:"
          echo "$RESPONSE_BODY"

          if [ "$RESPONSE_CODE" -ne 200 ]; then
            echo "‚ùå API call failed with status code $RESPONSE_CODE"
            exit 1
          fi

          if [[ "$RESPONSE_BODY" != *"Atualizacao de estrutura procedimentos e funcoes do banco de dados concluida"* ]]; then
            echo "‚ùå Resposta inesperada da API!"
            echo "üîé Esperado: 'Atualizacao de estrutura procedimentos e funcoes do banco de dados concluida'"
            exit 1
          fi

          echo "‚úÖ Deploy e atualiza√ß√£o do banco de dados realizados com sucesso para ${{ matrix.nome }}"

      - name: üìÇ PHPDoc ${{ matrix.nome }}
        if: matrix.tipo == 'ftp'
        uses: ghaithatfeh/FTP-Deploy-Action@master
        with:
          server: ${{ secrets[matrix.server] }}
          username: ${{ secrets[matrix.username_secret] }}
          password: ${{ secrets[matrix.password_secret] }}
          server-dir: ${{ matrix.dir }}/webservice/manual/php/
          local-dir: './webservice/manual/php/'