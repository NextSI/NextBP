define([],function(){return function(a){"use strict";var e=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.encerra_text=this.dialog.find(".encerra_text"),this.avalia_text=this.dialog.find(".avalia_text"),this.chamado_id=this.dialog.find(".chamado_id"),this.div_notas=this.dialog.find(".div_notas"),this.div_mensagem_enceramento=this.dialog.find(".div_mensagem_enceramento"),this.div_horas_trabalhadas=this.dialog.find(".div_horas_trabalhadas"),this.nota_avaliacao_id=this.dialog.find(".nota_avaliacao_id"),this.edt_msg_encerramento=this.dialog.find(".edt_msg_encerramento"),this.edt_horas_trabalhadas=this.dialog.find(".edt_horas_trabalhadas"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_registra_avaliacao=this.dialog.find(".btn_registra_avaliacao"),this.btn_encerramento=this.dialog.find(".btn_encerramento"),this.sugerir_mensagem_padrao=null,this.mensagem_padrao="",this.tipo_usuario="",this.anexo_array=[],this.numero_anexo=null,this.btn_anexo=this.dialog.find(".btn_anexo"),this.div_anexos=this.dialog.find(".div_anexos"),this.div_anexos_row=this.dialog.find(".div_anexos_row"),this.checkbox_array=[],e.valida_avaliacao="false",this.arr_anexos=[],this.listar_avaliacao=function(a){e.nota_avaliacao_id.find("option").remove(),WS.get("nota_avaliacao/listar/",{tipo_usuario:e.tipo_usuario},function(o){for(var t=0;t<o.length;t++){var n=o[t];"S"==n.padrao?add_option(e.nota_avaliacao_id,n._id,n.nome,"selected"):add_option(e.nota_avaliacao_id,n._id,n.nome)}a&&e.nota_avaliacao_id.val(a).trigger("change")})},this.validar_hora_minuto=function(){var a=new Validation,o=e.edt_horas_trabalhadas.val().split(":"),t=o[1];o.length;return t>59||e.edt_horas_trabalhadas.val().length>0&&6!=e.edt_horas_trabalhadas.val().length?(a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,'Campo "Horas Trabalhadas" inválido!')),alert_modal("Validação",a),!1):!(e.edt_horas_trabalhadas.val()>"838:59")||(a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,'Campo "Horas Trabalhadas" deve ser menor que 838:59 horas!')),alert_modal("Validação",a),!1)},this.show=function(a){if(e.chamado_id.val(a),App.PE.Chamado_Encerramento_show_antes)try{App.PE.Chamado_Encerramento_show_antes(e)}catch(a){console.log(a)}e.edt_msg_encerramento.attr("id","txt_encerramento"+e.html_id),App.sessao.dados.admin||App.sessao.dados.tipo==USUARIO_TIPO.COLABORADOR?e.div_horas_trabalhadas.removeClass("hidden"):e.div_horas_trabalhadas.addClass("hidden"),set_tinymce(e.edt_msg_encerramento,nl2br(e.mensagem_padrao),!1,MODULOS.CHAMADO),e.incAnexo(),WS.get("chamado/verifica_avaliacao_chamado/",{chamado_id:a},function(a){e.valida_avaliacao=a[0].exibir_avaliacao;var o=App.sessao.dados.usuario_id;if("S"!=e.valida_avaliacao||o!=a[0].usuario_abertura_id&&o!=a[0].usuario_cliente_id&&o!=a[0].usuario_empresa_id&&o!=a[0].usuario_fornecedor_id&&o!=a[0].usuario_prospect_id?(App.sessao.dados.tipo==USUARIO_TIPO.COLABORADOR||App.sessao.dados.admin||"N"==e.valida_avaliacao)&&(e.encerra_text.removeClass("hidden"),e.div_mensagem_enceramento.removeClass("hidden"),e.btn_encerramento.removeClass("hidden")):(null!=a[0].usuario_cliente_id?e.tipo_usuario="avaliacao_cliente":null!=a[0].usuario_empresa_id?e.tipo_usuario="avaliacao_colaborador":null!=a[0].usuario_fornecedor_id?e.tipo_usuario="avaliacao_fornecedor":null!=a[0].usuario_prospect_id&&(e.tipo_usuario="avaliacao_organizacao"),e.listar_avaliacao(),e.div_notas.removeClass("hidden"),e.btn_registra_avaliacao.removeClass("hidden"),e.avalia_text.removeClass("hidden"),e.div_horas_trabalhadas.addClass("hidden")),App.PE.Chamado_Encerramento_show_depois)try{App.PE.Chamado_Encerramento_show_depois(e)}catch(a){console.log(a)}}),formatarCampoHorasTrabalhadas(function(a){e.edt_horas_trabalhadas.mask(a),show_modal(e.modal.attr("id"))})},this.close=function(){close_modal(e.modal.attr("id")),void 0!==e.onclose&&e.onclose&&e.onclose()},this.unload=function(){e.close(),View.unload(this.html_id)},this.btn_anexo.click(function(){e.incAnexo()}),this.incAnexo=function(){var a=e.div_anexos_row.clone();e.numero_anexo=1+e.numero_anexo,a.find(".anexo_base_label").text("Anexo #"+e.numero_anexo);var o=a.find(".checkbox");o.attr("type","checkbox"),o.bootstrapSwitch(!0),a.removeClass("hidden"),a.appendTo(e.div_anexos),App.is_nativo()?(a.find("[type=file]").attr("id_localizacao",e.numero_anexo-1),a.find("[type=file]").unbind("click"),a.find("[type=file]").bind("click",function(o){o.preventDefault();var t=$(this),n=parseInt($(t).attr("id_localizacao"));PhoneGapFile.getFile(function(o){o.state==PhoneGapFile.STATE.SUCCESS?(void 0!==e.arr_anexos[n]&&null!=e.arr_anexos[n]&&""!=e.arr_anexos[n]?e.arr_anexos[n]=o.file:e.arr_anexos.push(o.file),a.find("[type=file]").next().find("*:contains('text')").next().next().text("Arquivo selecionado!").addClass("text-success")):o.state==PhoneGapFile.STATE.FAIL&&(null==e.arr_anexos[n]&&""==e.arr_anexos[n]?a.find("[type=file]").next().find("*:contains('text')").next().next().text("Nenhum Arquivo selecionado!").removeClass("text-success"):null!=e.arr_anexos[n]&&""!=e.arr_anexos[n]&&a.find("[type=file]").next().find("*:contains('text')").next().next().text("Arquivo selecionado!").addClass("text-success"))})})):a.find("input[type=file]").change(function(){0===$(this).get(0).files.length?$(this).next().find("*:contains('text')").next().next().text("Nenhum arquivo selecionado!"):$(this).next().find("*:contains('text')").next().next().text($(this).val().split("fakepath\\").length>1?$(this).val().split("fakepath\\")[1].toString():$(this).val().split("fakepath\\")[0].toString())})},this.preparar_anexos=function(){var a=e.div_anexos.find('input[type="file"]');a!=[]?$.each(a,function(a,o){o.files[0]&&(e.anexo_array[a]=o.files[0])}):e.anexo_array=[];var o=e.div_anexos.find('input[type="checkbox"]');if(o!=[])for(var t=0;t<o.length;t++)e.checkbox_array[t]=$(o[t]).prop("checked");else e.checkbox_array=[]},this.pe_salvar_depois=function(){if(App.PE.Chamado_Encerramento_salvar_depois)try{App.PE.Chamado_Encerramento_salvar_depois(e.chamado_id.val(),e)}catch(a){console.log(a)}},this.btn_registra_avaliacao.click(function(){e.preparar_anexos(),WS.post("chamado/salvar_avaliacao",{chamado_id:e.chamado_id.val(),nota_avaliacao_id:e.nota_avaliacao_id.val(),mensagem_encerramento:get_tinymce(e.edt_msg_encerramento),horas_trabalhadas:e.edt_horas_trabalhadas.val(),documentos:e.anexo_array,enviar_documento:e.checkbox_array},function(a){alert_saved("Avaliação realizada com sucesso"),e.unload(),e.pe_salvar_depois()},[e.btn_encerramento,e.btn_cancelar],null,!0)}),this.btn_encerramento.click(function(){e.validar_hora_minuto()&&(e.preparar_anexos(),App.is_nativo()?App.obter_token_publico(function(a){if(e.arr_anexos.length>0){var o={route:"documento/salvar_anexoGP",disable_buttons:[e.btn_encerramento,e.btn_cancelar],data:{token_publico:a,documento_key:"documentos",documentos:e.arr_anexos}};new PhoneGapWS(o,function(a){a.state==PhoneGapWS.STATE.SUCCESS&&WS.post("chamado/encerrar_chamado",{chamado_id:e.chamado_id.val(),mensagem_encerramento:get_tinymce(e.edt_msg_encerramento),horas_trabalhadas:e.edt_horas_trabalhadas.val(),files_names:a.return_value,enviar_documento:e.checkbox_array,mobile:"sim"},function(a){alert_saved("Chamado encerrado com sucesso"),e.unload(),e.pe_salvar_depois()},[e.btn_encerramento,e.btn_cancelar])})}else WS.post("chamado/encerrar_chamado",{chamado_id:e.chamado_id.val(),mensagem_encerramento:get_tinymce(e.edt_msg_encerramento),horas_trabalhadas:e.edt_horas_trabalhadas.val()},function(a){alert_saved("Chamado encerrado com sucesso"),e.unload(),e.pe_salvar_depois()},[e.btn_encerramento,e.btn_cancelar])}):WS.post("chamado/encerrar_chamado",{chamado_id:e.chamado_id.val(),mensagem_encerramento:get_tinymce(e.edt_msg_encerramento),documentos:e.anexo_array,enviar_documento:e.checkbox_array,horas_trabalhadas:e.edt_horas_trabalhadas.val()},function(a){alert_saved("Chamado encerrado com sucesso"),e.unload(),e.pe_salvar_depois()},[e.btn_encerramento,e.btn_cancelar],null,!0))}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){e.unload()})}});