define([],function(){return function(e){"use strict";var a=this;this.html_id=e,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.onsave=null,this.edt_mensagem=this.dialog.find(".edt_mensagem"),this.edt_usuario=this.dialog.find(".edt_usuario"),this.div_usuario=this.dialog.find(".div_usuario"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.btn_anexo=this.dialog.find(".btn_anexo"),this.div_anexos=this.dialog.find(".div_anexos"),this.div_anexos_row=this.dialog.find(".div_anexos_row"),this.panel_anexos=this.dialog.find(".panel_anexos"),this.titulo=this.dialog.find(".titulo"),this.mensagem_id=null,this.numero_anexo=null,this.anexo_array=[],this.administrativo=null,this.lista_id=null,this.comentario=null,this.comentario_id=null,this.anexo_fotos=[],this.anexo=[],this.show=function(e,n,t,i,o){switch(a.edt_mensagem.attr("id","edt_mensagem"+a.html_id),a.lista_id=i,a.tipo=n,a.comentario=t,a.mensagem_id=e,a.comentario_id=o,a.tipo){case FORMULARIO.NOVO:a.btn_salvar.show(),a.btn_excluir.hide(),a.div_usuario.addClass("hidden"),a.permite_alterar(!0);break;case FORMULARIO.EDITAR:a.btn_salvar.show(),a.btn_excluir.hide(),a.edt_usuario.prop("readonly",!0),a.div_usuario.removeClass("hidden");break;case FORMULARIO.VISUALIZAR:a.btn_salvar.hide(),a.btn_excluir.hide(),a.div_usuario.removeClass("hidden"),a.permite_alterar(!1);break;case FORMULARIO.EXCLUIR:a.btn_salvar.hide(),a.btn_excluir.show(),a.div_usuario.removeClass("hidden"),a.permite_alterar(!1)}0==a.comentario?a.titulo.text("Publicações"):a.titulo.text("Comentário"),void 0!==e&&e&&a.tipo!=FORMULARIO.NOVO?a.preencher():set_tinymce(a.edt_mensagem,""),show_modal(a.modal.attr("id")),set_focus(a.edt_mensagem)},this.close=function(){close_modal(a.modal.attr("id")),void 0!==a.onclose&&a.onclose&&a.onclose()},this.unload=function(){a.close(),View.unload(this.html_id)},this.permite_alterar=function(e){a.edt_mensagem.prop("readonly",!e),a.edt_usuario.prop("readonly",!e)},this.preencher=function(){0==a.comentario?WS.get("mensagem_listas_discussao/objeto/",{mural_mensagem_id:a.mensagem_id},function(e){a.mensagem_id=e.id,set_tinymce(a.edt_mensagem,e.mensagem,a.tipo==FORMULARIO.EXCLUIR||a.tipo==FORMULARIO.VISUALIZAR),a.edt_usuario.val(e.autor_nome),a.consultar_anexos()}):WS.get("mensagem_listas_discussao/popular_comentario/",{id_mensagem_lista:a.mensagem_id,id_comentario_lista:a.comentario_id},function(e){a.comentario_id=e.comentario_id,set_tinymce(a.edt_mensagem,e.comentario,a.tipo==FORMULARIO.EXCLUIR||a.tipo==FORMULARIO.VISUALIZAR),a.edt_usuario.val(e.usuario_autor_nome),a.consultar_anexos()})},this.incAnexo=function(){if(App.is_nativo()){var e=a.div_anexos_row.clone();a.numero_anexo=1+a.numero_anexo;var n=e.find(".btn_input");e.find('input[type="file"]').addClass("hidden"),e.find(".capture_photo").removeClass("hidden").addClass("text-primary");var t=e.find(".capture_photo");n.attr("id_localizacao",a.numero_anexo-1),t.attr("id_localizacao",a.numero_anexo-1),n.unbind("click"),n.bind("click",function(){var e=$(this),t=parseInt($(e).attr("id_localizacao"));PhoneGapFile.getFile(function(e){e.state==PhoneGapFile.STATE.SUCCESS?(void 0!==a.anexo[t]&&null!=a.anexo[t]&&""!=a.anexo[t]?a.anexo[t]=e.file:a.anexo.push(e.file),n.find("*:contains('text')").next().next().text("Arquivo selecionado!").addClass("text-success")):e.state==PhoneGapFile.STATE.FAIL&&(null==a.anexo[t]&&""==a.anexo[t]?n.find("*:contains('text')").next().next().text("Nenhum Arquivo selecionado!").removeClass("text-success"):null!=a.anexo[t]&&""!=a.anexo[t]&&n.find("*:contains('text')").next().next().text("Arquivo selecionado!").addClass("text-success"))})}),t.unbind("click"),t.bind("click",function(){var e=$(this),n=parseInt($(e).attr("id_localizacao"));App.pg_capture(t,function(e){void 0!==a.anexo[n]&&null!==a.anexo[n]&&""!==a.anexo[n]?a.anexo[n]=e:a.anexo.push(e),t.next().find("*:contains('text')").next().next().text("Imagem capturada!").addClass("text-success")},!1,function(e){0==parseInt(e)&&(null==a.anexo[n]&&""==a.anexo[n]?t.next().find("*:contains('text')").next().next().text("Nenhum Arquivo selecionado!").removeClass("text-success"):null!=a.anexo[n]&&""!=a.anexo[n]&&t.next().find("*:contains('text')").next().next().text("Imagem capturada!").addClass("text-success"))})}),e.find(".anexo_base_label").text("Anexo #"+a.numero_anexo),e.removeClass("hidden"),e.appendTo(a.div_anexos)}else{e=a.div_anexos_row.clone();a.numero_anexo=1+a.numero_anexo,e.find(".anexo_base_label").text("Anexo #"+a.numero_anexo);n=e.find(".mobile_inputfile");e.removeClass("hidden"),e.appendTo(a.div_anexos),n.change(function(){0===$(this).get(0).files.length?$(this).next().next().find(".anexo_base_input_text").text("Nenhum arquivo selecionado!"):$(this).next().next().find(".anexo_base_input_text").text($(this).val().split("fakepath\\").length>1?$(this).val().split("fakepath\\")[1].toString():$(this).val().split("fakepath\\")[0].toString())}),e.find('input[type="file"]').trigger("click")}},this.consultar_anexos=function(){var e=$(".div_anexos_carregados");e.removeClass("hidden");var n=e.find(".anexos");n.find(".line_anexos").remove();var t=$('<div class="form-inline">'),i=function(e){var i=$('<div class="input-group btn-group" style="margin-top: 10px; margin-right: 5px;">'),o=e.documento_revisao_id,s=e.documento_id;if("application/pdf"==e.mime_type){var l=$("<button>");l.addClass("btn btn-default btn-sm"),l.text(FileShortName(e.revisao_nome)),l.unbind("click"),l.click(function(){View.load("central_documentos/visualizar_pdf",function(e,a){a.show(o)})}),(_=$("<a>")).attr("type","button"),_.addClass("btn btn-default btn-sm"),_.attr("title",e.revisao_nome),_.attr("value",e.documento_id);var d=$("<span>");d.addClass("glyphicon glyphicon-download-alt"),_.append(d),(c=$("<a>")).attr("type","button"),c.addClass("btn btn-default btn-sm"),c.attr("value",e.documento_id),(m=$("<span>")).addClass("glyphicon glyphicon-trash"),c.append(m),i.append(l),i.append(_),i.append(c)}else{var _,c,m;(_=$("<a>")).attr("type","button"),_.addClass("btn btn-default btn-sm btn-group"),_.attr("title",e.revisao_nome),_.text(FileShortName(e.revisao_nome)),_.attr("value",e.documento_id),(c=$("<a>")).attr("type","button"),c.addClass("btn btn-default btn-sm"),c.attr("value",e.documento_id),(m=$("<span>")).addClass("glyphicon glyphicon-trash"),c.append(m),i.append(_),i.append(c)}_.click(function(){App.obter_token_publico(function(e){App.download(WS_URI+"documento/download/?documento_revisao_id="+o+"&token_publico="+e)})}),c.unbind("click"),c.click(function(){0==a.comentario?WS.post("mensagem_listas_discussao/excluir_anexo_mensagem/",{mural_mensagem_id:a.mensagem_id,documento_id:s},function(e){e&&i.find('[value="'+s+'"]').remove()}):WS.post("mensagem_listas_discussao/excluir_anexo_comentario/",{comentario_id:a.comentario_id,documento_id:s},function(e){e&&i.find('[value="'+s+'"]').remove()})}),t.append(i),n.append(t)};0==a.comentario?WS.get("documento/listar_documentos_listas_discussao/",{mural_mensagem_id:a.mensagem_id},function(e){$(e).each(function(e,a){i(a)})}):WS.get("documento/listar_documentos_comentarios_listas_discussao/",{id_comentario_lista:a.comentario_id},function(e){$(e).each(function(e,a){i(a)})})},this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){a.unload()}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){if(0==a.comentario)if(App.is_nativo())App.obter_token_publico(function(e){if(a.anexo.length>0){var n={route:"documento/salvar_anexoGP",disable_buttons:[a.btn_salvar,a.btn_cancelar],data:{token_publico:e,documento_key:"documentos",documentos:a.anexo}};new PhoneGapWS(n,function(e){e.state==PhoneGapWS.STATE.SUCCESS?WS.post("mensagem_listas_discussao/salvar",{id_mensagem_lista:a.mensagem_id,mensagem:get_tinymce(a.edt_mensagem),files_names:e.return_value,mobile:App.is_nativo()?"sim":"nao",lista_id:a.lista_id},function(e){alert_saved("Mensagem publicada com sucesso"),void 0!==a.onsave&&a.onsave&&a.onsave(e),a.unload()},[a.btn_salvar,a.btn_cancelar],null,!0):(a.btn_cancelar.removeClass("disabled"),a.btn_salvar.removeClass("disabled"))})}else WS.post("mensagem_listas_discussao/salvar",{id_mensagem_lista:a.mensagem_id,mensagem:get_tinymce(a.edt_mensagem),mobile:App.is_nativo()?"sim":"nao",lista_id:a.lista_id},function(e){alert_saved("Mensagem publicada com sucesso"),void 0!==a.onsave&&a.onsave&&a.onsave(e),a.unload()},[a.btn_salvar,a.btn_cancelar],null,!0)});else{var e=a.div_anexos.find('input[type="file"]');$.each(e,function(e,n){n.files[0]&&(a.anexo_array[e]=n.files[0])}),WS.post("mensagem_listas_discussao/salvar",{id_mensagem_lista:a.mensagem_id,mensagem:get_tinymce(a.edt_mensagem),documentos:a.anexo_array,mobile:App.is_nativo()?"sim":"nao",lista_id:a.lista_id},function(e){alert_saved("Mensagem publicada com sucesso"),void 0!==a.onsave&&a.onsave&&a.onsave(e),a.unload()},[a.btn_cancelar,a.btn_salvar],null,!0)}else if(App.is_nativo())App.obter_token_publico(function(e){if(a.anexo.length>0){var n={route:"documento/salvar_anexoGP",disable_buttons:[a.btn_cancelar,a.btn_salvar],data:{token_publico:e,documento_key:"documentos",documentos:a.anexo}};new PhoneGapWS(n,function(e){e.state==PhoneGapWS.STATE.SUCCESS?WS.post("mensagem_listas_discussao/salvar_comentarios",{id_mensagem_lista:a.mensagem_id,comentario:get_tinymce(a.edt_mensagem),files_names:e.return_value,mobile:App.is_nativo()?"sim":"nao",comentario_id:a.comentario_id},function(e){alert_saved("Mensagem publicada com sucesso"),void 0!==a.onsave&&a.onsave&&a.onsave(e),a.unload()},[a.btn_salvar,a.btn_cancelar],null,!0):(a.btn_cancelar.removeClass("disabled"),a.btn_salvar.removeClass("disabled"))})}else WS.post("mensagem_listas_discussao/salvar_comentario",{id_mensagem_lista:a.mensagem_id,comentario:get_tinymce(a.edt_mensagem),mobile:App.is_nativo()?"sim":"nao",comentario_id:a.comentario_id},function(e){alert_saved("Mensagem publicada com sucesso"),void 0!==a.onsave&&a.onsave&&a.onsave(e),a.unload()},[a.btn_salvar,a.btn_cancelar],null,!0)});else{e=a.div_anexos.find('input[type="file"]');$.each(e,function(e,n){n.files[0]&&(a.anexo_array[e]=n.files[0])}),WS.post("mensagem_listas_discussao/salvar_comentario",{id_mensagem_lista:a.mensagem_id,comentario:get_tinymce(a.edt_mensagem),documentos:a.anexo_array,mobile:App.is_nativo()?"sim":"nao",comentario_id:a.comentario_id},function(e){alert_saved("Mensagem publicada com sucesso"),void 0!==a.onsave&&a.onsave&&a.onsave(e),a.unload()},[a.btn_cancelar,a.btn_salvar],null,!0)}}),this.btn_excluir.unbind("click"),this.btn_excluir.click(function(){0==a.comentario?WS.post("mensagem_listas_discussao/excluir",{mural_mensagem_id:a.mensagem_id},function(e){alert_saved("Mensagem excluida com sucesso"),void 0!==a.onsave&&a.onsave&&a.onsave(e),a.unload()}):WS.post("mensagem_listas_discussao/excluir_comentario",{mural_mensagem_id:a.mensagem_id,comentario_id:a.comentario_id,lista_id:a.lista_id},function(e){alert_saved("Comentário excluida com sucesso"),void 0!==a.onsave&&a.onsave&&a.onsave(e),a.unload()})}),this.btn_anexo.click(function(){a.incAnexo()})}});