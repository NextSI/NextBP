define([],function(){return function(e){"use strict";var t=this;this.html_id=e,this.dialog=$("#"+this.html_id),this.title="Dashboard Entidades",this.div_cliente=this.dialog.find(".div_cliente"),this.div_grafico_cliente=this.dialog.find(".div_grafico_cliente"),this.div_grafico_cliente_linhas=this.dialog.find(".div_grafico_cliente_linhas"),this.tbl_qtd_motivos_perda=this.dialog.find(".tbl_qtd_motivos_perda"),this.div_grafico_motivo_perda_negocio=this.dialog.find(".div_grafico_motivo_perda_negocio"),this.div_segmento=this.dialog.find(".div_segmento"),this.div_grafico_segmento=this.dialog.find(".div_grafico_segmento"),this.div_alert_segmentos_mais_compram=this.dialog.find(".div_alert_segmentos_mais_compram"),this.div_alert_mais_compram=this.dialog.find(".div_alert_mais_compram"),this.div_alert_nao_compram=this.dialog.find(".div_alert_nao_compram"),this.edt_qtd_dias=this.dialog.find(".edt_qtd_dias"),this.lbl_qtd_dias=this.dialog.find(".lbl_qtd_dias"),this.div_filtros=this.dialog.find(".div_filtros"),this.edt_day_start=this.dialog.find(".edt_day_start"),this.edt_day_end=this.dialog.find(".edt_day_end"),this.btn_limpar_filtro=this.dialog.find(".btn_limpar_filtro"),this.btn_search=this.dialog.find(".btn_search"),this.tbl_origem_qtd=this.dialog.find(".tbl_origem_qtd"),this.div_grafico_origem_qtd=this.dialog.find(".div_grafico_origem_qtd"),this.div_cliente_nao_compram=this.dialog.find(".div_cliente_nao_compram"),this.div_grafico_cliente_nao_compram=this.dialog.find(".div_grafico_cliente_nao_compram"),this.div_principal=this.dialog.find(".div_principal"),this.dados=[],this.dados_clientes_nao_compram=[],this.dados_linha=[],this.segmentos=[],this.motivos_perda_negocio=[],this.cores=ColorsGrafico(),this.show=function(){set_datepicker(t.edt_day_start),set_datepicker(t.edt_day_end),t.edt_qtd_dias.val(10).trigger("change")},this.listar_dashboard=function(){var e=t.div_cliente.find('[template-row="cliente"]'),o=t.div_cliente_nao_compram.find('[template-row="cliente"]'),i=t.div_segmento.find('[template-row="segmento"]');t.dia_inicio=get_datepicker(t.edt_day_start),t.dia_fim=get_datepicker(t.edt_day_end),WS.get("oportunidade/get_dashboard_cliente/",{qtd_dias:t.edt_qtd_dias.val(),dia_inicio:t.dia_inicio,dia_fim:t.dia_fim},function(a){if(t.dados=[],t.dados_linha=[],t.dados_clientes_nao_compram=[],t.segmentos=[],t.motivos_perda_negocio=[],t.div_cliente.find(".rows").remove(),t.div_cliente_nao_compram.find(".rows").remove(),t.div_segmento.find(".rows").remove(),t.qtd_opt_origem(a.qtd_opt_origem),t.qtd_motivos_perda_oportunidade(a.qtd_motivos_perda_oportunidade),a.maiores_vendas_segmento.length>0){t.div_alert_segmentos_mais_compram.addClass("hidden");var d=0,n=0;$(a.maiores_vendas_segmento).each(function(e,o){!function(e,o){var a=i.clone();a.css("display",""),a.removeAttr("template-row"),a.addClass("rows"),$(a.find('[template-field="segmento_nome"]')).text(o.segmento_nome?o.segmento_nome:""),$(a.find('[template-field="valor_negocio_segmento"]')).text(o.valor_negocio?o.valor_negocio.format_number(2,!0):""),$(a.find('[template-field="qtd_segmento"]')).text(o.qtd_oportunidades_ganhas_segmento?parseInt(o.qtd_oportunidades_ganhas_segmento,10)+" oportunidade":""),$(a.find('[template-field="valor_medio_segmento"]')).text(o.gasto_medio_segmento?"Gasto Médio R$ "+o.gasto_medio_segmento.format_number(2,!0):"Gasto Médio R$ 0,00"),a.appendTo(t.div_segmento)}(0,o),t.segmentos.push([o.segmento_nome,parseInt(o.valor_negocio,10)]),d+=parseFloat(o.valor_negocio),n+=parseInt(o.qtd_oportunidades_ganhas_segmento,10)}),function(e,o){var a=0;o>0&&(a=e/o);var d=i.clone();d.css("display",""),d.removeAttr("template-row"),d.addClass("rows"),$(d.find('[template-field="segmento_nome"]')).text("Total"),$(d.find('[template-field="valor_negocio_segmento"]')).text("R$ "+e.format_number(2,!0)),$(d.find('[template-field="qtd_segmento"]')).text(parseInt(o,10)+" oportunidade"),$(d.find('[template-field="valor_medio_segmento"]')).text("Gasto Médio R$ "+a.format_number(2,!0)),d.appendTo(t.div_segmento)}(d,n),t.grafico_segmento()}else t.div_grafico_segmento.text(""),t.div_alert_segmentos_mais_compram.removeClass("hidden");if(a.maiores_vendas.length>0){t.div_alert_mais_compram.addClass("hidden");d=0,n=0;$(a.maiores_vendas).each(function(o,i){!function(o,i){var a=e.clone();a.css("display",""),a.removeAttr("template-row"),a.addClass("rows"),$(a.find('[template-field="nome"]')).text(i.entidade_nome?i.entidade_nome:"");var d=$(a.find('[template-field="tipo"]'));d.text(i.entidade_tipo),"C"==i.entidade_tipo?d.addClass("label-info"):"O"==i.entidade_tipo&&d.addClass("label-danger"),$(a.find('[template-field="valor"]')).text(i.valor_total_gasto?i.valor_total_gasto.format_number(2,!0):"0"),$(a.find('[template-field="qtd"]')).text(i.qtd_oportunidades_ganhas?i.qtd_oportunidades_ganhas+" oportunidade"+(parseInt(i.qtd_oportunidades_ganhas,10)?"s":""):"0 oportunidade"),$(a.find('[template-field="valor_medio"]')).text(i.gasto_medio?"Gasto Médio R$ "+i.gasto_medio.format_number(2,!0):"0"),a.appendTo(t.div_cliente)}(0,i),t.dados.push([i.entidade_nome,parseInt(i.valor_total_gasto,10)]),d+=parseFloat(i.valor_total_gasto),n+=parseInt(i.qtd_oportunidades_ganhas,10)}),function(o,i){var a=0;i>0&&(a=o/i);var d=e.clone();d.css("display",""),d.removeAttr("template-row"),d.addClass("rows"),$(d.find('[template-field="nome"]')).text("Total"),$(d.find('[template-field="tipo"]')).hide(),$(d.find('[template-field="valor"]')).text(o.format_number(2,!0)),$(d.find('[template-field="qtd"]')).text(i+" oportunidade"+(parseInt(i,10)?"s":"")),$(d.find('[template-field="valor_medio"]')).text("Gasto Médio R$ "+a.format_number(2,!0)),d.appendTo(t.div_cliente)}(d,n),t.grafico_cliente()}else t.div_grafico_cliente.text(""),t.div_alert_mais_compram.removeClass("hidden");if(a.tempo_sem_comprar.length>0?(t.div_alert_nao_compram.addClass("hidden"),$(a.tempo_sem_comprar).each(function(e,i){!function(e,i){var a=o.clone();a.css("display",""),a.removeAttr("template-row"),a.addClass("rows"),$(a.find('[template-field="nome"]')).text(i.entidade_nome?i.entidade_nome:"");var d=$(a.find('[template-field="tipo"]'));d.text(i.entidade_tipo),"C"==i.entidade_tipo?d.addClass("label-info"):"O"==i.entidade_tipo&&d.addClass("label-danger"),$(a.find('[template-field="ultima_compra"]')).text(i.data_ultima_compra?"Última compra:"+i.data_ultima_compra.format_date():""),$(a.find('[template-field="qtd_dias"]')).text(i.dias_sem_comprar?i.dias_sem_comprar+" dia"+(parseInt(i.dias_sem_comprar,10)?"s":""):"0"),a.appendTo(t.div_cliente_nao_compram)}(0,i),t.dados_clientes_nao_compram.push([i.entidade_nome,parseInt(i.dias_sem_comprar,10)])}),t.grafico_cliente_sem_comprar()):(t.div_grafico_cliente_nao_compram.text(""),t.div_alert_nao_compram.removeClass("hidden")),a.periodo_vendas){var r;t.dados_linha=a.periodo_vendas,r=t.get_periodo_grafico(),t.grafico_clientes_linha(r)}else t.div_grafico_cliente_linhas.text("");a.qtd_motivos_perda_oportunidade?$(a.qtd_motivos_perda_oportunidade).each(function(e,o){t.motivos_perda_negocio.push([o.nome_motivo_perda,parseInt(o.qtd_motivo_perda,10)])}):t.div_grafico_motivo_perda_negocio.text("")})},this.get_periodo_grafico=function(){var e=new Date(get_datepicker(t.edt_day_start)),o=new Date(get_datepicker(t.edt_day_end)),i=e.getMonth(),a=o.getMonth(),d=e.getFullYear(),n=a-i+12*(o.getFullYear()-d),r=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],s=[],_=i;isNaN(i)&&(i=0),isNaN(a)&&(a=11);for(var l=0;l<=n;l++)12==_&&(d+=1,_=0),s.push(r[_]+"/"+d.toString()),_+=1;return s},this.qtd_motivos_perda_oportunidade=function(e){var o=[],i=0,a=0,d=[],n=[];t.tbl_qtd_motivos_perda.find(".rows").remove(),$.each(e,function(e,r){$.each(t.cores,function(e,t){n.push(t.nome_hex),d.push(t.hex)});var s=$('<tr class="rows"><td><a href="javascript:;">'+r.nome_motivo_perda+'</a></td><td class="text-center"><span class="badge" style="padding-right: 10px; background:'+d[e]+'"><font color="'+n[e]+'">'+r.qtd_motivo_perda+'</font></td><td class="text-right">'+(r.valor_negocio?r.valor_negocio.format_number(2,!0):"&nbsp;")+"</td></tr>");s.on("click",function(){View.loadReact(window.views.motivo_perda_negocio.Relatorio.default,{motivoPerdaId:r.motivo_perda_negocio_id,diaInicio:t.dia_inicio,diaFim:t.dia_fim},function(e){},View.ABA.SIM)}),s.css("cursor","pointer"),t.tbl_qtd_motivos_perda.append(s),i=parseInt(r.qtd_motivo_perda,10)+i,a=parseFloat(r.valor_negocio)+a,o.push([r.nome_motivo_perda,parseInt(r.qtd_motivo_perda,10)])}),t.tbl_qtd_motivos_perda.find(".foot_total_qtd").text(i),t.tbl_qtd_motivos_perda.find(".foot_total_valor").text(a.format_number(2,!0)),t.div_grafico_motivo_perda_negocio.highcharts({chart:{backgroundColor:"#DDD",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},colors:d,title:{text:""},credits:{enabled:!1},exporting:{enabled:!1},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!1,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}}},series:[{type:"pie",name:"Motivos de Perda de Negócio",borderColor:"#DDD",data:o}]})},this.qtd_opt_origem=function(e){var o=[],i=0,a=0,d=[],n=[];t.tbl_origem_qtd.find(".rows").remove(),$.each(e,function(e,r){$.each(t.cores,function(e,t){n.push(t.nome_hex),d.push(t.hex)});var s=$('<tr class="rows"><td><a href="javascript:;">'+r.nome+'</a></td><td class="text-center"><span class="badge" style="padding-right: 10px; background:'+d[e]+'"><font color="'+n[e]+'">'+r.qtd+'</font></td><td class="text-right">'+(r.valor_negocio?r.valor_negocio.format_number(2,!0):"&nbsp;")+"</td></tr>");s.on("click",function(){View.loadReact(window.views.oportunidade_origem.Relatorio.default,{oportunidadeOrigemId:r.oportunidade_origem_id,diaInicio:t.dia_inicio,diaFim:t.dia_fim},function(e){},View.ABA.SIM)}),s.css("cursor","pointer"),t.tbl_origem_qtd.append(s),i=parseInt(r.qtd,10)+i,a=parseFloat(r.valor_negocio)+a,o.push([r.nome,parseInt(r.qtd,10)])}),t.tbl_origem_qtd.find(".foot_total_qtd").text(i),t.tbl_origem_qtd.find(".foot_total_valor").text(a.format_number(2,!0)),t.div_grafico_origem_qtd.highcharts({chart:{backgroundColor:"#DDD",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},colors:d,title:{text:""},credits:{enabled:!1},exporting:{enabled:!1},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!1,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}}},series:[{type:"pie",name:"Quantidade de Oportunidades Ganhas X Origem de Oportunidades",borderColor:"#DDD",data:o}]})},this.grafico_segmento=function(){t.segmentos.length>0&&t.div_grafico_segmento.highcharts({chart:{backgroundColor:"#DDD",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:""},credits:{enabled:!1},exporting:{enabled:!1},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!1,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}}},series:[{type:"pie",name:"Segmentos c/ mais gastos.",borderColor:"#DDD",data:t.segmentos}]})},this.grafico_cliente=function(){t.dados.length>0&&t.div_grafico_cliente.highcharts({chart:{backgroundColor:"#DDD",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:""},credits:{enabled:!1},exporting:{enabled:!1},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!1,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}}},series:[{type:"pie",name:"Entidades c/ mais gastos.",borderColor:"#DDD",data:t.dados}]})},this.grafico_cliente_sem_comprar=function(){t.dados_clientes_nao_compram.length>0&&t.div_grafico_cliente_nao_compram.highcharts({chart:{backgroundColor:"#DDD",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:""},credits:{enabled:!1},exporting:{enabled:!1},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!1,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}}},series:[{type:"pie",name:"Entidades c/ mais tempo sem comprar.",borderColor:"#DDD",data:t.dados_clientes_nao_compram}]})},this.grafico_clientes_linha=function(e){t.div_grafico_cliente_linhas.highcharts({exporting:{enabled:!1},title:{text:"Período de Compra",x:-20,useHTML:!0},xAxis:{categories:e},yAxis:{title:{text:"Valor da Compra (R$)"},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{valuePrefix:"R$ ",useHTML:!0},credits:{enabled:!1},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0,useHTML:!0},series:t.dados_linha})},this.unload=function(){View.unload(this.html_id)},this.btn_limpar_filtro.unbind("click"),this.btn_limpar_filtro.click(function(){set_datepicker(t.edt_day_start,"yyyy-MM-dd"),set_datepicker(t.edt_day_end,"yyyy-MM-dd"),t.edt_qtd_dias.val(10).trigger("change")}),this.btn_search.unbind("click"),this.btn_search.click(function(){""!==get_datepicker(t.edt_day_start)&&""!==get_datepicker(t.edt_day_end)?get_datepicker(t.edt_day_start)>get_datepicker(t.edt_day_end)?alert_modal("Atenção","Data Início não pode ser maior que a Data Fim"):(t.div_principal.removeClass("hidden"),t.listar_dashboard()):alert_modal("Atenção","Preencha os campos: Início e Fim")}),this.edt_qtd_dias.unbind("change"),this.edt_qtd_dias.change(function(){t.lbl_qtd_dias.text(this.value)})}});