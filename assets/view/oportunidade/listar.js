define([],function(){return function(a){"use strict";var o=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.title="Oportunidades",this.btn_novo=this.dialog.find(".btn_novo"),this.btn_opcoes_filtro=this.dialog.find(".btn_opcoes_filtro"),this.btn_limpar_filtro=this.dialog.find(".btn_limpar_filtro"),this.btn_configurar_filtros=this.dialog.find(".btn_configurar_filtros"),this.lb_orcamentos_pendentes=this.dialog.find(".orcamentos_pendentes"),this.cbo_filtro_situacao_orcamento=this.dialog.find(".cbo_filtro_situacao_orcamento"),this.cbo_funil_vendas=this.dialog.find(".cbo_funil_vendas"),this.btn_favoritar_funil=this.dialog.find(".btn_favoritar_funil"),this.btn_excel=this.dialog.find(".btn_excel"),this.btn_mudar_visualizacao=this.dialog.find(".btn_mudar_visualizacao"),this.btn_compactar_cards=this.dialog.find(".btn_compactar_cards"),this.btn_refresh=this.dialog.find(".btn_refresh"),this.lbl_total_geral_pipe=this.dialog.find(".lbl_total_geral_pipe"),this.div_info_qtd_opt_selec=this.dialog.find(".div_info_qtd_opt_selec"),this.div_drag_situacao=this.dialog.find(".div_drag_situacao"),this.dx_kanban=this.dialog.find(".dx_kanban"),this.dx_grid=this.dialog.find(".dx_grid"),this.context_menu=this.dialog.find(".context-menu"),this.arr_funil_vendas=[],this.funil_vendas_id=null,this.arr_etapas=[],this.arr_oportunidades_etapa=[],this.filtro_usuario_carregado=!1,this.observacao_oportunidade_perdida=null,this.observacao=null,this.motivo_perda_negocio=null,this.parametros_filtros=[],this.filtros={tipo_periodo:7,dt_ini:null,dt_fim:null,tipo_responsavel:2,situacao:3,representante:null,situacao_orcamento:null,entidade:null,entidade_tipo:null},this.requisicao_data={},this.arr_offset={},this.total_geral_pipe=0,this.context_opt_selecionada_id=0,this.context_opt_selecionada_div=null,this.context_opt_selecionada_situacao=null,this.arr_oportunidades_selecionadas=[],this.tipo_visualizacao=OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN,this.dataGrid=null,this.clearState=!1,this.cards_compactos=!1,this.imagem_id=null,this.arr_paginacao=[],this.take=20,this.funil_redimensionar_etapas=!1,this.exibir_data_abertura_oportunidade=!1,App.temp.oportunidade={},App.temp.oportunidade.filtros={},this.funil_vendas_selecionado=null,this.funil_exibir_razao_social_entidade=!1,this.show=function(a){o.funil_vendas_selecionado=a;var e=App.get_parametro_usuario("oportunidade_filtros");o.filtros=spread({},o.filtros,e),o.initialize(),o.parametros_filtros_usuario(o.construct)},this.initialize=function(){o.cbo_funil_vendas=$(o.cbo_funil_vendas).select_bp({direction:"right",placeholder:"Informe o Funil de Vendas"}),o.listar_funil(),o.cbo_funil_vendas.get().change(function(){o.funil_vendas_id=o.cbo_funil_vendas.val();var a=o.arr_funil_vendas.filter(function(a,e){return a.id==o.funil_vendas_id})[0];o.funil_redimensionar_etapas=a.redimensionar_etapas,o.funil_exibir_razao_social_entidade=a.exibir_razao_social_entidade,o.modo_aprovacao_supervisor(o.funil_vendas_id),o.listar_etapas()})},this.listar_funil=function(a){WS.get("funil_vendas/listar/",null,function(a){var e=null;o.arr_funil_vendas=a;var t=a.map(function(a,t){return+o.funil_vendas_selecionado>0?e=o.funil_vendas_selecionado:"S"==a.padrao&&(e=a.id),{name:a.nome,value:a.id,extra:a,escolha_empresa_ganho_perda:a.escolha_empresa_ganho_perda,exibir_data_abertura_oportunidade:a.exibir_data_abertura_oportunidade}});$.select_bp.set(o.cbo_funil_vendas,t),null!=e&&(o.cbo_funil_vendas.val(e),o.funil_vendas_id=e,o.modo_aprovacao_supervisor(o.funil_vendas_id))})},this.modo_aprovacao_supervisor=function(a){WS.get("oportunidade_orcamento/listar/",{situacao:ORCAMENTO_FILTROS.AGUARDANDO_APROVACAO,supervisor:!0,return_count:!0},function(a){a>0?(o.lb_orcamentos_pendentes.removeClass("hidden"),o.lb_orcamentos_pendentes.find("span.count_orcamentos").text(a)):o.lb_orcamentos_pendentes.addClass("hidden")})},this.get_parametros=function(a){var e=new Object;if(e.funil_vendas_id=o.cbo_funil_vendas.val(),e.listar_oportunidades=a,e.representantes=o.filtros.representante?o.filtros.representante.join():"",e.situacao_orcamento=o.filtros.situacao_orcamento?o.filtros.situacao_orcamento.join():"",e.tipo_periodo=o.filtros.tipo_periodo,e.dt_ini=o.filtros.dt_ini,e.dt_fim=o.filtros.dt_fim,e.entidade_id=o.filtros.entidade,e.entidade_tipo=o.filtros.entidade_tipo,e.observacao=o.observacao,void 0!==o.condicao_extra&&null!==o.condicao_extra){var t=null;if("string"==typeof o.condicao_extra.sql_condicao?t=o.condicao_extra.sql_condicao.match(/(\[.+\])/g):o.condicao_extra.sql_condicao instanceof Array&&(t=o.condicao_extra.sql_condicao.join(" ").match(/(\[.+\])/g)),void 0!==o.condicao_extra.sql_condicao&&null!=t){"string"==typeof o.condicao_extra.sql_condicao?o.condicao_extra.sql_condicao:o.condicao_extra.sql_condicao instanceof Array&&o.condicao_extra.sql_condicao.join(" ")}e.condicao_extra=o.condicao_extra}else e.condicao_extra=null;return e.tipo_responsavel=o.filtros.tipo_responsavel,e.situacao=o.filtros.situacao,e},this.parametros_filtros_usuario=function(a,e){"undefined"!=typeof Storage&&("G"!=localStorage.getItem("bp_oportunidade_modo_visualizacao")&&"T"!=localStorage.getItem("bp_oportunidade_modo_visualizacao")||localStorage.removeItem("bp_oportunidade_modo_visualizacao"),localStorage.getItem("bp_oportunidade_modo_visualizacao")&&(o.tipo_visualizacao=localStorage.getItem("bp_oportunidade_modo_visualizacao"))),WS.get("filtro_usuario/get_filtros_parametros/",{codigo_tela:TELAS.LISTAGEM_OPORTUNIDADE.codigo},function(t){var i=[],n=0;if(t&&t.length>0){var r='<div class="row">';$(t).each(function(a,e){var t=e.condicao_consulta.split(/ AND | OR /g);if(0==t[t.length-1].trim().length&&t.splice(t.length-1,1),null!=e.condicao_consulta.match(/\[\[parametro\]\]/g))for(var s=0;s<t.length;s++){var d=t[0].split("}")[0].split("{")[1]||(null!=t[a].match(/fn_situacao_oportunidade/g)?"estagnado.dias":null),l=o.coletar_alias(d);if(null!=t[s].match(/\[\[parametro\]\]/g)){(p=new PARAMETRO_CLASS).id=md5(new Date+d+Math.round(10*Math.random())+a),p.alias_campo=l.alias_campo,p.tipo_campo=l.tipo_campo,p.ipt_tipo=l.tipo_input,p.nome_campo=d,p.sql_original=t[s];var c=p.gerar_elemento().outerHTML;r+=c;var _={campo_id:d,operador:p.get_elemento_operador(),element_id:p.id,campo_tipo:p.get_elemento_tipo(),tipo_entrada:p.ipt_tipo,parametro_id:n};i.push(_),n++}}else{d=t[0].split("}")[0].split("{")[1]||(null!=t[a].match(/fn_situacao_oportunidade/g)?"estagnado.dias":null),l=o.coletar_alias(d);for(var u=0;u<t.length;u++){var p;(p=new PARAMETRO_CLASS).id=null,p.alias_campo=l.alias_campo,p.tipo_campo=l.tipo_campo,p.ipt_tipo=PARAMETRO_PERSONALIZADO_IPT.NOINPUT,p.nome_campo=d,p.sql_original=t[u];_={campo_id:d,operador:p.get_elemento_operador(),element_id:p.id,campo_tipo:p.get_elemento_tipo(),tipo_entrada:p.ipt_tipo};o.parametros_filtros.push(_),n++}}}),i.length>0?alert_modal("Informe o parâmetro",r,"Ok",function(e,t){$(i).each(function(e,t){var i=$("#"+t.element_id),n=null;if(""!==i.val()&&null!==i.val()&&i.val().trim().length>0){switch(t.operador){case"LIKE":n="'%"+i.val()+"%'";break;case"=":case">=":case"<=":case">":case"<":case"!=":case"<>":n="'"+i.val()+"'";break;case"NOT IN":case"IN":n="('"+i.val()+"')"}t.campo_tipo!=PARAMETRO_PERSONALIZADO_TIPO.FLOAT&&t.campo_tipo!=PARAMETRO_PERSONALIZADO_TIPO.INT||""!=n&&null!=n.match(/[\,]/g)&&(n=n.replace(/[\,]/g,"."));var r={campo_id:t.campo_id,valor:n,valor_original:i.val(),campo_tipo:t.campo_tipo,original:t.original,operador:t.operador};App.temp.oportunidade.filtros[t.campo_id+"_"+e]=$("#"+t.element_id).val(),o.parametros_filtros.push(r)}void 0!==a&&a()})},!0,null,function(a){for(var e=$(a).find("[campo_id]").length,t=["STATUS"],n=["nome"],r=0;r<$(a).find("select").length;r++){var s=$(a).find("select").eq(r);"status_oportunidade.nome"==$(a).find("select").eq(r).attr("campo_id")?s.SelectMultiColumn({route:"status_oportunidade/listar/",params:null,arr_cols:t,arr_campos:n,campo_value:"nome"}):s.SelectMultiColumn()}for(var d=0;d<e;d++)void 0!==App.temp.oportunidade.filtros&&void 0!==App.temp.oportunidade.filtros[$(a).find("[campo_id]").eq(d).attr("campo_id")+"_"+d]&&App.temp.oportunidade.filtros[$(a).find("[campo_id]").eq(d).attr("campo_id")+"_"+d].length>0?"status_oportunidade.nome"==$(a).find("[campo_id]").eq(d).attr("campo_id")?(s.SelectMultiColumn("val",App.temp.oportunidade.filtros[$(a).find("[campo_id]").eq(d).attr("campo_id")+"_"+d]),s.SelectMultiColumn("refresh")):$(a).find("[campo_id]").eq(d).val(App.temp.oportunidade.filtros[$(a).find("[campo_id]").eq(d).attr("campo_id")+"_"+d]):App.temp.oportunidade.filtros[$(a).find("[campo_id]").eq(d).attr("campo_id")+"_"+d]="";for(d=0;d<i.length;d++)i[d].tipo_entrada==PARAMETRO_PERSONALIZADO_IPT.DATE?set_datepicker($(a).find("#"+i[d].element_id)):i[d].tipo_entrada==PARAMETRO_PERSONALIZADO_IPT.INPUT&&(i[d].campo_tipo!=PARAMETRO_PERSONALIZADO_TIPO.INT&&i[d].campo_tipo!=PARAMETRO_PERSONALIZADO_TIPO.FLOAT||$(a).find("#"+i[d].element_id).keyup(function(a){var o=$(this).val();o=o.replace(/[^0-9]/g,""),46==a.which?$(this).val($(this).val().replace(/[\.]/g,",")):$(this).val($(this).val().replace(/([^0-9\.\,])/g,""))}).keypress(function(a){}).blur(function(a){$(this).val($(this).val().replace(/[\.]/g,","))}));o.parametros_filtros=[]},function(){void 0!==a&&a()}):0==i.length&&(void 0!==a&&a(),e&&alert_fail("Nenhum parâmetro precisa ser informado. Verifique as configurações de filtros do funíl."))}else void 0!==a&&a(),e&&alert_fail("Não existe filtro ativo para o funíl.")})},this.construct=function(){WS.get("filtro_usuario/listar/",{filtro_usuario_id:App.sessao.dados.usuario_id,codigo_tela:TELAS.LISTAGEM_OPORTUNIDADE.codigo,verificar:!0},function(a){var e=[],t=[],i=[],n=[],r="",s="",d=0,l=a;if(o.filtro_usuario_carregado=!0,l.length>0){if(void 0===o.parametros_filtros[d]){for(var c=0;c<a.length;c++)if(null==a[c].condicao_consulta.match(/\[\[(parametro)\]\]/g)){null!=a[c].condicao_consulta.match(/(cliente_regiao_vendas)|(regiao_vendas)/g)&&(e.push("regiao_vendas"),e.push("cliente_regiao_venda"));var _=a[c].condicao_consulta.match(/(\{.+\})/g);if(null!=_){(function(){for(var a=0;a<_.length;a++){if(null!=_[a].match(/(regiao_vendas)|(cliente_regiao_vendas)/g))return void _.splice(a,1);(function(a,o){var i=[];o.findIndex(function(o,e){return a===o.toString().replace(/({)|(})/g,"")&&i.push(e),0});if(i.length>1)for(var n=1;n<i.length;n++)_.splice(n,1);(function(){for(var a=0;a<_.length;a++)_[a]=_[a].replace(/({)|(})/g,"")})(),function(){for(var a=0;a<_.length;a++)t.push(_[a])}(),function(){for(var a=[],o=0;o<_.length;o++){var t=null!=_[o].match(/(.)/g)?_[o].split(".")[0]:"",i=!1,n=a.findIndex(function(a,o){return t===a?(i=!0,a):0});i&&0!=n.length||a.push(t)}for(o=0;o<a.length;o++)e.push(a[o])}()})(_[a].replace(/({)|(})/g,""),_)}})();s+=" AND "+a[c].condicao_consulta.replace(/({)|(})|(\[)|(\])/g,"")}}i={tabelas:e,sql_condicao:s};return o.condicao_extra=i.sql_condicao.length>0?i:null,void o.listar_etapas()}for(var u=0;u<l.length;u++){var p=0;if(null!=l[u].condicao_consulta.match(/\[\[(parametro)\]\]/g)){p=l[u].condicao_consulta.match(/\[\[(parametro)\]\]/g).length;for(c=0;null!=l[u].condicao_consulta.match(/\[\[(parametro)\]\]/g)&&c<p;c++){l[u].operadores=l[u].condicao_consulta.match(/(LIKE|=|>|<|<>|!=|>=|<=|NOT IN|IN)/g);var f="";f=o.parametros_filtros[d].valor,void 0!==o.parametros_filtros[d].valor_original&&""==o.parametros_filtros[d].valor_original&&(l[u].ignorar=!0),l[u].condicao_consulta=l[u].condicao_consulta.replace(l[u].condicao_consulta.match(/(\[\[parametro\]\])/)[0],f),l[u].condicao_consulta=o.tratamento_da_query(l[u].condicao_consulta),d++}}else{for(var m=[],g=l[u].condicao_consulta.split(" OR "),v=0;v<g.length;v++){var A=(r=g[v].replace(/(( OR ).+)/g,"")).match(/(LIKE|=|>|<|<>|!=|>=|<=|NOT IN|IN)/g),h=(f="",!1);(b=null==r.match(/\[\[parametro\]\]/g)&&null!=r.match(/\[|\]/g))&&(r=r.replace(/(\[)|(\])/g,"")),null==A||b||(">"!=A[0]&&"<"!=A[0]||(h=!0,void 0===(f=r.split("'")[1])&&(l[u].campo_tipo!=ELEMENTO_TIPO.DECIMAL&&l[u].campo_tipo!=ELEMENTO_TIPO.INTEIRO||(f=l[u].valor.replace(",",".")))),"LIKE"==A[0]&&(f="'%"+r.split("'")[1]+"%'"),"="==A[0]&&(f="'"+r.split("'")[1]+"'"),"IN"==A[0]&&(f="('"+r.split("'")[1]+"')"),"NOT IN"==A[0]&&(f="('"+r.split("'")[1]+"')")),r=h?r.split(A[0])[0]+A[0]+f+" OR ":r.split("'")[0]+f+" OR ",m.push(r)}var O=l[u].condicao_consulta.split(" AND ");if(g.join(" OR ")!=O.join()||l[u].condicao_consulta.indexOf(" AND ")>-1)for(v=0;v<O.length;v++){var b;A=(r=O[v].replace(/(( OR ).+)/g,"")).match(/(LIKE|=|>|<|<>|!=|>=|<=|NOT IN|IN)/g),f="",h=!1;(b=null==r.match(/\[\[parametro\]\]/g)&&null!=r.match(/\[|\]/g))&&(r=r.replace(/(\[)|(\])/g,"")),null==A||b||(">"!=A[0]&&"<"!=A[0]||(h=!0,void 0===(f=r.split("'")[1])&&(l[u].campo_tipo!=ELEMENTO_TIPO.DECIMAL&&l[u].campo_tipo!=ELEMENTO_TIPO.INTEIRO||(f=l[u].valor.replace(",",".")))),"LIKE"==A[0]&&(f="'%"+r.split("'")[1]+"%'"),"IN"==A[0]&&(f="('"+r.split("'")[1]+"')"),"NOT IN"==A[0]&&(f="('"+r.split("'")[1]+"')")),r=h?r.split(A[0])[0]+A[0]+f+" AND ":r.split("'")[0]+f+" AND ",m.push(r)}m.length>0&&(m[m.length-1]=m[m.length-1].replace(/( AND | OR )/g,""),l[u].condicao_consulta=m.join(""))}l[u].ultima_query=l[u].condicao_consulta}for(var I=0;I<l.length;I++)if(void 0===l[I].ignorar||!0!==l[I].ignorar){var T=l[I].condicao_consulta.split(" OR ");if(-1==T.join().indexOf(" AND "))for(u=0;u<T.length;u++)r=T[u].replace(/(( AND ).+)/g,""),n.push(r+(u!=T.length-1?" OR ":" AND "));var P=l[I].condicao_consulta.split(" AND ");if(-1!=l[I].condicao_consulta.indexOf(" AND "))for(u=0;u<P.length;u++)r=P[u].replace(/(( OR ).+)/g,""),n.push(r+" AND ")}n.length>=1&&(n[n.length-1]=n[n.length-1].replace(/( OR | AND |)/g,""));for(I=0;I<n.length;I++){var R=n[I].match(/[\{](.+?)[\}]/g);null!=R&&-1==t.join(",").indexOf(R[0].toString().replace(/[\{]|[\}]/g,""))&&t.push(R[0].toString().replace(/[\{]|[\}]/g,""));var x=n[I].match(/(\{.).*?(\.)/g);null!=x&&-1==e.join(",").indexOf(x[0].toString().replace(/[\{]|[.]/g,""))&&e.push(x[0].toString().replace(/[\{]|[.]/g,"")),n[I]=n[I].replace(/[\{]|[\}]/g,"")}for(i={campos:t,tabelas:e,sql_condicao:n},I=0;I<i.sql_condicao.length;I++)if(i.sql_condicao[I].indexOf("(")>-1&&I+1<i.sql_condicao.length&&i.sql_condicao[I+1].indexOf(" AND ")>-1){var N=i.sql_condicao[I+1].indexOf(" AND ")-1;c=i.sql_condicao[I+1].substring(0,N)+") "+i.sql_condicao[I+1].substring(N,i.sql_condicao[I+1].length);i.sql_condicao[I+1]=c}o.condicao_extra=i.sql_condicao.length>0?i:null}else o.condicao_extra=a.condicao_consulta;o.listar_etapas()})},this.listar_etapas=function(){if(o.filtro_usuario_carregado){for(var a=0;a<o.arr_funil_vendas.length;a++){var e=o.arr_funil_vendas[a];e.id==o.funil_vendas_id&&(o.imagem_id=e.imagem_id)}o.definir_background();var t=o.get_parametros(!0);for(var i in t)"clean"!=i&&(o.requisicao_data[i]=t[i]);App.set_parametro_usuario("oportunidade_filtros",o.filtros),o.dataGrid&&o.dataGrid.beginCustomLoading(),WS.get("oportunidade/listar/",o.requisicao_data,function(a){o.observacao_oportunidade_perdida=a.observacao_oportunidade_perdida,o.observacao=a.observacao,o.motivo_perda_negocio=a.motivo_perda_negocio,o.arr_etapas=a,o.arr_oportunidades_selecionadas=[];var e=null,t=null;(o.dx_kanban.find(".dx-card").map(function(a,o){e=$(o).css("background-color"),t=e.replace(".4","1"),$(o).css("background-color",t)}),o.dx_kanban.find(".dx-card").css("border","1px solid rgb(211,211,211)"),o.div_info_qtd_opt_selec.addClass("hidden"),a)&&(!0===a.map(function(a){return verifica_favorito("funis_vendas",a.funil_vendas_id)})[0]?o.alterna_botao_favorito("desfavoritar"):o.alterna_botao_favorito("favoritar"),a.length>0?o.btn_favoritar_funil.show():o.btn_favoritar_funil.hide());o.preencher_kanban(),o.load_datagrid_list(),o.modo_aprovacao_supervisor()})}},this.validar_modo_visualizacao=function(){},this.preencher_kanban=function(){o.exibir_data_abertura_oportunidade=void 0!==o.cbo_funil_vendas.getJSON()&&"S"==o.cbo_funil_vendas.getJSON().exibir_data_abertura_oportunidade,$(function(){!function(){var a=document.createElement("div");a.className="div_kanban",a.style="min-width: 100%;",o.dx_kanban.find(".div_kanban").remove(),o.dx_kanban[0].appendChild(a);var e=o.dx_kanban.find(".div_kanban");o.total_geral_pipe=0;for(var t=0;t<o.arr_etapas.length;t++){var i=o.arr_etapas[t];o.total_geral_pipe+=parseFloat(i.total_oportunidade),r(e,i)}"S"!=o.funil_redimensionar_etapas&&1!=o.funil_redimensionar_etapas||o.calcula_width_etapa();o.div_drag_situacao.find("#A").dxSortable({group:"tasksGroup",moveItemOnDrop:!0,onAdd:function(a){var e=$(a.itemElement).attr("id"),t=$(a.itemElement).attr("situacao");"A"==t||"AT"==t?(alert_info("A oportunidade #"+e+" já se encontra aberta"),o.hide_drag_situacao()):DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja marcar a oportunidade #"+e+" como aberta?",buttons:[{text:"Sim",onClick:function(){alert_info("Por favor, aguarde"),o.atualizar_situacao_oportunidade(e,"A")}},{text:"Não",onClick:function(a){o.hide_drag_situacao(),o.preencher_kanban()}}]}).show(),a.cancel=!0}}),o.div_drag_situacao.find("#G").dxSortable({group:"tasksGroup",moveItemOnDrop:!0,onAdd:function(a){var e=$(a.itemElement).attr("id");"G"==$(a.itemElement).attr("situacao")?(alert_info("A oportunidade #"+e+" já se encontra ganha"),o.hide_drag_situacao()):(alert_info("Por favor, aguarde"),o.checa_eventos_abertos(e,"G")),a.cancel=!0}}),o.div_drag_situacao.find("#P").dxSortable({group:"tasksGroup",moveItemOnDrop:!0,onAdd:function(a){var e=$(a.itemElement).attr("id");alert_info("Por favor, aguarde"),o.checa_eventos_abertos(e,"P"),a.cancel=!0}}),o.lbl_total_geral_pipe.text(o.total_geral_pipe.format_number(2,!0));var n=e.addClass("scrollable-board").dxScrollView({direction:"horizontal",showScrollbar:"always",onScroll:function(a){o.arr_offset["scrollable-board"]=this.scrollOffset()}}).dxScrollView("instance");function r(a,e){o.arr_oportunidades_etapa=[],o.arr_oportunidades_etapa=e.oportunidades;var t=$("<div>").addClass("list").addClass("listDrop").attr("id",e.funil_vendas_etapa_id).attr("oportunidades",JSON.stringify(e.oportunidades)).css("min-width","240px").appendTo(a);t.css("height","calc(100vh - 103px)"),function(a,o){var e=$("<div>");$("<div>").addClass("titulo_etapa").addClass("col-md-10").addClass("dx-theme-text-color").text(o.ordem+". "+o.nome).attr("title",o.nome).css("margin-top","8px").css("font-weight","bold").css("width","100%").css("font-size","14px").css("overflow","hidden").css("text-overflow","ellipsis").css("white-space","nowrap").appendTo(e),e.append($('<div style="border-bottom: 2px outset rgba(0,0,0,0.4); padding-bottom: 10px; width: 100%; margin-top: 5px; font-size: 14px;" class="col-md-10 dx-theme-text-color"><small>'+o.oportunidades.length+'</small> | <small><span class="glyphicon glyphicon-briefcase"></span> '+o.total_oportunidade.format_number(2,!0)+"</small></div>")),e.appendTo(a)}(t,e);var i=o.arr_oportunidades_etapa.filter(function(a){return a.funil_vendas_etapa_id==e.funil_vendas_etapa_id});o.arr_paginacao[e.funil_vendas_etapa_id]={skip:o.arr_paginacao[e.funil_vendas_etapa_id]?o.arr_paginacao[e.funil_vendas_etapa_id].skip:0,take:o.arr_paginacao[e.funil_vendas_etapa_id]?o.arr_paginacao[e.funil_vendas_etapa_id].take:o.take,total:i.length},function(a,e,t){var i=$("<div>").appendTo(a),n=$("<div>").appendTo(i);i.css("height","calc(100vh - 166px)");var r=function(a){for(var i=o.arr_paginacao[e.funil_vendas_etapa_id].take<o.arr_paginacao[e.funil_vendas_etapa_id].total?o.arr_paginacao[e.funil_vendas_etapa_id].take:o.arr_paginacao[e.funil_vendas_etapa_id].total,r=a?0:o.arr_paginacao[e.funil_vendas_etapa_id].skip;r<i;r++){var d=t[r];s(n,d)}};r(!0);var d=i.addClass("dx-scrollable-container").dxScrollView({direction:"vertical",showScrollbar:"always",useNative:!1,width:"100%",onScroll:function(a){var e=a.element.parents(".list").attr("id");o.arr_offset[e]=d.scrollOffset()},onReachBottom:function(a){o.arr_paginacao[e.funil_vendas_etapa_id].skip+=o.take,o.arr_paginacao[e.funil_vendas_etapa_id].take+=o.take,r(!1),o.arr_paginacao[e.funil_vendas_etapa_id].take<o.arr_paginacao[e.funil_vendas_etapa_id].total?a.component.release():a.component.release(!0)}}).dxScrollView("instance");i.find(".dx-scrollable-scroll-content").css("background","rgb(54,54,54)"),n.addClass("sortable-cards").dxSortable({group:"tasksGroup",moveItemOnDrop:!0,data:t,onDragStart:function(a){o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&o.div_drag_situacao.fadeIn(300)},onDragEnd:function(a){o.hide_drag_situacao();var e=$(a.fromComponent._$element).parents(".list").attr("id"),t=$(a.toComponent._$element).parents(".list").attr("id");if(!isNaN(e)&&!isNaN(t)){var i=$(a.itemElement).attr("id"),n=a.fromIndex,r=a.toIndex,s=function(){WS.post({route:"oportunidade/alterar_ordem/",data:{oportunidade_id:i,funil_vendas_id:o.cbo_funil_vendas.val(),funil_vendas_etapa_anterior:e,funil_vendas_etapa_id:t,old_ordem:n,new_ordem:r},func_response:function(a){o.listar_etapas()},func_fail:function(){o.listar_etapas()}})};e==t?s():WS.get("oportunidade/verificar_oportunidade_solicitacao/",{oportunidade_id:i},function(a){a.retorno||"N"!=a.vinculo_obrigatorio?s():alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',"A oportunidade precisa de um processo com a etapa "+a.nome_etapa+" aprovada<br />Esta oportunidade não possui, deseja continuar mesmo assim ?","Sim",function(){s()},!0,"Cancelar",void 0,function(){o.listar_etapas()})})}}});var l=[{text:"Negócio Aberto",icon:"dx-icon-clock"},{text:"Negócio Ganho",icon:"fa fa-thumbs-up"},{text:"Negócio Perdido",icon:"fa fa-thumbs-down"},{text:"Selecionar",icon:"dx-icon-check"},{text:"Desmarcar",icon:"dx-icon-close"},{text:"Desmarcar todas",icon:"fa fa-ban"},{text:"Mais opções",items:[{text:"Clonar Oportunidade(s)",icon:"dx-icon-copy"},{text:"Transferir Oportunidade(s)",icon:"fa fa-share-square"},{text:"Excluir",icon:"dx-icon-trash"}]}],c=o.context_menu.dxContextMenu({dataSource:l,width:function(){return window.innerWidth/7},target:".dx-card",onPositioning:function(a){o.context_opt_selecionada_div=$(a.event.currentTarget),o.context_opt_selecionada_id=$(a.event.currentTarget).attr("id"),o.context_opt_selecionada_situacao=$(a.event.currentTarget).attr("situacao");var e=c._dataSource._items[0],t=c._dataSource._items[1],i=c._dataSource._items[2],n=c._dataSource._items[3],r=c._dataSource._items[4],s=c._dataSource._items[5],d=c._dataSource._items[6].items[2];e.visible=!(o.arr_oportunidades_selecionadas.length>0),t.visible=!(o.arr_oportunidades_selecionadas.length>0),i.visible=!(o.arr_oportunidades_selecionadas.length>0),d.visible=!(o.arr_oportunidades_selecionadas.length>0),n.visible=!o.arr_oportunidades_selecionadas.includes(o.context_opt_selecionada_id),r.visible=o.arr_oportunidades_selecionadas.includes(o.context_opt_selecionada_id),s.visible=o.arr_oportunidades_selecionadas.length,c.repaint()},itemTemplate:function(a,o,e){var t=$("<div></div>");return a.icon&&t.append('<span class="'+a.icon+'"></span> '),a.items&&t.append('<span class="dx-icon-spinright"></span> '),"Negócio Aberto"==a.text&&($(t).css("background-color","rgba(211, 211, 211, 0.4)"),$(t).css("padding","10px 3px"),$(t).css("font-weight","bold")),"Negócio Ganho"==a.text&&($(t).css("background-color","rgba(0, 255, 140, 0.4)"),$(t).css("padding","10px 3px"),$(t).css("font-weight","bold")),"Negócio Perdido"==a.text&&($(t).css("background-color","rgba(255, 165, 0, 0.4)"),$(t).css("padding","10px 3px"),$(t).css("font-weight","bold")),t.append(a.text),t},onItemClick:function(a){if(!a.itemData.items)switch(a.itemData.text){case"Negócio Aberto":"A"==o.context_opt_selecionada_situacao||"AT"==o.context_opt_selecionada_situacao?alert_info("A oportunidade #"+o.context_opt_selecionada_id+" já se encontra aberta"):DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja marcar a oportunidade #"+o.context_opt_selecionada_id+" como aberta?",buttons:[{text:"Sim",onClick:function(){alert_info("Por favor, aguarde"),o.atualizar_situacao_oportunidade(o.context_opt_selecionada_id,"A")}},{text:"Não",onClick:function(a){return!1}}]}).show();break;case"Negócio Ganho":"G"==o.context_opt_selecionada_situacao?alert_info("A oportunidade #"+o.context_opt_selecionada_id+" já se encontra ganha"):o.checa_eventos_abertos(o.context_opt_selecionada_id,"G");break;case"Negócio Perdido":"P"==o.context_opt_selecionada_situacao?alert_info("A oportunidade #"+o.context_opt_selecionada_id+" já se encontra perdida"):o.checa_eventos_abertos(o.context_opt_selecionada_id,"P");break;case"Excluir":o.checa_eventos_abertos(o.context_opt_selecionada_id,"E");break;case"Selecionar":var e=(i=o.context_opt_selecionada_div.css("background-color")).replace("rgb","rgba").replace(")",",.4)");o.context_opt_selecionada_div.css("background-color",e),o.context_opt_selecionada_div.css("border","4px solid rgb(25, 45, 100)"),o.arr_oportunidades_selecionadas.includes(o.context_opt_selecionada_id)||o.arr_oportunidades_selecionadas.push(o.context_opt_selecionada_id),o.div_info_qtd_opt_selec.removeClass("hidden"),o.div_info_qtd_opt_selec.find("span.qtd_oportunidades_selec").text(o.arr_oportunidades_selecionadas.length);break;case"Desmarcar":e=(i=o.context_opt_selecionada_div.css("background-color")).replace(".4","1");o.context_opt_selecionada_div.css("background-color",e),o.context_opt_selecionada_div.css("border","1px solid rgb(211,211,211)"),o.arr_oportunidades_selecionadas=o.arr_oportunidades_selecionadas.filter(function(a,e,t){return a!=o.context_opt_selecionada_id}),0==o.arr_oportunidades_selecionadas.length&&o.div_info_qtd_opt_selec.addClass("hidden"),o.div_info_qtd_opt_selec.find("span.qtd_oportunidades_selec").text(o.arr_oportunidades_selecionadas.length);break;case"Clonar Oportunidade(s)":if(0==o.arr_oportunidades_selecionadas.length||1==o.arr_oportunidades_selecionadas.length){if(1==o.arr_oportunidades_selecionadas.length)var t=o.arr_oportunidades_selecionadas[0];else t=o.context_opt_selecionada_id;DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja clonar a oportunidade #"+t+"? ",buttons:[{text:"Sim",onClick:function(){alert_info("Clonando Oportunidade. Por favor, aguarde"),WS.post("oportunidade/clonar_oportunidade",{oportunidade_id:t},function(a){o.listar_etapas(),alert_saved("Oportunidade clonada com sucesso!")})}},{text:"Não",onClick:function(a){return!1}}]}).show()}else DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja clonar "+o.arr_oportunidades_selecionadas.length+" oportunidades? ",buttons:[{text:"Sim",onClick:function(){alert_info("Clonando Oportunidades. Por favor, aguarde"),WS.post("oportunidade/clonar_oportunidade",{oportunidade_id:JSON.stringify(o.arr_oportunidades_selecionadas)},function(a){o.listar_etapas(),alert_saved("Oportunidades clonadas com sucesso!")})}},{text:"Não",onClick:function(a){return!1}}]}).show();break;case"Transferir Oportunidade(s)":0==o.arr_oportunidades_selecionadas.length&&o.arr_oportunidades_selecionadas.push(o.context_opt_selecionada_id),View.load("oportunidade/transferencia_representantes",function(a,e){e.onsave=o.listar_etapas,e.show(o.arr_oportunidades_selecionadas)});break;case"Desmarcar todas":o.arr_oportunidades_selecionadas=[];var i=null;e=null;o.dx_kanban.find(".dx-card").map(function(a,o){i=$(o).css("background-color"),e=i.replace(".4","1"),$(o).css("background-color",e)}),o.dx_kanban.find(".dx-card").css("border","1px solid rgb(211,211,211)"),o.div_info_qtd_opt_selec.addClass("hidden")}}}).dxContextMenu("instance");n.css("min-height","calc(100vh - 166px)"),setTimeout(function(){var a=o.arr_offset[e.id];a&&d.scrollTo(a)})}(t,e,i)}function s(a,e){var t=$("<div>").addClass("card").addClass("dx-card").removeClass("dx-theme-background-color").removeClass("dx-theme-text-color").attr("id",e.oportunidade_id).attr("cor-texto",e.cor_status_texto).attr("situacao",e.situacao).css("background-color",e.cor_status).css("color",e.cor_status_texto).css("padding","7px").css("border","1px solid rgb(211,211,211)").appendTo(a);t.parent().find(".card").css("width","initial");var i=!0===o.exibir_data_abertura_oportunidade?e.data_abertura.format_date():e.nome,n="C"==e.entidade_tipo?"label-info":"label-primary",r="C"==e.entidade_tipo?"C":"O",s=null,d=null,l=null;switch(e.situacao){case"G":d="Ganho",l="G",s="label-success";break;case"P":d="Perdido",l="P",s="label-warning";break;case"A":d="Aberto",l="A",s="label-default";break;case"AT":d="Atrasado",l="At",s="label-danger";break;case"E":d="Estagnado",l="E",s="label-info"}if(o.cards_compactos){t.append($('<div class="card-subject" style="font-size: 13px; padding-bottom: 5px;"> <strong>#'+e.oportunidade_id+"</strong> - "+i+' | <span style="font-size: 14px;"><small><span class="label '+s+'" data-toggle="tooltip" title="'+d+'">'+l+"</span></small></span></div>")),t.append($('<div style="font-size: 12px; display: inline-block; margin-right: 10px;"> <span class="label '+n+'">'+r+"</span> "+e.entidade_nome+"</div>"));var c=e.representante_foto,_=WS_URI+"documento/midia/?&tamanho=20&documento_id="+c+"&token_midia="+App.sessao.token_midia,u=e.representante_nome;c?t.append($('<span style="margin-top: 3px;"><img style="height: 20px; width: 20px; border-radius: 25em;" data-toggle="tooltip" title="'+u+'" class="imagem_responsavel" src="'+_+'"></span>')):t.append('<span style="width: 20px; height: 20px; background-color: #dfe1e6; border-radius: 25em; color: #172b4d; line-height: 20px; text-align: center; display: inline-block; margin-top: 3px; vertical-align: middle;"><span style="font-weight: 600;" data-toggle="tooltip" title="'+u+'">'+obter_iniciais(u)+"</span></span>")}else{t.append($('<div class="card-subject" style="font-size: 14px;"> <strong>#'+e.oportunidade_id+"</strong> - "+i+" </div>")),!0===o.exibir_data_abertura_oportunidade&&t.append($('<div style="font-size: 14px; margin-bottom: 8px;">'+e.nome+"</div>"));let a=e.entidade_nome;if("S"!=o.funil_exibir_razao_social_entidade&&1!=o.funil_exibir_razao_social_entidade||(a=e.entidade_razao_social),t.append($('<div style="font-size: 14px;"> <span class="label '+n+'">'+r+"</span> "+a+" </div>")),t.append($('<div style="margin-top: 5px; font-size: 14px;"> <span class="label label-warning">R</span> '+e.representante_nome+" </div>")),void 0!==e.situacao_ultimo_orcamento&&null!=e.situacao_ultimo_orcamento){var p=null,f=null;switch(e.situacao_ultimo_orcamento){case"0":f="Orçamento Aguardando Aprovação",p="label-warning";break;case"1":f="Orçamento Aprovado",p="label-success";break;case"2":f="Orçamento Reprovado",p="label-danger";break;case"4":f="Orçamento Aprovado / Aguardando E-Mail",p="label-default";break;default:f="Orçamento Em Análise",p="label-info"}t.append($('<div style="margin-top: 5px; font-size: 15px;"><small><span class="label '+p+'">'+f+"</span></small></div>"))}t.append($('<div style="width: 100%; margin-top: 8px;"><span style="float: left; font-size: 15px;"><small>R$ '+e.valor_negocio.format_number(2,!0)+'</small></span><span style="float: right; font-size: 15px;"><small><span class="label '+s+'">'+d+"</span></small></span></div>"))}t.unbind("click").click(function(){View.load("oportunidade/detalhes",function(a,t){t.onclose=function(){o.listar_etapas()},t.show(e.oportunidade_id,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS)})}setTimeout(function(){var a=o.arr_offset["scrollable-board"];a&&n.scrollTo(a)}),e.addClass("sortable-lists").dxSortable({filter:".listDrop",itemOrientation:"horizontal",handle:".titulo_etapa",moveItemOnDrop:!0,onDragStart:function(a){a.cancel=!0}})}()})},this.coletar_alias=function(a){var o="",e="",t="";switch(a){case"oportunidade.id":o="Oportunidade - ID",e=PARAMETRO_PERSONALIZADO_TIPO.INT,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade.nome":o="Oportunidade - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade.Tipo":o="Oportunidade - Tipo",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade.valor_negocio":o="Oportunidade - Valor Negocio",e=PARAMETRO_PERSONALIZADO_TIPO.INT,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"municipio.municipio":o="Municipio - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"cliente.nome":o="Cliente - Nome Fantasia",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"cliente.razao_social":o="Cliente - Razão Social",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"prospect.nome":o="Organização - Nome Fantasia",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"prospect.razao_social":o="Organização - Razão Social",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"contato.nome":o="Contato - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"motivo_perda_negocio.nome":o="Motivo da Perda - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"motivo_perda_negocio.observacao_obrigatoria":o="Motivo da Perda  - Observação",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"usuario.nome":o="Representante - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"status_oportunidade.nome":o="Oportunidade - Status",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.SMC;break;case"regiao_vendas.descricao":o="Região de Vendas - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"item.descricao":o="Oportunidade - Item",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"item.codigo":o="Item - Código",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade.data_fechamento":o="Oportunidade - Data de Fechamento",e=PARAMETRO_PERSONALIZADO_TIPO.DATE,t=PARAMETRO_PERSONALIZADO_IPT.DATE;break;case"estagnado.dias":o="Estagnado - Dias",e=PARAMETRO_PERSONALIZADO_TIPO.INT,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"usuario_representante_2.nome":o="Representante 2 - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade_origem.nome":o="Origem - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"representante.tipo_representante":o="Representante 1 - Tipo",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade_observacoes.observacao":o="Oportunidade - Observação",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade_orcamento.id":o="Orçamento - ID",e=PARAMETRO_PERSONALIZADO_TIPO.INT,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade.integracao_nextone":o="Oportunidade - Data de Integração",e=PARAMETRO_PERSONALIZADO_TIPO.DATE,t=PARAMETRO_PERSONALIZADO_IPT.DATE;break;default:if(null!==a&&""!==a){var i=a.split(".");"filtro_formulario_oportunidade"==i[0]?(o=i[1],e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT):(o="",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT)}else o="",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT}return{alias_campo:o,tipo_campo:e,tipo_input:t}},this.checa_eventos_abertos=function(a,e){WS.post("oportunidade/eventos_abertos",{oportunidade_id:a},function(t){var i=function(){"G"==e?View.load("oportunidade/fechamento",function(e,t){t.onclose=function(){o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&(o.preencher_kanban(),o.hide_drag_situacao())},t.onsave=function(){o.listar_etapas(),o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&o.hide_drag_situacao()},t.show(a,o.cbo_funil_vendas.getJSON().escolha_empresa_ganho_perda)}):"P"==e?View.load("oportunidade/motivo_perda",function(e,t){t.onclose=function(){o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&(o.preencher_kanban(),o.hide_drag_situacao())},t.onsave=function(){o.listar_etapas(),o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&o.hide_drag_situacao()},t.show(a,o.cbo_funil_vendas.getJSON().escolha_empresa_ganho_perda)}):"E"==e&&DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja mesmo excluir a oportunidade #"+a+"?",buttons:[{text:"Sim",onClick:function(){alert_info("Por favor, aguarde"),WS.post({route:"oportunidade/excluir",type:"POST",data:{oportunidade_id:a},func_response:function(a){o.hide_drag_situacao(),o.listar_etapas(),alert_saved("Oportunidade excluída com sucesso!")},func_fail:function(a){o.listar_etapas()}})}},{text:"Não",onClick:function(a){return o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&(o.preencher_kanban(),o.hide_drag_situacao()),!1}}]}).show()};t.chamados.length>0||t.agenda.length>0?DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Existem eventos abertos na oportunidade #"+a+", deseja finalizá-los?",buttons:[{text:"Sim",onClick:function(){View.load("oportunidade/eventos_abertos",function(a,e){e.onclose=o.listar_etapas,e.show(t)},View.ABA.NAO)}},{text:"Não",onClick:function(a){i()}}]}).show():i()})},this.atualizar_situacao_oportunidade=function(a,e){WS.post("oportunidade/atualizar_situacao",{oportunidade_id:a,situacao:e},function(a){alert_saved("Situação alterada com sucesso!"),o.listar_etapas(),o.hide_drag_situacao()})},this.load_datagrid_list=function(){var a=detectmob()?"select":"dragAndDrop";if(o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.GRID){o.arr_oportunidades_selecionadas=[];var e=null,t=null;o.dx_kanban.find(".dx-card").map(function(a,o){e=$(o).css("background-color"),t=e.replace(".4","1"),$(o).css("background-color",t)}),o.dx_kanban.find(".dx-card").css("border","1px solid rgb(211,211,211)"),o.div_info_qtd_opt_selec.addClass("hidden"),o.btn_mudar_visualizacao.find("span").removeClass().addClass("fab fa-trello"),o.dx_kanban.hide(),o.btn_compactar_cards.hide(),o.dx_grid.show()}else o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&(o.dx_kanban.show(),o.btn_compactar_cards.show(),o.dx_grid.hide(),o.btn_mudar_visualizacao.find("span").removeClass().addClass("fa fa-table"));var i=get_icon_class(),n=[];o.arr_etapas.forEach(function(a,o){a.oportunidades.forEach(function(a,o){n.push(a)})}),n=n.sort(function(a,o){var e=a.etapa_ordem,t=o.etapa_ordem,i=0;return e>t?i=1:e<t&&(i=-1),i}),o.dataGrid?(o.dataGrid.option("dataSource",n),o.dataGrid.endCustomLoading()):(o.dx_grid.css("height","calc(100vh - 85px)"),o.dataGrid=o.dx_grid.dxDataGrid({dataSource:n,paging:{pageSize:20},pager:{showPageSizeSelector:!0,allowedPageSizes:[20,50,100],showInfo:!0},searchPanel:{visible:!0,highlightCaseSensitive:!0},groupPanel:{visible:!0},filterPanel:{visible:!0},filterRow:{visible:!0,applyFilter:"auto"},headerFilter:{visible:!0},grouping:{autoExpandAll:!0},selection:{mode:"multiple"},columnChooser:{enabled:!0,allowSearch:!0,mode:a},searchPanel:{visible:!detectmob(),width:200,placeholder:"Pesquisa geral"},allowColumnReordering:!0,rowAlternationEnabled:!1,allowColumnResizing:!0,showBorders:!0,stateStoring:{enabled:!0,type:"custom",customLoad:function(){return App.get_parametro_usuario("oportunidade_grid")},customSave:function(a){App.set_parametro_usuario("oportunidade_grid",a)}},export:{enabled:!0,fileName:"Listagem de Oportunidades "+agora(),allowExportSelectedData:!0},columns:[{caption:"Etapa do Funil",dataType:"string",groupIndex:0,fixed:!0,calculateCellValue:function(a){var e=o.arr_etapas.filter(function(o,e){return o.funil_vendas_etapa_id==a.funil_vendas_etapa_id})[0];return a.etapa_ordem+". "+a.etapa_nome+" | "+e.quantidade_oportunidade+" oportunidade(s), R$"+e.total_oportunidade.format_number(2,!0)}},{dataField:"oportunidade_id",caption:"#",dataType:"number",alignment:"right",width:40},{dataField:"nome",caption:"Nome",dataType:"string"},{dataField:"data_abertura",caption:"Data de inclusão",dataType:"datetime"},{caption:"Tipo de Entidade",dataType:"string",calculateCellValue:function(a){var o="";switch(a.entidade_tipo){case"C":o="Cliente";break;case"O":o="Organização"}return o}},{dataField:"entidade_nome",caption:"Entidade Nome Fantasia",dataType:"string"},{dataField:"entidade_razao_social",caption:"Entidade Razão Social",dataType:"string"},{dataField:"entidade_municipio",caption:"Município",width:200},{dataField:"entidade_uf_sigla",caption:"UF",width:50},{dataField:"representante_nome",caption:"Representante",dataType:"string"},{dataField:"status",caption:"Status",dataType:"string"},{dataField:"oportunidade_origem_nome",caption:"Origem Oportunidade",dataType:"string"},{caption:"Valor do Negócio R$",dataType:"string",calculateCellValue:function(a){return"R$ "+a.valor_negocio.format_number(2,!0)}},{dataField:"situacao",caption:"Situação da Oportunidade",dataType:"string",calculateCellValue:function(a){var o="";switch(a.situacao){case"G":o="Ganho";break;case"P":o="Perdido";break;case"A":o="Aberto";break;case"AT":o="Atrasado";break;case"E":o="Estagnado"}return o}},{dataField:"situacao_ultimo_orcamento",caption:"Situação do Orçamento",dataType:"string",calculateCellValue:function(a){var o="";if(a.situacao_ultimo_orcamento)switch(a.situacao_ultimo_orcamento){case"0":o="Orçamento Aguardando Aprovação";break;case"1":o="Orçamento Aprovado";break;case"2":o="Orçamento Reprovado";break;case"4":o="Orçamento Aprovado / Aguardando E-Mail";break;default:o="Orçamento Em Análise"}return o}},{type:"buttons",fixed:!0,fixedPosition:"right",buttons:[{hint:"Editar Oportunidade",icon:"fa fa-pencil-alt",cssClass:i,onClick:function(a){View.load("oportunidade/detalhes",function(e,t){t.onclose=function(){o.listar_etapas()},t.show(a.row.data.oportunidade_id,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS)}},{hint:"Clonar Oportunidade",icon:"copy",cssClass:i,onClick:function(a){DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja clonar a oportunidade #"+a.row.data.oportunidade_id+"?",buttons:[{text:"Sim",onClick:function(){alert_info("Clonando Oportunidade. Por favor, aguarde"),WS.post("oportunidade/clonar_oportunidade",{oportunidade_id:a.row.data.oportunidade_id},function(a){o.listar_etapas(),alert_saved("Oportunidade clonada com sucesso!")})}},{text:"Não",onClick:function(a){return!1}}]}).show()}},{hint:"Transferir Oportunidade",icon:"fa fa-share-square",cssClass:i,onClick:function(a){View.load("oportunidade/transferencia_representantes",function(e,t){t.onsave=o.listar_etapas,t.show([a.row.data.oportunidade_id])})}},{hint:"Marcar como Negócio Aberto",icon:"clock",cssClass:i,onClick:function(a){"A"==a.row.data.situacao||"AT"==a.row.data.situacao?alert_info("A oportunidade #"+a.row.data.oportunidade_id+" já se encontra aberta"):DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja marcar a oportunidade #"+a.row.data.oportunidade_id+" como aberta?",buttons:[{text:"Sim",onClick:function(){alert_info("Por favor, aguarde"),o.atualizar_situacao_oportunidade(a.row.data.oportunidade_id,"A")}},{text:"Não",onClick:function(a){return!1}}]}).show()}},{hint:"Marcar como Negócio Ganho",icon:"fa fa-thumbs-up",cssClass:i,onClick:function(a){"G"==a.row.data.situacao?alert_info("A oportunidade #"+a.row.data.oportunidade_id+" já se encontra ganha"):o.checa_eventos_abertos(a.row.data.oportunidade_id,"G")}},{hint:"Marcar como Negócio Perdido",icon:"fa fa-thumbs-down",cssClass:i,onClick:function(a){"P"==a.row.data.situacao?alert_info("A oportunidade #"+a.row.data.oportunidade_id+" já se encontra perdida"):o.checa_eventos_abertos(a.row.data.oportunidade_id,"P")}},{hint:"Excluir Oportunidade",icon:"trash",cssClass:i,onClick:function(a){o.checa_eventos_abertos(a.row.data.oportunidade_id,"E")}}]}],onToolbarPreparing:function(a){var e=[{widget:"dxButton",options:{icon:"copy",hint:"Clonar Oportunidades selecionadas",text:"Clonar Oportunidades selecionadas",onClick:function(a){var e=o.dataGrid.getSelectedRowsData().map(function(a){return a.oportunidade_id});DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja clonar a(s) oportunidade(s) "+e.join(", ")+"?",buttons:[{text:"Sim",onClick:function(){alert_info("Clonandos Oportunidades. Por favor, aguarde"),WS.post("oportunidade/clonar_oportunidade",{oportunidade_id:JSON.stringify(e)},function(a){o.listar_etapas(),alert_saved("Oportunidades clonadas com sucesso!")})}},{text:"Não",onClick:function(a){return!1}}]}).show()}},showText:"inMenu",location:"after",name:"BtnClonarEmMassa",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-share-square",hint:"Transferir Oportunidades selecionadas",text:"Transferir Oportunidades selecionadas",onClick:function(){var a=o.dataGrid.getSelectedRowsData().map(function(a){return a.oportunidade_id});View.load("oportunidade/transferencia_representantes",function(e,t){t.onsave=o.listar_etapas,t.show(a)})}},showText:"inMenu",location:"after",name:"BtnTransferirEmMassa",locateInMenu:"auto"}];a.toolbarOptions.items=add_botao_dx_toolbar(e,a.toolbarOptions.items)},onRowPrepared:function(a){"data"===a.rowType&&(setTimeout(function(){var e=o.dataGrid.getCellElement(a.rowIndex,"situacao");if(e){var t=e.text();if(t.trim().length){var i="";switch(t){case"Ganho":i="label-success";break;case"Perdido":i="label-warning";break;case"Aberto":i="label-default";break;case"Atrasado":i="label-danger";break;case"Estagnado":i="label-info"}e.html('<span class=" label '+i+'">'+t+"</span>")}}}),setTimeout(function(){var e=o.dataGrid.getCellElement(a.rowIndex,"situacao_ultimo_orcamento");if(e){var t=e.text();if(t.trim().length){var i="";switch(t){case"Orçamento Aguardando Aprovação":i="label-warning";break;case"Orçamento Aprovado":i="label-success";break;case"Orçamento Reprovado":i="label-danger";break;case"Orçamento Aprovado / Aguardando E-Mail":i="label-default";break;case"Orçamento Em Análise":i="label-info"}e.html('<span class=" label '+i+'">'+t+"</span>")}}}))},onRowClick:function(a){onDoubleClick(a,function(){View.load("oportunidade/detalhes",function(e,t){t.onclose=function(){o.listar_etapas()},t.show(a.data.oportunidade_id,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS)})},onContextMenuPreparing:function(a){"header"==a.target&&Array.isArray(a.items)&&a.items.push({text:"Restaurar estado das colunas",visible:!0,beginGroup:!0,onItemClick:function(a){DevExpress.ui.dialog.confirm("Os filtros, ordenações, agrupamentos, posição, tamanho, e visibilidade das colunas desta listagem serão restauradas ao estado padrão. <b>Deseja continuar?</b>","Restaurar estado das colunas").done(function(a){a&&(o.clearState=!0,o.listar_etapas())})}})},onContentReady:function(a){o.clearState&&(o.dataGrid.state({}),o.clearState=!1)}}).dxDataGrid("instance"),o.dataGrid.endCustomLoading())},this.hide_drag_situacao=function(){o.div_drag_situacao&&o.div_drag_situacao.fadeOut(300)},this.definir_background=function(){if(o.imagem_id){var a=cripto(WS.token),e=WS_URI+"documento/download/?documento_id="+o.imagem_id+"&token_publico="+a+"&tipo=S&acao=abrir";o.dialog.css({background:"url("+e+")","background-position":"50%","background-size":"cover"})}else o.dialog.css({background:"none"})},this.calcula_width_etapa=function(){var a=o.dx_kanban.width()-10*o.arr_etapas.length;a=(a/=o.arr_etapas.length).toFixed(2),o.dx_kanban.find(".listDrop:not(#A, #G, #P)").css("width",a).css("margin",5)},this.tratamento_da_query=function(a){return a.replace(/(LIKE ').+?(')/g,function(a,o){var e=0;return a.indexOf("%")>-1?a:a.replace(/[']/g,function(a,o,t){return 0==e&&"'"==a?(e++,"'%"):"%'"})})},this.alterna_botao_favorito=function(a){"favoritar"===a?(o.btn_favoritar_funil.attr("acao","favoritar"),o.btn_favoritar_funil.find("span.icone").removeClass("fas").addClass("far"),o.btn_favoritar_funil.find("span.texto").text("Favoritar")):(o.btn_favoritar_funil.attr("acao","desfavoritar"),o.btn_favoritar_funil.find("span.icone").removeClass("far").addClass("fas"),o.btn_favoritar_funil.find("span.texto").text("Desfavoritar"))},$(window).on("resize",function(){"S"!=o.funil_redimensionar_etapas&&1!=o.funil_redimensionar_etapas||o.calcula_width_etapa()}),this.unload=function(){View.unload(this.html_id)},this.btn_novo.unbind("click"),this.btn_novo.click(function(){if("N"==App.sessao.dados.representante&&1!=App.sessao.dados.admin&&"S"!=App.sessao.dados.admin&&"S"!=App.sessao.dados.supervisor_atendimento_relacionamento)return(a=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Por favor, relacionar seu usuário com representante")),void alert_modal("Validação",a);var a,e=o.cbo_funil_vendas.val();if(null==e||""==e)return(a=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Informe o Funil de Vendas")),void alert_modal("Validação",a);View.load("oportunidade/detalhes",function(a,t){t.onclose=function(){o.listar_etapas()},t.show(null,FORMULARIO.NOVO,e)},View.ABA.MULTIPLAS)}),this.btn_opcoes_filtro.unbind("click"),this.btn_opcoes_filtro.click(function(){View.load("oportunidade/filtro",function(a,e){e.show(o)})}),this.btn_limpar_filtro.unbind("click").click(function(){o.filtros=spread(o.filtros,{cliente_id:"",cliente_nome:"",tipo_periodo:7,tipo_responsavel:2,situacao:3,representante:null,situacao_orcamento:null,entidade:null,entidade_tipo:null,dt_ini:"2000-01-01",dt_fim:"2050-12-31",situacao_orcamento:null}),App.set_parametro_usuario("oportunidade_filtros",o.filtros),o.listar_etapas()}),this.btn_configurar_filtros.unbind("click").click(function(a){o.parametros_filtros_usuario(o.construct,!0)}),this.btn_excel.unbind("click"),this.btn_excel.click(function(){o.dataGrid?o.dataGrid.exportToExcel():alert_fail("Falha ao exportar para Excel. Por favor, tente novamente pela listagem de tabela")}),this.btn_mudar_visualizacao.unbind("click"),this.btn_mudar_visualizacao.click(function(){o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN?o.tipo_visualizacao=OPORTUNIDADE_TIPO_VISUALIZACAO.GRID:o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.GRID&&(o.tipo_visualizacao=OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN),localStorage.setItem("bp_oportunidade_modo_visualizacao",o.tipo_visualizacao),o.load_datagrid_list(),"S"!=o.funil_redimensionar_etapas&&1!=o.funil_redimensionar_etapas||o.calcula_width_etapa()}),this.btn_compactar_cards.unbind("click"),this.btn_compactar_cards.click(function(){var a=App.get_parametro_usuario("opcoesCardsOportunidade");o.cards_compactos=!o.cards_compactos,a!=o.cards_compactos&&App.set_parametro_usuario("opcoesCardsOportunidade",{cards_compactos:o.cards_compactos}),o.listar_etapas()}),this.btn_refresh.unbind("click"),this.btn_refresh.click(function(){o.listar_etapas()}),this.btn_favoritar_funil.on("click",function(a){favoritar_item("funis_vendas",o.funil_vendas_id,"favoritar"===o.btn_favoritar_funil.attr("acao")),"favoritar"===o.btn_favoritar_funil.attr("acao")?(o.alterna_botao_favorito("desfavoritar"),alert_saved("Favorito adicionado")):(o.alterna_botao_favorito("favoritar"),alert_saved("Favorito removido"))})}});