define([],function(){return function(a){"use strict";var e=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.title="Signatários",this.grid_signatarios=this.dialog.find(".grid_signatarios"),this.grid_observadores=this.dialog.find(".grid_observadores"),this.divCheckWorkflow=this.dialog.find(".divCheckWorkflow"),this.txt_mensagem_signatarios=this.dialog.find(".txt_mensagem_signatarios"),this.comunica_d4sign=!1,this.id_elemento_anexo=null,this.id_linha_tabela="",this.solicitacao_id=null,this.dados_signatarios=[],this.checkWorkFlowInstace=null,this.mensagem_padrao_d4sign=null,this.show=function(a,o,i,t,s,d){e.comunica_d4sign=o,e.id_elemento_anexo=i,e.solicitacao_id=null!=s?s.toString():"",e.mensagem_padrao_d4sign=d||null,e.txt_mensagem_signatarios.val(e.mensagem_padrao_d4sign).trigger("change"),void 0!==t&&null!=t&&(e.id_linha_tabela="_"+t),void 0===App.temp.signatarios&&(App.temp.signatarios={}),void 0===App.temp.observadores&&(App.temp.observadores={}),void 0===App.temp.signatarios[e.solicitacao_id+"_"+e.id_elemento_anexo+e.id_linha_tabela]&&(App.temp.signatarios[e.solicitacao_id+"_"+e.id_elemento_anexo+e.id_linha_tabela]=[]),void 0===App.temp.observadores[e.solicitacao_id+"_"+e.id_elemento_anexo+e.id_linha_tabela]&&(App.temp.observadores[e.solicitacao_id+"_"+e.id_elemento_anexo+e.id_linha_tabela]=[]),e.dados_signatarios=App.temp.signatarios[e.solicitacao_id+"_"+e.id_elemento_anexo+e.id_linha_tabela],e.dados_observadores=App.temp.observadores[e.solicitacao_id+"_"+e.id_elemento_anexo+e.id_linha_tabela],void 0===e.dados_signatarios.d4sign&&(e.dados_signatarios.d4sign=[]),void 0===e.dados_observadores.d4sign&&(e.dados_observadores.d4sign=[]),e.checkWorkFlowInstace=e.divCheckWorkflow.dxSwitch({value:!1}).dxSwitch("instance"),e.grid_signatarios.dxDataGrid({dataSource:e.dados_signatarios.d4sign,showBorders:!0,allowColumnReordering:!0,allowColumnResizing:!0,columnResizingMode:"widget",columnAutoWidth:!0,rowAlternationEnabled:!1,height:490,scrolling:{mode:"virtual",showScrollbar:"Always",useNative:!0},paging:{enabled:!1},onInitNewRow:function(a){a.data={certificadoicpbr:"0",assinatura_presencial:"0",foreign:"0",act:"1"}},focusedRowEnabled:!1,editing:{mode:"cell",allowUpdating:!0,allowDeleting:!0,useIcons:!0},rowDragging:{allowReordering:!0,dropFeedbackMode:"push",onReorder(a){const o=a.component.getVisibleRows(),i=e.dados_signatarios.d4sign.indexOf(o[a.toIndex].data),t=e.dados_signatarios.d4sign.indexOf(a.itemData);e.dados_signatarios.d4sign.splice(t,1),e.dados_signatarios.d4sign.splice(i,0,a.itemData),a.component.refresh()}},onToolbarPreparing:function(i){let t=[{widget:"dxButton",options:{icon:"plus",hint:"Adicionar signatário",text:"Adicionar",onClick:function(){i.component.addRow()}},location:"after",name:"addRowButton",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"save",hint:"Salvar",text:"Salvar",disabled:!1,visible:!0,onClick:function(i){var t=!0,s=e.grid_signatarios.dxDataGrid("instance"),d=e.grid_observadores.dxDataGrid("instance"),r=s.getDataSource()._items,n=d.getDataSource()._items,c=function(a,e,o){t=!1,a.nome_completo?DevExpress.ui.dialog.alert(o+" para o signatário <strong>"+a.nome_completo+"</strong>","Validação"):DevExpress.ui.dialog.alert(o+" na linha "+(e+1),"Validação")};r.forEach(function(a,e){a.opcoes_assinatura==D4SIGN_OPCAO_ASSINATURA.EXIGIR_CODIGO&&!1==!!a.codigo_acesso?c(a,e,"Informe o código de acesso"):a.opcoes_assinatura!=D4SIGN_OPCAO_ASSINATURA.EXIGIR_TOKEN_SMS&&a.opcoes_assinatura!=D4SIGN_OPCAO_ASSINATURA.EXIGIR_TOKEN_WHATSAPP||!1!=!!a.whatsapp_number?a.opcoes_assinatura==D4SIGN_OPCAO_ASSINATURA.EXIGIR_AUTENTICACAO_PIX?!1==!!a.nome_completo?c(a,e,"Informe o nome completo do signatário"):!1==!!a.cpf&&c(a,e,"Informe o CPF"):a.opcoes_assinatura==D4SIGN_OPCAO_ASSINATURA.EXIGIR_CERTIFICADO_DIGITAL_CPF&&!1==!!a.cpf?c(a,e,"Informe o CPF"):a.opcoes_assinatura==D4SIGN_OPCAO_ASSINATURA.EXIGIR_CERTIFICADO_DIGITAL_CNPJ&&!1==!!a.cnpj&&c(a,e,"Informe o CNPJ"):c(a,e,"Informe o número de celular")}),t&&(o?e.solicitar_assinaturas(r,a,n):(e.dados_signatarios.d4sign=[],$.each(r,function(a,o){e.dados_signatarios.d4sign.push(o)}),e.dados_signatarios.d4sign.params={workflow:e.checkWorkFlowInstace.option("value"),mensagem_signatarios:nl2br(e.txt_mensagem_signatarios.val()),solicitacao_id:e.solicitacao_id},e.solicitacao_id>0&&alert_info("A assinatura será solicitada após o envio da atividade do Processo"),e.unload()))}},location:"after",name:"salvarSignatarios",locateInMenu:"auto"}];i.toolbarOptions.items=window.add_botao_dx_toolbar(t,i.toolbarOptions.items)},onEditorPrepared:function(a){if("dataRow"===a.parentType)switch(a.dataField){case"email":a.editorElement.dxTextBox("instance").option("onValueChanged",function(e){""!==e.value&&emailValido(e.value),a.setValue(e.value)});break;case"whatsapp_number":a.editorElement.find("input").last().mask("+55(00)00000-0000"),a.editorElement.dxTextBox("instance").option("onValueChanged",function(e){a.row.data.opcoes_assinatura==D4SIGN_OPCAO_ASSINATURA.EXIGIR_TOKEN_SMS||a.row.data.opcoes_assinatura==D4SIGN_OPCAO_ASSINATURA.EXIGIR_TOKEN_WHATSAPP?(a.row.data.embed_smsnumber=e.value,a.setValue(e.value)):(delete a.row.data.embed_smsnumber,a.setValue(e.value))});break;case"codigo_acesso":a.editorElement.dxTextBox("instance").option("onValueChanged",function(e){a.row.data.opcoes_assinatura==D4SIGN_OPCAO_ASSINATURA.EXIGIR_CODIGO?(a.row.data.password_code=e.value,a.setValue(e.value)):(delete a.row.data.password_code,a.setValue(e.value))});break;case"nome_completo":a.editorElement.dxTextBox("instance").option("onValueChanged",function(e){a.row.data.opcoes_assinatura==D4SIGN_OPCAO_ASSINATURA.EXIGIR_AUTENTICACAO_PIX?(a.row.data.auth_pix_nome=e.value,a.setValue(e.value)):(delete a.row.data.auth_pix_nome,a.setValue(e.value))});break;case"cpf":a.editorElement.dxTextBox("instance").option("onValueChanged",function(e){a.row.data.opcoes_assinatura==D4SIGN_OPCAO_ASSINATURA.EXIGIR_AUTENTICACAO_PIX?(a.row.data.auth_pix_cpf=e.value,a.setValue(e.value)):a.row.data.opcoes_assinatura==D4SIGN_OPCAO_ASSINATURA.EXIGIR_CERTIFICADO_DIGITAL_CPF?(a.row.data.certificadoicpbr_cpf=e.value,a.setValue(e.value)):(delete a.row.data.auth_pix_cpf,delete a.row.data.certificadoicpbr_cpf,a.setValue(e.value))});break;case"cnpj":a.editorElement.dxTextBox("instance").option("onValueChanged",function(e){a.row.data.opcoes_assinatura==D4SIGN_OPCAO_ASSINATURA.EXIGIR_CERTIFICADO_DIGITAL_CNPJ?(a.row.data.certificadoicpbr_cnpj=e.value,a.setValue(e.value)):(delete a.row.data.certificadoicpbr_cnpj,a.setValue(e.value))});break;case"opcoes_assinatura":a.editorElement.dxSelectBox("instance").option("onValueChanged",function(e){const o=()=>{delete a.row.data.password_code,delete a.row.data.certificadoicpbr_tipo,delete a.row.data.certificadoicpbr_cpf,delete a.row.data.certificadoicpbr_cnpj,delete a.row.data.docauth,delete a.row.data.docauthandselfie,delete a.row.data.auth_pix,delete a.row.data.embed_smsnumber,delete a.row.data.embed_methodauth,delete a.row.data.auth_pix_nome,delete a.row.data.auth_pix_cpf,a.row.data.assinatura_presencial="0",a.row.data.certificadoicpbr="0"};switch(o(),+e.value){case D4SIGN_OPCAO_ASSINATURA.NENHUMA:o(),a.setValue(e.value);break;case D4SIGN_OPCAO_ASSINATURA.EXIGIR_CODIGO:a.row.data.password_code=a.row.data.codigo_acesso,a.setValue(e.value);break;case D4SIGN_OPCAO_ASSINATURA.EXIGIR_CERTIFICADO_DIGITAL:a.row.data.certificadoicpbr="1",a.row.data.certificadoicpbr_tipo="1",a.setValue(e.value);break;case D4SIGN_OPCAO_ASSINATURA.EXIGIR_CERTIFICADO_DIGITAL_CPF:a.row.data.certificadoicpbr="1",a.row.data.certificadoicpbr_tipo="2",a.row.data.certificadoicpbr_cpf=a.row.data.cpf,a.setValue(e.value);break;case D4SIGN_OPCAO_ASSINATURA.EXIGIR_CERTIFICADO_DIGITAL_CNPJ:a.row.data.certificadoicpbr="1",a.row.data.certificadoicpbr_tipo="3",a.row.data.certificadoicpbr_cnpj=a.row.data.cnpj,a.setValue(e.value);break;case D4SIGN_OPCAO_ASSINATURA.EXIGIR_DOCUMENTO_FOTO:a.row.data.docauth="1",a.setValue(e.value);break;case D4SIGN_OPCAO_ASSINATURA.EXIGIR_DOCUMENTO_FOTO_SELFIE:a.row.data.docauthandselfie="1",a.setValue(e.value);break;case D4SIGN_OPCAO_ASSINATURA.EXIGIR_TOKEN_SMS:a.row.data.embed_methodauth="sms",a.row.data.embed_smsnumber=a.row.data.whatsapp_number,a.setValue(e.value);break;case D4SIGN_OPCAO_ASSINATURA.EXIGIR_TOKEN_WHATSAPP:a.row.data.embed_methodauth="whats",a.row.data.embed_smsnumber=a.row.data.whatsapp_number,a.setValue(e.value);break;case D4SIGN_OPCAO_ASSINATURA.EXIGIR_AUTENTICACAO_PIX:a.row.data.auth_pix="1",a.row.data.auth_pix_nome=a.row.data.nome_completo,a.row.data.auth_pix_cpf=a.row.data.cpf,a.setValue(e.value);break;case D4SIGN_OPCAO_ASSINATURA.ASSINATURA_PRESENCIAL:a.row.data.assinatura_presencial="1",a.setValue(e.value)}})}},columns:[{dataField:"email",caption:"Email",validationRules:[{type:"required",message:"Preencha o E-mail"},{type:"email",message:"E-mail inválido"}]},{dataField:"nome_completo",caption:"Nome Completo",validationRules:[{type:"required",message:"Preencha o Nome"}]},{dataField:"whatsapp_number",caption:"Celular (Whatsapp/SMS)"},{dataField:"act",caption:"Assinar Como",lookup:{dataSource:[{id:"1",descricao:"Assinar"},{id:"2",descricao:"Aprovar"},{id:"3",descricao:"Reconhecer"},{id:"4",descricao:"Assinar como parte"},{id:"5",descricao:"Assinar como testemunha"},{id:"6",descricao:"Assinar como interveniente"},{id:"7",descricao:"Acusar recebimento"},{id:"8",descricao:"Assinar como Emissor, Endossante e Avalista"},{id:"9",descricao:"Assinar como Emissor, Endossante, Avalista, Fiador"},{id:"10",descricao:"Assinar como fiador"},{id:"11",descricao:"Assinar como parte e fiador"},{id:"12",descricao:"Assinar como responsável solidário"},{id:"13",descricao:"Assinar como parte e responsável solidário"}],valueExpr:"id",displayExpr:"descricao"}},{dataField:"opcoes_assinatura",caption:"Autenticação",width:300,lookup:{dataSource:[{id:"0",descricao:"Nenhuma"},{id:"1",descricao:"Exigir código de acesso"},{id:"2",descricao:"Exigir Certificado Digital ICP-Brasil"},{id:"3",descricao:"Exigir Certificado Digital ICP-Brasil com CPF"},{id:"4",descricao:"Exigir Certificado Digital ICP-Brasil com CNPJ"},{id:"5",descricao:"Exigir documento com foto"},{id:"6",descricao:"Exigir documento com foto + selfie"},{id:"7",descricao:"Exigir TOKEN SMS"},{id:"8",descricao:"Exigir TOKEN Whatsapp"},{id:"9",descricao:"Exigir autenticação PIX"},{id:"10",descricao:"Assinatura Presencial"}],valueExpr:"id",displayExpr:"descricao"},setCellValue:function(a,e){if(e==D4SIGN_OPCAO_ASSINATURA.EXIGIR_CODIGO){const e=makeid(8,!0);a.codigo_acesso=e,a.password_code=e}this.defaultSetCellValue(a,e)}},{dataField:"codigo_acesso",caption:"Código Acesso",dataType:"string"},{dataField:"foreign",caption:"Possui CPF ?",lookup:{dataSource:[{id:"0",descricao:"Sim (Brasileiro)"},{id:"1",descricao:"Não (Estrangeiro)"}],valueExpr:"id",displayExpr:"descricao"}},{dataField:"cpf",caption:"CPF",dataType:"string"},{dataField:"cnpj",caption:"CNPJ",dataType:"string"}],rowAlternationEnabled:!1,showRowLines:!0,showBorders:!0}),e.grid_observadores.dxDataGrid({dataSource:e.dados_observadores.d4sign,showBorders:!0,allowColumnReordering:!0,allowColumnResizing:!0,columnResizingMode:"widget",columnAutoWidth:!0,rowAlternationEnabled:!1,height:250,scrolling:{mode:"virtual",showScrollbar:"Always",useNative:!0},focusedRowEnabled:!1,editing:{mode:"cell",allowUpdating:!0,allowAdding:!1,allowDeleting:!0,useIcons:!0},onToolbarPreparing:function(a){let e=[{widget:"dxButton",options:{icon:"plus",hint:"Adicionar Observadores",text:"Adicionar",onClick:function(){a.component.addRow()}},location:"after",name:"addRowButton",locateInMenu:"auto"}];a.toolbarOptions.items=window.add_botao_dx_toolbar(e,a.toolbarOptions.items)},columns:[{dataField:"email",caption:"Email",validationRules:[{type:"required",message:"Preencha o E-mail"},{type:"email",message:"E-mail inválido"}]},{dataField:"permissao",caption:"Permissão",validationRules:[{type:"required",message:"Preencha a Permissão"}],lookup:{dataSource:[{id:"0",descricao:"Permite fazer download"},{id:"1",descricao:"Não permite fazer download"}],valueExpr:"id",displayExpr:"descricao"}}],rowAlternationEnabled:!1,showRowLines:!0,showBorders:!0})},this.solicitar_assinaturas=function(a,o,i){if(function(a){for(var e=[],o=0;o<a.length;++o){var i=a[o].whatsapp_number,t=a[o].email;if(i||t){if(-1!==e.indexOf(i)||-1!==e.indexOf(t))return!0;i&&e.push(i),t&&e.push(t)}}return!1}(a))alert_modal("Atenção","Existem e-mails ou telefones duplicados. <br> Por favor, corrija os dados duplicados e reconfirme a operação","OK");else{let t="0",s="",d=null;e.checkWorkFlowInstace?t=!0===e.checkWorkFlowInstace.option("value")?"1":"0":void 0!==a.params&&(t=!0===a.params.workflow?"1":"0"),void 0!==e.txt_mensagem_signatarios&&e.txt_mensagem_signatarios.length>0?s=nl2br(e.txt_mensagem_signatarios.val()):void 0!==a.params&&(s=a.params.mensagem_signatarios),void 0!==e.solicitacao_id&&Number(e.solicitacao_id)>0?d=e.solicitacao_id:void 0!==a.params&&(d=a.params.solicitacao_id),WS.post("d4sign/solicitar_assinaturas",{signatarios:JSON.stringify(a),documento_revisao_id:o,mensagem_signatarios:s,workflow:t,solicitacao_id:d,observadores:JSON.stringify(i)},function(a){var o="";void 0===a.mensagem_pt&&(o="<h4>Falha ao transmitir o arquivo. Possíveis causas: </h4><br>",o+=a.message);if(""!=o)return alert_modal("Atenção",o),!1;e.comunica_d4sign&&DevExpress.ui.dialog.alert("Documento disponibilizado para o(s) signatário(s)!","Atenção").done(function(){e.unload()})})}},this.close=function(){void 0!==e.onclose&&e.onclose&&e.onclose()},this.unload=function(){e.close(),View.unload(this.html_id)}}});