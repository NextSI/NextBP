define([],function(){return function(e){"use strict";var o=this;this.html_id=e,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title"),this.tipo=null,this.onclose=null,this.onsave=null,this.onremove=null,this.lbl_titulo_gateway=this.dialog.find(".lbl_titulo_gateway"),this.lbl_titulo_id=this.dialog.find(".lbl_titulo_id"),this.lbl_tab_geral=this.dialog.find(".lbl_tab_geral"),this.lbl_tab_fluxo=this.dialog.find(".lbl_tab_fluxo"),this.coluna_opcional=this.dialog.find(".coluna_opcional"),this.edt_descricao=this.dialog.find(".edt_descricao"),this.cbo_tipo=this.dialog.find(".cbo_tipo"),this.chk_bloqueio_decisao=this.dialog.find(".chk_bloqueio_decisao"),this.tab_fluxo=this.dialog.find(".tab_fluxo"),this.btn_add_fluxo=this.dialog.find(".btn_add_fluxo"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.gateway={id:0,elemento_tipo:PROCESSO_ELEMENTO_TIPO.GATEWAY,descricao:"",tipo:0,destinos:[],permissoes_formulario:[],removido:!1,evento_enviar:null,bloqueio_decisao:!1,filtro_evento_enviar:null,tipo_automacao:null},this.elemento_pai=null,this.formulario=null,this.processo_ref=null,this.show=function(e,t,i,a,n,l,s){switch(o.formulario=l,void 0!==e&&e&&(o.gateway=clone_obj(e)),void 0!==i&&i&&(o.processo_ref=i),void 0!==a&&a&&(o.elemento_pai=a),void 0!==s&&s&&(o.gateway.tipo=s),t){case FORMULARIO.NOVO:case FORMULARIO.EDITAR:o.btn_salvar.show(),o.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:case FORMULARIO.EXCLUIR:o.btn_salvar.hide(),o.permite_alterar(!1)}o.tipo=t,o.preencher(),show_modal(o.modal.attr("id")),set_focus(o.edt_descricao),0==o.processo_ref.elementos.length&&0==o.processo_ref.elementos.length&&o.btn_add_fluxo.attr("disabled",!0),n&&n.find("a").tab("show")},this.close=function(){close_modal(o.modal.attr("id")),void 0!==o.onclose&&o.onclose&&o.onclose()},this.unload=function(){o.close(),View.unload(this.html_id)},this.permite_alterar=function(e){},this.preencher=function(){void 0!==o.gateway.id&&o.gateway.id>0?o.lbl_titulo_id.text("Id."+o.gateway.id):o.lbl_titulo_id.text(""),o.lbl_titulo_gateway.text(o.gateway.descricao),o.edt_descricao.val(o.gateway.descricao),o.cbo_tipo.val(o.gateway.tipo),o.chk_bloqueio_decisao.prop("checked",o.gateway.bloqueio_decisao).change(),o.cbo_tipo.change(),o.render_fluxo()};var t=function(e){o.dialog.find(".cbo_fluxo_elemento").prop("disabled",!0);var t=!0;void 0!==e&&e||(e={tipo:null,elemento_tipo:null,id:null,opcional:!1,evento_enviar:null,removido:!1,filtro_evento_enviar:null,tipo_automacao:null},t=!1),void 0===e.elem_key&&(e.elem_key=String((new Date).getTime())+String(Math.round(1e4*Math.random()))+String((new Date).getTime())+String(Math.round(1e4*Math.random())));var i=o.tab_fluxo.find("tbody"),a=i.find("tr:first").clone();a.removeAttr("template-row"),a.css("display","");var n=$(a.find("[template-field='opcional']"));n.attr("type","checkbox").addClass("checkbox_bootstrap_toggle").removeClass("hidden"),n.prop("checked",!0===e.opcional).change(),n.change(function(){e.opcional=$(this).prop("checked")});for(var l=$(a.find("[template-field='elemento']")),s=$("<optGroup/>").attr("label","Atividade"),d=$("<optGroup/>").attr("label","Gateway"),r=0;r<o.processo_ref.elementos.length;r++){for(var c=!1,_=0;_<o.gateway.destinos.length;_++)o.gateway.destinos[_].elem_key==o.processo_ref.elementos[r].elem_key&&0==o.gateway.destinos[_].removido&&(c=!0);if(t&&(c=!1),!1===c){if(o.processo_ref.elementos[r].elemento_tipo==PROCESSO_ELEMENTO_TIPO.ATIVIDADE)$('<option elemento_tipo="'+PROCESSO_ELEMENTO_TIPO.ATIVIDADE+'" tipo="'+o.processo_ref.elementos[r].tipo+'" id="'+o.processo_ref.elementos[r].id+'" />').attr("value",o.processo_ref.elementos[r].elem_key).text(o.processo_ref.elementos[r].descricao).appendTo(s);if(o.processo_ref.elementos[r].elemento_tipo==PROCESSO_ELEMENTO_TIPO.GATEWAY)$('<option elemento_tipo="'+PROCESSO_ELEMENTO_TIPO.GATEWAY+'" tipo="'+o.processo_ref.elementos[r].tipo+'" id="'+o.processo_ref.elementos[r].id+'" />').attr("value",o.processo_ref.elementos[r].elem_key).text(o.processo_ref.elementos[r].descricao).appendTo(d)}}$("<option/>").attr("value","").text(" - Selecionar - ").appendTo(l),s.clone().appendTo(l),d.clone().appendTo(l),l.unbind("change"),l.change(function(){if(e.elem_key=l.val(),e.elemento_tipo=parseInt(l.find("option:selected").attr("elemento_tipo"),10),e.tipo=parseInt(l.find("option:selected").attr("tipo"),10),e.descricao=l.find("option:selected").text(),e.id=l.find("option:selected").attr("id"),l.find("option:selected").length>0)if(o.gateway.destinos.length>0){var i=!1;$(o.gateway.destinos).each(function(o,t){if(e.elem_key==t.elem_key)return i=!0,!1}),i||o.gateway.destinos.push(e)}else o.gateway.destinos.push(e);$(o.gateway.destinos).each(function(i,a){if(!t&&a.elem_key==e.elem_key)return o.gateway.destinos[i].removido=!1,o.render_fluxo(),!1})}),l.val(e.elem_key).trigger("change"),l.prop("disabled",t);var u=$(a.find(".btn_evento"));u.unbind("click"),u.click(function(){var t=e.elem_key;View.load("processo/gateway_destino_evento",function(i,a){a.onsave=function(e,i,a){$(o.gateway.destinos).each(function(n,l){l.elem_key==t&&(o.gateway.destinos[n].evento_enviar=e,o.gateway.destinos[n].filtro_evento_enviar=i,o.gateway.destinos[n].tipo_automacao=a,o.render_fluxo())})},a.show(e.evento_enviar,o.formulario,e.filtro_evento_enviar,e.tipo_automacao)})});var h=$(a.find(".btn_fluxo_remover"));h.unbind("click"),h.click(function(){alert_modal(o.title.text(),"Deseja remover este elemento do fluxo?","Remover",function(){$(o.gateway.destinos).each(function(t,i){i.elem_key==e.elem_key&&(o.gateway.destinos[t].removido=!0,o.render_fluxo())})},!0)}),a.appendTo(i),App.aplicar_checkbox(i)};this.render_fluxo=function(){$(o.gateway.destinos).each(function(e,t){void 0===o.gateway.destinos[e].evento_enviar?o.gateway.destinos[e].evento_enviar=null:o.gateway.destinos[e].evento_enviar=o.gateway.destinos[e].evento_enviar,void 0===o.gateway.destinos[e].removido&&(o.gateway.destinos[e].removido=!1)});var e=o.gateway.destinos.filter(function(e){var o=!0;return!0===e.removido&&(o=!1),o});e=e.sort(function(e,o){return parseInt(e.elemento_tipo,10)>parseInt(o.elemento_tipo,10)}),o.tab_fluxo.find("tr:gt(1)").remove(),$(e).each(function(e,o){t(o)})},this.edt_descricao.unbind("keyup"),this.edt_descricao.keyup(function(){o.lbl_titulo_gateway.text(o.edt_descricao.val())}),this.btn_add_fluxo.unbind("click"),this.btn_add_fluxo.click(function(){var e=!0;$(o.gateway.destinos).each(function(o,t){!(void 0===t.descricao||t.descricao&&""==t.elem_key)||t.removido&&0!=t.removido||(alert_modal("Validação","Existe(m) elemento(s) no fluxo sem atividade ou gateway selecionado(s)"),e=!1)}),0==o.processo_ref.elementos.length&&(e=!1),!0===e&&t()}),this.cbo_tipo.unbind("change"),this.cbo_tipo.change(function(){this.value==PROCESSO_GATEWAY_TIPO.INCLUSIVO?o.coluna_opcional.removeClass("hidden"):o.coluna_opcional.addClass("hidden"),o.render_fluxo()}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){o.unload()}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){var e=!0;void 0===o.gateway.elem_key&&(o.gateway.elem_key=String((new Date).getTime())+String(Math.round(1e4*Math.random()))+String((new Date).getTime())+String(Math.round(1e4*Math.random()))),o.gateway.descricao=o.edt_descricao.val(),o.gateway.tipo=o.cbo_tipo.val(),o.gateway.bloqueio_decisao=o.chk_bloqueio_decisao.prop("checked"),$(o.gateway.destinos).each(function(o,t){!(void 0===t.descricao||t.descricao&&""==t.elem_key)||t.removido&&0!=t.removido||(alert_modal("Validação","Existe(m) elemento(s) no fluxo sem atividade ou gateway selecionado(s)"),e=!1)}),e&&(void 0!==o.onsave&&o.onsave&&o.onsave(o.gateway,o.elemento_pai),o.unload())})}});