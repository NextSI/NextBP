define([],function(){return function(a){"use strict";var o=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.title="Detalhes Alçada",this.tab_listagem=this.dialog.find(".tab_listagem"),this.btn_novo_aprovador=this.dialog.find(".btn_novo_aprovador"),this.div_cbo_aprovador=this.dialog.find(".div_cbo_aprovador"),this.cbo_aprovador=this.dialog.find(".cbo_aprovador"),this.btn_salvar_alteracoes=this.dialog.find(".btn_salvar_alteracoes"),this.edt_nome_alcada=this.dialog.find(".edt_nome_alcada"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.alcada_generica_id=null,this.arr_aprovadores=new Array,this.onsave=null,this.show=function(a){create_combobox(o.cbo_aprovador,o.listar_grupos_usuarios);var r=o.cbo_aprovador.parent();o.edt_aprovador=r.find(".edt_combobox"),o.edt_aprovador.keypress(function(a){if(13==a.keyCode){var r=o.cbo_aprovador.parent().find(".ncbo_scroll").find(".row_selected"),e=r.attr("dados-adicionais")?JSON.parse(r.attr("dados-adicionais")):null;o.adicionar_linha(e),o.cbo_aprovador.parent().find(".edt_combobox").val(""),r.removeClass("row_selected")}}),a>0&&WS.get("alcada_aprovadores/objeto/",{alcada_generica_id:a},function(a){null!==a&&(o.alcada_generica_id=a.alcada_generica_id,o.edt_nome_alcada.val(a.nome_alcada_generica),$(a.aprovadores).each(function(a,r){r.usuario_id>0?r.tipo_aprovador=TIPO_APROVADOR.USUARIO:r.grupo_usuarios_id>0&&(r.tipo_aprovador=TIPO_APROVADOR.GRUPO_USUARIOS),o.arr_aprovadores.push(r)}),o.render_aprovadores())})},this.render_aprovadores=function(a,r){var e=o.tab_listagem.find("tbody"),i=e.find("tr:first");o.tab_listagem.find("tr:gt(1)").remove(),$(o.arr_aprovadores).each(function(a,r){!function(a,r){var t=i.clone();t.removeAttr("template-row"),t.removeAttr("style");var n=$(t.find("[template-field='nivel']"));n.val(a.nivel);var d=$(t.find("[template-field='label_tipo']"));a.usuario_id?(d.addClass("label-info"),d.text("U"),d.attr("tipo","usuarios")):(d.addClass("label-warning"),d.text("GU"),d.attr("tipo","grupo_usuarios")),$(t.find("[template-field='aprovador']")).text(a.usuario_id?a.aprovador_usuario_nome:a.aprovador_grupo_nome);var s=$(t.find("[template-field='tipo_aprovacao']"));s.val(a.tipo_aprovacao),n.change(function(){o.arr_aprovadores[r].nivel=$(this).val(),o.arr_aprovadores.sort(function(a,o){var r=a.nivel,e=o.nivel;return parseInt(r)<parseInt(e)?-1:parseInt(r)>parseInt(e)?1:0}),o.render_aprovadores()}),s.change(function(){o.arr_aprovadores[r].tipo_aprovacao=$(this).val()}),$(t.find(".btn_remover_aprovador")).click(function(){alert_modal("Atenção","Deseja remover este registro? "+(a.usuario_id?a.aprovador_usuario_nome:a.aprovador_grupo_nome),"Remover",function(){$(o.arr_aprovadores).each(function(r,e){return a.tipo_aprovador==TIPO_APROVADOR.USUARIO&&e.usuario_id==a.usuario_id&&e.nivel==a.nivel||a.tipo_aprovador==TIPO_APROVADOR.GRUPO_USUARIOS&&e.grupo_usuarios_id==a.grupo_usuarios_id&&e.nivel==a.nivel?(t.remove(),o.arr_aprovadores.splice(r,1),o.render_aprovadores(),!1):void 0})},!0,"Não",function(){})}),t.appendTo(e)}(r,a)})},this.adicionar_linha=function(a){null!==a&&("usuarios"==a.tipo?setTimeout(function(){var r={};r.usuario_id=a.id,r.aprovador_usuario_nome=a.nome,r.nivel=void 0===o.arr_aprovadores[o.arr_aprovadores.length-1]?"1":parseInt(o.arr_aprovadores[o.arr_aprovadores.length-1].nivel),r.tipo_aprovacao="2",r.tipo_aprovador=TIPO_APROVADOR.USUARIO,o.arr_aprovadores.push(r),o.render_aprovadores()},150):"grupo_usuarios"==a.tipo&&setTimeout(function(){var r={};r.grupo_usuarios_id=a.id,r.aprovador_grupo_nome=a.nome,r.nivel=void 0===o.arr_aprovadores[o.arr_aprovadores.length-1]?"1":parseInt(o.arr_aprovadores[o.arr_aprovadores.length-1].nivel),r.tipo_aprovacao="2",r.tipo_aprovador=TIPO_APROVADOR.GRUPO_USUARIOS,o.arr_aprovadores.push(r),o.render_aprovadores()},150))},this.listar_grupos_usuarios=function(a){var r=o.cbo_aprovador.parent().find(".edt_combobox"),e=new Object;e.nome=r.val(),e.modulo=MODULOS.DOCUMENTO,WS.get("usuario/listar_usuarios_grupos/",e,function(r){limpar_combobox(o.cbo_aprovador),$(r).each(function(a,r){var e=[];e.Nome=r.nome;var i=$('<span class="label lb_tipo" style="margin: 5px;"></span>');"usuarios"==r.tipo?(i.addClass("label-info"),i.text("U"),i.attr("tipo","usuarios")):"grupo_usuarios"==r.tipo&&(i.addClass("label-warning"),i.text("GU"),i.attr("tipo","grupo_usuarios")),i.tooltip(),add_option_combobox(o.cbo_aprovador,a,r.id>0?r.id:null,e,i,JSON.stringify(r))}),r.length>0&&a(!0),$(o.cbo_aprovador.parent()).find(".ul_row").click(function(){var a=$(this).parent().attr("dados-adicionais")?JSON.parse($(this).parent().attr("dados-adicionais")):null;o.adicionar_linha(a),setTimeout(function(){var a=o.cbo_aprovador.parent().find(".ncbo_scroll").find(".row_selected");o.cbo_aprovador.parent().find(".edt_combobox").val(""),a.removeClass("row_selected")})})})},this.close=function(){void 0!==o.onsave&&o.onsave&&o.onsave()},this.unload=function(){o.close(),View.unload(this.html_id)},o.btn_cancelar.click(function(){o.unload()}),o.btn_salvar_alteracoes.click(function(){for(var a,r=!1,e=!1,i=[],t=o.arr_aprovadores.length,n=0;n<t;n++){for(var d=n;d<t;d++)1==o.arr_aprovadores[d].tipo_aprovador?n!=d&&o.arr_aprovadores[n].usuario_id==o.arr_aprovadores[d].usuario_id&&o.arr_aprovadores[n].nivel==o.arr_aprovadores[d].nivel&&(r=!0,i.push(o.arr_aprovadores[n].aprovador_usuario_nome)):2==o.arr_aprovadores[d].tipo_aprovador&&n!=d&&o.arr_aprovadores[n].grupo_usuarios_id==o.arr_aprovadores[d].grupo_usuarios_id&&o.arr_aprovadores[n].nivel==o.arr_aprovadores[d].nivel&&(r=!0,i.push(o.arr_aprovadores[n].aprovador_grupo_nome));n>0&&parseInt(o.arr_aprovadores[n].nivel)-parseInt(o.arr_aprovadores[n-1].nivel)>1&&(e=!0)}return 1==r?((a=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Os itens abaixo estão duplicados: <br /><br />"+i)),alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',a),!1):1==e?((a=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Por gentileza, verifique a ordem dos niveis")),alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',a),!1):0==o.arr_aprovadores.length?((a=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Por gentileza, informe ao menos um usuário para salvar uma alçada.")),alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',a),!1):1!=o.arr_aprovadores[0].nivel?((a=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,'A alçada sempre deverá iniciar com o nivel "1" ')),alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',a),!1):void WS.post("alcada_aprovadores/salvar/",{alcada_generica_id:o.alcada_generica_id,nome_alcada_generica:o.edt_nome_alcada.val(),aprovadores:JSON.stringify(o.arr_aprovadores)},function(a){o.unload()},[o.btn_salvar_alteracoes])})}});