"use strict";define(["react","react-dom"],function(a,e){class t extends a.Component{constructor(a){super(a),this.state={clearState:!1},this.props.setParams=a=>{const e=void 0===a.fullscreen||a.fullscreen,t=a.data.projeto?a.data.projeto.arr_sequencias_baseline:[],i=a.data.projeto?a.data.projeto.controle_baseline:0,o=void 0!==a.listar_somente_analiticas&&a.listar_somente_analiticas;let n=this,d=null,r=null,l=null,s=null,c=set_format_date(!1),p=document.createElement("div");p.className="div_listagem_atividade_projeto",p.style="min-width: 100%;",a.div.find(".div_listagem_atividade_projeto").remove(),a.div[0].appendChild(p);let _=detectmob()?"select":"dragAndDrop",u=get_icon_class();a.diferenca_altura&&(a.obter_tamanho_div_pai?a.div.find(".div_listagem_atividade_projeto").css("height","100%"):a.div.find(".div_listagem_atividade_projeto").css("height","calc(100vh - "+a.diferenca_altura+"px)"));let v=[{ID:"1",Status:"Programado"},{ID:"2",Status:"Andamento"},{ID:"3",Status:"Concluído"},{ID:"4",Status:"Não iniciado"},{ID:"5",Status:"Atrasado"},{ID:"6",Status:"Cancelada"}],m=[{ID:TIPO_PREVISAO_INICIO.O_MAIS_BREVE_POSSIVEL,Tipo:"O mais breve possível"},{ID:TIPO_PREVISAO_INICIO.DEVE_INICIAR_EM,Tipo:"Deve iniciar em"}],h=function(){let e=E.getController("editing").getChanges(),t=!1;for(let a=0;a<e.length;a++){const i=e[a];if(i.data&&Object.keys(i.data).length){t=!0;break}}t?alert_modal("Aviso","Você possui alterações não salvas que serão perdidas ao atualizar a listagem <br /> Deseja atualizar mesmo assim?","Sim",function(){a.fn_listar()},!0,"Cancelar",null,function(){}):a.fn_listar()},f=function(a){let e=0;if(a&&a.hasChildren)for(let t=0;t<a.children.length;t++){let i=a.children[t];!1===i.data.cancelada&&(e+=parseInt(i.data.porcentagem?i.data.porcentagem:0),e+=f(i),"A"==i.data.tipo_atividade&&d++)}return e},g=function(a){let e="000:00";return a&&a.hasChildren&&a.children.forEach(function(a){(!1===a.data.cancelada||!0===a.data.cancelada&&!1===a.data.tipo_cancelamento_ignorar_prev_real)&&(e=somar_horas(e,qtd_str_ocorrencias(a.data.horas_previstas,":")?a.data.horas_previstas:a.data.horas_previstas.substr(0,a.data.horas_previstas.length-2)+":"+a.data.horas_previstas.substr(a.data.horas_previstas.length-2,2)),e=somar_horas(e,g(a)))}),e},w=function(a){let e="000:00";return a&&a.hasChildren&&a.children.forEach(function(a){(!1===a.data.cancelada||!0===a.data.cancelada&&!1===a.data.tipo_cancelamento_ignorar_prev_real)&&(e=somar_horas(e,qtd_str_ocorrencias(a.data.horas_trabalhadas,":")?a.data.horas_trabalhadas:a.data.horas_trabalhadas.substr(0,a.data.horas_trabalhadas.length-2)+":"+a.data.horas_trabalhadas.substr(a.data.horas_trabalhadas.length-2,2)),e=somar_horas(e,w(a)))}),e},j=function(a,e){if(e==a.key)r=!0,s=a;else if(a.hasChildren)for(let t=0;t<a.children.length;t++){let i=a.children[t];if(r)break;j(i,e)}},x=function(a){let e=[];return e.push(a.key),a.children.forEach(function(a){e=e.concat(x(a))}),e},b=function(a){if(a){2==qtd_str_ocorrencias(a,":")&&(a=a.substring(0,a.lastIndexOf(":")));var e=a.indexOf("-");return e>-1&&(a=a.replaceAll("-","")),a=(a=pad(a.replaceAll(":",""),6)).substring(0,4)+":"+a.substring(4,6),e>-1&&(a="-"+a),a}},I=function(a,e,t){let i={atividade_projeto_id:a.id,cancelada:e,tipo_cancelamento_ignorar_prev_real:void 0!==t?t:""};WS.post({route:"atividade_projeto/cancelar/",data:i,func_response:function(a){h()}})},A=function(a){if(a){let e=JSON.parse(JSON.stringify(a));return e=e.filter(function(a){return"P"!=a.tipo_atividade}),e}return[]};let E=null,T=null,C=null,S={},y=null,O=null,P=null;a.somente_leitura?a.dropdown?(y={mode:"single"},O=function(e){if(e.selectedRowsData.length&&"A"==e.selectedRowsData[0].tipo_atividade&&("N"==a.data.projeto.bloquear_apontamento_atividade_concluida||e.selectedRowsData[0].status!=ATIVIDADE_SITUACAO.CONCLUIDO)){a.div_porcentagem&&(a.div_porcentagem.val(e.selectedRowsData[0].porcentagem),e.selectedRowsData[0].tarefas.length>0?a.div_porcentagem.addClass("disabled").attr("disabled","disabled"):a.div_porcentagem.removeClass("disabled").removeAttr("disabled")),T.component._$element.attr("id",e.selectedRowsData[0].id);let t=e.selectedRowKeys,i=t.length;T.component.option("value",i?t[0]:null),a.ao_selecionar&&a.ao_selecionar(t[0],e.selectedRowsData[0]),T.component.close()}}):y={mode:"multiple"}:(C={dataField:"toolbar",allowSearch:!1,allowSorting:!1,allowFiltering:!1,allowGrouping:!1,caption:"Opções",fixed:!0,fixedPosition:"right",allowEditing:!1,width:"90px",cellTemplate:function(e,t){const o=$("<div>").dxToolbar({items:[{locateInMenu:"auto",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Adicionar atividade analítica",hint:"Adicionar atividade analítica",icon:"fa fa-plus",cssClass:u,visible:("S"==t.row.data.tipo_atividade||"P"==t.row.data.tipo_atividade)&&(a.planejamento_atividade||a.gerente_projeto||App.sessao.dados.admin),onClick:()=>E.addRow(t.row.key)}},{locateInMenu:"auto",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Editar",hint:"Editar",icon:"fa fa-pencil-alt",cssClass:u,visible:("S"==t.row.data.tipo_atividade||"A"==t.row.data.tipo_atividade)&&(a.planejamento_atividade||a.planejamento_datas||a.planejamento_financeiro||a.planejamento_recursos||a.gerente_projeto||App.sessao.dados.admin),onClick:()=>{"A"==t.row.data.tipo_atividade?View.load("atividade_projeto/detalhes",function(e,i){let o={projeto_id:a.projeto.id,projeto_atividade_id:t.row.data.id,tipo:FORMULARIO.EDITAR,template:a.template,equipe:a.projeto.equipe_toda,nome:t.row.data.atividade_simplificada,grupo_usuarios_equipe:a.projeto.grupo_usuarios_equipe,cliente_nome:a.projeto.cliente_nome,equipe_toda:a.projeto.equipe_toda,permitir_apontamento_projeto_concluido:a.permitir_apontamento_projeto_concluido,status_projeto:a.projeto.status_projeto,projeto_apontamento_por:a.projeto_apontamento_por,utiliza_peso_atividades:a.projeto.utiliza_peso_atividades};i.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&h()})},i.show(o)},View.ABA.MULTIPLAS,null,null,{projetoAtividadeId:t.row.data.id}):"S"==t.row.data.tipo_atividade&&View.load("atividade_projeto/atividade_sintetica_detalhes",function(e,i){i.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&h()})};let o={atividade_sintetica_id:t.row.data.id,tipo:FORMULARIO.EDITAR,projeto_id:a.projeto.id,gerente_projeto:a.gerente_projeto,planejamento_datas:a.planejamento_datas};i.show(o)})}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Visualizar",hint:"Visualizar",icon:"fa fa-eye",cssClass:u,visible:!(a.gerente_projeto||a.planejamento_atividade||App.sessao.dados.admin||a.planejamento_datas||a.planejamento_financeiro||a.planejamento_recursos||"P"==t.row.data.tipo_atividade),onClick:()=>{"A"==t.row.data.tipo_atividade?View.load("atividade_projeto/detalhes",function(e,i){let o={projeto_id:a.projeto.id,projeto_atividade_id:t.row.data.id,tipo:FORMULARIO.VISUALIZAR,template:a.template,equipe:a.projeto.equipe_toda,nome:t.row.data.atividade_simplificada,grupo_usuarios_equipe:a.projeto.grupo_usuarios_equipe,cliente_nome:a.projeto.cliente_nome,equipe_toda:a.projeto.equipe_toda,permitir_apontamento_projeto_concluido:a.permitir_apontamento_projeto_concluido,status_projeto:a.projeto.status_projeto,projeto_apontamento_por:a.projeto_apontamento_por,utiliza_peso_atividades:a.projeto.utiliza_peso_atividades};i.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&h()})},i.show(o)},View.ABA.MULTIPLAS,null,null,{projetoAtividadeId:t.row.data.id}):"S"==t.row.data.tipo_atividade&&View.load("atividade_projeto/atividade_sintetica_detalhes",function(e,i){i.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&h()})};let o={atividade_sintetica_id:t.row.data.id,tipo:FORMULARIO.VISUALIZAR,projeto_id:a.projeto.id,gerente_projeto:a.gerente_projeto,planejamento_datas:a.planejamento_datas};i.show(o)})}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Criar baseline (Projeto)",hint:"Criar baseline (Projeto)",icon:"fa fa-magic",cssClass:u,visible:(a.gerente_projeto||App.sessao.dados.admin)&&"P"==t.row.data.tipo_atividade,onClick:()=>{alert_modal("Atenção","Deseja criar uma baseline para todas as atividades deste projeto?","Sim",function(){WS.post("atividade_projeto/criar_baseline/",{projeto_id:a.projeto.id,projeto_atividade_id:null,tipo_controle_baseline:i},function(){h(),alert_tooltip("Baseline criada com sucesso","success",800)})},!0,"Não",()=>{})}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Histórico baseline (Projeto)",hint:"Histórico baseline (Projeto)",icon:"fa fa-history",cssClass:u,visible:a.projeto.controle_baseline==window.PROJETO_CONTROLE_BASELINE.PROJETO&&"P"==t.row.data.tipo_atividade&&(a.gerente_projeto||App.sessao.dados.admin),onClick:()=>{View.loadReact(window.views.projeto.HistoricoBaseline.default,{projeto_id:a.data.projeto.id,abaTitulo:"Baseline - "+a.data.projeto.nome})}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Apontamento",hint:"Apontamento",icon:"fa fa-clock",cssClass:u,visible:"A"==t.row.data.tipo_atividade&&App.verifica_permissao(App.temp.empresa,"apontamento_atividade")&&(a.projeto.status_projeto!=PROJETO_STATUS.CONCLUIDO||a.permitir_apontamento_projeto_concluido),onClick:()=>{View.load("apontamento_projeto/detalhes",function(e,i){let o={projeto_id:a.projeto.id,projeto_nome:a.projeto.nome,cliente_id:a.projeto.cliente_id,cliente_nome:a.projeto.cliente_nome||a.projeto.cliente_razao_social,projeto_atividade_id:t.row.data.id};i.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&h()})},i.show(o)},View.ABA.MULTIPLAS)}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Novo chamado",hint:"Novo chamado",icon:"fa fa-comments",cssClass:u,visible:"A"==t.row.data.tipo_atividade&&(a.planejamento_atividade||a.gerente_projeto||App.sessao.dados.admin),onClick:()=>{WS.get({route:"atividade_projeto/get_detalhes_atividade/",data:{atividade_id:t.row.data.id,extra_info:!0},func_response:function(e){const i=e[0].atividade_nome;let o="";for(let e in a.projeto.equipe_toda)if("clean"!=e){let t=a.projeto.equipe_toda[e];!0!==t.gerente_projeto&&"S"!=t.gerente_projeto||(o=""===o&&null!==t.email&&""!==t.email&&"null"!==t.email?t.email:o+";"+t.email)}let n=t.row.data.email_executores?t.row.data.email_executores:"",d=o+(""!==n?";"+n:"")+(null!==t.row.data.email_responsavel&&""!==t.row.data.email_responsavel?";"+t.row.data.email_responsavel:""),r="";d.split(";"),d=$.unique(d.split(";")),$(d).each(function(a,e){""===r&&null!==e&&""!==e&&"null"!==e?r=e:";"!=e&&-1==r.indexOf(e)&&(r=r+";"+e)}),View.loadReact(window.views.chamado.Detalhes.default,{projetoAtividadeId:t.row.data.id,projetoId:a.projeto.id,entidadeId:a.projeto.cliente_id,entidadeTipo:TIPO_ENTIDADE.CLIENTE,assunto:i,emails:r},function(a,e){},View.ABA.MULTIPLAS)}})}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Nova solicitação",hint:"Nova solicitação",icon:"fas fa-project-diagram",cssClass:u,visible:"A"==t.row.data.tipo_atividade&&(a.planejamento_atividade||a.gerente_projeto||App.sessao.dados.admin),onClick:()=>{View.load("solicitacao/nova",function(e,i){i.onclose=h(),i.show(null,t.row.data.id,a.projeto.id)})}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Criar baseline (Atividade)",hint:"Criar baseline (Atividade)",icon:"fa fa-magic",cssClass:u,visible:a.projeto.controle_baseline==window.PROJETO_CONTROLE_BASELINE.ATIVIDADE&&"A"==t.row.data.tipo_atividade&&(a.gerente_projeto||App.sessao.dados.admin),onClick:()=>{alert_modal("Atenção","Deseja criar uma baseline para esta atividade?","Sim",function(){WS.post("atividade_projeto/criar_baseline/",{projeto_id:t.row.data.projeto_id,projeto_atividade_id:t.row.data.id,tipo_controle_baseline:i},function(){h(),alert_tooltip("Baseline criada com sucesso","success",800)})},!0,"Não",()=>{})}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Histórico baseline (Atividade)",hint:"Histórico baseline (Atividade)",icon:"fa fa-history",cssClass:u,visible:a.projeto.controle_baseline==window.PROJETO_CONTROLE_BASELINE.ATIVIDADE&&"A"==t.row.data.tipo_atividade&&(a.gerente_projeto||App.sessao.dados.admin),onClick:()=>{View.load("atividade_projeto/historico_baseline",function(a,e){e.show(t.row.data)},View.ABA.NAO)}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Favoritar",hint:"Favoritar",icon:"far fa-star",cssClass:u,visible:!verifica_favorito("atividades",t.row.data.id)&&!t.row.removed&&"A"==t.row.data.tipo_atividade&&"raiz"!=t.row.data.id,onClick:()=>{favoritar_item("atividades",t.row.data.id,!0),h()}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Desfavoritar",hint:"Desfavoritar",icon:"fas fa-star",cssClass:u,visible:verifica_favorito("atividades",t.row.data.id)&&!t.row.removed&&"A"==t.row.data.tipo_atividade&&"raiz"!=t.row.data.id,onClick:()=>{favoritar_item("atividades",t.row.data.id,!1),h()}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Apagar registro",hint:"Apagar registro",icon:"fa fa-trash",cssClass:u,visible:!t.row.removed&&"P"!=t.row.data.tipo_atividade&&a.gerente_projeto,onClick:()=>{"S"==t.row.data.tipo_atividade?View.load("atividade_projeto/atividade_sintetica_detalhes",function(e,i){i.onsave=function(){h()};let o={atividade_sintetica_id:t.row.data.id,tipo:FORMULARIO.EXCLUIR,projeto_id:a.projeto.id,gerente_projeto:a.gerente_projeto,planejamento_datas:a.planejamento_datas};i.show(o)}):(E.deleteRow(t.row.rowIndex),t.component.focus(t.component.getCellElement(0,0)))}}}].filter(a=>void 0===a.visible||a.visible)});o.css("background-color","initial"),o.appendTo(e)}},S={mode:"batch",allowUpdating:!0,useIcons:!0});const R={dataField:"porcentagem_peso",caption:"(%) Peso",dataType:"number",width:120,visibleIndex:9,allowFiltering:!1,allowFixing:!1,allowGrouping:!1,allowHeaderFiltering:!1,allowHiding:!1,allowReordering:!1,allowResizing:!1,allowSearch:!1,allowSorting:!1,cellTemplate:(a,e)=>{"raiz"==e.key?e.data.total_peso_atividades&&(e.data.total_peso_atividades=Number(e.data.total_peso_atividades),Number.isInteger(e.data.total_peso_atividades)&&(e.data.total_peso_atividades=+e.data.total_peso_atividades),100!==e.data.total_peso_atividades?a.append($("<i>",{class:"text-warning fas fa-exclamation-triangle"})).append("&nbsp;").append($("<span>",{class:"text-warning",text:e.data.total_peso_atividades})).attr("title","A soma dos pesos das atividades deve resultar em 100%"):$(a).text(e.data.total_peso_atividades)):"S"==e.data.tipo_atividade&&e.data.total_peso_atividades_filhas?(e.data.total_peso_atividades_filhas=Number(e.data.total_peso_atividades_filhas),Number.isInteger(e.data.total_peso_atividades_filhas)&&(e.data.total_peso_atividades_filhas=+e.data.total_peso_atividades_filhas),$(a).append($("<span>",{text:e.data.total_peso_atividades_filhas})).text(e.data.total_peso_atividades_filhas).attr("title","Soma dos pesos das atividades filhas")):$(a).text(e.value)}};let D=[{dataField:"atividade_simplificada",caption:"Nome da atividade",allowHiding:!1,fixed:!0,validationRules:[{type:"required"}],width:200},{dataField:"codigo",width:100,hidingPriority:24}];if(e){if(D=[...D,{dataField:"sequencia",caption:"Sequência",dataType:"string",allowEditing:!1,hidingPriority:23,width:100,calculateSortValue:function(a){var e;let t=null!==(e=a.sequencia)&&void 0!==e?e:"",i=String(t).split(".");return t="",i.forEach(a=>{t+=pad(a,10)+"."}),t}},{dataField:"marco",dataType:"boolean",hidingPriority:22,width:100},{dataField:"arr_atividades_predecessoras",caption:"Atividades Predecessoras",hidingPriority:21,visible:!a.somente_leitura,editorType:"dxTagBox",calculateCellValue:function(a){return a.arr_atividades_predecessoras?Array.isArray(a.arr_atividades_predecessoras)?a.arr_atividades_predecessoras:JSON.parse(a.arr_atividades_predecessoras):null},calculateDisplayValue:function(e){if(e.arr_atividades_predecessoras){if(Array.isArray(e.arr_atividades_predecessoras))return converterLookup(e.arr_atividades_predecessoras,a.data.atividades,"id","atividade_simplificada");var t=JSON.parse(e.arr_atividades_predecessoras);return converterLookup(t,a.data.atividades,"id","atividade_simplificada")}return null},editorOptions:{dataSource:A(a.data.atividades),showSelectionControls:!0,applyValueMode:"useButtons",displayExpr:"atividade_simplificada",valueExpr:"id"},width:200},{dataField:"projeto_atividade_sintetica_pai_id",caption:"Atividade Pai",hidingPriority:20,visible:!a.somente_leitura,lookup:{dataSource:a.data.atividades_sinteticas,displayExpr:"nome",valueExpr:"id"},width:100},{dataField:"assunto_projetos_id",caption:"Assunto",hidingPriority:19,lookup:{dataSource:a.data.assuntos,displayExpr:"descricao",valueExpr:"assunto_projeto_id"},width:120},{dataField:"classificacao_projeto_atividade_id",caption:"Classificação",hidingPriority:18,lookup:{dataSource:a.data.classificacoes,displayExpr:"nome",valueExpr:"projeto_atividade_classificacao_id"},width:120,visible:!1},{dataField:"status",hidingPriority:17,lookup:{dataSource:v,displayExpr:"Status",valueExpr:"ID"},width:120,cellTemplate:(a,e)=>{let t="default";+e.value===ATIVIDADE_SITUACAO.ANDAMENTO&&(t="info"),+e.value===ATIVIDADE_SITUACAO.CONCLUIDO&&(t="success"),+e.value===ATIVIDADE_SITUACAO.NAO_INICIADO&&(t="warning"),+e.value!==ATIVIDADE_SITUACAO.ATRASADO&&+e.value!==ATIVIDADE_SITUACAO.PROGRAMADO||(t="danger"),$('<div class="label label-'.concat(t,'">')).text(e.displayValue).appendTo(a)}},{dataField:"porcentagem",hidingPriority:16,filterOperations:[],caption:"% Conclusão",dataType:"number",calculateDisplayValue:function(a){let e="0";if("P"==a.tipo_atividade)e=a.projeto_porcentagem_concluido,a.porcentagem_total=e;else if("S"==a.tipo_atividade){r=!1,s=null,d=0,j(l,a.id);let t=f(s);e=parseInt(a.porcentagem)<0||0==t?"0":parseInt(a.porcentagem)>100?"100":Number(t/d).toFixed(2),a.porcentagem_total=e}else e=parseInt(a.porcentagem)<0||null==a.porcentagem?"0":parseInt(a.porcentagem)>100?"100":Number(a.porcentagem).toFixed(2);return e},cellTemplate:(e,t)=>{let i=t.data.porcentagem||t.data.porcentagem_total||null;if(i){let o=function(e){for(var t=0;t<a.data.cores_atividades.length;t++){var i=a.data.cores_atividades[t];if(parseInt(e)>=parseInt(i.inicio)&&parseInt(e)<=parseInt(i.fim))return i}return!1}(i),n=o.cor_fonte||"",d=o.cor||"";$(e).css({color:n,background:d}).text(t.displayValue)}},width:100},{dataField:"tarefas",hidingPriority:15,caption:"Checklist",allowEditing:!1,customizeText:function(a){if(void 0!==a.value&&void 0!==a.target&&("filterPanel"==a.target||"row"==a.target))return a.value.length>0?"".concat(a.value.filter(a=>a.realizado).length," / ").concat(a.value.length):" - "},width:100},{dataField:"horas_previstas",hidingPriority:14,filterOperations:[],editCellTemplate:(a,e)=>{var t={valor:e.value,aoAlterar:a=>{e.setValue(a)}};ReactDOM.render(React.createElement(window.components.TextBoxHora.default,t),a[0])},calculateDisplayValue:function(a){let e="00:00";return"S"==a.tipo_atividade||"P"==a.tipo_atividade?(r=!1,s=null,j(l,a.id),e=g(s),e=e.substr(0,e.length-3)):e=a.horas_previstas,e},width:100},{dataField:"horas_trabalhadas",hidingPriority:13,filterOperations:[],format:"decimal fixedPoint",customizeText:function(a){return b(a.value)},calculateSortValue:function(a){let e="000:00";return"S"==a.tipo_atividade||"P"==a.tipo_atividade?(r=!1,s=null,j(l,a.id),e=w(s)):(void 0!==a.horas_trabalhadas&&null!==a.horas_trabalhadas&&""!==a.horas_trabalhadas||(a.horas_trabalhadas="000:00"),e=b(a.horas_trabalhadas)),e?fn_converter_horas_para_segundos(e):null},calculateDisplayValue:function(a){let e="000:00";return"S"==a.tipo_atividade||"P"==a.tipo_atividade?(r=!1,s=null,j(l,a.id),e=w(s)):(void 0!==a.horas_trabalhadas&&null!==a.horas_trabalhadas&&""!==a.horas_trabalhadas||(a.horas_trabalhadas="000:00"),e=b(a.horas_trabalhadas)),e},width:100},{dataField:"saldo_horas",hidingPriority:12,filterOperations:[],format:"decimal fixedPoint",customizeText:function(a){return b(a.value)},calculateSortValue:function(a){let e="000:00";return"S"==a.tipo_atividade||"P"==a.tipo_atividade?(r=!1,s=null,j(l,a.id),e=subtrair_horas(g(s),w(s))):(void 0!==a.saldo_horas&&null!==a.saldo_horas&&""!==a.saldo_horas||(a.saldo_horas="000:00"),e=b(a.saldo_horas)),e?fn_converter_horas_para_segundos(e):null},calculateDisplayValue:function(a){let e="000:00";return"S"==a.tipo_atividade||"P"==a.tipo_atividade?(r=!1,s=null,j(l,a.id),e=subtrair_horas(g(s),w(s))):(void 0!==a.saldo_horas&&null!==a.saldo_horas&&""!==a.saldo_horas||(a.saldo_horas="000:00"),e=b(a.saldo_horas)),e},width:100},{dataField:"tipo_cancelamento_ignorar_prev_real",caption:"Ignorar Prev./Realiz. Quando Cancelada",hidingPriority:11,dataType:"boolean",width:170,visible:!1},{dataField:"nome_executores",caption:"Executores",hidingPriority:10,filterOperations:[],width:150},{dataField:"responsavel_nome",caption:"Responsável",hidingPriority:9,filterOperations:[],width:150,visible:!1},{dataField:"tipo_previsao_inicio",caption:"Tipo Prev. Ini",hidingPriority:8,lookup:{dataSource:m,displayExpr:"Tipo",valueExpr:"ID"},width:120},{dataField:"previsao_inicio",caption:"Prev. Ini",hidingPriority:7,dataType:"date",format:c,width:100,setCellValue:function(a,e){a.tipo_previsao_inicio!=TIPO_PREVISAO_INICIO.DEVE_INICIAR_EM&&(a.tipo_previsao_inicio=TIPO_PREVISAO_INICIO.DEVE_INICIAR_EM),this.defaultSetCellValue(a,e)},allowHeaderFiltering:!1},{dataField:"inicio",caption:"Início real",hidingPriority:6,dataType:"date",format:c,width:100,allowHeaderFiltering:!1},{dataField:"prazo",caption:"Prev. Conclusão",hidingPriority:5,dataType:"date",format:c,width:100,allowHeaderFiltering:!1},{dataField:"conclusao",caption:"Conclusão",hidingPriority:4,dataType:"date",format:c,width:100,allowHeaderFiltering:!1},C],i==PROJETO_CONTROLE_BASELINE.PROJETO){for(let B=0;B<t.length;B++){k(t[B])}function k(a){let e={dataField:"inicio_previsto_baseline_"+a,hidingPriority:3,caption:"Inicio Previsto Baseline ("+a+")",dataType:"date",format:c,width:100,allowEditing:!1,allowHeaderFiltering:!1},t={dataField:"termino_previsto_baseline_"+a,caption:"Término Previsto Baseline ("+a+")",hidingPriority:2,dataType:"date",format:c,width:100,allowEditing:!1,allowHeaderFiltering:!1},i={dataField:"trabalho_previsto_baseline_"+a,caption:"Trabalho Previsto Baseline ("+a+")",hidingPriority:1,dataType:"string",width:100,allowEditing:!1};D.push(e,t,i)}}else i==PROJETO_CONTROLE_BASELINE.ATIVIDADE&&D.push({dataField:"inicio_previsto_baseline",caption:"Início Previsto Baseline",hidingPriority:3,dataType:"date",format:c,allowEditing:!1,width:100,allowHeaderFiltering:!1},{dataField:"termino_previsto_baseline",caption:"Termino Previsto Baseline",hidingPriority:2,dataType:"date",format:c,allowEditing:!1,width:100,allowHeaderFiltering:!1},{dataField:"trabalho_previsto_baseline",caption:"Trabalho Previsto Baseline",hidingPriority:1,format:"decimal fixedPoint",allowEditing:!1,customizeText:function(a){if(void 0===a.value||void 0===a.target||"filterPanel"!=a.target&&"row"!=a.target||!a.value)return"000:00";{let e=a.value.indexOf(":");return a.value=a.value.replaceAll(":",""),a.value.substring(0,e)+":"+a.value.substring(e,e+2)}},width:100});!a.projeto||"S"!=a.projeto.utiliza_peso_atividades&&!0!==a.projeto.utiliza_peso_atividades||D.push(R)}const V=D.filter(a=>a&&"string"==typeof a.dataField).map(a=>a.dataField),F=["apontamento_projeto","projeto_predecessora"].includes(a.parametro_usuario)?null:window.components.DataGridPadrao.stateStoring(a.parametro_usuario,V);let M={dataSource:o?a.data.atividades.filter(a=>"A"===a.tipo_atividade).map(a=>(a.projeto_atividade_sintetica_pai_id=null,a)):a.data.atividades,keyExpr:"id",parentIdExpr:"projeto_atividade_sintetica_pai_id",showBorders:!0,expandedRowKeys:["raiz"],columnResizingMode:detectmob()?"nextColumn":"widget",columnHidingEnabled:!!detectmob(),rowAlternationEnabled:!1,searchPanel:{visible:!detectmob(),width:200,placeholder:"Pesquisa geral"},onRowPrepared:function(a){"data"==a.rowType&&("S"!=a.data.tipo_atividade&&"P"!=a.data.tipo_atividade||a.rowElement.css("font-weight","bold"))},onToolbarPreparing:function(e){let t=null;a.obj_solicitacao&&(t={widget:"dxButton",options:{icon:"assets/img/icones_bp/processos.svg",hint:a.obj_solicitacao.entrega?"S"==a.obj_solicitacao.cancelada?"Atividade da solicitação #"+a.obj_solicitacao.id+" cancelada":"Atividade da solicitação #"+a.obj_solicitacao.id+" concluída":"Dar continuidade no processo "+a.obj_solicitacao.solicitacao.versao_processo.nome,text:a.obj_solicitacao.entrega?"S"==a.obj_solicitacao.cancelada?"Atividade da solicitação #"+a.obj_solicitacao.id+" cancelada":"Atividade da solicitação #"+a.obj_solicitacao.id+" concluída":"Dar continuidade no processo "+a.obj_solicitacao.solicitacao.versao_processo.nome,onClick:function(){View.load("solicitacao/detalhes",function(e,t){t.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&h()})},t.show(a.obj_solicitacao.id,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS,null,null,{solicitacaoAtividadeId:a.obj_solicitacao.id})},onInitialized:function(e){e.component.element().addClass("S"==a.obj_solicitacao.cancelada?"bg-danger":"bg-success")},visible:parseInt(a.projeto.porcentagem_concluido)>=parseInt(a.obj_solicitacao.projeto_conclusao)},showText:"inMenu",location:"after",name:"BtnSolicitacao",locateInMenu:"auto"});let i=[{widget:"dxDropDownButton",location:"before",name:"BtnGroupAdd",locateInMenu:"auto",visible:!a.somente_leitura&&(a.planejamento_atividade||a.gerente_projeto||App.sessao.dados.admin),options:{text:"Adicionar",icon:"plus",displayExpr:"name",keyExpr:"id",items:[{id:1,name:"Atividade Analítica",tipo_atividade:"analitica"},{id:2,name:"Atividade Sintética",tipo_atividade:"sintetica"}],onItemClick:e=>{"analitica"===e.itemData.tipo_atividade?E.addRow("raiz"):"sintetica"===e.itemData.tipo_atividade&&View.load("atividade_projeto/atividade_sintetica_detalhes",function(e,t){let i={projeto_id:a.projeto.id,gerente_projeto:a.gerente_projeto,planejamento_datas:a.planejamento_datas};t.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&h()})},t.show(i)},View.ABA.NAO)}}},{widget:"dxDropDownButton",location:"before",name:"BtnImportExport",locateInMenu:"auto",visible:!a.somente_leitura&&(a.planejamento_atividade||a.gerente_projeto||App.sessao.dados.admin),options:{text:"Importar/Exportar",icon:"fa fa-exchange-alt",items:[{id:"importar_template",text:"Importar Template",icon:"fa fa-list"},{id:"exportar_marco",text:"Exportar Marco",icon:"fa fa-file-excel"},{id:"exportar_planilha",text:"Exportar Planilha",icon:"fa fa-file-excel"},{id:"importar_planilha",text:"Importar Planilha",icon:"fa fa-file-excel"},{id:"importar_msproject",text:"Importar XML (MS Project)",icon:"fa fa-file-code"},{id:"exportar_msproject",text:"Exportar XML (MS Project)",icon:"fa fa-file-code"}],onItemClick:function(e){switch(e.itemData.id){case"importar_template":a.importar_template();break;case"exportar_marco":a.exportar_marco();break;case"exportar_planilha":a.exportar_template();break;case"importar_planilha":a.importar_excel();break;case"importar_msproject":a.importar_msproject();break;case"exportar_msproject":a.exportar_msproject()}}}}];e.toolbarOptions.items=add_botao_dx_toolbar(i,e.toolbarOptions.items);let o=[{widget:"dxButton",options:{text:"Editar Projeto",hint:"Editar Projeto",icon:"glyphicon glyphicon-th-list",onClick:()=>{a.editar_projeto()}},visible:!a.somente_leitura&&(a.planejamento_atividade||a.gerente_projeto||App.sessao.dados.admin),location:"after",name:"BtnEnumerarTopicos",locateInMenu:"auto",showText:"inMenu"},{widget:"dxButton",options:{text:"Gerar sequência das atividades",hint:"Gerar sequência das atividades",icon:"orderedlist",onClick:e=>{WS.post("/atividade_projeto/gerar_sequencia_atividades/",{projeto_id:a.projeto.id,atividades:l&&l.children&&l.children.length?window.CircularJSON.stringify(l.children[0]):[]},a=>{!0===a?(window.alert_saved("Operação concluída com sucesso"),h()):window.alert_fail("Ocorreu uma falha na operação")})}},visible:!a.somente_leitura&&(a.planejamento_atividade||a.gerente_projeto||App.sessao.dados.admin),location:"after",name:"BtnEnumerarTopicos",locateInMenu:"auto",showText:"inMenu"},{widget:"dxButton",options:{icon:"fa fa-sync",hint:"Recarregar listagem de atividades",text:"Recarregar listagem de atividades",onClick:function(){h()},visible:!a.somente_leitura},showText:"inMenu",location:"after",name:"BtnRefresh",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-expand-alt",hint:"Expandir todas as atividades",text:"Expandir todas as atividades",onClick:function(){let a=x(l);E.beginUpdate(),a.forEach(function(a){E.expandRow(a)}),E.endUpdate()}},showText:"inMenu",location:"after",name:"BtnExpandAll",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-compress-alt",hint:"Recolher todas as atividades",text:"Recolher todas as atividades",onClick:function(){let a=x(l);E.beginUpdate(),a.forEach(function(a){E.collapseRow(a)}),E.endUpdate()}},showText:"inMenu",location:"after",name:"BtnCollapseAll",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"glyphicon glyphicon-envelope",hint:"Enviar E-mail",text:"Enviar E-mail",onClick:function(){a.abrir_email()}},showText:"inMenu",location:"after",name:"BtnCollapseAll",locateInMenu:"auto"},t];e.toolbarOptions.items=add_botao_dx_toolbar(o,e.toolbarOptions.items);for(let t=0;t<e.toolbarOptions.items.length;t++){const i=e.toolbarOptions.items[t];"saveButton"===i.name&&(i.options.onClick=function(t){const i=e.component.getController("validating")._validationState;let o=!1;if(i.length)for(let a=0;a<i.length;a++){if(!1===i[a].isValid){o=!0;break}}if(o)return window.alertaPopUp("Validação","Realize os ajustes dos valores inválidos antes de continuar."),!1;WS.post("atividade_projeto/salvar_dxtreelist/",{projeto_id:a.projeto.id,data:CircularJSON.stringify(E.getController("editing").getChanges())},function(a){alert_tooltip(!0===a?"Todas as atividades foram salvas":"Falha ao salvar as atividades",!0===a?"success":"error"),!0===a&&(E.saveEditData(),setTimeout(function(){h()}))})})}},onContentReady:function(e){add_filtro_cor_tema(e);const t=E.getCellElement(0,"porcentagem");if(t&&a.projeto&&(a.projeto.cor_execucao&&t.css("background",a.projeto.cor_execucao),a.projeto.cor_execucao_fonte&&t.css("color",a.projeto.cor_execucao_fonte)),n.state.clearState&&(E.state({}),n.setState({clearState:!1})),l=e.component.getRootNode(),E.getDataSource().sort())E.option("rowDragging.allowReordering",!1);else if(!a.somente_leitura){E.option("rowDragging.allowReordering",!0);let e=[];const t=function(i){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(a.somente_leitura)return!1;i.data.id&&e.push({id:i.data.id,tipo_atividade:i.data.tipo_atividade,ordem:o}),i.hasChildren&&i.children.forEach((a,e)=>t(a,e+1))};void 0!==l&&t(l.children[0]);const i={projeto_id:a.projeto.id,atividades:e};WS.post({route:"atividade_projeto/salvar_ordem/",data:i,func_response:a=>{}})}},onEditorPreparing:function(e){if(!a.somente_leitura){let t=!1,i=!1,o=!1,n=!1;switch(a.planejamento_atividade||a.gerente_projeto||App.sessao.dados.admin||(o=!0),e.dataField){case"assunto_projetos_id":case"classificacao_projeto_atividade_id":case"tipo_cancelamento_ignorar_prev_real":case"inicio":case"conclusao":i=!0;break;case"status":t=!0,i=!0;break;case"porcentagem":case"horas_previstas":i=!0,n=!0;break;case"horas_trabalhadas":case"saldo_horas":case"nome_executores":case"responsavel_nome":t=!0,i=!0,n=!0;break;case"codigo":"S"==a.projeto.bloquear_codigo&&(t=!0,i=!0)}"dataRow"==e.parentType&&("A"==e.row.data.tipo_atividade&&t||"S"==e.row.data.tipo_atividade&&i||null==e.row.data.tipo_atividade&&t||"P"==e.row.data.tipo_atividade||o)&&(e.editorOptions.disabled=!0),"filterRow"==e.parentType&&n&&(e.cancel=!0),"dxSelectBox"==e.editorName&&(e.editorOptions.onOpened=function(a){a.component._popup.option("resizeEnabled",!0),a.component._popup.option("width",300)});let d=e.editorOptions.onValueChanged;e.editorOptions.onValueChanged=function(t){if(d.apply(this,arguments),"previsao_inicio"==e.dataField){let i=e.row.rowIndex;if(t.value&&e.row.data.prazo_dias>0){let o=t.value,n=o.getFullYear(),d=String(o.getMonth()+1).padStart(2,"0"),r=String(o.getDate()).padStart(2,"0"),l="".concat(n,"-").concat(d,"-").concat(r),s=fn_dias_uteis(a.data.projeto.calendario_trabalho_id,l,e.row.data.prazo_dias);e.component.cellValue(i,"prazo",s)}}}}},selection:y,filterRow:{visible:!0,applyFilter:"auto"},headerFilter:{visible:!0,texts:{emptyValue:"(Vazio)"}},filterPanel:{visible:!0},sorting:{mode:"multiple"},allowColumnReordering:!0,allowColumnResizing:!0,columnChooser:{enabled:!0,allowSearch:!0,mode:_},columnFixing:{enabled:!0},stateStoring:F,focusedRowEnabled:!1,editing:S,columns:D,onInitNewRow:function(e){e.data.marco=!1,e.data.status="4",e.data.tipo_cancelamento_ignorar_prev_real="S"===a.projeto.tipo_cancelamento_ignorar_prev_real,e.data.nova_atividade_analitica=!0},onEditingStart:function(e){e.data.tipo_previsao_inicio!=TIPO_PREVISAO_INICIO.O_MAIS_BREVE_POSSIVEL||"previsao_inicio"!=e.column.dataField&&"prazo"!=e.column.dataField||(e.cancel=!0),"A"==e.data.tipo_atividade&&"porcentagem"==e.column.dataField&&e.data.tarefas.length>0&&(e.cancel=!0),"S"!=e.data.tipo_atividade&&"P"!=e.data.tipo_atividade||"horas_previstas"!=e.column.dataField||(e.cancel=!0),"porcentagem_peso"==e.column.dataField&&("A"===e.data.tipo_atividade||e.data.nova_atividade_analitica||"S"===a.projeto.utiliza_peso_atividades||!0===a.projeto.utiliza_peso_atividades||(e.cancel=!0))},onEditorPrepared:function(a){if("horas_previstas"==a.dataField){var e={mask:"999:59",definitions:{5:{validator:"[0-5]"}}};a.editorElement.find("input").last().inputmask(e),a.editorElement.find("input").last().on("blur",function(){var a=$(this).val(),t=Inputmask.isValid($(this).val(),e);a.trim().length>0&&!t&&(alert_warning(a+" não é um valor válido!"),$(this).val("000:00").trigger("change"))})}else"previsao_inicio"!=a.dataField&&"inicio"!=a.dataField&&"prazo"!=a.dataField&&"conclusao"!=a.dataField||a.editorElement.find("input").last().mask("99/99/99")},selectedRowKeys:P?[P]:[],onSelectionChanged:O,onNodesInitialized:function(a){l=a.root},onContextMenuPreparing:function(e){if("header"==e.target&&Array.isArray(e.items)&&e.items.push({text:"Restaurar estado das colunas",visible:!0,beginGroup:!0,onItemClick:function(a){DevExpress.ui.dialog.confirm("Os filtros, ordenações, agrupamentos, posição, tamanho, e visibilidade das colunas desta listagem serão restauradas ao estado padrão. <b>Deseja continuar?</b>","Restaurar estado das colunas").done(function(a){a&&(n.setState({clearState:!0}),h())})}}),e.row&&"data"===e.row.rowType&&((a.gerente_projeto||App.sessao.dados.admin)&&"A"==e.row.data.tipo_atividade&&(e.row.data.cancelada?e.items=[{text:"Desfazer cancelamento da atividade",visible:!0,onItemClick:function(){I(e.row.data,!1)}}]:e.items=[{text:"Cancelar atividade",visible:!0,onItemClick:function(){I(e.row.data,!0,"S"===a.projeto.tipo_cancelamento_ignorar_prev_real)}},{text:"Mais opções",items:[{text:"Cancelar atividade e considerar previsto/realizado"+("N"==a.projeto.tipo_cancelamento_ignorar_prev_real?" (Padrão)":""),visible:!0,onItemClick:function(){I(e.row.data,!0,!1)}},{text:"Cancelar atividade e ignorar previsto/realizado"+("S"==a.projeto.tipo_cancelamento_ignorar_prev_real?" (Padrão)":""),visible:!0,onItemClick:function(){I(e.row.data,!0,!0)}}]}]),l&&l.children&&l.children.length)){function t(a,e){if(a.hasOwnProperty("level")){const t=a.level;!e.includes(t)&&a.hasChildren&&e.push(t)}if(a.hasOwnProperty("children")&&Array.isArray(a.children))for(const i of a.children)t(i,e)}const i=[];if(t(l.children[0],i),i.length){void 0!==e.items&&e.items.length||(e.items=[]),e.items.push({text:"Estrutura de tópicos",items:[]});const o=e.items.length-1;for(let d=0;d<i.length;d++){let r=i[d];e.items[o].items.push({text:"Nível ".concat(r),level:r,onItemClick:a=>{function e(a,t,i){if(a.hasOwnProperty("key")&&(i.includes(a.key)||a.level!=t||i.push(a.key)),a.hasOwnProperty("children")&&Array.isArray(a.children))for(const o of a.children)e(o,t,i)}let t=[];for(let i=0;i<=a.itemData.level;i++)e(l.children[0],i,t);if(t.length){function o(a,e){return new Promise(t=>{a.beginUpdate();for(const t of e)a.collapseRow(t);t()})}function n(a,e){return new Promise(t=>{for(const t of e)a.expandRow(t);a.endUpdate(),t()})}let d=x(l);o(E,d).then(()=>n(E,t)).catch(a=>{console.error("Erro na estrutura de tópicos. Verifique o erro abaixo."),console.error(a)})}}})}}}},rowDragging:a.somente_leitura?null:{allowDropInsideItem:!1,allowReordering:!a.somente_leitura,onReorder(e){const t=e.component.getVisibleRows(),i=e.itemData,o=e.fromIndex>e.toIndex?e.toIndex-1:e.toIndex;let n=o>=0?t[o].node.data:null;const d=a.data.atividades.indexOf(i);a.data.atividades.splice(d,1);const r=a.data.atividades.indexOf(n)+1;a.data.atividades.splice(r,0,i),e.component.refresh()}}};a.dropdown?a.div.find(".div_listagem_atividade_projeto").dxDropDownBox({value:a.atividade_selecionada?a.atividade_selecionada.toString():null,valueExpr:"id",displayExpr:function(a){return a&&a.atividade_simplificada},placeholder:"Escolha...",disabled:0===a.data.length||void 0!==a.dropdown_disabled&&!0===a.dropdown_disabled,showClearButton:!0,dataSource:a.data.atividades,contentTemplate:function(a){T=a,P=a.component.option("value");let t=document.createElement("div");t.className="div_listagem_atividade_projeto_popup",t.style="min-width: 100%;",$(t).css("height",e?"calc(100vh - 76px)":"100%");let i=$(t).dxTreeList(M);return E=i.dxTreeList("instance"),a.component.on("valueChanged",function(a){E.selectRows(a.value,!1)}),i},onFocusIn:function(a){$("html,body").scrollTop(0),setTimeout(function(){a.component.open()},100)},onOpened:function(a){e?(a.component._popup.option("fullScreen",!0),a.component._popup.option("showTitle",!0),a.component._popup.option("showCloseButton",!0),a.component._popup.content().parents(".dx-popup-fullscreen").css("max-height","none").css("overflow-y","scroll"),a.component._popup.content().parents(".dx-popup-wrapper").css("width","100%").css("max-height","100vh").css("height","100%")):(a.component._popup.content().parents(".dx-popup-normal").css("width","50vw"),E.updateDimensions())},onInitialized:function(e){a.atividade_selecionada&&e.component._$element.attr("id",a.atividade_selecionada)}}):(E=a.div.find(".div_listagem_atividade_projeto").dxTreeList(M).dxTreeList("instance"),this.props.treeList=E)}}render(){return!1}}return t});