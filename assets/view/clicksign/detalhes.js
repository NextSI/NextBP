define([],function(){return function(o){"use strict";var a=this;this.html_id=o,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title="Histórico Documentos - Clicksign",this.onclose=null,this.onsave=null,this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_refresh=this.dialog.find(".btn_refresh"),this.btn_solicitar_assinaturas=this.dialog.find(".btn_solicitar_assinaturas"),this.treelist_historico_documento_clicksign=this.dialog.find(".treelist_historico_documento_clicksign"),this.div_job_scheduler_ativo=this.dialog.find(".div_job_scheduler_ativo"),this.btn_job_scheduler=this.dialog.find(".btn_job_scheduler"),this.documento_revisao_id=null,this.usuario_permissao_escrita=null,this.grupo_usuario_permissao_escrita=null,this.job_scheduler_ativo=!1,this.existe_reprocessamento_pendente=!1,this.show=function(o,i){a.documento_revisao_id=o,void 0!==i&&(a.usuario_permissao_escrita=i.usuario_permissao_escrita||"S",a.grupo_usuario_permissao_escrita=i.grupo_usuario_permissao_escrita||"S"),a.listar(),show_modal(a.modal.attr("id"))},this.listar=function(){WS.get("documento_revisao_assinatura/listar_eventos_por_revisao/",{documento_revisao_id:a.documento_revisao_id,plataforma:"clicksign"},function(o){a.job_scheduler_ativo=!0===o.job_scheduler_ativo,a.montaTreeList(o.listagem)})},this.exibir_div_job_scheduler_ativo=()=>{!1===a.job_scheduler_ativo&&!0===a.existe_reprocessamento_pendente?a.div_job_scheduler_ativo.show():a.div_job_scheduler_ativo.hide()},this.onTreeContextMenuPreparing=o=>{o.row&&"data"===o.row.rowType&&(o.items=[{text:"Download",visible:"A"!==o.row.data.situacao&&parseInt(o.row.data.signed_document_tamanho,10)>0,onItemClick:()=>a.download(o)},{text:"Reprocessar download do documento assinado",visible:"A"!==o.row.data.situacao&&!o.row.data.reprocessar_download,onItemClick:()=>a.reprocessar_download(o)},{text:"Cancelar reprocessamento de download",visible:"A"!==o.row.data.situacao&&o.row.data.reprocessar_download,onItemClick:()=>a.reprocessar_download(o,!0)}])},this.download=o=>{const i=o.row.data.documento_revisao_assinatura_id;App.obter_token_publico(o=>{App.download(WS_URI+"documento/download/?documento_revisao_id="+a.documento_revisao_id+"&documento_revisao_assinatura_id="+i+"&token_publico="+o)})},this.reprocessar_download=(o,i=!1)=>{const t=o.row.data.documento_revisao_assinatura_id;WS.post("documento_revisao_assinatura/reprocessar_download/",{documento_revisao_id:a.documento_revisao_id,documento_revisao_assinatura_id:t,plataforma:"clicksign",cancelar:i},o=>{a.job_scheduler_ativo=!0===o.job_scheduler_ativo,a.montaTreeList(o.listagem)})},this.montaTreeList=function(o){a.existe_reprocessamento_pendente=!1;for(let i=0;i<o.length;i++){const t=o[i];if("A"!==t.situacao&&!0===t.reprocessar_download){a.existe_reprocessamento_pendente=!0;break}}a.exibir_div_job_scheduler_ativo(),a.treelist_historico_documento_clicksign.dxTreeList({dataSource:o,showBorders:!0,keyExpr:"id",parentIdExpr:"pai_id",editing:{useIcons:!0},rowAlternationEnabled:!1,onRowPrepared:function(o){"data"===o.rowType&&"C"===o.data.situacao&&o.rowElement.find("td").css("background","#ffcdd2")},onContextMenuPreparing:a.onTreeContextMenuPreparing,columns:[{dataField:"solicitante_nome",caption:"Solicitante"},{dataField:"data_envio",caption:"Data de Envio",dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss"},{dataField:"situacao",caption:"Situação",alignment:"center",cellTemplate:function(o,a){var i="",t="";switch(a.data.situacao){case"A":t="Aguardando",i="label label-warning";break;case"F":t="Finalizado",i="label label-success";break;case"C":t="Cancelado",i="label label-danger"}$("<span class='"+i+"'>"+t+"</span>").appendTo(o)}},{dataField:"nome_arquivo",caption:"Nome do Arquivo"},{dataField:"nome_completo",caption:"Signatário"},{dataField:"event_occurred_at",caption:"Data Assinatura",width:130,dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss"},{type:"buttons",buttons:[{hint:"Download",icon:"fa fa-download",visible:function(o){return 0===o.row.level&&"A"!==o.row.data.situacao&&parseInt(o.row.data.signed_document_tamanho,10)>0},onClick:a.download},{hint:!1===a.job_scheduler_ativo?"Configuração Pendente":"Reprocessando Download",visible:function(o){return 0===o.row.level&&"A"!==o.row.data.situacao&&!0===o.row.data.reprocessar_download},template:function(){return!1===a.job_scheduler_ativo?$('<i class="fas fa-exclamation-triangle text-warning"></i>'):$('<i class="fas fa-cog fa-spin text-info"></i>')}},{hint:"Cancelar Assinatura",icon:"fa fa-thumbs-down",cssClass:"icon_red",visible:function(o){return 0===o.row.level&&("S"===a.usuario_permissao_escrita||"S"===a.grupo_usuario_permissao_escrita)&&"F"!==o.row.data.situacao&&"C"!==o.row.data.situacao},onClick:function(o){a.cancelar_documento_assinado(o.row.data.clicksign_document_key)}}]}],showRowLines:!0})},this.cancelar_documento_assinado=function(o){alert_modal("Aviso","Deseja cancelar esta solicitação de assinatura?","Sim",function(){WS.get("clicksign/cancelar_assinatura/",{clicksign_document_key:o},function(o){alert_modal("Atenção","Solicitação de cancelamento enviado com sucesso! <br><br> A situação será atualizada automaticamente após o Clicksign confirmar o cancelamento.","OK")})},!0,"Não")},this.close=function(){close_modal(a.modal.attr("id")),void 0!==a.onclose&&a.onclose&&a.onclose()},this.unload=function(){a.close(),View.unload(this.html_id)},this.btn_refresh.unbind("click"),this.btn_refresh.click(function(){a.listar()}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){a.unload()}),this.btn_solicitar_assinaturas.unbind("click"),this.btn_solicitar_assinaturas.click(function(){View.load("clicksign/configurar_signatarios",function(o,i){i.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==a.html_id&&a.listar()})},i.show(a.documento_revisao_id,!0)},View.ABA.SIM)}),this.btn_job_scheduler.on("click",()=>{View.load("job_scheduler/listar",o=>{},View.ABA.SIM)})}});