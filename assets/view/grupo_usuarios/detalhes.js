define([],function(){return function(a){"use strict";var i=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.title=this.modal.find(".modal-title").text(),this.tipo=null,this.onclose=null,this.tab_listagem=this.dialog.find(".tab_listagem"),this.cbo_usuarios=this.dialog.find(".cbo_usuarios"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.btn_usuario_remover=this.dialog.find(".btn_usuario_remover"),this.edt_usuario=null,this.edt_nome_usuario=this.dialog.find(".edt_nome_usuario"),this.edt_email_usuario=this.dialog.find(".edt_email_usuario"),this.edt_nome=this.dialog.find(".edt_nome"),this.painel_usuario=this.dialog.find(".painel_usuario"),this.grupo_usuarios_id=null,this.arr_usuarios=[],this.array_send=[],this.limite=0,this.continua_listagem=!0,this.btn_carregar_mais=i.painel_usuario.find(".btn_carregar_mais"),this.txt_carregar_mais=i.painel_usuario.find(".txt_carregar_mais"),this.check_agenda=this.dialog.find(".check_agenda"),this.check_chamados=this.dialog.find(".check_chamados"),this.check_documentos=this.dialog.find(".check_documentos"),this.check_processos=this.dialog.find(".check_processos"),this.check_projetos=this.dialog.find(".check_projetos"),this.check_crm=this.dialog.find(".check_crm"),this.check_social=this.dialog.find(".check_social"),this.check_inovacao=this.dialog.find(".check_inovacao"),this.check_pdca=this.dialog.find(".check_pdca"),this.show=function(a,r){switch(r){case FORMULARIO.NOVO:case FORMULARIO.EDITAR:i.btn_salvar.show(),i.btn_excluir.hide(),i.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:i.btn_salvar.hide(),i.btn_excluir.hide(),i.permite_alterar(!1);break;case FORMULARIO.EXCLUIR:i.btn_salvar.hide(),i.btn_excluir.show(),i.permite_alterar(!1)}setTimeout(function(){null==i.edt_usuario&&(create_combobox(i.cbo_usuarios,i.listar_usuarios),i.edt_usuario=i.cbo_usuarios.parent().find(".edt_combobox"),i.edt_usuario.keypress(function(a){if(13==a.keyCode||13==a.tecla_value){var r=i.cbo_usuarios.parent().find("[selected-value]").attr("selected-value"),e=$(this),s=e.attr("dados-adicionais")?e.attr("dados-adicionais"):null;WS.get("grupo_usuarios/verifica_usuario/",{usuario_id:r,grupo_usuarios_id:i.grupo_usuarios_id},function(a){var e={};if(e.nome=i.edt_usuario.val(),e.usuario_id=r,e.email=s,e.removido=!1,0==a){for(var o=!1,t=0;t<i.array_send.length;t++){var u=i.array_send[t];u.usuario_id==e.usuario_id&&0==u.removido?o=!0:u.usuario_id==e.usuario_id&&1==u.removido&&(i.array_send[t].removido=!1,o=!0)}o||(i.array_send.push(e),i.render_usuarios(e))}})}}))},150),i.tipo=r,void 0!==a&&a&&(i.grupo_usuarios_id=a,i.preencher()),show_modal(i.modal.attr("id")),setTimeout(function(){i.modal.css("opacity",1)},150),set_focus(i.edt_nome)},this.listar_usuarios=function(a,r){WS.get("usuario/listar/",{nome:i.edt_usuario.val(),limite:0},function(r){limpar_combobox(i.cbo_usuarios),$(r).each(function(a,r){var e=[];e.Nome=r.nome,add_option_combobox(i.cbo_usuarios,a,r.usuario_id,e,null,r.email)}),i.cbo_usuarios.next().find(".ul_row").bind("mousedown",function(){var a=$(this).parent().attr("id_registro"),r=($(this).parent().parent().parent().parent().parent().parent(),$(this).parent()),e=r.attr("dados-adicionais")?r.attr("dados-adicionais"):null,s=r.find("span").text();WS.get("grupo_usuarios/verifica_usuario/",{usuario_id:a,grupo_usuarios_id:i.grupo_usuarios_id},function(r){var o={};if(o.nome=s,o.usuario_id=a,o.email=e,o.removido=!1,0==r){for(var t=!1,u=0;u<i.array_send.length;u++){var c=i.array_send[u];c.usuario_id==o.usuario_id&&0==c.removido?t=!0:c.usuario_id==o.usuario_id&&1==c.removido&&(i.array_send[u].removido=!1,t=!0)}t||(i.array_send.push(o),i.render_usuarios(o))}})}),a&&a(!0)})},this.close=function(){close_modal(i.modal.attr("id")),void 0!==i.onclose&&i.onclose&&i.onclose()},this.unload=function(){i.close(),View.unload(this.html_id)},this.permite_alterar=function(a){i.edt_nome.prop("readonly",!a),i.cbo_usuarios.prop("disabled",!a),i.btn_usuario_remover.prop("disabled",!a)},this.carregar_usuarios=function(a){WS.get("grupo_usuarios/carregar_usuarios_grupo/",{grupo_usuarios_id:i.grupo_usuarios_id,nome:i.edt_nome_usuario.val(),email:i.edt_email_usuario.val(),limite:i.limite},function(r){a&&i.tab_listagem.find(".rows").remove(),i.continua_listagem=!(r.length<5),i.arr_usuarios=r,i.render_usuarios()})},this.preencher=function(){WS.get("grupo_usuarios/objeto/",{grupo_usuarios_id:i.grupo_usuarios_id,no_users:!0},function(a){i.check_agenda.prop("checked","S"==a.agenda).change(),i.check_chamados.prop("checked","S"==a.chamados).change(),i.check_documentos.prop("checked","S"==a.documentos).change(),i.check_processos.prop("checked","S"==a.processos).change(),i.check_projetos.prop("checked","S"==a.projetos).change(),i.check_crm.prop("checked","S"==a.crm).change(),i.check_social.prop("checked","S"==a.social).change(),i.check_inovacao.prop("checked","S"==a.inovacao).change(),i.check_pdca.prop("checked","S"==a.pdca).change(),i.edt_nome.val(a.nome),i.carregar_usuarios()})},this.render_usuarios=function(a){var r=i.tab_listagem.find("tbody"),e=r.find("tr:first"),s=r.find("#tr_carregar_mais"),o=function(a){var s=e.clone();s.removeAttr("template-row"),s.addClass("usuario_id_"+a.usuario_id),s.css("display","").addClass("rows"),$(s.find("[template-field='nome']")).text(a.nome),$(s.find("[template-field='email']")).text(a.email);var o=$(s.find(".btn_usuario_remover"));o.unbind("click"),o.click(function(){alert_modal(i.title,"Deseja remover o usuÃ¡rio?","Remover",function(){s.remove();var r=!1,e=0;$(i.array_send).each(function(i,s){s.usuario_id==a.usuario_id&&(r=!0,e=i)}),r||0!=e?i.array_send[e].removido=!0:(a.removido=!0,i.array_send.push(a))},!0)}),s.appendTo(r)};if(a)a&&(s.css("display","none"),o(a),i.tipo!=FORMULARIO.NOVO&&(s.css("display",""),s.appendTo(r)));else{var t=i.array_send;t=t.filter(function(a){return!($(".usuario_id_"+a.usuario_id).length>0)}),""!=i.edt_email_usuario.val()&&(t=t.filter(function(a){return a.email.indexOf(i.edt_email_usuario.val())>=0})),""!=i.edt_nome_usuario.val()&&(t=t.filter(function(a){return a.nome.indexOf(i.edt_nome_usuario.val())>=0}));var u=[];if(t.length>0&&i.arr_usuarios.length>0)for(var c=0;c<t.length;c++){for(var n=t[c],_=!1,d=0;d<i.arr_usuarios.length;d++){var l=i.arr_usuarios[d];if(l.usuario_id==n.usuario_id&&(_=!0),l.usuario_id==n.usuario_id&&1==n.excluido)i.arr_usuarios.split(d,1);else{for(var h=!1,p=0;p<u.length;p++){u[p].usuario_id==l.usuario_id&&(h=!0)}h||u.push(l)}}_||u.push(n)}else t.length>0?u=t.filter(function(a){var i=!0;return!0===a.removido&&(i=!1),i}):i.arr_usuarios.length>0&&(u=i.arr_usuarios);$(u).each(function(a,e){o(e),a==u.length-1&&i.tipo!=FORMULARIO.NOVO&&(s.css("display",""),s.appendTo(r),!0===i.continua_listagem?(i.txt_carregar_mais.text(App.lang.btn_carregar_mais.carregar_mais_registros),i.txt_carregar_mais.find("span.icn_carregar_mais").remove(),i.txt_carregar_mais.append('&nbsp;<span class="icn_carregar_mais fa fa-arrow-down"></span>')):(i.txt_carregar_mais.text(App.lang.btn_carregar_mais.todos_carregados),i.txt_carregar_mais.find("span.icn_carregar_mais").remove(),i.txt_carregar_mais.append('&nbsp;<span class="icn_carregar_mais fa fa-check"></span>')))})}},this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){i.unload()}),i.btn_carregar_mais.click(function(){!1!==i.continua_listagem&&(i.txt_carregar_mais.text(App.lang.btn_carregar_mais.aguarde),i.txt_carregar_mais.find("span.icn_carregar_mais").remove(),i.txt_carregar_mais.append('&nbsp;<span class="icn_carregar_mais fa fa-spinner fa-spin"></span>'),i.limite=i.limite+5,i.carregar_usuarios())}),this.edt_nome_usuario.unbind("change"),this.edt_nome_usuario.change(function(){i.limite=0,i.carregar_usuarios(!0)}),this.edt_email_usuario.unbind("change"),this.edt_email_usuario.change(function(){i.limite=0,i.carregar_usuarios(!0)}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){WS.post("grupo_usuarios/salvar",{grupo_usuarios_id:i.grupo_usuarios_id,nome:i.edt_nome.val(),usuarios:JSON.stringify(i.array_send),agenda:1==i.check_agenda.prop("checked")?"S":"N",chamados:1==i.check_chamados.prop("checked")?"S":"N",documentos:1==i.check_documentos.prop("checked")?"S":"N",processos:1==i.check_processos.prop("checked")?"S":"N",projetos:1==i.check_projetos.prop("checked")?"S":"N",crm:1==i.check_crm.prop("checked")?"S":"N",social:1==i.check_social.prop("checked")?"S":"N",inovacao:1==i.check_inovacao.prop("checked")?"S":"N",pdca:1==i.check_pdca.prop("checked")?"S":"N"},function(a){i.grupo_usuarios_id=a.id,alert_saved(a.nome+" salvo com sucesso"),i.unload()})}),this.btn_excluir.unbind("click"),this.btn_excluir.click(function(){WS.post("grupo_usuarios/excluir",{grupo_usuarios_id:i.grupo_usuarios_id},function(a){alert_saved(a.nome+" excluido com sucesso"),i.unload()})})}});