define(["react","react-dom","ListarAtividadeProjeto"],function(a,e,t){return function(o){"use strict";var i=this;this.html_id=o,this.dialog=$("#"+this.html_id),this.title="Apontamento Atividade",this.onclose=null,$(this.dialog).attr("viewcode",TELAS.APONTAMENTO_PROJETO_MULTIPLO.codigo),this.cbo_consultor=this.dialog.find(".cbo_consultor"),this.div_cbo_consultor=this.dialog.find(".div_cbo_consultor"),this.cbo_projeto=this.dialog.find(".cbo_projeto"),this.cbo_cliente=this.dialog.find(".cbo_cliente"),this.div_todas_atividades=this.dialog.find(".div_todas_atividades"),this.btn_add_atividade=this.dialog.find(".btn_add_atividade"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.ListarAtividadeProjeto=a.createElement(t,null,null),this.usuario_id=null,this.qtde_atividades=null,this.atividades=null,this.aux=null,this.atividade=null,this.qtde_atv_filhos=null,this.data_fechamento=null,this.show=function(){WS.get("apontamento_projeto/get_parametros/",null,function(a){i.data_fechamento=a.apontamento_data_fechamento}),App.sessao.dados.admin?(i.div_cbo_consultor.removeClass("hidden"),i.listar_consultor(App.sessao.dados.usuario_id)):i.cbo_consultor.prop("disabled",!0),i.adiciona_atividade()},this.listar_consultor=function(a){i.cbo_consultor.find("option").remove(),add_option(i.cbo_consultor,"","-- Selecione --"),WS.get("usuario/listar/",null,function(e){for(var t=0;t<e.length;t++){var o=e[t];add_option(i.cbo_consultor,o.usuario_id,o.nome)}a&&(i.cbo_consultor.val(a).trigger("change"),i.usuario_id=a),i.cbo_consultor.selectpicker("refresh")})},this.incAnexo=function(a,e,t){var o=a.clone();t=1+t,o.find(".anexo_base_label").text("Anexo #"+t);var i=o.find(".checkbox");i.attr("type","checkbox"),i.bootstrapSwitch(!0),o.addClass("anexo_atividade"),o.removeClass("hidden"),o.appendTo(e),o.find('input[type="file"]').trigger("click")},this.adiciona_atividade=function(){var a=i.dialog.find("[template-row='atividade']").clone();a.addClass("div_atividades"),a.removeAttr("template-row"),a.css("display","");var t,o,n=$(a).find("[template-field='cbo_cliente']");t=null,o={entidade_tipo:TIPO_ENTIDADE.CLIENTE,entidade_id:t||void 0,selecionado:t?{tipo:TIPO_ENTIDADE.CLIENTE,id:t.toString()}:void 0,aoAlterar:a=>{i.entidade_tipo=a.tipo,i.cliente_id=a.id,$(n[0]).attr("id",i.cliente_id),i.projeto_id=null,l(i.projeto_id,i.cliente_id)}},ReactDOM.unmountComponentAtNode(n[0]),ReactDOM.render(React.createElement(window.components.SelecaoEntidade.default,o),n[0]);var d=$(a).find("[template-field='cbo_projeto']"),l=async function(a,e){var t=[{dataField:"codigo",caption:"Código",width:"100px"},{dataField:"nome",caption:"Nome do projeto",width:"400px"},{dataField:"status_nome",caption:"Status",width:"150px"},{dataField:"saldo_horas",calculateSortValue:function(a){return a.saldo_horas?window.fn_converter_horas_para_segundos(a.saldo_horas):null},allowFiltering:!1,width:"100px"},{dataField:"cliente_nome",caption:"Nome do Cliente"}],o={cliente_id:e||void 0,selecionado:a?a.toString():void 0,columns:t,readOnly:!e,aoAlterar:async a=>{i.projeto_id=a,$(d[0]).attr("id",i.projeto_id);var e=await s(i.projeto_id);r(e.projeto,e.projeto.permitir_apontamento_projeto_concluido)}};ReactDOM.unmountComponentAtNode(d[0]),ReactDOM.render(React.createElement(window.components.SelecaoProjeto.default,o),d[0])};l(null,null);var r=function(a,e){var t=new Validation;if("S"!=e&&a.projeto_status_id==PROJETO_STATUS.CONCLUIDO)return i.projeto_id=null,t.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Você não pode realizar apontamentos em projetos concluídos.")),alert_modal("Validação",t),!1;a.id?WS.get({route:"atividade_projeto/listar/",data:{projeto_id:a.id},func_response:function(a){a.atividades.push({atividade_simplificada:a.projeto.nome,id:"raiz",projeto_atividade_sintetica_pai_id:null,tipo_atividade:"P",marco:!1,horas_previstas:"000:00"}),x(),u(a)},html_id:i.html_id}):u([])},s=function(a){return new Promise((e,t)=>{WS.get({route:"atividade_projeto/listar/",data:{projeto_id:a},func_response:function(a){a.atividades.push({atividade_simplificada:a.projeto.nome,id:"raiz",projeto_atividade_sintetica_pai_id:null,tipo_atividade:"P",marco:!1,horas_previstas:"000:00"}),i.projeto=a,"undefined"!=typeof callback&&callback(),e(a)},html_id:i.html_id})})},c=$(a).find("[template-field='porcentagem_atividade']");c.addClass("porcentagem_atividade"),c.unbind("change").change(function(){$(this).val($(this).val()>100?100:$(this).val()<0?0:$(this).val())});var u=function(t){var o=$(a).find("[template-field='div_componente_atividades']");e.render(i.ListarAtividadeProjeto,o[0]),i.ListarAtividadeProjeto.props.setParams({div:o,html_id:i.html_id,div_porcentagem:c,data:t,dialog:i.dialog,parametro_usuario:"apontamento_projeto",dropdown:!0,somente_leitura:!0})};u([]);var _=function(){var a=y.getVisibleRows().map(function(a){return{dia:y.cellValue(a.rowIndex,"dia")||null,inicio:y.cellValue(a.rowIndex,"inicio")?formatDateTime(y.cellValue(a.rowIndex,"inicio")).substr(-5):null,fim:y.cellValue(a.rowIndex,"fim")?formatDateTime(y.cellValue(a.rowIndex,"fim")).substr(-5):null,ini_intervalo:y.cellValue(a.rowIndex,"ini_intervalo")?formatDateTime(y.cellValue(a.rowIndex,"ini_intervalo")).substr(-5):null,fim_intervalo:y.cellValue(a.rowIndex,"fim_intervalo")?formatDateTime(y.cellValue(a.rowIndex,"fim_intervalo")).substr(-5):null,subtotal:y.cellValue(a.rowIndex,"subtotal")||null,translado:y.cellValue(a.rowIndex,"translado")?formatDateTime(y.cellValue(a.rowIndex,"translado")).substr(-5):null,total:y.cellValue(a.rowIndex,"total")||null,descricao:y.cellValue(a.rowIndex,"descricao")||null,apontar_despesa:y.cellValue(a.rowIndex,"apontar_despesa")||null,km_rodado:y.cellValue(a.rowIndex,"km_rodado")||null,pedagio:y.cellValue(a.rowIndex,"pedagio")||null,refeicao:y.cellValue(a.rowIndex,"refeicao")||null,outras_despesas:y.cellValue(a.rowIndex,"outras_despesas")||null,despesa_descricao:y.cellValue(a.rowIndex,"despesa_descricao")||null,despesa_observacoes:y.cellValue(a.rowIndex,"despesa_observacoes")||null}});y._$element.prop("id",JSON.stringify(a))},p=$(a).find("[template-field='div_componente_apontamentos']"),m=document.createElement("div");m.className="div_componente_apontamentos",m.style="min-width: 100%;",p.find(".div_componente_apontamentos").remove(),p[0].appendChild(m);var v=get_icon_class(),f=[],h=0,b=[],g=function(a){var e=a.inicio&&a.fim?subtrair_horas(formatDateTime(a.fim).substr(-5),formatDateTime(a.inicio).substr(-5)):"00:00",t=a.ini_intervalo&&a.fim_intervalo?subtrair_horas(formatDateTime(a.fim_intervalo).substr(-5),formatDateTime(a.ini_intervalo).substr(-5)):"00:00";return subtrair_horas(e,t).substr(0,5)},w=function(a){var e=a.inicio&&a.fim?subtrair_horas(formatDateTime(a.fim).substr(-5),formatDateTime(a.inicio).substr(-5)):"00:00",t=a.ini_intervalo&&a.fim_intervalo?subtrair_horas(formatDateTime(a.fim_intervalo).substr(-5),formatDateTime(a.ini_intervalo).substr(-5)):"00:00",o=subtrair_horas(e,t),i=a.translado||"00:00";return somar_horas(o,i).substr(0,5)},x=function(){var a=i.projeto.projeto?i.projeto.projeto:null;if(a){for(var e=y.totalCount(),t="S"===a.sugerir_despesas_no_apontamento_atividades||!0===a.sugerir_despesas_no_apontamento_atividades,o=0;o<e;o++)y.cellValue(o,"apontar_despesa",t),y.cellValue(o,"translado",a.traslado_padrao),y.cellValue(o,"km_rodado",a.quantidade_km_padrao),y.cellValue(o,"pedagio",a.valor_pedagio),y.cellValue(o,"refeicao",a.valor_refeicao),y.cellValue(o,"outras_despesas",a.outras_despesas);var n="S"===a.permite_alterar_padrao_apontamento||!0===a.permite_alterar_padrao_apontamento;y.columnOption("km_rodado","allowEditing",n),y.columnOption("pedagio","allowEditing",n),y.columnOption("refeicao","allowEditing",n),y.columnOption("outras_despesas","allowEditing",n)}},y=p.find(".div_componente_apontamentos").dxDataGrid({dataSource:f,keyExpr:"ID",showBorders:!0,allowColumnResizing:!0,columnResizingMode:"widget",rowAlternationEnabled:!1,paging:{enabled:!1},stateStoring:{enabled:!0,type:"custom",customLoad:function(){return App.get_parametro_usuario("apontamento_projeto_multiplo")},customSave:function(a){App.set_parametro_usuario("apontamento_projeto_multiplo",a)}},focusedRowEnabled:!1,editing:{mode:"cell",allowUpdating:!0,allowDeleting:!0,allowAdding:!0,useIcons:!0},columns:[{dataField:"dia",dataType:"date",format:"dd/MM/yyyy",width:140,calculateCellValue:function(a){return a.dia||new Date}},{dataField:"inicio",caption:"Início",width:100,dataType:"datetime",format:"HH:mm",editorOptions:{displayFormat:"HH:mm",useMaskBehavior:!0,type:"time"}},{dataField:"fim",width:100,dataType:"datetime",format:"HH:mm",editorOptions:{displayFormat:"HH:mm",useMaskBehavior:!0,type:"time"}},{dataField:"ini_intervalo",width:100,dataType:"datetime",format:"HH:mm",editorOptions:{displayFormat:"HH:mm",useMaskBehavior:!0,type:"time"}},{dataField:"fim_intervalo",width:100,dataType:"datetime",format:"HH:mm",editorOptions:{displayFormat:"HH:mm",useMaskBehavior:!0,type:"time"}},{dataField:"subtotal",width:120,calculateCellValue:function(a){return g(a)}},{dataField:"translado",width:60,dataType:"string"},{dataField:"total",width:120,calculateCellValue:function(a){return w(a)}},{dataField:"descricao",caption:"Descrição",width:160},dx_Apontar_Despesa(),dx_KM_Rodado_Col(),dx_Pedagio_Col(),dx_Refeicao_Col(),dx_Outras_Despesas_Col(),dx_Descricao_da_Despesa_Col(),dx_Despesa_Observacao_Col(),{type:"buttons",fixed:!0,buttons:[{hint:"Duplicar registro",icon:"repeat",cssClass:v,onClick:function(a){var e=$.extend({},a.row.data,{ID:++h});f.splice(a.row.rowIndex,0,e),a.component.refresh(!0),a.event.preventDefault(),setTimeout(function(){_()})}},{hint:"Apagar registro",icon:"fa fa-trash",cssClass:v,onClick:function(a){y.deleteRow(a.row.rowIndex)}}]}],onInitNewRow:function(a){a.data={translado:"",apontar_despesa:!1,km_rodado:0,pedagio:0,refeicao:0,outras_despesas:0,despesa_descricao:"",despesa_observacoes:""};var e=i.projeto.projeto?i.projeto.projeto:null;if(e){"S"!==e.sugerir_despesas_no_apontamento_atividades&&!0!==e.sugerir_despesas_no_apontamento_atividades||(a.data.apontar_despesa=!0),a.data.translado=e.traslado_padrao,a.data.km_rodado=e.quantidade_km_padrao,a.data.pedagio=e.valor_pedagio,a.data.refeicao=e.tipo_valor_padrao_refeicao==TIPO_VALOR_REFEICAO.TECNICO?parseFloat(e.tecnico_valor_refeicao):parseFloat(e.valor_refeicao),a.data.outras_despesas=e.outras_despesas;var t="S"===e.permite_alterar_padrao_apontamento||!0===e.permite_alterar_padrao_apontamento;a.component.columnOption("km_rodado","allowEditing",t),a.component.columnOption("pedagio","allowEditing",t),a.component.columnOption("refeicao","allowEditing",t),a.component.columnOption("outras_despesas","allowEditing",t)}},onRowPrepared:function(a){"data"==a.rowType&&a.data.dia&&(formatDate(a.data.dia,!0)<=i.data_fechamento?App.verifica_permissao(App.temp.empresa,"apontamento_projetos_fechado")?a.rowElement.addClass("bg-warning"):a.rowElement.addClass("bg-danger"):a.rowElement.removeClass("bg-warning bg-danger"))},onCellPrepared:function(a){"data"===a.rowType&&$.inArray(a.rowIndex+":"+a.columnIndex,b)>=0&&a.cellElement.css("background-color","#BDBDBD")},onEditorPreparing:function(a){if("dataRow"===a.parentType){var e=a.editorOptions.onValueChanged;a.editorOptions.onValueChanged=function(a){e.apply(this,arguments);for(var t=0;t<b.length;t++){var o=Number(b[t].split(":")[0]),i=Number(b[t].split(":")[1]);y.cellValue(o,i,a.value),y.getCellElement(o,i).css("background-color","")}b=[]}}"dataRow"!=a.parentType||"subtotal"!=a.dataField&&"total"!=a.dataField||(a.editorOptions.disabled=!0)},onEditorPrepared:function(a){"translado"==a.dataField||"total"==a.dataField?a.editorElement.find("input").last().mask("99:99"):"dia"==a.dataField&&a.editorElement.find("input").last().mask("99/99/9999")},onCellClick:function(a){a.event.ctrlKey?b.push(a.rowIndex+":"+a.columnIndex):b.length&&(b=[],a.component.repaint())},summary:{totalItems:[{name:"subtotal",showInColumn:"subtotal",displayFormat:"Soma: {0}",summaryType:"custom"},{name:"total",showInColumn:"total",displayFormat:"Soma: {0}",summaryType:"custom"}],calculateCustomSummary:function(a){"subtotal"===a.name?"start"===a.summaryProcess?a.totalValue=0:"calculate"===a.summaryProcess&&(a.totalValue=somar_horas(a.totalValue,g(a.value).substr(0,5))):"total"===a.name&&("start"===a.summaryProcess?a.totalValue=0:"calculate"===a.summaryProcess&&(a.totalValue=somar_horas(a.totalValue,w(a.value).substr(0,5))))}},onRowInserted:function(a){_()},onRowUpdated:function(a){_()},onRowRemoved:function(a){_()}}).dxDataGrid("instance"),I=$(a).find(".btn_exclui_atividade");I.unbind("click"),I.click(function(){a.remove()}),a.appendTo(i.div_todas_atividades)},this.close=function(){void 0!==i.onclose&&i.onclose&&i.onclose()},this.unload=function(){i.close(),View.unload(this.html_id)},this.cbo_consultor.unbind("change"),this.cbo_consultor.change(function(){i.usuario_id=i.cbo_consultor.val()}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){i.unload()}),this.btn_add_atividade.unbind("click"),this.btn_add_atividade.click(function(){i.adiciona_atividade()}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){var a=[],e=i.dialog.find(".div_atividades");$(e).each(function(e,t){var o={};o.cliente_id=$(t).find(".cbo_cliente").attr("id"),o.projeto_id=$(t).find(".cbo_projeto").attr("id"),o.atividade_projeto_id=$(t).find(".div_listagem_atividade_projeto").attr("id"),o.porcentagem_atividade=$(t).find(".porcentagem_atividade").val(),o.apontamentos=$(t).find(".div_componente_apontamentos").attr("id"),a.push(o)});var t={usuario_id:i.cbo_consultor.val(),arr_atividades:JSON.stringify(a)};WS.post("apontamento_projeto/salvar_multiplos",t,function(a){i.apontamento_id=a.id,alert_saved("Apontamento salvo com sucesso"),i.unload()})})}});