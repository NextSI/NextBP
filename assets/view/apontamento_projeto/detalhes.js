define(["react","react-dom","ListarAtividadeProjeto"],function(a,e,o){return function(t){"use strict";var i=this;this.html_id=t,this.dialog=$("#"+this.html_id),this.title="Apontamento Atividade",this.onclose=null,this.tipo=null,$(this.dialog).attr("viewcode",TELAS.APONTAMENTO_PROJETO.codigo),this.cbo_consultor=this.dialog.find(".cbo_consultor"),this.cbo_projeto=this.dialog.find(".cbo_projeto"),this.cbo_cliente=this.dialog.find(".cbo_cliente"),this.edt_data=this.dialog.find(".edt_data"),this.edt_hora_inicio=this.dialog.find(".edt_hora_inicio"),this.edt_hora_fim=this.dialog.find(".edt_hora_fim"),this.edt_intervalo_inicio=this.dialog.find(".edt_intervalo_inicio"),this.edt_intervalo_fim=this.dialog.find(".edt_intervalo_fim"),this.edt_traslado=this.dialog.find(".edt_traslado"),this.edt_total=this.dialog.find(".edt_total"),this.edt_total_atividade=this.dialog.find(".edt_total_atividade"),this.edt_subtotal=this.dialog.find(".edt_subtotal"),this.div_todas_atividades=this.dialog.find(".div_todas_atividades"),this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_salvar=this.dialog.find(".btn_salvar"),this.btn_excluir=this.dialog.find(".btn_excluir"),this.floating=this.dialog.find(".floating-menu"),this.dx_check_despesas=this.dialog.find(".dx_check_despesas"),this.dx_despesas_formulario=this.dialog.find(".dx_despesas_formulario"),this.ListarAtividadeProjeto=a.createElement(o,null,null),this.apontamento_id=null,this.projeto_id=null,this.cliente_id=null,this.cliente_nome=null,this.usuario_id=null,this.total_horas_apontamento=null,this.total_horas_atividade=null,this.total_horas_negativo=!1,this.atividade_id=[],this.descricao=[],this.atividade=[],this.horas_atividade=[],this.valor=null,this.anexo_atividade=[],this.filtros=null,this.projeto_nome="",this.arr_atividades=[],this.apontamento_despesa_id=0,this.dx_depesas_valores_formulario_data_source={km_rodado:0,pedagio:0,refeicao:0,outras_despesas:0,descricao:"",observacoes:""},this.qtde_atividades=null,this.atividades=null,this.aux=null,this.atividade=null,this.qtde_atv_filhos=null,this.projeto={},this.data_fechamento=null,this.auto_size=null,this.arquivos_anexados=[],this.show=function(a,e,o,t,d,s,r,n,_,l){if("object"==typeof a&&null!=a){var p=clone_obj(a);a=null!=p.apontamento_id&&""!=p.apontamento_id?p.apontamento_id:null,e=null!=p.tipo&&""!=p.tipo?p.tipo:FORMULARIO.NOVO,null!=p.dia&&""!=p.dia?p.dia:null,t=null!=p.projeto_id&&""!=p.projeto_id?p.projeto_id:null,d=null!=p.cliente_id&&""!=p.cliente_id?p.cliente_id:null,s=null!=p.cliente_nome&&""!=p.cliente_nome?p.cliente_nome:null,r=null!=p.projeto_atividade_id&&""!=p.projeto_atividade_id?p.projeto_atividade_id:null,n=null!=p.projeto_nome&&""!=p.projeto_nome?p.projeto_nome:null,_=null!=p.hora_inicio&&""!=p.hora_inicio?p.hora_inicio:null,l=null!=p.hora_fim&&""!=p.hora_fim?p.hora_fim:null}switch(i.dx_check_despesas.dxCheckBox({value:!1,text:"Apontar despesas",onValueChanged:function(a){a.value?i.dx_despesas_formulario.show():i.dx_despesas_formulario.hide()}}),i.edt_hora_inicio.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){i.calcula_horas()}}),i.edt_hora_fim.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){i.calcula_horas()}}),i.edt_intervalo_inicio.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){i.calcula_horas()}}),i.edt_intervalo_fim.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){i.calcula_horas()}}),i.edt_traslado.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){i.calcula_horas()}}),i.edt_total.dxDateBox({type:"time",displayFormat:"HH:mm",useMaskBehavior:!0,showClearButton:!0,onValueChanged:function(){i.calcula_horas()}}),i.dx_despesas_formulario.dxForm(dx_Apontamento_Depesa_Projeto_Valores_Formulario(i.dx_depesas_valores_formulario_data_source)),WS.get("apontamento_projeto/get_parametros/",null,function(a){i.data_fechamento=a.apontamento_data_fechamento}),i.projeto_id=t,i.cliente_id=d,i.cliente_nome=s,i.projeto_nome=n,set_datepicker(i.edt_data),i.edt_total.dxDateBox("instance").option("disabled",!0),i.edt_total_atividade.prop("disabled",!0),i.tipo=e,e){case FORMULARIO.NOVO:i.btn_salvar.show(),i.btn_excluir.hide(),i.permite_alterar(!0),App.titulo_aba(i.html_id,"Novo - Apontamento Atividade");break;case FORMULARIO.EDITAR:i.btn_salvar.show(),i.btn_excluir.hide(),i.permite_alterar(!0);break;case FORMULARIO.VISUALIZAR:i.btn_salvar.hide(),i.btn_excluir.hide(),i.permite_alterar(!1);break;case FORMULARIO.EXCLUIR:i.btn_salvar.hide(),i.btn_excluir.show(),i.permite_alterar(!1)}if(void 0!==a&&a)i.apontamento_id=a,i.preencher();else{var c=new Date,u=("0"+c.getDate()).slice(-2),m=("0"+(c.getMonth()+1)).slice(-2),v=c.getFullYear()+"-"+m+"-"+u;if(i.listar_consultor(App.sessao.dados.usuario_id),_&&l&&(u=("0"+_.getDate()).slice(-2),m=("0"+(_.getMonth()+1)).slice(-2),v=_.getFullYear()+"-"+m+"-"+u,i.edt_hora_inicio.dxDateBox("instance").option("value",_),i.edt_hora_fim.dxDateBox("instance").option("value",l)),setTimeout(function(){set_datepicker(i.edt_data,v)},150),t&&i.preencher_despesas_padrao(),r>=0&&r){i.listar_atividades_projeto(t,function(){i.adiciona_atividade(r)})}else i.adiciona_atividade();i.renderiza_componentes()}},this.renderiza_componentes=function(){i.renderiza_clientes(i.cliente_id),i.renderiza_projetos(i.projeto_id,i.cliente_id)},this.renderiza_projetos=async function(a,e){var o={cliente_id:e||void 0,selecionado:a?a.toString():void 0,readOnly:!e,aoAlterar:async a=>{i.projeto_id=a;var e=await this.listar_atividades_projeto(i.projeto_id);i.function_select_projeto(e.projeto,e.projeto.permitir_apontamento_projeto_concluido)}};ReactDOM.unmountComponentAtNode(i.cbo_projeto[0]),ReactDOM.render(React.createElement(window.components.SelecaoProjeto.default,o),i.cbo_projeto[0])},this.renderiza_clientes=function(a){var e={entidade_tipo:TIPO_ENTIDADE.CLIENTE,entidade_id:a||void 0,selecionado:a?{tipo:TIPO_ENTIDADE.CLIENTE,id:a?a.toString():void 0}:null,aoAlterar:a=>{i.entidade_tipo=a.tipo,i.cliente_id=a.id,i.projeto_id=null,i.renderiza_projetos(i.projeto_id,i.cliente_id)}};ReactDOM.unmountComponentAtNode(i.cbo_cliente[0]),ReactDOM.render(React.createElement(window.components.SelecaoEntidade.default,e),i.cbo_cliente[0])},this.listar_consultor=function(a){i.cbo_consultor.find("option").remove(),add_option(i.cbo_consultor,"","-- Selecione --"),WS.get("usuario/listar/",null,function(e){for(var o=0;o<e.length;o++){var t=e[o];add_option(i.cbo_consultor,t.usuario_id,t.nome)}a&&(i.cbo_consultor.val(a).trigger("change"),i.usuario_id=a),i.cbo_consultor.selectpicker("refresh")})},this.listar_atividades_projeto=function(a,e){if(a)return new Promise((o,t)=>{WS.get({route:"atividade_projeto/listar/",data:{projeto_id:a},func_response:function(a){a.atividades.push({atividade_simplificada:a.projeto.nome,id:"raiz",projeto_atividade_sintetica_pai_id:null,tipo_atividade:"P",marco:!1,horas_previstas:"000:00"}),i.projeto.data=a,void 0!==e&&e(),o(a)},html_id:i.html_id})})},this.function_select_projeto=function(a,e){var o=new Validation;if("S"!=e&&a.projeto_status_id==PROJETO_STATUS.CONCLUIDO)return i.projeto_id=null,o.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Você não pode realizar apontamentos em projetos concluídos.")),alert_modal("Validação",o),i.edt_traslado.dxDateBox("instance").option("value",null),i.dx_depesas_valores_formulario_data_source.km_rodado=0,i.dx_depesas_valores_formulario_data_source.pedagio=0,i.dx_depesas_valores_formulario_data_source.refeicao=0,i.dx_depesas_valores_formulario_data_source.outras_despesas=0,i.dx_despesas_formulario.dxForm("instance").option("formData",i.dx_depesas_valores_formulario_data_source),!1;if(i.projeto_id=a.id,i.projeto_permite_alterar_padrao_apontamento=a.permite_alterar_padrao_apontamento,i.projeto_sugerir_despesas_no_apontamento_atividades=a.sugerir_despesas_no_apontamento_atividades,a.id){a.id>0?"S"!=i.projeto_permite_alterar_padrao_apontamento&&!0!==i.projeto_permite_alterar_padrao_apontamento||!(i.dx_check_despesas.dxCheckBox("instance").option("value")&&(i.dx_depesas_valores_formulario_data_source.km_rodado>0||i.dx_depesas_valores_formulario_data_source.pedagio>0||i.dx_depesas_valores_formulario_data_source.refeicao>0||i.dx_depesas_valores_formulario_data_source.outras_despesas>0)||i.edt_traslado.dxDateBox("instance").option("value"))?a.id&&i.preencher_despesas_padrao():alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',"Deseja substituir as despesas pelas padrões do projeto ?","Sim",function(){i.preencher_despesas_padrao()},!0):(i.edt_traslado.dxDateBox("instance").option("value",null),i.dx_depesas_valores_formulario_data_source.km_rodado=0,i.dx_depesas_valores_formulario_data_source.pedagio=0,i.dx_depesas_valores_formulario_data_source.refeicao=0,i.dx_depesas_valores_formulario_data_source.outras_despesas=0,i.dx_despesas_formulario.dxForm("instance").option("formData",i.dx_depesas_valores_formulario_data_source)),"S"==i.projeto_permite_alterar_padrao_apontamento||!0===i.projeto_permite_alterar_padrao_apontamento?dx_Apontamento_Depesa_Projeto_Valores_Formulario_Valores_ReadOnly(i.dx_despesas_formulario.dxForm("instance"),!1):dx_Apontamento_Depesa_Projeto_Valores_Formulario_Valores_ReadOnly(i.dx_despesas_formulario.dxForm("instance"),!0),"S"==i.projeto_sugerir_despesas_no_apontamento_atividades||!0===i.projeto_sugerir_despesas_no_apontamento_atividades?i.dx_check_despesas.dxCheckBox("instance").option("value",!0):i.dx_check_despesas.dxCheckBox("instance").option("value",!1),i.listar_atividades_projeto(a.id,function(){for(var e=i.dialog.find(".div_atividades"),o=0;o<e.length;o++){var t=e[o];i.ListarAtividadeProjeto.props.setParams({div:$(t).find(".div_componente_atividades"),html_id:i.html_id,div_porcentagem:$(t).find(".porcentagem_atividade"),data:i.projeto.data||[],dialog:i.dialog,parametro_usuario:"apontamento_projeto",dropdown:!0,somente_leitura:!0,atividade_selecionada:a.projeto_atividade_id})}})}else i.projeto.data=[]},this.preencher_despesas_padrao=function(){WS.get("projeto/objeto/",{projeto_id:i.projeto_id,usuario_id:i.usuario_id},function(a){i.edt_traslado.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+(a.traslado_padrao?a.traslado_padrao:"00:00"))),i.dx_depesas_valores_formulario_data_source.km_rodado=parseFloat(a.quantidade_km_padrao),i.dx_depesas_valores_formulario_data_source.pedagio=parseFloat(a.valor_pedagio),i.dx_depesas_valores_formulario_data_source.refeicao=a.tipo_valor_padrao_refeicao==TIPO_VALOR_REFEICAO.TECNICO?parseFloat(a.tecnico_valor_refeicao):parseFloat(a.valor_refeicao),i.dx_depesas_valores_formulario_data_source.outras_despesas=parseFloat(a.outras_despesas),i.dx_despesas_formulario.dxForm("instance").option("formData",i.dx_depesas_valores_formulario_data_source),void 0!==i.projeto_permite_alterar_padrao_apontamento&&void 0!==i.projeto_sugerir_despesas_no_apontamento_atividades||(i.projeto_permite_alterar_padrao_apontamento=a.permite_alterar_padrao_apontamento,i.projeto_sugerir_despesas_no_apontamento_atividades=a.sugerir_despesas_no_apontamento_atividades,"S"==i.projeto_permite_alterar_padrao_apontamento||!0===i.projeto_permite_alterar_padrao_apontamento?dx_Apontamento_Depesa_Projeto_Valores_Formulario_Valores_ReadOnly(i.dx_despesas_formulario.dxForm("instance"),!1):dx_Apontamento_Depesa_Projeto_Valores_Formulario_Valores_ReadOnly(i.dx_despesas_formulario.dxForm("instance"),!0),"S"==i.projeto_sugerir_despesas_no_apontamento_atividades||!0===i.projeto_sugerir_despesas_no_apontamento_atividades?i.dx_check_despesas.dxCheckBox("instance").option("value",!0):i.dx_check_despesas.dxCheckBox("instance").option("value",!1))})},this.incAnexo=function(a,e,o){var t=a.clone();o=1+o,t.find(".anexo_base_label").text("Anexo #"+o);var i=t.find(".checkbox");i.attr("type","checkbox"),i.bootstrapSwitch(!0),t.addClass("anexo_atividade"),t.removeClass("hidden"),t.appendTo(e),t.find('input[type="file"]').trigger("click")},this.carrega_documentos=function(a,e){var o=$(e).find(".div_anexos_carregados");o.removeClass("hidden"),o.find(".anexos").find(".line_anexos").remove();var t=function(a,o){i.arquivos_anexados=i.arquivos_anexados||{},i.arquivos_removidos=i.arquivos_removidos||{},i.arquivos_anexados[o]=a||[],i.arquivos_iniciais||(i.arquivos_iniciais={}),i.arquivos_iniciais[o]=a.filter(a=>!a.isNovo).map(a=>({documento_revisao_id:a.documento_revisao_id,documento_id:a.documento_id,nome:a.nome}));var t=$(e).find(".panel-footer .react-anexos")[0];ReactDOM.unmountComponentAtNode(t),ReactDOM.render(React.createElement(window.components.InputAnexoPreview.default,{aoAlterar:function(a){i.arquivos_anexados[o]=a;var e=a.filter(a=>!a.isNovo),t=[];i.arquivos_iniciais[o].forEach(function(a){e.find(function(e){return e.documento_revisao_id==a.documento_revisao_id})||t.push(a)}),i.arquivos_removidos[o]=t},arquivos:i.arquivos_anexados[o],somente_leitura:i.tipo==FORMULARIO.VISUALIZAR||i.tipo==FORMULARIO.EXCLUIR}),t)};a>0&&i.apontamento_id>0?WS.get("documento/get_by_atividade_projeto/",{apontamento_id:i.apontamento_id},function(e){var o=[];$(e).each(function(a,e){o.push({documento_revisao_id:e.documento_revisao_id,documento_id:e.documento_id,nome:e.revisao_nome,mime_type:e.mime_type,size:e.revisao_tamanho,isNovo:!1})}),t(o,a)}):t([])},this.adiciona_atividade=function(a,o,t){var d=i.dialog.find("[template-row='atividade']").clone();d.addClass("div_atividades"),d.removeAttr("template-row"),d.css("display","");var s=$(d).find("[template-field='porcentagem_atividade']"),r=$(d).find("[template-field='div_componente_atividades']");e.render(i.ListarAtividadeProjeto,r[0]),i.ListarAtividadeProjeto.props.setParams({div:r,html_id:i.html_id,div_porcentagem:s,data:i.projeto.data||[],dialog:i.dialog,parametro_usuario:"apontamento_projeto",dropdown:!0,somente_leitura:!0,atividade_selecionada:a}),a&&WS.get("atividade_projeto/objeto/",{atividade_projeto_id:a},function(e){i.carrega_documentos(a,d);var o=$(d).find("[template-field='status']"),t=str_identifica_status(e.inicio,e.prazo,e.conclusao);t=str_nome_status(t),o.text("- "+t),n=e.porcentagem,$(s).val(n);var r=$(d).find("[template-field='horas_atividade']"),_="",l="",p="";if(""!=e.horas_previstas&&null!=e.horas_previstas&&(e.horas_previstas=8==e.horas_previstas.length?"0"+e.horas_previstas:e.horas_previstas,_="Horas previstas: "+e.horas_previstas.substring(0,6)),""!=e.horas_previstas&&null!=e.horas_previstas&&(e.horas_previstas=8==e.horas_previstas.length?"0"+e.horas_previstas:e.horas_previstas,_="Horas previstas: "+e.horas_previstas.substring(0,6)),null!=e.horas_trabalhadas&&""!=e.horas_trabalhadas&&(e.horas_trabalhadas=8==e.horas_trabalhadas.length?"0"+e.horas_trabalhadas:e.horas_trabalhadas,l="<br>Horas trabalhadas: "+e.horas_trabalhadas.substring(0,6)),null!=e.saldo&&""!=e.saldo){var c=e.saldo.indexOf("-");e.saldo=c>-1?e.saldo.replace("-","").trim():e.saldo,e.saldo=8==e.saldo.length?-1==c?"0"+e.saldo:"-0"+e.saldo:e.saldo,p="<br>Saldo: "+(-1==e.saldo.indexOf("-")?e.saldo.substring(0,6):e.saldo.substring(0,7))}void 0!==e.tarefas&&e.tarefas.length>0&&s.addClass("disabled").attr("disabled","disabled"),r.html(_+" "+l+" "+p),r.html(_+" "+l+" "+p)});var n=null;i.dialog.find(".edt_descricao").prop("disabled",!i.valor),o&&$(d).find(".edt_descricao").val(o);$(d).find(".div_anexos"),$(d).find(".div_anexos_row"),$(d).find(".panel-footer .react-anexos")[0];i.carrega_documentos(a,d),s.addClass("porcentagem_atividade"),s.prop("readonly",!i.valor),s.unbind("change").change(function(){$(this).val($(this).val()>100?100:$(this).val()<0?0:$(this).val())});var _=$(d).find("[template-field='horas']");_.attr("type","text"),_.mask("00:00"),_.addClass("edt_horas"),_.prop("disabled",!i.valor),_.unbind("change").change(function(){i.horas_atividades()}),t&&$(_).val(t),d.appendTo(i.div_todas_atividades)},this.horas_atividades=function(){var a=i.dialog.find(".edt_horas"),e=null;$(a).each(function(a,o){if(null!=o&&"00:00"!=o){var t=o.value.substring(0,2),i=o.value.substring(3,5),d=60*parseInt(t,10)+parseInt(i,10);e+=isNaN(d)?0:d}}),i.total_horas_atividade=e;var o=e,t=Math.floor(o/60);o-=60*t;var d=i.format_hora(t,o);i.edt_total_atividade.val("NaN:NaN"==d?"00:00":d)},this.close=function(){void 0!==i.onclose&&i.onclose&&i.onclose()},this.unload=function(){i.close(),View.unload(this.html_id)},this.calcula_horas=function(){var a=i.edt_hora_inicio.dxDateBox("instance").option("value"),e=i.edt_hora_fim.dxDateBox("instance").option("value"),o=i.edt_intervalo_inicio.dxDateBox("instance").option("value"),t=i.edt_intervalo_fim.dxDateBox("instance").option("value"),d=i.edt_traslado.dxDateBox("instance").option("value")?formatDateTime(i.edt_traslado.dxDateBox("instance").option("value")).substr(-5):"00:00:00",s="00:00:00",r="00:00:00";if(a&&e){if(pad(a.getHours(),2)+":"+pad(a.getMinutes(),2)>pad(e.getHours(),2)+":"+pad(e.getMinutes(),2))return i.edt_hora_inicio.dxDateBox("instance").option("value",null),i.edt_hora_fim.dxDateBox("instance").option("value",null),(n=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,'A "hora inicial" não pode ser maior que a "hora final". Digite novamente.')),void alert_modal("Validação",n);s=subtrair_horas(formatDateTime(e).substr(-5),formatDateTime(a).substr(-5))}if(o&&t){if(o>t)return i.edt_intervalo_inicio.dxDateBox("instance").option("value",null),i.edt_intervalo_fim.dxDateBox("instance").option("value",null),(n=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,'O "intervalo inicial" não pode ser maior que o "intervalo final". Digite novamente.')),void alert_modal("Validação",n);r=subtrair_horas(formatDateTime(t).substr(-5),formatDateTime(o).substr(-5))}var n,_=somar_horas(subtrair_horas(s,r),d);if(a&&e&&o&&t&&"-"===_.substr(0,1))return i.total_horas_negativo=!0,(n=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"O intervalo está maior que o tempo gasto na atividade. Revise os horários.")),void alert_modal("Validação",n);i.total_horas_negativo=!1,i.edt_total.dxDateBox("instance").option("value",_)},this.permite_alterar=function(a){const e=App.sessao.dados.admin||App.verifica_permissao(App.temp.empresa,"admin_apontamento_atividade");i.valor=a,i.edt_data.prop("readonly",!a),i.cbo_consultor.prop("disabled",!(i.tipo==FORMULARIO.NOVO&&e)),i.edt_hora_inicio.dxDateBox("instance").option("disabled",!a),i.edt_hora_fim.dxDateBox("instance").option("disabled",!a),i.edt_intervalo_inicio.dxDateBox("instance").option("disabled",!a),i.edt_intervalo_fim.dxDateBox("instance").option("disabled",!a),i.edt_traslado.dxDateBox("instance").option("disabled",!a),i.edt_total.dxDateBox("instance").option("disabled",!a)},this.preencher=function(){WS.get("apontamento_projeto/objeto/",{apontamento_id:i.apontamento_id},function(a){App.titulo_aba(i.html_id,"#"+a.id+" - Apontamento Atividade"),i.projeto_id=a.projeto_id,i.cliente_id=a.cliente_id,i.usuario_id=a.usuario_id,i.apontamento_despesa_id=a.apontamento_despesa_id,i.projeto_permite_alterar_padrao_apontamento=a.projeto_permite_alterar_padrao_apontamento,i.projeto_sugerir_despesas_no_apontamento_atividades=a.projeto_sugerir_despesas_no_apontamento_atividades,i.filtros=spread({},i.filtros,{cliente_id:a.cliente_id,cliente_nome:a.cliente_nome,cliente_tipo:"C"}),i.renderiza_componentes(),set_datepicker(i.edt_data,a.dia),i.listar_consultor(a.usuario_id),a.hora_inicial&&i.edt_hora_inicio.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+a.hora_inicial)),a.hora_final&&i.edt_hora_fim.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+a.hora_final)),a.intervalo_inicial&&i.edt_intervalo_inicio.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+a.intervalo_inicial)),a.intervalo_final&&i.edt_intervalo_fim.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+a.intervalo_final)),a.horas_traslado&&i.edt_traslado.dxDateBox("instance").option("value",new Date(formatDate(new Date,!0)+"T"+a.horas_traslado)),i.apontamento_despesa_id>0&&(i.dx_check_despesas.dxCheckBox("instance").option("value",!0),i.dx_depesas_valores_formulario_data_source.km_rodado=parseFloat(a.km_rodado),i.dx_depesas_valores_formulario_data_source.pedagio=parseFloat(a.pedagio),i.dx_depesas_valores_formulario_data_source.refeicao=parseFloat(a.refeicao),i.dx_depesas_valores_formulario_data_source.outras_despesas=parseFloat(a.outras_despesas),i.dx_depesas_valores_formulario_data_source.descricao=a.despesa_descricao,i.dx_depesas_valores_formulario_data_source.observacoes=a.despesa_observacoes,i.dx_despesas_formulario.dxForm("instance").option("formData",i.dx_depesas_valores_formulario_data_source),"N"!=i.projeto_permite_alterar_padrao_apontamento&&!1!==i.projeto_permite_alterar_padrao_apontamento||dx_Apontamento_Depesa_Projeto_Valores_Formulario_Valores_ReadOnly(i.dx_despesas_formulario.dxForm("instance"),!0));i.listar_atividades_projeto(a.projeto_id,function(){a.atividade!=[]&&$(a.atividade).each(function(a,e){i.adiciona_atividade(e.projeto_atividade_id,e.descricao,e.horas)}),i.horas_atividades()})})},this.format_hora=function(a,e){return a.toString().indexOf("-")>-1?(a=a.toString().replace("-",""),parseInt(a,10)<10&&parseInt(e,10)<10?" -0"+a+":0"+e:parseInt(a,10)<10?" -0"+a+":"+e:parseInt(e,10)<10?a+":0"+e:a+":"+e):parseInt(a,10)<10&&parseInt(e,10)<10?"0"+a+":0"+e:parseInt(a,10)<10?"0"+a+":"+e:parseInt(e,10)<10?a+":0"+e:a+":"+e},this.cbo_consultor.unbind("change"),this.cbo_consultor.change(function(){null!==i.usuario_id&&(i.usuario_id=i.cbo_consultor.val(),i.cliente_id>0&&i.tipo==FORMULARIO.NOVO&&(i.projeto_id=null))}),this.btn_cancelar.unbind("click"),this.btn_cancelar.click(function(){i.unload()}),this.btn_salvar.unbind("click"),this.btn_salvar.click(function(){var a=function(){if(i.total_horas_negativo){var a=new Validation;return a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"O intervalo está maior que o tempo gasto na atividade. Revise os horários.")),void alert_modal("Validação",a)}i.arr_atividades=[];var e=i.dialog.find(".div_atividades");$(e).each(function(a,e){var o={};o.atividade_id=$(e).find(".div_listagem_atividade_projeto").attr("id"),o.descricao=$(e).find("textarea").val(),o.horas_atividade=i.edt_total.dxDateBox("instance").option("value")?i.edt_total.dxDateBox("instance").option("value").substr(0,5):null,o.horas_atividade&&i.edt_traslado.dxDateBox("instance").option("value")&&(o.horas_atividade=subtrair_horas(formatDateTime(o.horas_atividade).substr(-5),formatDateTime(i.edt_traslado.dxDateBox("instance").option("value")).substr(-5))),o.porcentagem_atividade=$(e).find(".porcentagem_atividade").val(),i.arr_atividades[a]=o});var o={apontamento_id:i.apontamento_id,usuario_id:i.cbo_consultor.val(),projeto_id:i.projeto_id,atividade:JSON.stringify(i.arr_atividades),cliente_id:i.cliente_id,dia:get_datepicker(i.edt_data),hora_inicial:i.edt_hora_inicio.dxDateBox("instance").option("value")?formatDateTime(i.edt_hora_inicio.dxDateBox("instance").option("value")).substr(-5):null,hora_final:i.edt_hora_fim.dxDateBox("instance").option("value")?formatDateTime(i.edt_hora_fim.dxDateBox("instance").option("value")).substr(-5):null,intervalo_inicial:i.edt_intervalo_inicio.dxDateBox("instance").option("value")?formatDateTime(i.edt_intervalo_inicio.dxDateBox("instance").option("value")).substr(-5):null,intervalo_final:i.edt_intervalo_fim.dxDateBox("instance").option("value")?formatDateTime(i.edt_intervalo_fim.dxDateBox("instance").option("value")).substr(-5):null,horas_traslado:i.edt_traslado.dxDateBox("instance").option("value")?formatDateTime(i.edt_traslado.dxDateBox("instance").option("value")).substr(-5):null,horas_total:i.edt_total.dxDateBox("instance").option("value")?i.edt_total.dxDateBox("instance").option("value").substr(0,5):null,apontar_despesa:i.dx_check_despesas.dxCheckBox("instance").option("value"),km_rodado:i.dx_depesas_valores_formulario_data_source.km_rodado,pedagio:i.dx_depesas_valores_formulario_data_source.pedagio,refeicao:i.dx_depesas_valores_formulario_data_source.refeicao,outras_despesas:i.dx_depesas_valores_formulario_data_source.outras_despesas,despesa_descricao:i.dx_depesas_valores_formulario_data_source.descricao,despesa_observacoes:i.dx_depesas_valores_formulario_data_source.observacoes};Object.entries(i.arquivos_anexados||{}).forEach(([a,e])=>{e.forEach((e,t)=>{e.isNovo&&e.file instanceof File&&(o[a+"_"+t]=e.file)})}),Object.entries(i.arquivos_removidos||{}).forEach(([a,e])=>{e.length>0&&(o[`removidos_${a}`]=JSON.stringify(e.map(a=>({documento_revisao_id:a.documento_revisao_id,documento_id:a.documento_id}))))}),WS.post("apontamento_projeto/salvar",o,function(a){i.apontamento_id=a.id,alert_saved("Apontamento salvo com sucesso"),i.unload()},[i.btn_cancelar,i.btn_salvar],null,!0)};get_datepicker(i.edt_data)<=i.data_fechamento&&App.verifica_permissao(App.temp.empresa,"apontamento_projetos_fechado")?alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !','<div class="alert alert-info" style="text-align: center"> <span href="#" class="alert-link"><strong>Você está tentando realizar um apontamento </strong>fechado,<strong> deseja continuar ?  </strong></span></div>','<i class="fa fa-check" aria-hidden="true"></i> Sim',function(){a()},!0,'<i class="fa fa-times" aria-hidden="true"></i> Cancelar'):a()}),this.btn_excluir.unbind("click"),this.btn_excluir.click(function(){WS.post("apontamento_projeto/excluir",{apontamento_projeto_id:i.apontamento_id},function(a){alert_saved("Apontamento excluido com sucesso"),i.unload()},[i.btn_cancelar,i.btn_excluir])}),$(document).scroll(function(){i.floating.css("top",$(this).scrollTop())})}});