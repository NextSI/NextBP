define([],function(){return function(i){"use strict";var a=this;this.html_id=i,this.dialog=$("#"+this.html_id),this.title="Signatários",this.grid_signatarios=this.dialog.find(".grid_signatarios"),this.chk_solicitar_assinaturas_ordem=this.dialog.find(".chk_solicitar_assinaturas_ordem"),this.edt_intervalo_lembrete=this.dialog.find(".edt_intervalo_lembrete"),this.txt_mensagem_signatarios=this.dialog.find(".txt_mensagem_signatarios"),this.comunica_clicksign=!1,this.id_elemento_anexo=null,this.id_linha_tabela="",this.solicitacao_id=null,this.dados_signatarios=[],this.show=function(i,o,e,t,s){a.comunica_clicksign=o,a.id_elemento_anexo=e,a.solicitacao_id=void 0!==s?s.toString():"",void 0!==t&&null!=t&&(a.id_linha_tabela="_"+t),void 0===App.temp.signatarios&&(App.temp.signatarios={}),void 0===App.temp.signatarios[a.solicitacao_id+"_"+a.id_elemento_anexo+a.id_linha_tabela]&&(App.temp.signatarios[a.solicitacao_id+"_"+a.id_elemento_anexo+a.id_linha_tabela]=[]),a.dados_signatarios=App.temp.signatarios[a.solicitacao_id+"_"+a.id_elemento_anexo+a.id_linha_tabela],void 0===a.dados_signatarios.clicksign&&(a.dados_signatarios.clicksign=[]),a.grid_signatarios.dxDataGrid({dataSource:a.dados_signatarios.clicksign,showBorders:!0,allowColumnReordering:!0,allowColumnResizing:!0,columnResizingMode:"widget",columnAutoWidth:!0,rowAlternationEnabled:!1,height:550,scrolling:{mode:"virtual",showScrollbar:"Always",useNative:!0},paging:{enabled:!1},onInitNewRow:function(i){i.data={sign_as:"sign",auths:"email"}},focusedRowEnabled:!1,editing:{mode:"cell",allowUpdating:!0,allowDeleting:!0,useIcons:!0},onToolbarPreparing:function(e){let t=[{widget:"dxButton",options:{icon:"plus",hint:"Adicionar signatário",text:"Adicionar",onClick:function(){e.component.addRow()}},location:"after",name:"addRowButton",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"save",hint:"Salvar",text:"Salvar",disabled:!1,visible:!0,onClick:()=>{var e=a.grid_signatarios.dxDataGrid("instance");e.getController("validating").validate(!0).then(function(t){if(t){var s=e.getDataSource()._items;o?a.solicitar_assinaturas(s,i):(a.dados_signatarios.clicksign=[],$.each(s,function(i,o){a.dados_signatarios.clicksign.push(o)}),a.dados_signatarios.clicksign.params={mensagem_signatarios:a.txt_mensagem_signatarios.val(),solicitar_assinaturas_ordem:a.chk_solicitar_assinaturas_ordem.prop("checked"),intervalo_lembrete:a.edt_intervalo_lembrete.val()},a.unload())}else DevExpress.ui.dialog.alert("Preencha todos os campos obrigatórios!","Atenção")})}},location:"after",name:"salvarSignatarios",locateInMenu:"auto"}];e.toolbarOptions.items=window.add_botao_dx_toolbar(t,e.toolbarOptions.items)},onEditorPrepared:function(i){if("dataRow"===i.parentType)switch(i.dataField){case"documentation":i.editorElement.find("input").last().mask("000.000.000-00");break;case"birthday":i.editorElement.find("input").last().mask("99/99/9999");break;case"phone_number":i.editorElement.find("input").last().mask("(00)00000-0000");break;case"email":i.editorElement.dxTextBox("instance").option("onValueChanged",function(a){""!==a.value&&emailValido(a.value),i.setValue(a.value)})}},columns:[{dataField:"email",caption:"Email",validationRules:[{type:"required",message:"Preencha o E-mail"},{type:"email",message:"E-mail inválido"}]},{dataField:"sign_as",caption:"Assinar Como",lookup:{dataSource:[{id:"sign",descricao:"Assinar"},{id:"approve",descricao:"Aprovar"},{id:"party",descricao:"Assinar como parte"},{id:"witness",descricao:"Assinar como testemunha"},{id:"intervening",descricao:"Assinar como interveniente"},{id:"receipt",descricao:"Acusar recebimento"},{id:"endorser",descricao:"Assinar como endossante"},{id:"endorsee",descricao:"Assinar como endossatário"}],valueExpr:"id",displayExpr:"descricao"}},{dataField:"auths",caption:"Autenticar Como",lookup:{dataSource:[{id:"email",descricao:"Email"},{id:"sms",descricao:"SMS"},{id:"whatsapp",descricao:"WhatsApp"},{id:"icp_brasil",descricao:"Certificado Digital"}],valueExpr:"id",displayExpr:"descricao"}},{dataField:"phone_number",caption:"Celular",validationRules:[{type:"custom",message:"O campo Celular é obrigatório quando Autenticar Como = WhatsApp",validationCallback:function(i){const a=i.data?.auths;return"whatsapp"!==a||!!i.value&&""!==i.value.trim()}}]},{dataField:"name",caption:"Nome Completo",validationRules:[{type:"custom",message:"O Nome Completo é obrigatório (Nome e Sobrenome)",validationCallback:function(i){const a=i.value,o=a?a.trim().split(" "):[];if(!a||o.length<2)return!1;let e=0;for(let i=0;i<o.length;i++){o[i].length>2&&e++}return e>=2}}]},{dataField:"documentation",caption:"CPF"},{dataField:"birthday",allowEditing:!0,dataType:"date",caption:"Data de Nascimento",format:"dd/MM/yyyy"}],rowAlternationEnabled:!1,showRowLines:!0,showBorders:!0,rowDragging:{allowReordering:!0,dropFeedbackMode:"push",onReorder(i){const o=i.component.getVisibleRows(),e=a.dados_signatarios.clicksign.indexOf(o[i.toIndex].data),t=a.dados_signatarios.clicksign.indexOf(i.itemData);a.dados_signatarios.clicksign.splice(t,1),a.dados_signatarios.clicksign.splice(e,0,i.itemData),i.component.refresh()}}})},this.solicitar_assinaturas=function(i,o){let e=i.params||{},t=e.mensagem_signatarios||a.txt_mensagem_signatarios.val(),s=e.solicitar_assinaturas_ordem||a.chk_solicitar_assinaturas_ordem.prop("checked"),n=e.intervalo_lembrete||a.edt_intervalo_lembrete.val();WS.post("clicksign/solicitar_assinaturas",{signatarios:JSON.stringify(i),documento_revisao_id:o,mensagem_signatarios:t,solicitar_assinaturas_ordem:s,intervalo_lembrete:n},function(i){var o="";void 0!==i.signers&&i.signers.length>0?void 0!==i.signers[0].errors&&i.signers[0].errors.length>0&&(o="<h4>Falha ao transmitir o arquivo. Possíveis causas: </h4><br>",o+=i.signers[0].errors.toString().replace(/,/g,"<br>")):void 0!==i.errors&&i.errors.length>0&&(o=i.errors[0].toString().replace(/,/g,"<br>"));if(""!=o)return alert_modal("Atenção",o),!1;a.comunica_clicksign&&DevExpress.ui.dialog.alert("Documento disponibilizado para o(s) signatário(s)!","Atenção").done(function(){a.unload()})})},this.close=function(){void 0!==a.onclose&&a.onclose&&a.onclose()},this.unload=function(){a.close(),View.unload(this.html_id)}}});