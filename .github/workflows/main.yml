on: 
  push:
    branches:
      - 24@8.2

name: üöÄ Deploy on push vers√£o 24 PHP 8.2

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - nome: PortalHomolog
            sigla: PORTALHOMOLOG
            dir: ./homolog/
            api: FTP_URL_DBU_HOMOLOG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: PortalProd
            sigla: PORTALPROD
            dir: ./
            api: FTP_URL_DBU_PROD
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000205 Homolog
            sigla: 000205
            dir: ./homolog/
            api: FTP_URL_DBU_000205_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000205 Prod
            sigla: 000205
            dir: ./
            api: FTP_URL_DBU_000205
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000347 Homolog
            sigla: 000347
            dir: ./homolog/
            api: FTP_URL_DBU_000347_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000347 Prod
            sigla: 000347
            dir: ./
            api: FTP_URL_DBU_000347
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000348 Homolog
            sigla: 000348
            dir: ./homolog/
            api: FTP_URL_DBU_000348_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000348 Prod
            sigla: 000348
            dir: ./
            api: FTP_URL_DBU_000348
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000353 Homolog
            sigla: 000353
            dir: ./homolog/
            api: FTP_URL_DBU_000353_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000353 Prod
            sigla: 000353
            dir: ./
            api: FTP_URL_DBU_000353
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000333 Homolog
            sigla: 000333
            dir: ./homolog/
            api: FTP_URL_DBU_000333_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000333 Prod
            sigla: 000333
            dir: ./
            api: FTP_URL_DBU_000333
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000335 Homolog
            sigla: 000335
            dir: ./homolog/
            api: FTP_URL_DBU_000335_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000335 Prod
            sigla: 000335
            dir: ./
            api: FTP_URL_DBU_000335
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000226 Homolog
            sigla: 000226
            dir: ./homolog/
            api: FTP_URL_DBU_000226_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000226 Prod
            sigla: 000226
            dir: ./
            api: FTP_URL_DBU_000226
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000234 Homolog
            sigla: 000234_HLG
            dir: ./
            api: FTP_URL_DBU_000234_HLG
            server: FTP_HOST_PORTALPRODHOMOLOG

          - nome: 000234 Prod
            sigla: 000234
            dir: ./
            api: FTP_URL_DBU_000234
            server: FTP_HOST_PORTALPRODHOMOLOG

    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üìÇ Sync files ${{ matrix.nome }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets[matrix.server] }}
          username: ${{ secrets['FTP_USERNAME_' + matrix.sigla] }}
          password: ${{ secrets['FTP_PASSWORD_' + matrix.sigla] }}
          server-dir: ${{ matrix.dir }}

      - name: üîó Call API after deploy ${{ matrix.nome }}
        run: |
          echo "üì° Chamando API para ${{ matrix.nome }}"

          RESPONSE_CODE=$(curl -X POST "${{ secrets[matrix.api] }}${{ secrets.SUFIXO_DBU_API }}" \
            -H "Content-Type: application/json" \
            -H "Dbutoken: ${{ secrets.DBU_API_TOKEN }}" \
            -d '{"status": "success", "message": "FTP deploy complete"}' \
            -w "%{http_code}" -o response.txt -s)

          echo "üîç HTTP Response Code: $RESPONSE_CODE"

          RESPONSE_BODY=$(cat response.txt)
          echo "üìÑ API Response:"
          echo "$RESPONSE_BODY"

          if [ "$RESPONSE_CODE" -ne 200 ]; then
            echo "‚ùå API call failed with status code $RESPONSE_CODE"
            exit 1
          fi

          if [[ "$RESPONSE_BODY" != *"Atualizacao de estrutura procedimentos e funcoes do banco de dados concluida"* ]]; then
            echo "‚ùå Resposta inesperada da API!"
            echo "üîé Esperado: 'Atualizacao de estrutura procedimentos e funcoes do banco de dados concluida'"
            exit 1
          fi

          echo "‚úÖ Deploy e atualiza√ß√£o do banco de dados realizados com sucesso para ${{ matrix.nome }}"
