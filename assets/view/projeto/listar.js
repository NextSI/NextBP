define([],function(){return function(a){"use strict";var t=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.title="Projetos",this.dx_listagem_projeto=this.dialog.find(".dx_listagem_projeto");const o=App.get_parametro_usuario("projeto");this.dataGrid=null,this.template=o.template?o.template:"N",this.clearState=!1,this.show=async function(){t.listar()},this.listar_categorias=async function(){const a=await WS.get({route:"/projeto_categoria/listar/",data:null,awaitReturn:!0});return(a.length||Object.keys(a).length)&&a.data?a.data:[]},this.listar_classificacoes=async function(){return await WS.get({route:"/projeto_classificacao/listar/",data:null,awaitReturn:!0})},this.listar_cores_atividades=async function(){return await WS.get({route:"/cores_atividades_execucao/listar/",data:null,awaitReturn:!0})},this.listar_cores_atividades_saldo=async function(){return await WS.get({route:"/cores_atividades_saldo/listar/",data:null,awaitReturn:!0})},this.listar_projeto_status=async function(){return await WS.get({route:"/projeto_status/listar/",data:null,awaitReturn:!0})},this.get_objeto_formulario=async function(){const a=App.sessao.dados.parametro_projeto.projeto_formulario_id;if(+a>0){return await WS.get({route:"/formulario_projeto/get_formulario/",data:{projeto_formulario_id:a},awaitReturn:!0})}return[]},this.get_projeto_colunas_formulario=async function(){return await WS.get({route:"/projeto/get_projeto_colunas_formulario/",awaitReturn:!0})},this.listar=async function(){t.dataGrid&&t.dataGrid.beginCustomLoading();const a={categorias:await t.listar_categorias(),classificacoes:await t.listar_classificacoes(),cores_atividades:await t.listar_cores_atividades(),cores_atividades_saldo:await t.listar_cores_atividades_saldo(),projeto_status:await t.listar_projeto_status(),formulario_customizado:await t.get_objeto_formulario(),colunas_formulario:await t.get_projeto_colunas_formulario()};t.preencher(a)},this.preencher=function(a){var o=document.createElement("div");o.className="div_listagem_projeto",o.style="min-width: 100%;",t.dataGrid&&t.dx_listagem_projeto.find(".div_listagem_projeto").dxDataGrid("dispose"),t.dx_listagem_projeto.find(".div_listagem_projeto").remove(),t.dx_listagem_projeto[0].appendChild(o);var i=detectmob()?"select":"dragAndDrop",r=get_icon_class();t.dx_listagem_projeto.find(".div_listagem_projeto").css("height","calc(100vh - 42px)");var n=a.colunas_formulario,l=a.projeto_status,d=function(t){for(var e=0;e<a.cores_atividades.length;e++){var o=a.cores_atividades[e];if(parseInt(t)>=parseInt(o.inicio)&&parseInt(t)<=parseInt(o.fim))return o}return!1},s=[{dataField:"codigo",hidingPriority:22,width:"100px"},{dataField:"nome",caption:"Nome do projeto",allowHiding:!1,width:"100px"},{dataField:"projeto_categoria_id",hidingPriority:21,caption:"Categoria",lookup:{dataSource:a.categorias,displayExpr:"descricao",valueExpr:"id"},groupIndex:0,allowSearch:!1},{dataField:"projeto_status_id",hidingPriority:20,caption:"Status",dataType:"number",format:"fixedPoint",precision:0,lookup:{dataSource:l,displayExpr:"descricao",valueExpr:"projeto_status_id"},width:"100px",allowSearch:!1},{dataField:"status_atividades",hidingPriority:19,dataType:"number",format:"fixedPoint",precision:0,lookup:{dataSource:[{id:"1",descricao:"Programado"},{id:"2",descricao:"Andamento"},{id:"3",descricao:"Concluído"},{id:"4",descricao:"Não iniciado"},{id:"5",descricao:"Atrasado"},{id:"6",descricao:"Cancelado"}],displayExpr:"descricao",valueExpr:"id"},width:"100px",allowSearch:!1},{dataField:"classificacao_projeto_id",hidingPriority:18,caption:"Classificação",dataType:"number",format:"fixedPoint",precision:0,lookup:{dataSource:a.classificacoes,displayExpr:"nome",valueExpr:"projeto_classificacao_id"},width:"100px",allowSearch:!1},{dataField:"inicio",hidingPriority:17,caption:"Ínicio Previsto",dataType:"date",format:"dd/MM/yyyy",width:"100px",allowSearch:!1,allowHeaderFiltering:!1},{dataField:"fim",hidingPriority:16,caption:"Término Previsto",dataType:"date",format:"dd/MM/yyyy",width:"100px",allowSearch:!1,allowHeaderFiltering:!1},{dataField:"horas_previstas",hidingPriority:15,calculateSortValue:function(a){return a.horas_previstas?fn_converter_horas_para_segundos(a.horas_previstas):null},calculateDisplayValue:function(a){return a.horas_previstas?format_time(a.horas_previstas):""},width:"80px",allowSearch:!1},{dataField:"horas_trabalhadas",hidingPriority:14,calculateSortValue:function(a){return a.horas_trabalhadas?fn_converter_horas_para_segundos(a.horas_trabalhadas):null},calculateDisplayValue:function(a){return a.horas_trabalhadas?format_time(a.horas_trabalhadas):""},width:"80px",allowSearch:!1},{dataField:"saldo_horas",hidingPriority:13,calculateSortValue:function(a){return a.saldo_horas?fn_converter_horas_para_segundos(a.saldo_horas):null},calculateDisplayValue:function(a){return a.saldo_horas?format_time(a.saldo_horas,!0):""},width:"80px",allowSearch:!1},{dataField:"percentual_horas_trabalhadas",hidingPriority:12,caption:"% Trabalhado",dataType:"number",calculateSortValue:function(a){return a.percentual_horas_trabalhadas?parseInt(a.percentual_horas_trabalhadas):null},calculateDisplayValue:function(a){return a.percentual_horas_trabalhadas?a.percentual_horas_trabalhadas+" %":null},width:"80px",allowSearch:!1},{dataField:"percentual_saldo_horas",hidingPriority:11,caption:"% Saldo",dataType:"number",calculateSortValue:function(a){return a.percentual_saldo_horas?parseInt(a.percentual_saldo_horas):null},calculateDisplayValue:function(a){return a.percentual_saldo_horas?a.percentual_saldo_horas+" %":null},width:"80px",allowSearch:!1},{dataField:"porcentagem_concluido",hidingPriority:10,caption:"% Conclusão",dataType:"number",calculateSortValue:function(a){return a.porcentagem_concluido?parseInt(a.porcentagem_concluido):null},calculateDisplayValue:function(a){return a.porcentagem_concluido?a.porcentagem_concluido+" %":null},width:"80px",allowSearch:!1},{dataField:"percentual_estimado",hidingPriority:9,caption:"% Estimado",dataType:"number",calculateSortValue:function(a){return a.percentual_estimado?parseInt(a.percentual_estimado):null},calculateDisplayValue:function(a){return a.percentual_estimado?a.percentual_estimado+" %":null},allowFiltering:!1,allowSorting:!1,width:"80px",allowSearch:!1},{dataField:"cliente_nome",hidingPriority:8,caption:"Cliente",width:"100px"},{dataField:"equipe",hidingPriority:7,caption:"Equipe",allowSearch:!1,allowFiltering:!1,allowSorting:!1,width:"200px"},{dataField:"tipo_nome",hidingPriority:6,caption:"Tipo Projeto",width:"80px",allowSearch:!1,allowFiltering:!1,allowHeaderFiltering:!0},{dataField:"entrada_previsto",hidingPriority:5,dataType:"number",width:"100px",format:{type:"currency",precision:2},editorOptions:{format:"R$ #,##0.##",showClearButton:!0},allowSearch:!1},{dataField:"entrada_realizado",hidingPriority:4,dataType:"number",width:"100px",format:{type:"currency",precision:2},editorOptions:{format:"R$ #,##0.##",showClearButton:!0},allowSearch:!1},{dataField:"saida_previsto",hidingPriority:3,dataType:"number",width:"100px",format:{type:"currency",precision:2},editorOptions:{format:"R$ #,##0.##",showClearButton:!0},allowSearch:!1},{dataField:"saida_realizado",hidingPriority:2,dataType:"number",width:"100px",format:{type:"currency",precision:2},editorOptions:{format:"R$ #,##0.##",showClearButton:!0},allowSearch:!1},{dataField:"saldo_previsto",hidingPriority:1,dataType:"number",width:"100px",format:{type:"currency",precision:2},editorOptions:{format:"R$ #,##0.##",showClearButton:!0},allowSearch:!1},{dataField:"saldo_realizado",hidingPriority:0,dataType:"number",width:"100px",format:{type:"currency",precision:2},editorOptions:{format:"R$ #,##0.##",showClearButton:!0},allowSearch:!1},{dataField:"toolbar",allowSearch:!1,allowSorting:!1,allowFiltering:!1,allowGrouping:!1,caption:"Opções",fixed:!0,fixedPosition:"right",width:"90px",cellTemplate:function(a,o){$("<div>").dxToolbar({items:[{locateInMenu:"auto",location:"after",widget:"dxButton",showText:"inMenu",options:{text:"Visualizar atividades",hint:"Visualizar atividades",icon:"fa fa-tasks",cssClass:r,onClick:function(a){View.load("atividade_projeto/listar",function(a,t){t.show(o.row.data.projeto_id,o.row.data.template,o.row.data.cliente_nome)},View.ABA.MULTIPLAS,null,null,{projetoId:o.row.data.projeto_id}),a.event.preventDefault()}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{id:"projeto",text:"Visualizar projeto",title:"Visualizar projeto",hint:"Visualizar projeto",icon:"fa fa-eye",onClick:()=>{View.load("projeto/detalhes",function(a,t){t.show(o.row.data.projeto_id,FORMULARIO.VISUALIZAR)},View.ABA.MULTIPLAS,null,null,{projetoId:o.row.data.projeto_id})}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{id:"editar",text:"Editar projeto",icon:"fa fa-pencil-alt",visible:"S"==o.row.data.gerente_projeto||"S"==o.row.data.planejamento_formulario||App.sessao.dados.admin,onClick:()=>{View.load("projeto/detalhes",function(a,t){t.show(o.row.data.projeto_id,FORMULARIO.EDITAR,null,null,"S"==o.row.data.gerente_projeto,"S"==o.row.data.planejamento_formulario)},View.ABA.MULTIPLAS)}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{id:"gantt",text:"Visualizar Gantt",icon:"fa fa-chart-bar",onClick:()=>{View.loadReact(window.views.projeto.ProjetoGantt.default,{abaTitulo:`Gantt - ${o.row.data.nome}`,projeto_id:o.row.data.projeto_id,projeto_nome:o.row.data.nome},()=>{},View.ABA.MULTIPLAS)}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{id:"kanban",text:"Visualizar Kanban",icon:"fab fa-trello",onClick:()=>{View.loadReact(window.views.projeto.ProjetoKanban.default,{projeto_id:o.row.data.projeto_id,projeto_nome:o.row.data.nome},()=>{},View.ABA.MULTIPLAS)}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{hint:"Relatório de posicionamento do projeto",text:"Relatório de posicionamento do projeto",icon:"fa fa-file-pdf",cssClass:r,visible:"S"==o.row.data.planejamento_relatorio||"S"==o.row.data.gerente_projeto||App.sessao.dados.admin,onClick:function(){View.load("projeto/parametros_relatorio",function(a,t){t.show(o.row.data.projeto_id,o.row.data.projeto_atividade_id)}),e.event.preventDefault()}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{hint:"Resumo do Projeto",text:"Resumo do Projeto",icon:"far fa-calendar-alt",cssClass:r,visible:"S"==o.row.data.planejamento_relatorio||"S"==o.row.data.gerente_projeto||App.sessao.dados.admin,onClick:function(){alert_info("Gerando seu relatório em PDF. Aguarde."),App.obter_token_publico(function(a){View.navegador(WS_URI+"projeto/gerar_resumo_projeto/?projeto_id="+o.row.data.projeto_id+"&token_publico="+a,`Posicionamento - ${o.row.data.nome}`,View.ABA.MULTIPLAS,!0,`Posicionamento - ${o.row.data.nome}`)})}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{id:"excluir",text:"Excluir projeto",icon:"fa fa-trash",visible:"S"==o.row.data.gerente_projeto||App.sessao.dados.admin,onClick:()=>{var a=function(){setTimeout(function(){View.get_md5_tela_ativa()==t.html_id&&t.listar()})};View.load("projeto/detalhes",function(t,e){e.onclose=a,e.show(o.row.data.projeto_id,FORMULARIO.EXCLUIR)},View.ABA.MULTIPLAS)}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{hint:"Favoritar",text:"Favoritar",icon:"far fa-star",cssClass:r,visible:!verifica_favorito("projetos",o.row.data.projeto_id),onClick:()=>{favoritar_item("projetos",o.row.data.projeto_id,!0),t.listar()}}},{locateInMenu:"always",location:"after",widget:"dxButton",showText:"inMenu",options:{hint:"Desfavoritar",text:"Desfavoritar",icon:"fas fa-star",cssClass:r,visible:verifica_favorito("projetos",o.row.data.projeto_id),onClick:function(){favoritar_item("projetos",o.row.data.projeto_id,!1),t.listar()}}}]}).appendTo(a)}}];n&&ColumnsFormularioCustomizado(n,s,a.formulario_customizado),t.dataGrid=t.dx_listagem_projeto.find(".div_listagem_projeto").dxDataGrid({dataSource:t.listar_projetos(),showBorders:!0,columnResizingMode:detectmob()?"nextColumn":"widget",columnHidingEnabled:!!detectmob(),rowAlternationEnabled:!1,grouping:{autoExpandAll:!0},searchPanel:{visible:!0,width:window.detectmob()?"100%":200,placeholder:"Pesquisa geral"},remoteOperations:!0,pager:{showPageSizeSelector:!0,allowedPageSizes:[20,50,100],showInfo:!0},allowColumnReordering:!0,allowColumnResizing:!0,columnChooser:{enabled:!0,allowSearch:!0,mode:i},stateStoring:{enabled:!0,type:"custom",customLoad:function(){var a=App.get_parametro_usuario("projeto");return t.template=a.template?a.template:"N",a},customSave:function(a){App.set_parametro_usuario("projeto",a)}},selection:{mode:"multiple"},export:{enabled:!0,fileName:"Relatório de projetos "+agora(),allowExportSelectedData:!0,customizeExcelCell:a=>{var t=a.gridCell;if(t&&"data"===t.rowType&&["horas_previstas","horas_trabalhadas","saldo_horas"].includes(t.column.dataField)&&(t.column.dataType="number",a.numberFormat="[h]:mm",a.value)){if(window.fn_converter_horas_para_segundos(a.value)>0){var e=new Date("1900-01-01 00:00:00");e.setSeconds(window.fn_converter_horas_para_segundos(a.value)-86400),a.value=e}}}},filterRow:{visible:!0,applyFilter:"auto"},headerFilter:{visible:!0},filterPanel:{visible:!0},sorting:{mode:"multiple"},columnFixing:{enabled:!0},groupPanel:{visible:!0},onRowPrepared:function(e){setTimeout(function(){if("data"==e.rowType){var o=function(t){for(var e=0;e<a.cores_atividades_saldo.length;e++){var o=a.cores_atividades_saldo[e];if(parseInt(t)>=parseInt(o.inicio)&&parseInt(t)<=parseInt(o.fim))return o}return!1}(e.data.percentual_saldo_horas);if(o&&t.dataGrid.getCellElement(e.rowIndex,"percentual_saldo_horas")){var i=t.dataGrid.getCellElement(e.rowIndex,"percentual_saldo_horas");o.cor_fonte&&i.css("color",o.cor_fonte),o.cor&&i.css("background-color",o.cor)}var r=d(e.data.porcentagem_concluido);if(r&&t.dataGrid.getCellElement(e.rowIndex,"porcentagem_concluido")){i=t.dataGrid.getCellElement(e.rowIndex,"porcentagem_concluido");r.cor_fonte&&i.css("color",r.cor_fonte),r.cor&&i.css("background-color",r.cor)}var n=d(e.data.percentual_estimado);if(n&&t.dataGrid.getCellElement(e.rowIndex,"percentual_estimado")&&t.dataGrid.getCellElement(e.rowIndex,"percentual_estimado").css("color",n.cor_fonte).css("background-color",n.cor),t.dataGrid.getCellElement(e.rowIndex,"projeto_status_id")){var l="Andamento"==(s=t.dataGrid.getCellElement(e.rowIndex,"projeto_status_id").text())?"info":"Concluído"==s?"success":"Não iniciado"==s?"warning":"danger";t.dataGrid.getCellElement(e.rowIndex,"projeto_status_id").html('<span class="label" style="background-color: '+e.data.cor+"; color:"+e.data.cor_fonte+'">'+t.dataGrid.getCellElement(e.rowIndex,"projeto_status_id").text()+"</span>")}if(t.dataGrid.getCellElement(e.rowIndex,"status_atividades")){var s;l="Andamento"==(s=t.dataGrid.getCellElement(e.rowIndex,"status_atividades").text())?"info":"Concluído"==s?"success":"Não iniciado"==s?"warning":"danger";t.dataGrid.getCellElement(e.rowIndex,"status_atividades").html('<span class="label label-'+l+'">'+t.dataGrid.getCellElement(e.rowIndex,"status_atividades").text()+"</span>")}const c=t.dataGrid.getCellElement(e.rowIndex,"equipe");c&&(c.css("cursor","pointer"),c.off("click").on("click",function(){View.load("projeto/detalhes",function(a,t){t.show(e.data.projeto_id,FORMULARIO.VISUALIZAR),t.tab_geral.removeClass("active"),t.tab_equipe.addClass("active"),t.menu_equipe.closest(".panel-heading").addClass("hidden"),t.btn_cancelar.addClass("hidden"),t.div_componente_usuario.closest(".row").addClass("hidden")},View.ABA.POPUP,null,null,{projetoId:e.data.projeto_id})}))}})},onToolbarPreparing:function(a){var e=[{widget:"dxButton",options:{icon:"fa fa-plus",hint:"Novo projeto",text:"Novo projeto",visible:App.verifica_permissao(App.temp.empresa,"criacao_projetos"),onClick:function(){View.load("projeto/detalhes",function(a,e){e.onclose=function(){setTimeout(function(){View.get_md5_tela_ativa()==t.html_id&&t.listar()})},e.show(null,FORMULARIO.NOVO)},View.ABA.MULTIPLAS)}},location:"after",name:"BtnNovoProjeto",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-sync",hint:"Recarregar listagem de projetos",text:"Recarregar listagem de projetos",onClick:function(){t.listar()}},showText:"inMenu",location:"after",name:"BtnRefresh",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-cog",hint:"Configurar preferências",text:"Configurar preferências",onClick:function(){View.load("projeto/configuracoes",function(a,t){t.show()})},visible:App.sessao.dados.admin||App.verifica_permissao(App.sessao.dados.empresa_filial_id,"config_modulo_projetos")},showText:"inMenu",location:"after",name:"BtnConfiguracoes",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"assets/img/icones_bp/"+r+"_project.svg",hint:"Listar projetos",text:"Listar projetos",onClick:function(){t.template="N",App.set_parametro_usuario("projeto",{template:t.template}),t.listar()},onInitialized:function(a){"N"==t.template&&a.component.element().addClass("dx-state-active")}},showText:"inMenu",location:"after",name:"BtnProjetos",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-clone",hint:"Listar template",text:"Listar template",onClick:function(){t.template="S",App.set_parametro_usuario("projeto",{template:t.template}),t.listar()},onInitialized:function(a){"S"==t.template&&a.component.element().addClass("dx-state-active")}},showText:"inMenu",location:"after",name:"BtnModoTeste",locateInMenu:"auto"}];a.toolbarOptions.items=add_botao_dx_toolbar(e,a.toolbarOptions.items)},onContentReady:function(a){add_filtro_cor_tema(a),t.clearState&&(t.dataGrid.state({}),t.clearState=!1)},columns:s,onRowClick:function(a){var t=a.component;function e(){t.clickCount=1,t.clickKey=a.key,t.clickDate=new Date}t.clickCount&&1==t.clickCount&&t.clickKey==a.key?t.clickKey==a.key&&(new Date-t.clickDate<=300?(t.clickCount=0,t.clickKey=0,t.clickDate=null,View.load("atividade_projeto/listar",function(t,e){e.show(a.data.projeto_id,a.data.template,a.data.cliente_nome)},View.ABA.MULTIPLAS,null,null,{projetoId:a.data.projeto_id}),a.event.preventDefault()):e()):e()},onContextMenuPreparing:function(a){"header"==a.target&&Array.isArray(a.items)&&a.items.push({text:"Restaurar estado das colunas",visible:!0,beginGroup:!0,onItemClick:function(a){DevExpress.ui.dialog.confirm("Os filtros, ordenações, agrupamentos, posição, tamanho, e visibilidade das colunas desta listagem serão restauradas ao estado padrão. <b>Deseja continuar?</b>","Restaurar estado das colunas").done(function(a){a&&(t.clearState=!0,t.listar())})}})}}).dxDataGrid("instance"),t.dataGrid.endCustomLoading()},this.listar_projetos=()=>new DevExpress.data.DataSource.default({paginate:!0,pageSize:20,key:"projeto_id",load:a=>{let e=window.loadOptionsToActionParams(a);return new Promise((a,o)=>{WS.get({route:"/projeto/listar/",data:{template:t.template,dx_grid:!0,...e},func_response:t=>{let e=window.createLoadExtra(t);a({...e,data:t.data})},func_fail:a=>{a.validation&&o(new Error(a.validation.messages.map(function(a){return a.message}).join("<br/>")))}})})}}),this.unload=function(){View.unload(this.html_id)}}});