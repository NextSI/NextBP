define([],function(){return function(a){"use strict";var o=this;this.html_id=a,this.dialog=$("#"+this.html_id),this.title="Oportunidades",this.div_drag_situacao=this.dialog.find(".div_drag_situacao"),this.tab_panel=this.dialog.find(".tab_panel"),this.toolbar=this.dialog.find(".toolbar"),this.btn_opcoes_filtro=this.dialog.find(".btn_opcoes_filtro"),this.btn_limpar_filtro=this.dialog.find(".btn_limpar_filtro"),this.btn_configurar_filtros=this.dialog.find(".btn_configurar_filtros"),this.lb_orcamentos_pendentes=null,this.cbo_filtro_situacao_orcamento=this.dialog.find(".cbo_filtro_situacao_orcamento"),this.cbo_funil_vendas=this.dialog.find(".cbo_funil_vendas"),this.btn_favoritar_funil=this.dialog.find(".btn_favoritar_funil"),this.lbl_total_geral_pipe=null,this.div_info_qtd_opt_selec=null,this.div_dropdown_etiquetas=null,this.dx_kanban=null,this.dx_filtro=null,this.template_kanban=null,this.dx_funil_vendas=null,this.dx_grid=null,this.drop_down_visoes=$("<div></div>"),this.context_menu=this.dialog.find(".context-menu"),this.arr_funil_vendas=[],this.funil_vendas_id=null,this.funil_vendas_favorito=null,this.arr_etapas=[],this.arr_oportunidades_etapa=[],this.datagrid_kanban=null,this.arr_oportunidades_kanban=[],this.filtro_usuario_carregado=!1,this.observacao_oportunidade_perdida=null,this.observacao=null,this.motivo_perda_negocio=null,this.parametros_filtros=[],this.filtros={tipo_periodo:7,dt_ini:null,dt_fim:null,tipo_responsavel:2,situacao:OPORTUNIDADE_FILTROS.EM_ABERTO,representante:null,situacao_orcamento:null,entidade:null,entidade_tipo:null,filtro_kanban:null,funil_vendas_id:null,etiqueta_id:[]},this.requisicao_data={},this.arr_offset={},this.total_geral_pipe=0,this.qtd_orcamentos_pendentes=0,this.context_opt_selecionada_id=0,this.context_opt_selecionada_div=null,this.context_opt_selecionada_situacao=null,this.arr_oportunidades_selecionadas=[],this.tipo_visualizacao=OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN,this.dataGrid=null,this.dataGridStateStoring=null,this.clearState=!1,this.cards_compactos=!1,this.imagem_id=null,this.arr_paginacao=[],this.take=20,this.funil_redimensionar_etapas=!1,this.exibir_data_abertura_oportunidade=!1,App.temp.oportunidade={},App.temp.oportunidade.filtros={},this.funil_vendas_selecionado=null,this.funil_exibir_razao_social_entidade=!1,this.opcoes_filtro_situacao=[{id:OPORTUNIDADE_FILTROS.TODOS,descricao:"Todas"},{id:OPORTUNIDADE_FILTROS.EM_ABERTO,descricao:"Em Aberto"},{id:OPORTUNIDADE_FILTROS.GANHAS,descricao:"Ganhas"},{id:OPORTUNIDADE_FILTROS.PERDIDAS,descricao:"Perdidas"},{id:OPORTUNIDADE_FILTROS.ATRASADAS,descricao:"Atrasadas"},{id:OPORTUNIDADE_FILTROS.ESTAGNADAS,descricao:"Estagnadas"}],this.opcoes_filtro_tipo_responsavel=[{id:2,descricao:"Minhas Oportunidades"},{id:12,descricao:"Oportunidades Acompanhamento"},{id:1,descricao:"Todas Oportunidades"}],this.arrColunasCustomizadas=null,this.formularioCustomizado=null,this.toolbarInstace=null,this.show=function(a){o.funil_vendas_selecionado=a;var e=App.get_parametro_usuario("oportunidade_filtros");o.filtros=spread({},o.filtros,e),o.funil_vendas_id=o.filtros.funil_vendas_id=o.funil_vendas_selecionado?o.funil_vendas_selecionado:o.filtros.funil_vendas_id,o.toolbarInstace=o.toolbar.dxToolbar({onContentReady:a=>{o.lbl_total_geral_pipe=o.dialog.find(".lbl_total_geral_pipe"),o.div_info_qtd_opt_selec=o.dialog.find(".div_info_qtd_opt_selec"),o.lb_orcamentos_pendentes=o.dialog.find(".orcamentos_pendentes"),o.lbl_total_geral_pipe.text(o.total_geral_pipe.format_number(2,!0)),o.div_info_qtd_opt_selec.find("span.qtd_oportunidades_selec").text(o.arr_oportunidades_selecionadas.length),o.lb_orcamentos_pendentes.find("span.count_orcamentos").text(o.qtd_orcamentos_pendentes),o.qtd_orcamentos_pendentes>0&&o.lb_orcamentos_pendentes.show();var e={aoAlterar:a=>{o.filtros.entidade_tipo=a?a.tipo:null,o.filtros.entidade=a?a.id:null,o.render_tipo_visualizacao()},selecionado:{tipo:o.filtros.entidade_tipo,id:o.filtros.entidade},showClearButton:!0};ReactDOM.render(React.createElement(window.components.SelecaoEntidade.default,e),o.dialog.find(".selecaoClientes")[0]),this.div_dropdown_etiquetas=this.dialog.find(".selecaoEtiquetas"),ReactDOM.unmountComponentAtNode(o.div_dropdown_etiquetas[0]),ReactDOM.render(React.createElement(window.components.DropDownEtiquetas.default,{pai_tabela:"funil_vendas",pai_id:o.filtros.funil_vendas_id,selecionados:o.filtros.etiqueta_id.map(a=>a),onValueChanged:a=>{o.filtros.etiqueta_id=a||[],o.render_tipo_visualizacao()},readOnly:!1,stylingMode:"filled",width:300,maxDisplayedTags:2,applyValueMode:"useButtons"}),o.div_dropdown_etiquetas[0])},items:[{widget:"dxButton",options:{icon:"plus",hint:"Nova Oportunidade",text:"Nova Oportunidade",onClick:o.btn_novo_click},showText:"always",location:"before",name:"btn_novo",locateInMenu:"never",visible:!1},{template:$('<div title="Total Geral"><span></span>R$&nbsp;<strong><span class="lbl_total_geral_pipe">0,00</span></strong></div>'),location:"after",name:"lbl_total_geral_pipe",locateInMenu:"auto"},{template:$('<div class="text-info div_info_qtd_opt_selec hidden"><span class="fa fa-info-circle"></span>&nbsp;Oportunidades&nbsp;selecionadas:&nbsp;<span class="qtd_oportunidades_selec"></span></div>'),location:"after",name:"qtd_oportunidades_selec",locateInMenu:"auto"},{template:$('<div class="text-muted orcamentos_pendentes small" style="display: none;" title="Orçamentos aguardando aprovação"><i class="fas fa-tasks"></i>&nbsp;<span class="count_orcamentos">0</span></div>'),location:"after",name:"orcamentos_pendentes",locateInMenu:"auto"},{location:"after",widget:"dxButton",locateInMenu:"auto",showText:"inMenu",options:{icon:"fab fa-elementor",hint:"Compactar Cards",text:"Compactar Cards",onClick(){if(o.tipo_visualizacao!=OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN)return!1;var a=App.get_parametro_usuario("opcoesCardsOportunidade");o.cards_compactos=!o.cards_compactos,a!=o.cards_compactos&&App.set_parametro_usuario("opcoesCardsOportunidade",{cards_compactos:o.cards_compactos}),o.listar_etapas()}},visible:!1},{location:"after",widget:"dxButton",locateInMenu:"auto",showText:"inMenu",options:{icon:"fa fa-file-excel",hint:"Exportar para Excel",text:"Exportar para Excel",onClick(){switch(o.tipo_visualizacao){case OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN:o.download_datagrid_kanban();break;case OPORTUNIDADE_TIPO_VISUALIZACAO.GRID:o.dataGrid.exportToExcel()}}},visible:!1},{location:"after",widget:"dxButton",locateInMenu:"auto",showText:"inMenu",options:{icon:"far fa-star",hint:"Favoritar",text:"Favoritar",onClick(a){if(!o.funil_vendas_id)return!1;favoritar_item("funis_vendas",o.funil_vendas_id,!0),o.funil_vendas_favorito=!0,o.repaint_toolbar()}},visible:!1},{location:"after",widget:"dxButton",locateInMenu:"auto",showText:"inMenu",options:{icon:"fas fa-star",hint:"Desfavoritar",text:"Desfavoritar",onClick(a){if(!o.funil_vendas_id)return!1;favoritar_item("funis_vendas",o.funil_vendas_id,!1),o.funil_vendas_favorito=!1,o.repaint_toolbar()}},visible:!1},{location:"after",widget:"dxButton",locateInMenu:"auto",showText:"inMenu",options:{icon:"fa fa-sync",hint:"Recarregar",text:"Recarregar",onClick(){o.render_tipo_visualizacao()}},visible:!1},{location:"after",widget:"dxSelectBox",locateInMenu:"auto",options:{width:"auto",items:o.opcoes_filtro_situacao,valueExpr:"id",displayExpr:"descricao",value:parseInt(o.filtros.situacao),onValueChanged:function(a){o.filtros.situacao=a.value,o.render_tipo_visualizacao()}}},{location:"after",widget:"dxSelectBox",locateInMenu:"auto",options:{width:"auto",items:o.opcoes_filtro_tipo_responsavel,valueExpr:"id",displayExpr:"descricao",value:parseInt(o.filtros.tipo_responsavel),onValueChanged:function(a){o.filtros.tipo_responsavel=a.value,o.render_tipo_visualizacao()}}},{location:"after",template:(a,e,t)=>(o.dx_funil_vendas=$('<div class="dx_funil_vendas"/>').dxSelectBox({placeholder:"Funil de Vendas",width:"auto",valueExpr:"id",displayExpr:"nome",value:o.filtros.funil_vendas_id,dataSource:new DevExpress.data.DataSource.default({type:"array",key:"id",store:o.arr_funil_vendas.map(function(a,e){return 0==+o.funil_vendas_selecionado&&"S"==a.padrao&&(o.funil_vendas_selecionado=a.id),{nome:a.nome,id:a.id,extra:a}})}),onValueChanged(a){if(!a.value)return!1;o.filtros.funil_vendas_id=a.value,o.funil_vendas_id=a.value,o.ao_selecionar_funil()}}),o.dx_funil_vendas),locateInMenu:"never"},{template:$('<div class="selecaoEtiquetas"></div>'),location:"after",name:"selecaoEtiquetas",locateInMenu:"auto"},{template:$('<div class="selecaoClientes"></div>'),location:"after",name:"selecaoClientes",locateInMenu:"auto"}]}).dxToolbar("instance"),o.lbl_total_geral_pipe=o.dialog.find(".lbl_total_geral_pipe"),o.div_info_qtd_opt_selec=o.dialog.find(".div_info_qtd_opt_selec"),o.lb_orcamentos_pendentes=o.dialog.find(".orcamentos_pendentes"),o.tab_panel.dxTabPanel({height:"calc(100vh - 125px)",items:[{title:"Kanban",icon:"fab fa-trello",template:()=>(o.dx_kanban=o.dx_kanban||$('<div class="dx_kanban"></div>'),o.dx_filtro=o.dx_filtro||$('<div class="dx_filtro"></div>'),o.template_kanban=o.template_kanban||$('<div class="template_kanban"></div>').append(o.dx_kanban).append(o.dx_filtro),o.tipo_visualizacao=OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN,o.render_tipo_visualizacao(),o.template_kanban),tipo_visualizacao:OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN},{title:"Listagem",icon:"fas fa-list",template:()=>(o.dx_grid=o.dx_grid||$('<div class="dx_grid"></div>'),o.tipo_visualizacao=OPORTUNIDADE_TIPO_VISUALIZACAO.GRID,o.render_tipo_visualizacao(),o.dx_grid),tipo_visualizacao:OPORTUNIDADE_TIPO_VISUALIZACAO.GRID}],selectedIndex:0,onSelectionChanged:a=>{o.tipo_visualizacao=a.component.instance().option("selectedItem").tipo_visualizacao,o.repaint_toolbar(),o.funil_vendas_id&&View.loadPE("Oportunidade_Listagem",o)}}).dxTabPanel("instance"),o.listar_funil(),o.parametros_filtros_usuario(o.construct)},this.ao_selecionar_funil=function(){if(!o.funil_vendas_id)return!1;var a=o.arr_funil_vendas.filter(function(a,e){return a.id==o.funil_vendas_id})[0];a&&(o.escolha_empresa_ganho_perda=a.escolha_empresa_ganho_perda,o.exibir_data_abertura_oportunidade="S"==a.exibir_data_abertura_oportunidade,o.funil_redimensionar_etapas=a.redimensionar_etapas,o.funil_exibir_razao_social_entidade=a.exibir_razao_social_entidade,o.render_tipo_visualizacao())},this.listar_funil=function(){WS.get("funil_vendas/listar/",null,function(a){o.arr_funil_vendas=a,o.repaint_toolbar(),o.ao_selecionar_funil()})},this.modo_aprovacao_supervisor=function(a){WS.get("oportunidade_orcamento/listar/",{situacao:ORCAMENTO_FILTROS.AGUARDANDO_APROVACAO,supervisor:!0,return_count:!0},function(a){a>0?(o.lb_orcamentos_pendentes.show(),o.qtd_orcamentos_pendentes=a,o.lb_orcamentos_pendentes.find("span.count_orcamentos").text(o.qtd_orcamentos_pendentes)):o.lb_orcamentos_pendentes.hide()})},this.get_parametros=function(a){var e=new Object;if(e.funil_vendas_id=o.funil_vendas_id,e.listar_oportunidades=a,e.representantes=o.filtros.representante?o.filtros.representante.join():"",e.situacao_orcamento=o.filtros.situacao_orcamento?o.filtros.situacao_orcamento.join():"",e.tipo_periodo=o.filtros.tipo_periodo,e.dt_ini=o.filtros.dt_ini,e.dt_fim=o.filtros.dt_fim,e.entidade_id=o.filtros.entidade,e.entidade_tipo=o.filtros.entidade_tipo,e.etiqueta_id=o.filtros.etiqueta_id,e.observacao=o.observacao,e.retorno_obj=!0,void 0!==o.condicao_extra&&null!==o.condicao_extra){var t=null;"string"==typeof o.condicao_extra.sql_condicao?t=o.condicao_extra.sql_condicao.match(/(\[.+\])/g):o.condicao_extra.sql_condicao instanceof Array&&(t=o.condicao_extra.sql_condicao.join(" ").match(/(\[.+\])/g)),void 0!==o.condicao_extra.sql_condicao&&null!=t&&("string"==typeof o.condicao_extra.sql_condicao?o.condicao_extra.sql_condicao:o.condicao_extra.sql_condicao instanceof Array&&o.condicao_extra.sql_condicao.join(" ")),e.condicao_extra=o.condicao_extra}else e.condicao_extra=null;switch(e.tipo_responsavel=o.filtros.tipo_responsavel,e.situacao=o.filtros.situacao,o.tipo_visualizacao){case OPORTUNIDADE_TIPO_VISUALIZACAO.GRID:e.filter=null;break;case OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN:default:e.filter=JSON.stringify(o.filtros.filtro_kanban||{})}return e},this.parametros_filtros_usuario=function(a,e){WS.get("filtro_usuario/get_filtros_parametros/",{codigo_tela:TELAS.LISTAGEM_OPORTUNIDADE.codigo},function(t){var i=[],n=0;if(t&&t.length>0){var r='<div class="row">';$(t).each(function(a,e){var t=e.condicao_consulta.split(/ AND | OR /g);if(0==t[t.length-1].trim().length&&t.splice(t.length-1,1),null!=e.condicao_consulta.match(/\[\[parametro\]\]/g))for(var d=0;d<t.length;d++){var s=t[0].split("}")[0].split("{")[1]||(null!=t[a].match(/fn_situacao_oportunidade/g)?"estagnado.dias":null),l=o.coletar_alias(s);if(null!=t[d].match(/\[\[parametro\]\]/g)){(u=new PARAMETRO_CLASS).id=md5(new Date+s+Math.round(10*Math.random())+a),u.alias_campo=l.alias_campo,u.tipo_campo=l.tipo_campo,u.ipt_tipo=l.tipo_input,u.nome_campo=s,u.sql_original=t[d];var c=u.gerar_elemento().outerHTML;r+=c;var _={campo_id:s,operador:u.get_elemento_operador(),element_id:u.id,campo_tipo:u.get_elemento_tipo(),tipo_entrada:u.ipt_tipo,parametro_id:n};i.push(_),n++}}else{s=t[0].split("}")[0].split("{")[1]||(null!=t[a].match(/fn_situacao_oportunidade/g)?"estagnado.dias":null),l=o.coletar_alias(s);for(var p=0;p<t.length;p++){var u;(u=new PARAMETRO_CLASS).id=null,u.alias_campo=l.alias_campo,u.tipo_campo=l.tipo_campo,u.ipt_tipo=PARAMETRO_PERSONALIZADO_IPT.NOINPUT,u.nome_campo=s,u.sql_original=t[p],_={campo_id:s,operador:u.get_elemento_operador(),element_id:u.id,campo_tipo:u.get_elemento_tipo(),tipo_entrada:u.ipt_tipo},o.parametros_filtros.push(_),n++}}}),i.length>0?alert_modal("Informe o parâmetro",r,"Ok",function(e,t){$(i).each(function(e,t){var i=$("#"+t.element_id),n=null;if(""!==i.val()&&null!==i.val()&&i.val().trim().length>0){switch(t.operador){case"LIKE":n="'%"+i.val()+"%'";break;case"=":case">=":case"<=":case">":case"<":n="'"+i.val()+"'";break;case"NOT IN":case"IN":n="('"+i.val()+"')";break;case"!=":case"<>":n="'"+i.val()+"'"}t.campo_tipo!=PARAMETRO_PERSONALIZADO_TIPO.FLOAT&&t.campo_tipo!=PARAMETRO_PERSONALIZADO_TIPO.INT||""!=n&&null!=n.match(/[\,]/g)&&(n=n.replace(/[\,]/g,"."));var r={campo_id:t.campo_id,valor:n,valor_original:i.val(),campo_tipo:t.campo_tipo,original:t.original,operador:t.operador};App.temp.oportunidade.filtros[t.campo_id+"_"+e]=$("#"+t.element_id).val(),o.parametros_filtros.push(r)}void 0!==a&&a()})},!0,null,function(a){for(var e=$(a).find("[campo_id]").length,t=["STATUS"],n=["nome"],r=0;r<$(a).find("select").length;r++){var d=$(a).find("select").eq(r);"status_oportunidade.nome"==$(a).find("select").eq(r).attr("campo_id")?d.SelectMultiColumn({route:"status_oportunidade/listar/",params:null,arr_cols:t,arr_campos:n,campo_value:"nome"}):d.SelectMultiColumn()}for(var s=0;s<e;s++)void 0!==App.temp.oportunidade.filtros&&void 0!==App.temp.oportunidade.filtros[$(a).find("[campo_id]").eq(s).attr("campo_id")+"_"+s]&&App.temp.oportunidade.filtros[$(a).find("[campo_id]").eq(s).attr("campo_id")+"_"+s].length>0?"status_oportunidade.nome"==$(a).find("[campo_id]").eq(s).attr("campo_id")?(d.SelectMultiColumn("val",App.temp.oportunidade.filtros[$(a).find("[campo_id]").eq(s).attr("campo_id")+"_"+s]),d.SelectMultiColumn("refresh")):$(a).find("[campo_id]").eq(s).val(App.temp.oportunidade.filtros[$(a).find("[campo_id]").eq(s).attr("campo_id")+"_"+s]):App.temp.oportunidade.filtros[$(a).find("[campo_id]").eq(s).attr("campo_id")+"_"+s]="";for(s=0;s<i.length;s++)i[s].tipo_entrada==PARAMETRO_PERSONALIZADO_IPT.DATE?set_datepicker($(a).find("#"+i[s].element_id)):i[s].tipo_entrada==PARAMETRO_PERSONALIZADO_IPT.INPUT&&(i[s].campo_tipo!=PARAMETRO_PERSONALIZADO_TIPO.INT&&i[s].campo_tipo!=PARAMETRO_PERSONALIZADO_TIPO.FLOAT||$(a).find("#"+i[s].element_id).keyup(function(a){var o=$(this).val();o=o.replace(/[^0-9]/g,""),46==a.which?$(this).val($(this).val().replace(/[\.]/g,",")):$(this).val($(this).val().replace(/([^0-9\.\,])/g,""))}).keypress(function(a){}).blur(function(a){$(this).val($(this).val().replace(/[\.]/g,","))}));o.parametros_filtros=[]},function(){void 0!==a&&a()}):0==i.length&&(void 0!==a&&a(),e&&alert_fail("Nenhum parâmetro precisa ser informado. Verifique as configurações de filtros do funíl."))}else void 0!==a&&a(),e&&alert_fail("Não existe filtro ativo para o funíl.")})},this.construct=function(){WS.get("filtro_usuario/listar/",{filtro_usuario_id:App.sessao.dados.usuario_id,codigo_tela:TELAS.LISTAGEM_OPORTUNIDADE.codigo,verificar:!0},function(a){var e=[],t=[],i=[],n=[],r="",d="",s=0,l=a;if(o.filtro_usuario_carregado=!0,l.length>0){if(void 0===o.parametros_filtros[s]){for(var c=0;c<a.length;c++)if(null==a[c].condicao_consulta.match(/\[\[(parametro)\]\]/g)){null!=a[c].condicao_consulta.match(/(cliente_regiao_vendas)|(regiao_vendas)/g)&&(e.push("regiao_vendas"),e.push("cliente_regiao_venda"));var _=a[c].condicao_consulta.match(/(\{.+\})/g);null!=_&&(!function(){for(var a=0;a<_.length;a++){if(null!=_[a].match(/(regiao_vendas)|(cliente_regiao_vendas)/g))return void _.splice(a,1);!function(a,o){var i=[];if(_.findIndex(function(o,e){return a===o.toString().replace(/({)|(})/g,"")&&i.push(e),0}),i.length>1)for(var n=1;n<i.length;n++)_.splice(n,1);(function(){for(var a=0;a<_.length;a++)_[a]=_[a].replace(/({)|(})/g,"")})(),function(){for(var a=0;a<_.length;a++)t.push(_[a])}(),function(){for(var a=[],o=0;o<_.length;o++){var t=null!=_[o].match(/(.)/g)?_[o].split(".")[0]:"",i=!1,n=a.findIndex(function(a,o){return t===a?(i=!0,a):0});i&&0!=n.length||a.push(t)}for(o=0;o<a.length;o++)e.push(a[o])}()}(_[a].replace(/({)|(})/g,""))}}(),d+=" AND "+a[c].condicao_consulta.replace(/({)|(})|(\[)|(\])/g,""))}return i={tabelas:e,sql_condicao:d},o.condicao_extra=i.sql_condicao.length>0?i:null,void o.render_tipo_visualizacao()}for(var p=0;p<l.length;p++){var u=0;if(null!=l[p].condicao_consulta.match(/\[\[(parametro)\]\]/g))for(u=l[p].condicao_consulta.match(/\[\[(parametro)\]\]/g).length,c=0;null!=l[p].condicao_consulta.match(/\[\[(parametro)\]\]/g)&&c<u;c++){l[p].operadores=l[p].condicao_consulta.match(/(LIKE|=|>|<|<>|!=|>=|<=|NOT IN|IN)/g);var f="";f=o.parametros_filtros[s].valor,void 0!==o.parametros_filtros[s].valor_original&&""==o.parametros_filtros[s].valor_original&&(l[p].ignorar=!0),l[p].condicao_consulta=l[p].condicao_consulta.replace(l[p].condicao_consulta.match(/(\[\[parametro\]\])/)[0],f),l[p].condicao_consulta=o.tratamento_da_query(l[p].condicao_consulta),s++}else{for(var m=[],v=l[p].condicao_consulta.split(" OR "),g=0;g<v.length;g++){var A=(r=v[g].replace(/(( OR ).+)/g,"")).match(/(LIKE|=|>|<|<>|!=|>=|<=|NOT IN|IN)/g),O=(f="",!1);(b=null==r.match(/\[\[parametro\]\]/g)&&null!=r.match(/\[|\]/g))&&(r=r.replace(/(\[)|(\])/g,"")),null==A||b||(">"!=A[0]&&"<"!=A[0]||(O=!0,void 0===(f=r.split("'")[1])&&(l[p].campo_tipo!=ELEMENTO_TIPO.DECIMAL&&l[p].campo_tipo!=ELEMENTO_TIPO.INTEIRO||(f=l[p].valor.replace(",",".")))),"LIKE"==A[0]&&(f="'%"+r.split("'")[1]+"%'"),"="==A[0]&&(f="'"+r.split("'")[1]+"'"),"IN"==A[0]&&(f="('"+r.split("'")[1]+"')"),"NOT IN"==A[0]&&(f="('"+r.split("'")[1]+"')")),r=O?r.split(A[0])[0]+A[0]+f+" OR ":r.split("'")[0]+f+" OR ",m.push(r)}var h=l[p].condicao_consulta.split(" AND ");if(v.join(" OR ")!=h.join()||l[p].condicao_consulta.indexOf(" AND ")>-1)for(g=0;g<h.length;g++){var b;A=(r=h[g].replace(/(( OR ).+)/g,"")).match(/(LIKE|=|>|<|<>|!=|>=|<=|NOT IN|IN)/g),f="",O=!1,(b=null==r.match(/\[\[parametro\]\]/g)&&null!=r.match(/\[|\]/g))&&(r=r.replace(/(\[)|(\])/g,"")),null==A||b||(">"!=A[0]&&"<"!=A[0]||(O=!0,void 0===(f=r.split("'")[1])&&(l[p].campo_tipo!=ELEMENTO_TIPO.DECIMAL&&l[p].campo_tipo!=ELEMENTO_TIPO.INTEIRO||(f=l[p].valor.replace(",",".")))),"LIKE"==A[0]&&(f="'%"+r.split("'")[1]+"%'"),"IN"==A[0]&&(f="('"+r.split("'")[1]+"')"),"NOT IN"==A[0]&&(f="('"+r.split("'")[1]+"')")),r=O?r.split(A[0])[0]+A[0]+f+" AND ":r.split("'")[0]+f+" AND ",m.push(r)}m.length>0&&(m[m.length-1]=m[m.length-1].replace(/( AND | OR )/g,""),l[p].condicao_consulta=m.join(""))}l[p].ultima_query=l[p].condicao_consulta}for(var I=0;I<l.length;I++)if(void 0===l[I].ignorar||!0!==l[I].ignorar){var T=l[I].condicao_consulta.split(" OR ");if(-1==T.join().indexOf(" AND "))for(p=0;p<T.length;p++)r=T[p].replace(/(( AND ).+)/g,""),n.push(r+(p!=T.length-1?" OR ":" AND "));var x=l[I].condicao_consulta.split(" AND ");if(-1!=l[I].condicao_consulta.indexOf(" AND "))for(p=0;p<x.length;p++)r=x[p].replace(/(( OR ).+)/g,""),n.push(r+" AND ")}for(n.length>=1&&(n[n.length-1]=n[n.length-1].replace(/( OR | AND |)/g,"")),I=0;I<n.length;I++){var R=n[I].match(/[\{](.+?)[\}]/g);null!=R&&-1==t.join(",").indexOf(R[0].toString().replace(/[\{]|[\}]/g,""))&&t.push(R[0].toString().replace(/[\{]|[\}]/g,""));var P=n[I].match(/(\{.).*?(\.)/g);null!=P&&-1==e.join(",").indexOf(P[0].toString().replace(/[\{]|[.]/g,""))&&e.push(P[0].toString().replace(/[\{]|[.]/g,"")),n[I]=n[I].replace(/[\{]|[\}]/g,"")}for(i={campos:t,tabelas:e,sql_condicao:n},I=0;I<i.sql_condicao.length;I++)if(i.sql_condicao[I].indexOf("(")>-1&&I+1<i.sql_condicao.length&&i.sql_condicao[I+1].indexOf(" AND ")>-1){var E=i.sql_condicao[I+1].indexOf(" AND ")-1;c=i.sql_condicao[I+1].substring(0,E)+") "+i.sql_condicao[I+1].substring(E,i.sql_condicao[I+1].length),i.sql_condicao[I+1]=c}o.condicao_extra=i.sql_condicao.length>0?i:null}else o.condicao_extra=a.condicao_consulta;o.render_tipo_visualizacao()})},this.repaint_toolbar=function(){o.toolbar.dxToolbar("instance").option("items[0]").visible=o.funil_vendas_id>0,o.toolbar.dxToolbar("instance").option("items[4]").visible=o.funil_vendas_id>0&&o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN,o.toolbar.dxToolbar("instance").option("items[5]").visible=o.funil_vendas_id>0,o.toolbar.dxToolbar("instance").option("items[6]").visible=o.funil_vendas_id>0&&!o.funil_vendas_favorito,o.toolbar.dxToolbar("instance").option("items[7]").visible=o.funil_vendas_id>0&&o.funil_vendas_favorito,o.toolbar.dxToolbar("instance").option("items[8]").visible=o.funil_vendas_id>0,o.toolbar.dxToolbar("instance").option("items[9]").options.value=parseInt(o.filtros.situacao),o.toolbar.dxToolbar("instance").option("items[10]").options.value=parseInt(o.filtros.tipo_responsavel),o.toolbar.dxToolbar("instance").repaint()},this.get_oportunidade_listar=((a,e)=>{WS.get("oportunidade/listar/",a,a=>{if(!a)return!1;o.observacao_oportunidade_perdida=a.observacao_oportunidade_perdida,o.observacao=a.observacao,o.motivo_perda_negocio=a.motivo_perda_negocio,o.arrColunasCustomizadas=a.colunas_customizadas,o.formularioCustomizado=a.formulario_model,o.arr_etapas=a.data,o.funil_vendas_favorito=a.data.map(function(a){return verifica_favorito("funis_vendas",a.funil_vendas_id)})[0],o.repaint_toolbar(),e&&e(a.data),o.modo_aprovacao_supervisor()})}),this.listar_grid=function(){if(o.filtro_usuario_carregado&&o.dx_grid){App.set_parametro_usuario("oportunidade_filtros",o.filtros),o.dataGrid&&o.dataGrid.beginCustomLoading();var a=detectmob()?"select":"dragAndDrop";o.get_oportunidade_listar(o.get_parametros(!0),e=>{o.arr_oportunidades_selecionadas=[],o.div_info_qtd_opt_selec.addClass("hidden");var t=get_icon_class(),i=[];o.total_geral_pipe=0,e.forEach(function(a,e){a.oportunidades.forEach(function(a,e){i.push(a),o.total_geral_pipe+=parseFloat(a.total_oportunidade||a.valor_negocio||0)})}),o.lbl_total_geral_pipe.text(o.total_geral_pipe.format_number(2,!0)),i=i.sort(function(a,o){var e=a.etapa_ordem,t=o.etapa_ordem,i=0;return e>t?i=1:e<t&&(i=-1),i}),o.dataGrid?(o.dataGrid.option("dataSource",i),o.dataGrid.endCustomLoading()):(ReactDOM.render(React.createElement(window.components.DropDownVisoes.default,{chave:"oportunidade_grid",aoAlterarStateStoring:a=>{o.dataGridStateStoring=a,o.dataGrid&&(o.dataGrid.option("dataSource",null),o.dataGrid.option("stateStoring",a),o.listar_grid())}}),o.drop_down_visoes[0]),o.dx_grid.css("height","calc(100vh - 125px)"),o.dataGrid=o.dx_grid.dxDataGrid({dataSource:i,stateStoring:o.dataGridStateStoring,paging:{pageSize:20},pager:{showPageSizeSelector:!0,allowedPageSizes:[20,50,100],showInfo:!0},searchPanel:{visible:!0,highlightCaseSensitive:!0},groupPanel:{visible:!0},filterPanel:{visible:!0},filterRow:{visible:!0,applyFilter:"auto"},headerFilter:{visible:!0},grouping:{autoExpandAll:!0},selection:{mode:"multiple"},columnChooser:{enabled:!0,allowSearch:!0,mode:a},searchPanel:{visible:!detectmob(),width:200,placeholder:"Pesquisa geral"},allowColumnReordering:!0,rowAlternationEnabled:!1,allowColumnResizing:!0,showBorders:!0,export:{enabled:!0,fileName:"Listagem de Oportunidades "+agora(),allowExportSelectedData:!0},columns:[...o.dx_oportunidade_columns(),{type:"buttons",fixed:!0,fixedPosition:"right",buttons:[{hint:"Editar Oportunidade",icon:"fa fa-pencil-alt",cssClass:t,onClick:function(a){View.load("oportunidade/detalhes",function(e,t){t.onclose=function(){o.render_tipo_visualizacao()},t.show(a.row.data.oportunidade_id,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS,null,null,{oportunidadeId:a.row.data.oportunidade_id})}},{hint:"Clonar Oportunidade",icon:"copy",cssClass:t,onClick:function(a){DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja clonar a oportunidade #"+a.row.data.oportunidade_id+"?",buttons:[{text:"Sim",onClick:function(){alert_info("Clonando Oportunidade. Por favor, aguarde"),WS.post("oportunidade/clonar_oportunidade",{oportunidade_id:a.row.data.oportunidade_id},function(a){o.render_tipo_visualizacao(),alert_saved("Oportunidade clonada com sucesso!")})}},{text:"Não",onClick:function(a){return!1}}]}).show()}},{hint:"Etiquetas",icon:"fas fa-tags",cssClass:t,onClick:function(a){View.loadReact(window.views.etiqueta.Listagem.default,{pai_tabela:"oportunidade",pai_id:a.row.data.oportunidade_id,titulo:a.row.data.nome},a=>{},View.ABA.MULTIPLAS)}},{hint:"Transferir Oportunidade",icon:"fa fa-share-square",cssClass:t,onClick:function(a){View.load("oportunidade/transferencia_representantes",function(e,t){t.onsave=o.render_tipo_visualizacao,t.show([a.row.data.oportunidade_id])})}},{hint:"Marcar como Negócio Aberto",icon:"clock",cssClass:t,onClick:function(a){"A"==a.row.data.situacao||"AT"==a.row.data.situacao?alert_info("A oportunidade #"+a.row.data.oportunidade_id+" já se encontra aberta"):DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja marcar a oportunidade #"+a.row.data.oportunidade_id+" como aberta?",buttons:[{text:"Sim",onClick:function(){alert_info("Por favor, aguarde"),o.atualizar_situacao_oportunidade(a.row.data.oportunidade_id,"A")}},{text:"Não",onClick:function(a){return!1}}]}).show()}},{hint:"Marcar como Negócio Ganho",icon:"fa fa-thumbs-up",cssClass:t,onClick:function(a){"G"==a.row.data.situacao?alert_info("A oportunidade #"+a.row.data.oportunidade_id+" já se encontra ganha"):o.checa_eventos_abertos(a.row.data.oportunidade_id,"G")}},{hint:"Marcar como Negócio Perdido",icon:"fa fa-thumbs-down",cssClass:t,onClick:function(a){o.checa_eventos_abertos(a.row.data.oportunidade_id,"P")}},{hint:"Excluir Oportunidade",icon:"trash",cssClass:t,onClick:function(a){o.checa_eventos_abertos(a.row.data.oportunidade_id,"E")}}]}],onToolbarPreparing:function(a){var e=[{widget:"dxButton",options:{icon:"copy",hint:"Clonar Oportunidades selecionadas",text:"Clonar Oportunidades selecionadas",onClick:function(a){var e=o.dataGrid.getSelectedRowsData().map(function(a){return a.oportunidade_id});DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja clonar a(s) oportunidade(s) "+e.join(", ")+"?",buttons:[{text:"Sim",onClick:function(){alert_info("Clonandos Oportunidades. Por favor, aguarde"),WS.post("oportunidade/clonar_oportunidade",{oportunidade_id:JSON.stringify(e)},function(a){o.render_tipo_visualizacao(),alert_saved("Oportunidades clonadas com sucesso!")})}},{text:"Não",onClick:function(a){return!1}}]}).show()}},showText:"inMenu",location:"after",name:"BtnClonarEmMassa",locateInMenu:"auto"},{widget:"dxButton",options:{icon:"fa fa-share-square",hint:"Transferir Oportunidades selecionadas",text:"Transferir Oportunidades selecionadas",onClick:function(){var a=o.dataGrid.getSelectedRowsData().map(function(a){return a.oportunidade_id});View.load("oportunidade/transferencia_representantes",function(e,t){t.onsave=o.render_tipo_visualizacao,t.show(a)})}},showText:"inMenu",location:"after",name:"BtnTransferirEmMassa",locateInMenu:"auto"},{location:"after",locateInMenu:"never",template:()=>o.drop_down_visoes[0]}];a.toolbarOptions.items=add_botao_dx_toolbar(e,a.toolbarOptions.items)},onRowPrepared:function(a){"data"===a.rowType&&(setTimeout(function(){var e=o.dataGrid.getCellElement(a.rowIndex,"situacao");if(e){var t=e.text();if(t.trim().length){var i="";switch(t){case"Ganho":i="label-success";break;case"Perdido":i="label-warning";break;case"Aberto":i="label-default";break;case"Atrasado":i="label-danger";break;case"Estagnado":i="label-info"}e.html('<span class=" label '+i+'">'+t+"</span>")}}}),setTimeout(function(){var e=o.dataGrid.getCellElement(a.rowIndex,"situacao_ultimo_orcamento");if(e){var t=e.text();if(t.trim().length){var i="";switch(t){case"Orçamento Aguardando Aprovação":i="label-warning";break;case"Orçamento Aprovado":i="label-success";break;case"Orçamento Reprovado":i="label-danger";break;case"Orçamento Aprovado / Aguardando E-Mail":i="label-default";break;case"Orçamento Em Análise":i="label-info"}e.html('<span class=" label '+i+'">'+t+"</span>")}}}))},onRowClick:function(a){onDoubleClick(a,function(){View.load("oportunidade/detalhes",function(e,t){t.onclose=function(){o.render_tipo_visualizacao()},t.show(a.data.oportunidade_id,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS,null,null,{oportunidadeId:a.data.oportunidade_id})})},onContextMenuPreparing:function(a){"header"==a.target&&Array.isArray(a.items)&&a.items.push({text:"Restaurar estado das colunas",visible:!0,beginGroup:!0,onItemClick:function(a){DevExpress.ui.dialog.confirm("Os filtros, ordenações, agrupamentos, posição, tamanho, e visibilidade das colunas desta listagem serão restauradas ao estado padrão. <b>Deseja continuar?</b>","Restaurar estado das colunas").done(function(a){a&&(o.clearState=!0,o.render_tipo_visualizacao())})}})},onContentReady:function(a){o.clearState&&(o.dataGrid.state({}),o.clearState=!1)}}).dxDataGrid("instance"),o.dataGrid.endCustomLoading())}),o.funil_vendas_id&&View.loadPE("Oportunidade_Listagem",o)}},this.listar_etapas=function(){if(o.filtro_usuario_carregado&&o.dx_kanban&&o.funil_vendas_id){for(var a=0;a<o.arr_funil_vendas.length;a++){var e=o.arr_funil_vendas[a];e.id==o.funil_vendas_id&&(o.imagem_id=e.imagem_id)}o.definir_background(),App.set_parametro_usuario("oportunidade_filtros",o.filtros),o.get_oportunidade_listar(o.get_parametros(!0),function(a){o.arr_oportunidades_selecionadas=[];var e=null,t=null;o.dx_kanban.find(".dx-card").map(function(a,o){e=$(o).css("background-color"),t=e.replace(".4","1"),$(o).css("background-color",t)}),o.dx_kanban.find(".dx-card").css("border","1px solid rgb(211,211,211)"),o.div_info_qtd_opt_selec.addClass("hidden"),o.preencher_kanban(),"S"!=o.funil_redimensionar_etapas&&1!=o.funil_redimensionar_etapas||o.calcula_width_etapa()}),o.funil_vendas_id&&View.loadPE("Oportunidade_Listagem",o)}},this.validar_modo_visualizacao=function(){},this.preencher_kanban=function(){$(function(){!function(){ReactDOM.render(React.createElement(window.components.Filtro.default,{fields:o.dx_kanban_filtro_fields(),value:o.filtros.filtro_kanban,onValueChanged:a=>{o.filtros.filtro_kanban=a,o.listar_etapas()}}),o.dx_filtro[0]);var a=document.createElement("div");a.className="div_kanban",a.style="min-width: 100%; height: calc(100vh - 179px);",o.dx_kanban.find(".div_kanban").remove(),o.dx_kanban[0].appendChild(a);var e=o.dx_kanban.find(".div_kanban");o.total_geral_pipe=0,o.arr_oportunidades_kanban=[],o.arr_etapas.forEach(function(a,t){a.oportunidades.forEach(function(a,e){o.arr_oportunidades_kanban.push(a)});let n=a.total_oportunidade||0;o.total_geral_pipe+=parseFloat(n),function(a,e){o.arr_oportunidades_etapa=[],o.arr_oportunidades_etapa=e.oportunidades;var t=$("<div>").addClass("list").addClass("listDrop").attr("id",e.funil_vendas_etapa_id).attr("oportunidades",JSON.stringify(e.oportunidades)).css("min-width","240px").appendTo(a);t.css("height","calc(100vh - 190px)"),function(a,e){var t=$("<div>");$("<div>").addClass("titulo_etapa").addClass("col-md-10").addClass("dx-theme-text-color").addClass("col-md-10").text(e.ordem+". "+e.nome).attr("title",e.nome).css("margin-top","8px").css("font-weight","bold").css("font-size","14px").css("overflow","hidden").css("text-overflow","ellipsis").css("white-space","nowrap").appendTo(t),$("<div>").addClass("opcoes_titulo_lista").addClass("col-md-2").appendTo(t).dxDropDownButton({icon:"sorted",showArrowIcon:!1,dropDownOptions:{width:230},onItemClick:function(a){a.itemData.fn_onclick(e)},dataSource:[{id:"1",descricao:"Ascendente",icon:"sortup",fn_onclick:function(a){WS.post("oportunidade/ordernarOportunidades/",{funil_vendas_etapa_id:a.funil_vendas_etapa_id,tipo_ordenacao:"ASC"},function(a){alert_saved("Ordenação realizada"),o.render_tipo_visualizacao()})}},{id:"2",descricao:"Descendente",icon:"sortdown",fn_onclick:function(a){WS.post("oportunidade/ordernarOportunidades/",{funil_vendas_etapa_id:a.funil_vendas_etapa_id,tipo_ordenacao:"DESC"},function(a){alert_saved("Ordenação realizada"),o.render_tipo_visualizacao()})}}],valueExpr:"id",displayExpr:"descricao"}).dxDropDownButton("instance").element().find(".dx-button-content").css("padding-right","10px").parent().css("border","none"),t.append($('<div style="border-bottom: 2px outset rgba(0,0,0,0.4); padding-bottom: 10px; width: 100%; margin-top: 5px; font-size: 14px;" class="col-md-10 dx-theme-text-color"><small>'+e.oportunidades.length+'</small> | <small><span class="glyphicon glyphicon-briefcase"></span> '+(e.total_oportunidade?e.total_oportunidade.format_number(2,!0):"0,00")+"</small></div>")),t.appendTo(a)}(t,e);var n=o.arr_oportunidades_etapa.filter(function(a){return a.funil_vendas_etapa_id==e.funil_vendas_etapa_id});o.arr_paginacao[e.funil_vendas_etapa_id]={skip:o.arr_paginacao[e.funil_vendas_etapa_id]?o.arr_paginacao[e.funil_vendas_etapa_id].skip:0,take:o.arr_paginacao[e.funil_vendas_etapa_id]?o.arr_paginacao[e.funil_vendas_etapa_id].take:o.take,total:n.length},function(a,e,t){var n=$("<div>").appendTo(a),r=$("<div>").appendTo(n);n.css("height","calc(100vh - 255px)");var d=function(a){for(var n=o.arr_paginacao[e.funil_vendas_etapa_id].take<o.arr_paginacao[e.funil_vendas_etapa_id].total?o.arr_paginacao[e.funil_vendas_etapa_id].take:o.arr_paginacao[e.funil_vendas_etapa_id].total,d=a?0:o.arr_paginacao[e.funil_vendas_etapa_id].skip;d<n;d++){var s=t[d];i(r,s)}};d(!0);var s=n.addClass("dx-scrollable-container").dxScrollView({direction:"vertical",showScrollbar:"always",useNative:!1,width:"100%",onScroll:function(a){var e=a.element.parents(".list").attr("id");o.arr_offset[e]=s.scrollOffset()},onReachBottom:function(a){o.arr_paginacao[e.funil_vendas_etapa_id].skip+=o.take,o.arr_paginacao[e.funil_vendas_etapa_id].take+=o.take,d(!1),o.arr_paginacao[e.funil_vendas_etapa_id].take<o.arr_paginacao[e.funil_vendas_etapa_id].total?a.component.release():a.component.release(!0)}}).dxScrollView("instance");n.find(".dx-scrollable-scroll-content").css("background","rgb(54,54,54)"),r.addClass("sortable-cards").dxSortable({group:"tasksGroup",moveItemOnDrop:!0,data:t,onDragStart:function(a){o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&o.div_drag_situacao.fadeIn(300)},onDragEnd:function(a){o.hide_drag_situacao();var e=$(a.fromComponent._$element).parents(".list").attr("id"),t=$(a.toComponent._$element).parents(".list").attr("id");if(!isNaN(e)&&!isNaN(t)){var i=$(a.itemElement).attr("id"),n=a.fromIndex,r=a.toIndex,d=function(){WS.post({route:"oportunidade/alterar_ordem/",data:{oportunidade_id:i,funil_vendas_id:o.funil_vendas_id,funil_vendas_etapa_anterior:e,funil_vendas_etapa_id:t,old_ordem:n,new_ordem:r},func_response:function(a){o.listar_etapas()},func_fail:function(){o.listar_etapas()}})};e==t?d():WS.get("oportunidade/verificar_oportunidade_solicitacao/",{oportunidade_id:i},function(a){a.retorno||"N"!=a.vinculo_obrigatorio?d():alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',"A oportunidade precisa de um processo com a etapa "+a.nome_etapa+" aprovada<br />Esta oportunidade não possui, deseja continuar mesmo assim ?","Sim",function(){d()},!0,"Cancelar",void 0,function(){o.listar_etapas()})})}}});var l=o.context_menu.dxContextMenu({dataSource:[{text:"Negócio Aberto",icon:"dx-icon-clock"},{text:"Negócio Ganho",icon:"fa fa-thumbs-up"},{text:"Negócio Perdido",icon:"fa fa-thumbs-down"},{text:"Selecionar",icon:"dx-icon-check"},{text:"Desmarcar",icon:"dx-icon-close"},{text:"Desmarcar todas",icon:"fa fa-ban"},{text:"Mais opções",items:[{text:"Clonar Oportunidade(s)",icon:"dx-icon-copy"},{text:"Transferir Oportunidade(s)",icon:"fa fa-share-square"},{text:"Excluir",icon:"dx-icon-trash"}]}],width:function(){return window.innerWidth/7},target:".dx-card",onPositioning:function(a){o.context_opt_selecionada_div=$(a.event.currentTarget),o.context_opt_selecionada_id=$(a.event.currentTarget).attr("id"),o.context_opt_selecionada_situacao=$(a.event.currentTarget).attr("situacao");var e=l._dataSource._items[0],t=l._dataSource._items[1],i=l._dataSource._items[2],n=l._dataSource._items[3],r=l._dataSource._items[4],d=l._dataSource._items[5],s=l._dataSource._items[6].items[2];e.visible=!(o.arr_oportunidades_selecionadas.length>0),t.visible=!(o.arr_oportunidades_selecionadas.length>0),i.visible=!(o.arr_oportunidades_selecionadas.length>0),s.visible=!(o.arr_oportunidades_selecionadas.length>0),n.visible=!o.arr_oportunidades_selecionadas.includes(o.context_opt_selecionada_id),r.visible=o.arr_oportunidades_selecionadas.includes(o.context_opt_selecionada_id),d.visible=o.arr_oportunidades_selecionadas.length,l.repaint()},itemTemplate:function(a,o,e){var t=$("<div></div>");return a.icon&&t.append('<span class="'+a.icon+'"></span> '),a.items&&t.append('<span class="dx-icon-spinright"></span> '),"Negócio Aberto"==a.text&&($(t).css("background-color","rgba(211, 211, 211, 0.4)"),$(t).css("padding","10px 3px"),$(t).css("font-weight","bold")),"Negócio Ganho"==a.text&&($(t).css("background-color","rgba(0, 255, 140, 0.4)"),$(t).css("padding","10px 3px"),$(t).css("font-weight","bold")),"Negócio Perdido"==a.text&&($(t).css("background-color","rgba(255, 165, 0, 0.4)"),$(t).css("padding","10px 3px"),$(t).css("font-weight","bold")),t.append(a.text),t},onItemClick:function(a){if(!a.itemData.items)switch(a.itemData.text){case"Negócio Aberto":"A"==o.context_opt_selecionada_situacao||"AT"==o.context_opt_selecionada_situacao?alert_info("A oportunidade #"+o.context_opt_selecionada_id+" já se encontra aberta"):DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja marcar a oportunidade #"+o.context_opt_selecionada_id+" como aberta?",buttons:[{text:"Sim",onClick:function(){alert_info("Por favor, aguarde"),o.atualizar_situacao_oportunidade(o.context_opt_selecionada_id,"A")}},{text:"Não",onClick:function(a){return!1}}]}).show();break;case"Negócio Ganho":"G"==o.context_opt_selecionada_situacao?alert_info("A oportunidade #"+o.context_opt_selecionada_id+" já se encontra ganha"):o.checa_eventos_abertos(o.context_opt_selecionada_id,"G");break;case"Negócio Perdido":o.checa_eventos_abertos(o.context_opt_selecionada_id,"P");break;case"Excluir":o.checa_eventos_abertos(o.context_opt_selecionada_id,"E");break;case"Selecionar":var e=o.context_opt_selecionada_div.css("background-color"),t=e.replace("rgb","rgba").replace(")",",.4)");o.context_opt_selecionada_div.css("background-color",t),o.context_opt_selecionada_div.css("border","4px solid rgb(25, 45, 100)"),o.arr_oportunidades_selecionadas.includes(o.context_opt_selecionada_id)||o.arr_oportunidades_selecionadas.push(o.context_opt_selecionada_id),o.div_info_qtd_opt_selec.removeClass("hidden"),o.div_info_qtd_opt_selec.find("span.qtd_oportunidades_selec").text(o.arr_oportunidades_selecionadas.length);break;case"Desmarcar":var e=o.context_opt_selecionada_div.css("background-color"),t=e.replace(".4","1");o.context_opt_selecionada_div.css("background-color",t),o.context_opt_selecionada_div.css("border","1px solid rgb(211,211,211)"),o.arr_oportunidades_selecionadas=o.arr_oportunidades_selecionadas.filter(function(a,e,t){return a!=o.context_opt_selecionada_id}),0==o.arr_oportunidades_selecionadas.length&&o.div_info_qtd_opt_selec.addClass("hidden"),o.div_info_qtd_opt_selec.find("span.qtd_oportunidades_selec").text(o.arr_oportunidades_selecionadas.length);break;case"Clonar Oportunidade(s)":if(0==o.arr_oportunidades_selecionadas.length||1==o.arr_oportunidades_selecionadas.length){if(1==o.arr_oportunidades_selecionadas.length)var i=o.arr_oportunidades_selecionadas[0];else var i=o.context_opt_selecionada_id;DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja clonar a oportunidade #"+i+"? ",buttons:[{text:"Sim",onClick:function(){alert_info("Clonando Oportunidade. Por favor, aguarde"),WS.post("oportunidade/clonar_oportunidade",{oportunidade_id:i},function(a){o.listar_etapas(),alert_saved("Oportunidade clonada com sucesso!")})}},{text:"Não",onClick:function(a){return!1}}]}).show()}else DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja clonar "+o.arr_oportunidades_selecionadas.length+" oportunidades? ",buttons:[{text:"Sim",onClick:function(){alert_info("Clonando Oportunidades. Por favor, aguarde"),WS.post("oportunidade/clonar_oportunidade",{oportunidade_id:JSON.stringify(o.arr_oportunidades_selecionadas)},function(a){o.listar_etapas(),alert_saved("Oportunidades clonadas com sucesso!")})}},{text:"Não",onClick:function(a){return!1}}]}).show();break;case"Transferir Oportunidade(s)":0==o.arr_oportunidades_selecionadas.length&&o.arr_oportunidades_selecionadas.push(o.context_opt_selecionada_id),View.load("oportunidade/transferencia_representantes",function(a,e){e.onsave=o.listar_etapas,e.show(o.arr_oportunidades_selecionadas)});break;case"Desmarcar todas":o.arr_oportunidades_selecionadas=[];var e=null,t=null;o.dx_kanban.find(".dx-card").map(function(a,o){e=$(o).css("background-color"),t=e.replace(".4","1"),$(o).css("background-color",t)}),o.dx_kanban.find(".dx-card").css("border","1px solid rgb(211,211,211)"),o.div_info_qtd_opt_selec.addClass("hidden")}}}).dxContextMenu("instance");r.css("min-height","calc(100vh - 186px)"),setTimeout(function(){var a=o.arr_offset[e.id];a&&s.scrollTo(a)})}(t,e,n)}(e,a)}),("S"==o.funil_redimensionar_etapas||1==o.funil_redimensionar_etapas)&&o.calcula_width_etapa(),o.div_drag_situacao.find("#A").dxSortable({group:"tasksGroup",moveItemOnDrop:!0,onAdd:function(a){var e=$(a.itemElement).attr("id"),t=$(a.itemElement).attr("situacao");"A"==t||"AT"==t?(alert_info("A oportunidade #"+e+" já se encontra aberta"),o.hide_drag_situacao()):DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja marcar a oportunidade #"+e+" como aberta?",buttons:[{text:"Sim",onClick:function(){alert_info("Por favor, aguarde"),o.atualizar_situacao_oportunidade(e,"A")}},{text:"Não",onClick:function(a){o.hide_drag_situacao(),o.preencher_kanban()}}]}).show(),a.cancel=!0}}),o.div_drag_situacao.find("#G").dxSortable({group:"tasksGroup",moveItemOnDrop:!0,onAdd:function(a){var e=$(a.itemElement).attr("id"),t=$(a.itemElement).attr("situacao");"G"==t?(alert_info("A oportunidade #"+e+" já se encontra ganha"),o.hide_drag_situacao()):(alert_info("Por favor, aguarde"),o.checa_eventos_abertos(e,"G")),a.cancel=!0}}),o.div_drag_situacao.find("#P").dxSortable({group:"tasksGroup",moveItemOnDrop:!0,onAdd:function(a){var e=$(a.itemElement).attr("id");alert_info("Por favor, aguarde"),o.checa_eventos_abertos(e,"P"),a.cancel=!0}}),o.lbl_total_geral_pipe.text(o.total_geral_pipe.format_number(2,!0));var t=e.addClass("scrollable-board").dxScrollView({direction:"horizontal",showScrollbar:"always",onScroll:function(a){o.arr_offset["scrollable-board"]=this.scrollOffset()}}).dxScrollView("instance");function i(a,e){var t=$("<div>").addClass("card").addClass("dx-card").removeClass("dx-theme-background-color").removeClass("dx-theme-text-color").attr("id",e.oportunidade_id).attr("cor-texto",e.cor_status_texto).attr("situacao",e.situacao).css("padding","7px").css("border","1px solid rgb(211,211,211)");!0!==e.status_oportunidade_pintar_cartao&&"S"!==e.status_oportunidade_pintar_cartao||t.css("background-color",e.cor_status).css("color",e.cor_status_texto),t.appendTo(a),t.parent().find(".card").css("width","initial");var i=!0===o.exibir_data_abertura_oportunidade?e.data_abertura.format_date():e.nome,n="C"==e.entidade_tipo?"label-info":"label-primary",r="C"==e.entidade_tipo?"C":"O",d=null,s=null,l=null;switch(e.situacao){case"G":s="Ganho",l="G",d="label-success";break;case"P":s="Perdido",l="P",d="label-warning";break;case"A":s="Aberto",l="A",d="label-default";break;case"AT":s="Atrasado",l="At",d="label-danger";break;case"E":s="Estagnado",l="E",d="label-info"}if(o.cards_compactos){t.append($('<div class="card-subject" style="font-size: 13px; padding-bottom: 5px;"> <strong>#'+e.oportunidade_id+"</strong> - "+i+' | <span style="font-size: 14px;"><small><span class="label '+d+'" data-toggle="tooltip" title="'+s+'">'+l+"</span></small></span></div>")),t.append($('<div style="font-size: 12px; display: inline-block; margin-right: 10px;"> <span class="label '+n+'">'+r+"</span> "+e.entidade_nome+"</div>"));var c=e.representante_foto,_=WS_URI+"documento/midia/?&tamanho=20&documento_id="+c+"&token_midia="+App.sessao.token_midia,p=e.representante_nome||"";c?t.append($('<span style="margin-top: 3px;"><img style="height: 20px; width: 20px; border-radius: 25em;" data-toggle="tooltip" title="'+p+'" class="imagem_responsavel" src="'+_+'"></span>')):t.append('<span style="width: 20px; height: 20px; background-color: #dfe1e6; border-radius: 25em; color: #172b4d; line-height: 20px; text-align: center; display: inline-block; margin-top: 3px; vertical-align: middle;"><span style="font-weight: 600;" data-toggle="tooltip" title="'+p+'">'+obter_iniciais(p)+"</span></span>")}else{t.append($('<div class="card-subject" style="font-size: 14px;"> <strong>#'+e.oportunidade_id+"</strong> - "+i+" </div>")),!0===o.exibir_data_abertura_oportunidade&&t.append($('<div style="font-size: 14px; margin-bottom: 8px;">'+e.nome+"</div>"));let a=e.entidade_nome;if("S"!=o.funil_exibir_razao_social_entidade&&1!=o.funil_exibir_razao_social_entidade||(a=e.entidade_razao_social),t.append($('<div style="font-size: 14px;"> <span class="label '+n+'">'+r+"</span> "+a+" </div>")),t.append($('<div style="margin-top: 5px; font-size: 14px;"> <span class="label label-warning">R</span> '+e.representante_nome+" </div>")),void 0!==e.situacao_ultimo_orcamento&&null!=e.situacao_ultimo_orcamento){var u=null,f=null;switch(e.situacao_ultimo_orcamento){case"0":f="Orçamento Aguardando Aprovação",u="label-warning";break;case"1":f="Orçamento Aprovado",u="label-success";break;case"2":f="Orçamento Reprovado",u="label-danger";break;case"4":f="Orçamento Aprovado / Aguardando E-Mail",u="label-default";break;default:f="Orçamento Em Análise",u="label-info"}t.append($('<div style="margin-top: 5px; font-size: 15px;"><small><span class="label '+u+'">'+f+"</span></small></div>"))}var m=e.status?'<span style="float: right; font-size: 15px;"><small><span class="label" style="background: '+e.cor_status+"; color: "+e.cor_status_texto+';">'+e.status+"</span></small></span>":"";t.append($('<div style="width: 100%; margin-top: 8px;"><span style="float: left; font-size: 15px;"><small>R$ '+e.valor_negocio.format_number(2,!0)+'</small></span><span style="float: right; font-size: 15px;"><small><span class="label '+d+'">'+s+"</span></small></span>"+m+"</div></br>")),t.append($('<div style="width: 100%; margin-top: 8px;display: flex; flex-wrap: wrap; margin-bottom: 10px;">')),e.etiquetas.map((a,o)=>{let e=o>0?"margin-left: 3px; ":"";t.append($(`<span style="float: left; font-size: 15px;"><small><span class="label" style="${e}background-color: ${a.cor_fundo}; color: ${a.cor_fonte};">${a.nome}</span></small></span>`))}),t.append($("</div>"))}t.unbind("click").click(function(){View.load("oportunidade/detalhes",function(a,t){t.onclose=function(){o.listar_etapas()},t.show(e.oportunidade_id,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS,null,null,{oportunidadeId:e.oportunidade_id})})}setTimeout(function(){var a=o.arr_offset["scrollable-board"];a&&t.scrollTo(a)}),e.addClass("sortable-lists").dxSortable({filter:".listDrop",itemOrientation:"horizontal",handle:".titulo_etapa",moveItemOnDrop:!0,onDragStart:function(a){a.cancel=!0}})}()})},this.download_datagrid_kanban=function(){let a=$("<div></div>");a.dxDataGrid({dataSource:o.arr_oportunidades_kanban,paging:{pageSize:20},allowColumnReordering:!0,rowAlternationEnabled:!1,allowColumnResizing:!0,showBorders:!0,export:{enabled:!0,fileName:"Listagem de Oportunidades "+agora()},columns:o.dx_oportunidade_columns(),onContentReady:o=>{a.dxDataGrid("instance").exportToExcel()}})},this.coletar_alias=function(a){var o="",e="",t="";switch(a){case"oportunidade.id":o="Oportunidade - ID",e=PARAMETRO_PERSONALIZADO_TIPO.INT,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade.nome":o="Oportunidade - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade.Tipo":o="Oportunidade - Tipo",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade.valor_negocio":o="Oportunidade - Valor Negocio",e=PARAMETRO_PERSONALIZADO_TIPO.INT,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"municipio.municipio":o="Municipio - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"cliente.nome":o="Cliente - Nome Fantasia",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"cliente.razao_social":o="Cliente - Razão Social",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"prospect.nome":o="Organização - Nome Fantasia",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"prospect.razao_social":o="Organização - Razão Social",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"contato.nome":o="Contato - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"motivo_perda_negocio.nome":o="Motivo da Perda - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"motivo_perda_negocio.observacao_obrigatoria":o="Motivo da Perda  - Observação",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"usuario.nome":o="Representante - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"status_oportunidade.nome":o="Oportunidade - Status",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.SMC;break;case"regiao_vendas.descricao":o="Região de Vendas - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"item.descricao":o="Oportunidade - Item",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"item.codigo":o="Item - Código",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade.data_fechamento":o="Oportunidade - Data de Fechamento",e=PARAMETRO_PERSONALIZADO_TIPO.DATE,t=PARAMETRO_PERSONALIZADO_IPT.DATE;break;case"estagnado.dias":o="Estagnado - Dias",e=PARAMETRO_PERSONALIZADO_TIPO.INT,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"usuario_representante_2.nome":o="Representante 2 - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade_origem.nome":o="Origem - Nome",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"representante.tipo_representante":o="Representante 1 - Tipo",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade_observacoes.observacao":o="Oportunidade - Observação",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade_orcamento.id":o="Orçamento - ID",e=PARAMETRO_PERSONALIZADO_TIPO.INT,t=PARAMETRO_PERSONALIZADO_IPT.INPUT;break;case"oportunidade.integracao_nextone":o="Oportunidade - Data de Integração",e=PARAMETRO_PERSONALIZADO_TIPO.DATE,t=PARAMETRO_PERSONALIZADO_IPT.DATE;break;default:if(null!==a&&""!==a){var i=a.split(".");"filtro_formulario_oportunidade"==i[0]?(o=i[1],e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT):(o="",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT)}else o="",e=PARAMETRO_PERSONALIZADO_TIPO.STRING,t=PARAMETRO_PERSONALIZADO_IPT.INPUT}return{alias_campo:o,tipo_campo:e,tipo_input:t}},this.checa_eventos_abertos=function(a,e){WS.post("oportunidade/eventos_abertos",{oportunidade_id:a},function(t){var i=function(){"G"==e?View.load("oportunidade/fechamento",function(e,t){t.onclose=function(){o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&(o.preencher_kanban(),o.hide_drag_situacao())},t.onsave=function(){o.render_tipo_visualizacao(),o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&o.hide_drag_situacao()},t.show(a,o.escolha_empresa_ganho_perda)}):"P"==e?View.load("oportunidade/motivo_perda",function(e,t){t.onclose=function(){o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&(o.preencher_kanban(),o.hide_drag_situacao())},t.onsave=function(){o.render_tipo_visualizacao(),o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&o.hide_drag_situacao()},t.show(a,o.escolha_empresa_ganho_perda)}):"E"==e&&DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Deseja mesmo excluir a oportunidade #"+a+"?",buttons:[{text:"Sim",onClick:function(){alert_info("Por favor, aguarde"),WS.post({route:"oportunidade/excluir",type:"POST",data:{oportunidade_id:a},func_response:function(a){o.hide_drag_situacao(),o.render_tipo_visualizacao(),alert_saved("Oportunidade excluída com sucesso!")},func_fail:function(a){o.render_tipo_visualizacao()}})}},{text:"Não",onClick:function(a){return o.tipo_visualizacao==OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN&&(o.preencher_kanban(),o.hide_drag_situacao()),!1}}]}).show()};t.chamados.length>0||t.agenda.length>0?DevExpress.ui.dialog.custom({title:"Aviso",messageHtml:"Existem eventos abertos na oportunidade #"+a+", deseja finalizá-los?",buttons:[{text:"Sim",onClick:function(){View.load("oportunidade/eventos_abertos",function(a,e){e.onclose=o.render_tipo_visualizacao,e.show(t)},View.ABA.NAO)}},{text:"Não",onClick:function(a){i()}}]}).show():i()})},this.atualizar_situacao_oportunidade=function(a,e){WS.post("oportunidade/atualizar_situacao",{oportunidade_id:a,situacao:e},function(a){alert_saved("Situação alterada com sucesso!"),o.render_tipo_visualizacao(),o.hide_drag_situacao()})},this.dx_oportunidade_columns=function(){let a=[{dataField:"etapa_nome",caption:"Etapa do Funil",dataType:"string",calculateCellValue:function(a){return a.etapa_ordem+". "+a.etapa_nome}},{dataField:"oportunidade_id",caption:"#",dataType:"number",alignment:"right",width:40},{dataField:"nome",caption:"Nome",dataType:"string"},{dataField:"data_abertura",caption:"Data de inclusão",dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss"},{caption:"Tipo de Entidade",dataType:"string",dataField:"entidade_tipo",calculateCellValue:function(a){var o="";switch(a.entidade_tipo){case"C":o="Cliente";break;case"O":o="Organização"}return o}},{dataField:"entidade_nome",caption:"Entidade Nome Fantasia",dataType:"string"},{dataField:"entidade_razao_social",caption:"Entidade Razão Social",dataType:"string"},{dataField:"cnpj_entidade",caption:"Entidade CNPJ",dataType:"string"},{dataField:"entidade_municipio",caption:"Município",width:200},{dataField:"entidade_uf_sigla",caption:"UF",width:50},{dataField:"representante_nome",caption:"Representante",dataType:"string"},{dataField:"status",caption:"Status",dataType:"string"},{dataField:"oportunidade_origem_nome",caption:"Origem Oportunidade",dataType:"string"},{dataField:"valor_negocio",caption:"Valor do Negócio R$",dataType:"decimal",calculateCellValue:function(a){return"R$ "+a.valor_negocio.format_number(2,!0)}},{dataField:"situacao",caption:"Situação da Oportunidade",dataType:"string",calculateCellValue:function(a){var o="";switch(a.situacao){case"G":o="Ganho";break;case"P":o="Perdido";break;case"A":o="Aberto";break;case"AT":o="Atrasado";break;case"E":o="Estagnado"}return o}},{dataField:"motivo_perda_negocio",caption:"Motivo da Perda",dataType:"string"},{dataField:"tipo_oportunidade_nome",caption:"Tipo Oportunidade",dataType:"string"},{dataField:"orcamentos_id",caption:"Nº Orçamentos",dataType:"string",filterOperations:["contains"],calculateCellValue:a=>a.orcamentos_id&&a.orcamentos_id.replace(/#/g,"").replace(/,/g,", ")},{dataField:"situacao_ultimo_orcamento",caption:"Situação do Orçamento",dataType:"string",calculateCellValue:function(a){var o="";if(a.situacao_ultimo_orcamento)switch(a.situacao_ultimo_orcamento){case"0":o="Orçamento Aguardando Aprovação";break;case"1":o="Orçamento Aprovado";break;case"2":o="Orçamento Reprovado";break;case"4":o="Orçamento Aprovado / Aguardando E-Mail";break;default:o="Orçamento Em Análise"}return o}}];return o.arrColunasCustomizadas&&ColumnsFormularioCustomizado(o.arrColunasCustomizadas,a,o.formularioCustomizado),a},this.dx_kanban_filtro_fields=function(){let a=[{dataField:"situacao",caption:"Situação da Oportunidade",dataType:"string",lookup:{dataSource:window.datasource.oportunidade.oportunidadeSituacoes,valueExpr:"id",displayExpr:"descricao"}},{dataField:"oportunidade_id",caption:"# Número da Oportunidade",dataType:"number",alignment:"right",width:40},{dataField:"nome",caption:"Nome",dataType:"string"},{dataField:"data_abertura",caption:"Data de Inclusão",dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss",editorOptions:{format:"dd/MM/yyyy HH:mm:ss",dateSerializationFormat:"yyyy-MM-dd HH:mm:ss"}},{dataField:"data_fechamento",caption:"Data de Fechamento",dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss",editorOptions:{format:"dd/MM/yyyy HH:mm:ss",dateSerializationFormat:"yyyy-MM-dd HH:mm:ss"}},{dataField:"data_situacao",caption:"Data da Situação",dataType:"datetime",format:"dd/MM/yyyy HH:mm:ss",editorOptions:{format:"dd/MM/yyyy HH:mm:ss",dateSerializationFormat:"yyyy-MM-dd HH:mm:ss"}},{dataField:"entidade_nome",caption:"Entidade Nome Fantasia",dataType:"string"},{dataField:"entidade_razao_social",caption:"Entidade Razão Social",dataType:"string"},{dataField:"cnpj_entidade",caption:"Entidade CNPJ",dataType:"string"},{dataField:"entidade_municipio",caption:"Município",width:200},{dataField:"entidade_uf_sigla",caption:"UF",width:50},{dataField:"representante_nome",caption:"Representante",dataType:"string"},{dataField:"status",caption:"Status",dataType:"string"},{dataField:"oportunidade_origem_nome",caption:"Origem Oportunidade",dataType:"string"},{caption:"Valor do Negócio R$",dataType:"number",format:{type:"fixedPoint",precision:2},dataField:"valor_negocio"},{dataField:"orcamentos_id",caption:"Número do Orçamento",dataType:"number",filterOperations:["contains"]}];return o.arrColunasCustomizadas&&ColumnsFormularioCustomizado(o.arrColunasCustomizadas,a,o.formularioCustomizado),a},this.render_tipo_visualizacao=function(){switch(o.tipo_visualizacao){case OPORTUNIDADE_TIPO_VISUALIZACAO.GRID:o.listar_grid();break;case OPORTUNIDADE_TIPO_VISUALIZACAO.KANBAN:default:o.listar_etapas()}},this.hide_drag_situacao=function(){o.div_drag_situacao&&o.div_drag_situacao.fadeOut(300)},this.definir_background=function(){if(o.imagem_id){var a=cripto(WS.token),e=WS_URI+"documento/download/?documento_id="+o.imagem_id+"&token_publico="+a+"&tipo=S&acao=abrir";o.dialog.css({background:"url("+e+")","background-position":"50%","background-size":"cover"})}else o.dialog.css({background:"none"})},this.calcula_width_etapa=function(){var a=o.dx_kanban.width()-10*o.arr_etapas.length;a=(a/=o.arr_etapas.length).toFixed(2),o.dx_kanban.find(".listDrop:not(#A, #G, #P)").css("width",a).css("margin",5)},this.tratamento_da_query=function(a){return a.replace(/(LIKE ').+?(')/g,function(a,o){var e=0;return a.indexOf("%")>-1?a:a.replace(/[']/g,function(a,o,t){return 0==e&&"'"==a?(e++,"'%"):"%'"})})},$(window).on("resize",function(){"S"!=o.funil_redimensionar_etapas&&1!=o.funil_redimensionar_etapas||o.calcula_width_etapa()}),this.unload=function(){View.unload(this.html_id)},this.btn_novo_click=function(a){var e;return"N"==App.sessao.dados.representante&&1!=App.sessao.dados.admin&&"S"!=App.sessao.dados.admin&&"S"!=App.sessao.dados.supervisor_atendimento_relacionamento?((e=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Por favor, relacionar seu usuário com representante")),void alert_modal("Validação",e)):null==o.funil_vendas_id||""==o.funil_vendas_id?((e=new Validation).add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Informe o Funil de Vendas")),void alert_modal("Validação",e)):void View.load("oportunidade/detalhes",function(a,e){e.onclose=function(){o.render_tipo_visualizacao()},e.show(null,FORMULARIO.NOVO,o.funil_vendas_id)},View.ABA.MULTIPLAS)},this.btn_opcoes_filtro.unbind("click"),this.btn_opcoes_filtro.click(function(){View.load("oportunidade/filtro",function(a,e){e.show(o)})}),this.btn_limpar_filtro.unbind("click").click(function(){o.filtros=spread(o.filtros,{cliente_id:"",cliente_nome:"",tipo_periodo:7,tipo_responsavel:2,situacao:OPORTUNIDADE_FILTROS.EM_ABERTO,representante:null,situacao_orcamento:null,entidade:null,entidade_tipo:null,etiqueta_id:[],dt_ini:"2000-01-01",dt_fim:"2050-12-31",situacao_orcamento:null}),App.set_parametro_usuario("oportunidade_filtros",o.filtros),o.render_tipo_visualizacao()}),this.btn_configurar_filtros.unbind("click").click(function(a){o.parametros_filtros_usuario(o.construct,!0)})}});