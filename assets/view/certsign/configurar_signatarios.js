define([],function(){return function(i){"use strict";var a=this;this.html_id=i,this.dialog=$("#"+this.html_id),this.title="Signatários",this.grid_signatarios=this.dialog.find(".grid_signatarios"),this.comunica_certsign=!1,this.id_elemento_anexo=null,this.id_linha_tabela="",this.solicitacao_id=null,this.dados_signatarios=[],this.show=function(i,e,o,t,n){a.comunica_certsign=e,a.id_elemento_anexo=o,a.solicitacao_id=void 0!==n?n.toString():"",void 0!==t&&null!=t&&(a.id_linha_tabela="_"+t),void 0===App.temp.signatarios&&(App.temp.signatarios={}),void 0===App.temp.signatarios[a.solicitacao_id+"_"+a.id_elemento_anexo+a.id_linha_tabela]&&(App.temp.signatarios[a.solicitacao_id+"_"+a.id_elemento_anexo+a.id_linha_tabela]=[]),a.dados_signatarios=App.temp.signatarios[a.solicitacao_id+"_"+a.id_elemento_anexo+a.id_linha_tabela],void 0===a.dados_signatarios.certsign&&(a.dados_signatarios.certsign=[]),a.grid_signatarios.dxDataGrid({dataSource:a.dados_signatarios.certsign,showBorders:!0,allowColumnReordering:!0,allowColumnResizing:!0,columnResizingMode:"widget",columnAutoWidth:!0,rowAlternationEnabled:!1,height:550,scrolling:{mode:"virtual",showScrollbar:"Always",useNative:!0},paging:{enabled:!1},onInitNewRow:function(i){},focusedRowEnabled:!1,editing:{mode:"batch",allowUpdating:!0,allowAdding:!0,allowDeleting:!0,useIcons:!0},onToolbarPreparing:function(o){var t=o.toolbarOptions.items;$.each(t,function(o,t){if("saveButton"===t.name)return t.options.onClick=function(o){var t=[],n=a.grid_signatarios.dxDataGrid("instance").getController("editing").getChanges().map(function(i){return void 0!==i.brokenRules&&i.brokenRules.length>0&&(t=i.brokenRules),i.data});if(t.length>0)return alert_fail(t[0].message),!1;e?a.solicitar_assinaturas(n,i):(a.dados_signatarios.certsign=[],$.each(n,function(i,e){a.dados_signatarios.certsign.push(e)}),a.unload())},!1})},onEditorPrepared:function(i){if("dataRow"===i.parentType)switch(i.dataField){case"documentation":i.editorElement.find("input").last().mask("000.000.000-00");break;case"email":i.editorElement.dxTextBox("instance").option("onValueChanged",function(e){var o=!0;""!==e.value&&emailValido(e.value)&&(o=!1),i.setValue(e.value),a.grid_signatarios.find(".dx-datagrid-save-button").dxButton("instance").option("disabled",o)})}},columns:[{dataField:"email",caption:"Email",validationRules:[{type:"required",message:"Preencha o E-mail"},{type:"email",message:"E-mail inválido"}]},{dataField:"sign_as",caption:"Assinar Como",lookup:{dataSource:[{id:"signers",descricao:"Digital"},{id:"electronicSigners",descricao:"Eletrônica"}],valueExpr:"id",displayExpr:"descricao"},validationRules:[{type:"required",message:"Preencha o tipo de assinatura"}]},{dataField:"name",caption:"Nome Completo",validationRules:[{type:"required",message:"Preencha o nome completo"}]},{dataField:"documentation",caption:"CPF",validationRules:[{type:"required",message:"Preencha o CPF"}]}],rowAlternationEnabled:!1,showRowLines:!0,showBorders:!0})},this.solicitar_assinaturas=function(i,e){WS.post("certsign/solicitar_assinaturas",{signatarios:JSON.stringify(i),documento_revisao_id:e},function(i){var e="";if(void 0!==i.code&&i.code>0&&(e=i.message.toString().replace(/./g,"<br>")),""!=e)return alert_modal("Atenção",e),!1;a.comunica_certsign&&DevExpress.ui.dialog.alert("Documento disponibilizado para o(s) signatário(s)!","Atenção").done(function(){a.unload()})})},this.close=function(){void 0!==a.onclose&&a.onclose&&a.onclose()},this.unload=function(){a.close(),View.unload(this.html_id)}}});