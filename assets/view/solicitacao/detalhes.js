define(["react","react-dom","./DetalharMenu","./../componentes_react/CboClientes","./../central_documentos/SelectPasta","./../componentes_react/InformativoPrazo"],function(a,i,o,e,t,s){return function(c){"use strict";var r=this;this.html_id=c,this.dialog=$("#"+this.html_id),this.title="Solicitação",this.modal=this.dialog.find(".modal"),this.modal.attr("id",this.html_id+"_modal"),this.tipo=null,this.onclose=null,this.onsave=null,this.scrollview=this.dialog.find(".scrollview"),this.div_diagrama=this.dialog.find(".div_diagrama"),this.aba_formulario=this.dialog.find(".aba_formulario"),this.aba_historico=this.dialog.find(".aba_historico"),this.aba_fluxo=this.dialog.find(".aba_fluxo"),this.aba_diagrama=this.dialog.find(".aba_diagrama"),this.detalharMenu=this.dialog.find(".detalharMenu"),this.processoDetalharMenu=a.createElement(o,null,null),this.menu_formulario=this.dialog.find(".menu_formulario"),this.menu_historico=this.dialog.find(".menu_historico"),this.observacao_historico=this.dialog.find(".observacao_historico"),this.menu_fluxo=this.dialog.find(".menu_fluxo"),this.menu_diagrama=this.dialog.find(".menu_diagrama"),this.solicitacao_id=this.dialog.find(".solicitacao_id"),this.lbl_versao=this.dialog.find(".lbl_versao"),this.lbl_nome=this.dialog.find(".lbl_nome"),this.lbl_usuario_solicitacao_atividade_nome=this.dialog.find(".lbl_usuario_solicitacao_atividade_nome"),this.div_usuario_responsavel_atividade_nome=this.dialog.find(".div_usuario_responsavel_atividade_nome"),this.lbl_usuario_responsavel_atividade_nome=this.dialog.find(".lbl_usuario_responsavel_atividade_nome"),this.lbl_data=this.dialog.find(".lbl_data"),this.lbl_descricao=this.dialog.find(".lbl_descricao"),this.lbl_projeto=this.dialog.find(".lbl_projeto"),this.lbl_projeto_atividade_descricao=this.dialog.find(".lbl_projeto_atividade_descricao"),this.div_solicitacao_informativo_prazo=this.dialog.find(".div_solicitacao_informativo_prazo"),this.solicitacao_informativo_prazo=a.createElement(s,null,null),this.formulario_util=null,this.form_editor=this.dialog.find(".form-editor"),this.form_grupos=this.dialog.find(".form-grupos"),this.template_grupo=this.dialog.find("[template-grupo]"),this.template_campo=this.dialog.find("[template-campo]"),this.lbl_processo_nome=this.dialog.find(".lbl_processo_nome"),this.lbl_processo_instrucao=this.dialog.find(".lbl_processo_instrucao"),this.lbl_atividade_nome=this.dialog.find(".lbl_atividade_nome"),this.lbl_atividade_instrucao=this.dialog.find(".lbl_atividade_instrucao"),this.bar_progresso=this.dialog.find(".bar_progresso:not([template-field])"),this.div_atraso=this.dialog.find(".div_atraso"),this.div_restante=this.dialog.find(".div_restante"),this.div_cliente=this.dialog.find(".div_cliente"),this.div_seleciona_cliente=this.dialog.find(".div_seleciona_cliente"),this.div_projeto=this.dialog.find(".div_projeto"),this.div_menu_block=this.dialog.find(".div_menu_block"),this.div_usuarios=this.dialog.find(".div_usuarios"),this.div_seleciona_pasta=this.dialog.find(".div_seleciona_pasta"),this.div_pasta=this.dialog.find(".div_pasta"),this.selectPasta=a.createElement(t,null,null),this.tab_atividades=this.dialog.find(".tab_atividades"),this.tab_historico=this.dialog.find(".tab_historico"),this.aba_referencias_solicitacao=this.dialog.find(".aba_referencias_solicitacao"),this.menu_referencias_solicitacao=this.dialog.find(".menu_referencias_solicitacao"),this.div_componente_referencias_solicitacao=this.dialog.find(".div_componente_referencias_solicitacao"),this.aba_referencias_atividade=this.dialog.find(".aba_referencias_atividade"),this.menu_referencias_atividade=this.dialog.find(".menu_referencias_atividade"),this.div_componente_referencias_atividade=this.dialog.find(".div_componente_referencias_atividade"),this.edt_observacoes=this.dialog.find(".edt_observacoes"),this.contador_obs=this.dialog.find(".contador_obs"),this.div_component_cbo_clientes=this.dialog.find(".div_component_cbo_clientes"),this.cboClientes=null,this.divs_informativo_prazo=[],this.btn_cancelar=this.dialog.find(".btn_cancelar"),this.btn_pesquisa_cliente=this.dialog.find(".btn_pesquisa_cliente"),this.text_altera_usuario=this.dialog.find(".text_altera_usuario"),this.cbo_usuarios=this.dialog.find(".cbo_usuarios"),this.div_topo=this.dialog.find(".div_topo"),this.aviso_modo_teste=this.dialog.find(".aviso_modo_teste"),this.p_usuario_teste=this.dialog.find(".p_usuario_teste"),this.btn_alterar_responsavel=this.dialog.find(".btn_alterar_responsavel"),this.panel_alterar_responsavel=this.dialog.find(".panel_alterar_responsavel"),this.floating=this.dialog.find(".floating-menu"),this.th_execucao=this.dialog.find(".th_execucao"),this.th_origem=this.dialog.find(".th_origem"),this.ordenacao={crscente_execucao:!0,crscente_origem:!0},this.dados_modificados=!1,this.execucao=null,this.origem=null,this.solicitacao_atividade=null,this.versao_solicitacao_atividade=null,this.status=null,this.acesso_cancelar,this.cliente_id=null,this.filtros=null,this.documento_pasta_id=null,this.renderizar_atividades=!0,this.liberar_campos=!1,this.diagram=null,this.usuario_cliente_acompanha=!1;var d=null;this.anexos=[],this.filenames=[],this.elem_keys=[],this.versao_atividade_tipo=null,this.nome_cliente=null,this.arr_ignorar=[],this.callback_clientes=$.Callbacks(),this.show=function(a,o,e,t){if(r.scrollview.dxScrollView().dxScrollView("instance"),r.scrollview.css("height","calc(100vh - 90px)"),!0===t&&(r.aviso_modo_teste.removeClass("hidden"),r.p_usuario_teste.html("Solicitação em modo teste <br><b>Usuário:</b> "+e)),r.processoDetalharMenu.props.handleSalvarEnviarClick=r.salva_envia,r.processoDetalharMenu.props.handleDownloadPDFClick=r.download_pdf,r.processoDetalharMenu.props.handleDownloadTemplateClick=r.download_template,r.processoDetalharMenu.props.handleImprimirPdfClick=r.imprimir_pdf,r.processoDetalharMenu.props.handleNovoChamadoClick=r.novo_chamado,r.processoDetalharMenu.props.handleNovaSolicitacaoClick=r.nova_solicitacao,r.processoDetalharMenu.props.handleSalvarSairClick=r.salvarSairClick,r.processoDetalharMenu.props.handleSalvarClick=r.salvarClick,r.processoDetalharMenu.props.handleCancelarClick=r.cancelarClick,r.processoDetalharMenu.props.handleReprogramarClick=r.reprogramarClick,r.processoDetalharMenu.props.handleAlterarResponsavelClick=r.alterar_responsavelClick,r.processoDetalharMenu.props.handleAssumirAtividadeClick=r.AssumirAtividadeClick,r.processoDetalharMenu.props.handleDesvincularResponsabilidadeClick=r.DesvincularResponsabilidadeClick,r.processoDetalharMenu.props.handleCancelarSolicitacaoClick=r.cancelar_solicitacaoClick,r.processoDetalharMenu.props.handleReabrirSolicitacaoClick=r.reabrir_solicitacaoClick,r.processoDetalharMenu.props.handleRetornarAtividadeAnteriorClick=r.retornarClick,r.processoDetalharMenu.props.handleDownloadTodosAnexos=r.download_todos_anexos,r.processoDetalharMenu.props.handleHabilitarEdicaoCampos=r.habilitar_edicao_campos,r.processoDetalharMenu.props.handleAlterarProjetoVinculado=r.handleAlterarProjetoVinculado,i.render(r.selectPasta,r.div_pasta[0]),r.selectPasta.props.setDesabilitado(!1),i.render(r.processoDetalharMenu,r.detalharMenu[0]),r.aba_formulario.attr("id","aba_formulario"+r.html_id),r.aba_historico.attr("id","aba_historico"+r.html_id),r.aba_fluxo.attr("id","aba_fluxo"+r.html_id),r.aba_diagrama.attr("id","aba_diagrama"+r.html_id),r.aba_referencias_solicitacao.attr("id","aba_referencias_solicitacao"+r.html_id),r.aba_referencias_atividade.attr("id","aba_referencias_atividade"+r.html_id),r.menu_formulario.attr("href","#"+r.aba_formulario.attr("id")),r.menu_historico.attr("href","#"+r.aba_historico.attr("id")),r.menu_fluxo.attr("href","#"+r.aba_fluxo.attr("id")),r.menu_diagrama.attr("href","#"+r.aba_diagrama.attr("id")),r.menu_referencias_solicitacao.attr("href","#"+r.aba_referencias_solicitacao.attr("id")),r.menu_referencias_atividade.attr("href","#"+r.aba_referencias_atividade.attr("id")),App.sessao.sessao_login_anonimo&&(r.menu_diagrama.addClass("hidden"),r.menu_referencias_solicitacao.addClass("hidden"),r.menu_referencias_atividade.addClass("hidden")),r.tipo=o,void 0!==a&&a?"object"==typeof a?((App.sessao.sessao_login_anonimo||!App.sessao.dados.admin&&"N"==a.permite_download_formulario_nao_concluido)&&r.processoDetalharMenu.props.setDisplayDownloadPdf("hidden"),r.solicitacao_atividade=a,r.preencher()):"number"!=typeof a&&"string"!=typeof a||WS.get({route:"solicitacao/objeto/",data:{solicitacao_atividade_id:a,tipo_visualizacao:r.tipo},func_response:function(a){(App.sessao.sessao_login_anonimo||!App.sessao.dados.admin&&null==a.entrega&&"N"==a.permite_download_formulario_nao_concluido)&&r.processoDetalharMenu.props.setDisplayDownloadPdf("hidden"),r.solicitacao_atividade=a,d=r.solicitacao_atividade.cliente_id,r.preencher(),r.permite_acompanhar(a.solicitacao.versao_processo.relaciona_cliente)},func_fail:function(){r.unload()}}):r.renderiza_componentes(),r.permite_alterar(),o==FORMULARIO.NOVO&&r.permite_acompanhar(a.solicitacao.versao_processo.relaciona_cliente),App.PE.Solicitacao_Detalhes_show_antes)try{App.PE.Solicitacao_Detalhes_show_antes(r)}catch(a){console.log(a)}r.listar_documento_pasta()},this.close=function(){void 0!==r.onclose&&r.onclose&&r.onclose()},this.unload=function(){var a=function(){for(var a=0;a<r.divs_informativo_prazo.length;a++)r.divs_informativo_prazo[a].props.desativarRefreshAutomatico();r.close(),View.unload(r.html_id)};!0===r.dados_modificados?alert_modal('<i class="fa fa-exclamation-triangle pull-left" aria-hidden="true"></i> Atenção !',"Você alterou alguns campos. O que deseja fazer?","Salvar e sair",function(){r.dados_modificados=!1,alert_info("Aguarde enquanto salvamos as alterações"),r.salvarSairClick(a)},!0,"Não salvar e sair",null,function(){r.dados_modificados=!1,a()}):(r.dados_modificados=!1,a())},this.permite_alterar=function(){switch(r.tipo){case FORMULARIO.NOVO:case FORMULARIO.EDITAR:break;case FORMULARIO.VISUALIZAR:r.processoDetalharMenu.props.setTextoCancelar("Sair"),r.processoDetalharMenu.props.setVisualizar(!0);break;case FORMULARIO.EXCLUIR:}},this.renderiza_componentes=function(){r.renderiza_combobox_cliente()},this.renderiza_combobox_cliente=function(){null===r.cboClientes&&(r.cboClientes=a.createElement(e,{initial_values:{placeholder:"Nome da Entidade",disabled:r.usuario_cliente_acompanha}},null)),i.render(r.cboClientes,r.div_component_cbo_clientes[0]),r.cboClientes.props.setConfiguracoes={main_externo:r,exibe_tipo_entidade:!0,placeholder:"Filtro por Cliente",WS_params:{desconsiderar_empresa:!0,desconsiderar_fornecedor:!0,desconsiderar_prospect:!0,limite:0}},r.cboClientes.props.setCliente(r.filtros),r.cboClientes.props.setFunctionSelect(r.evt_alterar_cliente)},this.evt_alterar_cliente=function(){if(r.cliente_id=r.cboClientes.props.ClienteSelecionado.id,r.nome_cliente=r.cboClientes.props.ClienteSelecionado.nome_fantasia,App.PE.Solicitacao_Detalhes_ao_selecionar_cliente)try{App.PE.Solicitacao_Detalhes_ao_selecionar_cliente(r,r.cboClientes.props.ClienteSelecionado)}catch(a){console.log(a)}r.listar_filtro_usuarios(r.cliente_id)},this.permite_acompanhar=function(a){a?(r.div_usuarios.removeClass("hidden"),r.render_usuarios_por_cliente()):r.div_usuarios.addClass("hidden")},this.adiciono_cliente=function(){!0===r.solicitacao_atividade.solicitacao.versao_processo.relaciona_cliente?$(r.solicitacao_atividade.solicitacao.versao_processo.elementos).each(function(a,i){parseInt(i.id,10)==r.solicitacao_atividade.versao_processo_atividade_id&&(parseInt(i.elemento_tipo,10)==PROCESSO_ELEMENTO_TIPO.ATIVIDADE&&parseInt(i.tipo,10)==PROCESSO_ATIVIDADE_TIPO.INICIO?(r.div_seleciona_cliente.removeClass("hidden"),r.div_cliente.addClass("hidden")):(r.div_cliente.removeClass("hidden"),r.div_seleciona_cliente.addClass("hidden")))}):(r.div_seleciona_cliente.addClass("hidden"),r.div_cliente.addClass("hidden"))},this.atualizar_progress=function(){i.render(r.solicitacao_informativo_prazo,r.div_solicitacao_informativo_prazo[0]),r.solicitacao_informativo_prazo.props.setConfiguracoes({ViewParent:r.html_id,Alinhamento:"right",TipoGestaoTempo:r.solicitacao_atividade.tipo_prazo_execucao==SOLICITACAO_TIPO_HORA.HORAS_UTEIS?GESTAO_TEMPO.HORAS_UTEIS:GESTAO_TEMPO.DIAS_CORRIDOS,HorasEstimadas:r.solicitacao_atividade.tempo_restante_acumulado||r.solicitacao_atividade.tempo_prazo_execucao,DataPrazo:r.solicitacao_atividade.prazo_execucao,CalendarioTrabalhoId:r.solicitacao_atividade.calendario_trabalho_id,TituloDataPrazo:"Prazo",LabelExcedente:"atrasado",LabelRestante:"restante",ExibirBarraProgresso:!1})},this.listar_documento_pasta=function(a,i){if(a){var o=void 0===i||""===i;r.selectPasta.props.setDocumentoPastaID(a,o)}void 0!==i&&""!==i&&r.selectPasta.props.setDocumentoPastaPath(i),r.selectPasta.props.handleSelecionar=function(){r.documento_pasta_id=r.selectPasta.props.documentoPastaID}},this.set_numero=function(){const a="S"==r.solicitacao_atividade.numero_solicitacao_por_processo?r.solicitacao_atividade.numero:r.solicitacao_atividade.solicitacao_id;setTimeout(()=>App.titulo_aba(r.html_id,"Solicitação #"+a)),r.solicitacao_id.text("#"+a)},this.preencher=function(){if(1!=App.sessao.dados.admin&&App.sessao.dados.tipo!=USUARIO_TIPO.COLABORADOR&&r.processoDetalharMenu.props.setDisplayDownloadTemplate("hidden"),(r.solicitacao_atividade.solicitacao.versao_processo.escolher_pasta_solicitacao||"S"==r.solicitacao_atividade.solicitacao.versao_processo.escolher_pasta_solicitacao)&&r.div_seleciona_pasta.removeClass("hidden"),r.solicitacao_atividade.solicitacao.documento_pasta_id&&(r.documento_pasta_id=r.solicitacao_atividade.solicitacao.documento_pasta_id,r.listar_documento_pasta(r.solicitacao_atividade.solicitacao.documento_pasta_id)),r.arr_ignorar=[],r.arr_ignorar.push(r.solicitacao_atividade.solicitacao_id),r.solicitacao_atividade.solicitacao.projeto_id>0&&r.solicitacao_atividade.solicitacao.projeto_atividade_id>0){r.div_projeto.removeClass("hidden");var a=r.solicitacao_atividade.solicitacao.projeto_codigo?"#"+r.solicitacao_atividade.solicitacao.projeto_codigo:"",i=r.solicitacao_atividade.solicitacao.projeto_nome?r.solicitacao_atividade.solicitacao.projeto_nome:"";r.lbl_projeto.text(a+" "+i);var o=r.solicitacao_atividade.solicitacao.projeto_atividade_codigo?"#"+r.solicitacao_atividade.solicitacao.projeto_atividade_codigo:"",e=r.solicitacao_atividade.solicitacao.atividade_simplificada?r.solicitacao_atividade.solicitacao.atividade_simplificada:"";r.lbl_projeto_atividade_descricao.text(o+" "+e.substring(0,20)+"...")}r.acesso_cancelar=r.solicitacao_atividade.solicitacao.acesso_cancelar,r.usuario_cliente_acompanha=App.sessao.dados.tipo==USUARIO_TIPO.CLIENTE&&!r.solicitacao_atividade.responsavel_id.includes(App.sessao.dados.usuario_id.toString()),r.usuario_cliente_acompanha&&(r.processoDetalharMenu.props.setTextoCancelar("Sair"),r.processoDetalharMenu.props.setVisualizar(!0),r.selectPasta.props.setDesabilitado(!0),r.cbo_usuarios.prop("disabled",!0),r.cbo_usuarios.selectpicker("refresh")),$(r.solicitacao_atividade.solicitacao.versao_processo.elementos).each(function(a,i){i.id==r.solicitacao_atividade.versao_processo_atividade_id&&i.elemento_tipo==PROCESSO_ELEMENTO_TIPO.ATIVIDADE&&(r.versao_solicitacao_atividade=i)}),r.set_numero(),r.cliente_id=r.solicitacao_atividade.solicitacao.cliente_id,r.nome_cliente=r.solicitacao_atividade.solicitacao.cliente?r.solicitacao_atividade.solicitacao.cliente.nome_fantasia||r.solicitacao_atividade.solicitacao.cliente.razao_social:"",r.div_cliente.text(r.cliente_id>0?r.solicitacao_atividade.solicitacao.cliente.nome_fantasia||r.solicitacao_atividade.solicitacao.cliente.razao_social:""),r.filtros=spread({},r.filtros,{cliente_id:r.cliente_id,cliente_nome:r.cliente_id>0?r.solicitacao_atividade.solicitacao.cliente.nome_fantasia||r.solicitacao_atividade.solicitacao.cliente.razao_social:"",cliente_tipo:"C"}),r.renderiza_componentes(),r.lbl_versao.text(r.solicitacao_atividade.solicitacao.versao_processo.sequencia),r.lbl_versao.text(r.solicitacao_atividade.solicitacao.versao_processo.sequencia),r.lbl_usuario_solicitacao_atividade_nome.text(r.solicitacao_atividade.usuario_nome),r.solicitacao_atividade.responsavel_nome?(r.lbl_usuario_responsavel_atividade_nome.text(r.solicitacao_atividade.responsavel_nome),r.div_usuario_responsavel_atividade_nome.show()):r.div_usuario_responsavel_atividade_nome.hide(),r.lbl_data.text(r.solicitacao_atividade.data?r.solicitacao_atividade.data.format_date():""),null!=r.solicitacao_atividade.solicitacao.descricao&&""!=r.solicitacao_atividade.solicitacao.descricao&&(r.lbl_descricao.removeClass("hidden"),r.lbl_descricao.text(r.solicitacao_atividade.solicitacao.descricao)),r.lbl_processo_nome.text(r.solicitacao_atividade.solicitacao.versao_processo.nome),r.lbl_processo_instrucao.html(r.solicitacao_atividade.solicitacao.versao_processo.instrucao_trabalho),r.lbl_processo_instrucao.hide(),r.lbl_processo_nome.click(function(){r.lbl_processo_instrucao.toggle()}),r.lbl_atividade_nome.text(r.versao_solicitacao_atividade.descricao),r.lbl_atividade_instrucao.html(r.versao_solicitacao_atividade.instrucao_trabalho);var t="";""!=r.solicitacao_atividade.solicitacao.data_finalizacao&&null!=r.solicitacao_atividade.solicitacao.data_finalizacao?(r.div_topo.addClass("borda_aprovado"),t+="Solicitação concluída"):"S"==r.solicitacao_atividade.cancelada?(r.div_topo.addClass("borda_reprovado"),t+="Solicitação cancelada",r.div_topo.css("background-color","#FFCDD2")):(r.div_topo.addClass("borda_pendente"),t+="Solicitação em andamento"),""!=r.solicitacao_atividade.entrega&&null!=r.solicitacao_atividade.entrega?r.bar_progresso.append('<span class="label label-success">Atividade concluída</span>'):!0===r.solicitacao_atividade.solicitacao.cancelada?r.bar_progresso.append('<span class="label label-danger">Atividade cancelada</span>'):r.solicitacao_atividade.prazo_execucao&&r.atualizar_progress(),r.bar_progresso.tooltip({title:t,placement:"left",html:!0}),App.sessao.sessao_login_anonimo?r.processoDetalharMenu.props.setDisplaySalvarEnviar(""):(r.versao_solicitacao_atividade.acao_projeto_template&&!r.solicitacao_atividade.solicitacao.cancelada&&r.processoDetalharMenu.props.setDisplayVincularProjeto(""),+r.solicitacao_atividade.projeto_id>0&&WS.get("projeto/objeto/",{projeto_id:r.solicitacao_atividade.projeto_id},function(a){var i=(null!==a.porcentagem_concluido?a.porcentagem_concluido:0)+"%";parseInt(a.porcentagem_concluido)<r.versao_solicitacao_atividade.acao_projeto_template_conclusao&&(r.processoDetalharMenu.props.setProjetoVinculadoPendente(!0),r.processoDetalharMenu.props.setPorcentagemConcluido(i),r.processoDetalharMenu.props.setPorcentagemNecessario(r.versao_solicitacao_atividade.acao_projeto_template_conclusao+"%")),r.processoDetalharMenu.props.setProjetoID(a.id),r.processoDetalharMenu.props.setProjetoTemplate(a.template)})),r.setDisplayDownloadTodosAnexos(),(App.sessao.dados.admin||"S"==r.solicitacao_atividade.solicitacao.acesso_supervisor.supervisor_processo&&"S"==r.solicitacao_atividade.solicitacao.acesso_supervisor.permite_edicao)&&r.tipo==FORMULARIO.VISUALIZAR&&r.processoDetalharMenu.props.setSupervisorProcesso(!0),r.adiciono_cliente(),r.listar_filtro_usuarios(r.cliente_id),r.render_formulario(),r.edt_observacoes.val(r.solicitacao_atividade.observacoes),r.render_historico(),r.verifica_status(),r.render_atividades(),r.verifica_permissao(),App.sessao.dados.admin||"S"==r.solicitacao_atividade.solicitacao.acesso_supervisor.supervisor_processo&&"S"==r.solicitacao_atividade.solicitacao.acesso_supervisor.permite_edicao||"S"==r.solicitacao_atividade.versao_processo_atividade_permite_reprogramar&&!1!==r.solicitacao_atividade.permite_edicao?r.processoDetalharMenu.props.setDisplayReprogramar(""):r.processoDetalharMenu.props.setDisplayReprogramar("hidden"),App.sessao.sessao_login_anonimo&&(r.processoDetalharMenu.props.setDisplayNovoChamado("hidden"),r.processoDetalharMenu.props.setDisplayNovaSolicitacao("hidden"),r.processoDetalharMenu.props.setDisplaySalvarSair("hidden"),r.processoDetalharMenu.props.setDisplayReprogramar("hidden"),r.processoDetalharMenu.props.setDisplayCancelar("hidden"),r.processoDetalharMenu.props.setDisplayRetornarAtividadeAnterior("hidden"))},this.verifica_permissao=function(){$(r.versao_solicitacao_atividade.todos_usuarios_responsaveis).each(function(a,i){i.usuario_id!=App.sessao.usuario_id&&1!=App.sessao.dados.admin||"S"!=i.altera_responsavel&&!0!==i.altera_responsavel&&1!=App.sessao.dados.admin||r.panel_alterar_responsavel.removeClass("hidden")})},this.render_formulario=function(){r.solicitacao_atividade.formulario||(r.solicitacao_atividade.formulario=r.solicitacao_atividade.solicitacao.versao_processo.formulario);const a=a=>"object"==typeof a?a:"string"==typeof a&&""!==a.trim()?JSON.parse(a):{};r.solicitacao_atividade.solicitacao.formulario.evento_iniciar_construtor=a(r.solicitacao_atividade.solicitacao.formulario.evento_iniciar_construtor),r.solicitacao_atividade.formulario.evento_iniciar_construtor=a(r.solicitacao_atividade.formulario.evento_iniciar_construtor),require(["./assets/view/formulario/util"],function(a){r.formulario_util=new a,r.formulario_util.render_previsao({div_formulario:r,template_campo:r.template_campo,template_grupo:r.template_grupo,obj_formulario:r.tipo==FORMULARIO.VISUALIZAR||null!==r.solicitacao_atividade.entrega||"S"==r.solicitacao_atividade.cancelada||null!==r.solicitacao_atividade.cancelamento_hora_atividade?r.solicitacao_atividade.solicitacao.formulario:r.solicitacao_atividade.formulario,permissoes_formulario:r.versao_solicitacao_atividade.permissoes_formulario,obj_solicitacao:r.solicitacao_atividade,disabled_all:r.tipo==FORMULARIO.VISUALIZAR||!1===r.solicitacao_atividade.permite_edicao||!0===r.usuario_cliente_acompanha,persistencia_ao_editar:!1,clicksign_ativo:"S"===r.solicitacao_atividade.clicksign_ativo,permite_retrair_exibir_grupos:!0,certsign_ativo:"S"===r.solicitacao_atividade.certsign_ativo,liberar_campos:r.liberar_campos,d4sign_ativo:"S"===r.solicitacao_atividade.d4sign_ativo})})},this.verifica_status=function(){if(r.processoDetalharMenu.props.setDisplayRetornarAtividadeAnterior("hidden"),r.solicitacao_atividade.situacao==SOLICITACAO_STATUS.ATIVIDADE_CONCLUIDA||r.solicitacao_atividade.situacao==SOLICITACAO_STATUS.ATIVIDADE_RETORNADA||"S"==r.solicitacao_atividade.cancelada||r.solicitacao_atividade.situacao==SOLICITACAO_STATUS.ATIVIDADE_CANCELADA)r.processoDetalharMenu.props.setDisplaySalvar("hidden"),r.processoDetalharMenu.props.setDisplaySalvarSair("hidden"),r.processoDetalharMenu.props.setDisplayCancelarSolicitacao("hidden"),r.processoDetalharMenu.props.setDisplayRetornarAtividadeAnterior("hidden"),r.processoDetalharMenu.props.setDisplaySalvarEnviar("hidden"),r.processoDetalharMenu.props.setDisplayAssumirAtividade("hidden"),r.processoDetalharMenu.props.setDisplayDesvincularResponsabilidade("hidden"),1==r.acesso_cancelar&&"S"==r.solicitacao_atividade.cancelada&&r.processoDetalharMenu.props.setDisplayReabrirSolicitacao("");else{r.processoDetalharMenu.props.setDisplaySalvar(""),r.processoDetalharMenu.props.setDisplaySalvarSair(""),1==r.acesso_cancelar?r.processoDetalharMenu.props.setDisplayCancelarSolicitacao(""):r.processoDetalharMenu.props.setDisplayCancelarSolicitacao("hidden");var a=r.versao_solicitacao_atividade.todos_usuarios_responsaveis.find(function(a){return a.usuario_id==App.sessao.dados.usuario_id});a=void 0!==a,void 0!==r.solicitacao_atividade.permite_alterar_responsavel&&!0===r.solicitacao_atividade.permite_alterar_responsavel?("S"!==r.solicitacao_atividade.solicitante_responsavel&&"S"!==r.solicitacao_atividade.executor_responsavel_automatico&&"S"!==r.solicitacao_atividade.tornar_superior_imediato_responsavel&&void 0!==r.solicitacao_atividade.permite_vincular_responsabilidade&&!0===r.solicitacao_atividade.permite_vincular_responsabilidade&&!0===a&&(void 0!==r.versao_solicitacao_atividade.usuarios_responsaveis&&r.versao_solicitacao_atividade.usuarios_responsaveis.length>1||void 0!==r.versao_solicitacao_atividade.grupos_usuarios_responsaveis&&r.versao_solicitacao_atividade.grupos_usuarios_responsaveis.length>0)&&(void 0!==r.solicitacao_atividade.responsavel_id&&r.solicitacao_atividade.responsavel_id.length?(r.processoDetalharMenu.props.setDisplayAssumirAtividade("hidden"),r.solicitacao_atividade.responsavel_id.includes(App.sessao.dados.usuario_id.toString())&&(parseInt(r.versao_solicitacao_atividade.tipo,10)==PROCESSO_ATIVIDADE_TIPO.INICIO&&r.solicitacao_atividade.responsavel_id.includes(r.solicitacao_atividade.solicitacao.usuario_id.toString())?r.processoDetalharMenu.props.setDisplayDesvincularResponsabilidade("hidden"):r.processoDetalharMenu.props.setDisplayDesvincularResponsabilidade(""))):(r.processoDetalharMenu.props.setDisplayAssumirAtividade(""),r.processoDetalharMenu.props.setDisplayDesvincularResponsabilidade("hidden"))),r.processoDetalharMenu.props.setDisplayAlterarResponsavel("")):(r.processoDetalharMenu.props.setDisplayAlterarResponsavel("hidden"),r.processoDetalharMenu.props.setDisplayAssumirAtividade("hidden"),r.processoDetalharMenu.props.setDisplayDesvincularResponsabilidade("hidden")),parseInt(r.versao_solicitacao_atividade.tipo,10)==PROCESSO_ATIVIDADE_TIPO.INICIO||1!=r.solicitacao_atividade.permite_retorno||App.sessao.sessao_login_anonimo||r.processoDetalharMenu.props.setDisplayRetornarAtividadeAnterior(""),r.processoDetalharMenu.props.setDisplaySalvarEnviar("")}},this.render_historico=function(){if(App.sessao.sessao_login_anonimo)r.menu_historico.addClass("hidden");else{var a=r.tab_historico.find("tbody"),i=a.find("[template-row='atividade']"),o=(a.find("[template-row='chamado']"),a.find("[template-row='historico']")),e=0;r.tab_historico.find(".row_historico").remove(),$(r.solicitacao_atividade.solicitacao.historico).each(function(t,s){s.id_md5||s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.PROCESSO_VINCULADO||s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.PROCESSO_DESVINCULADO||s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.CHAMADO_VINCULADO||s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.CHAMADO_DESVINCULADO?s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.PROCESSO_VINCULADO||s.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.PROCESSO_DESVINCULADO?function(i){var e=o.clone();e.removeAttr("template-row"),e.css("display",""),e.addClass("row_historico");var t=e.find('[template-field="descricao"]'),s=$('<label class="label label-info">Processo</label>'),c=$("<span>&nbsp;&nbsp;"+i.valor_novo+"</span>");s.appendTo(t),c.appendTo(t);var d=$(e.find(".btn_detalhes"));if(d.addClass("hidden"),i.acao==TIPO_ACAO_HISTORICO_SOLICITACAO.PROCESSO_VINCULADO&&i.solicitacao_atividade_id_vinculado){d.removeClass("hidden"),d.addClass("btn"),d.addClass("btn-primary"),d.addClass("btn_ver_processo"),d.attr("value",i.id),d.append('<span class="glyphicon glyphicon-list-alt"></span>');var l=function(){View.load("solicitacao/detalhes",function(a,o){o.onclose=r.detalhes_onclose,o.show(i.solicitacao_atividade_id_vinculado,FORMULARIO.EDITAR)},View.ABA.MULTIPLAS)};d.unbind("click"),d.click(l),e.dblclick(l)}e.appendTo(a)}(s):function(i){var e=o.clone();e.css("display","").removeAttr("template-row").addClass("row_historico");var t=null,s=e.find('[template-field="descricao"]'),c=e.find(".btn_detalhes");c.addClass("btn btn-primary");var r=$('<i class="glyphicon glyphicon-folder-open"></i>'),d=$('<label class="label label-danger">Chamado</label>');r.appendTo(c),d.appendTo(s),i.chamado_id?($("<span>&nbsp;&nbsp;"+i.valor_novo+"</span>").appendTo(s),t=i.chamado_id):($("<span>&nbsp;&nbsp;[#"+i.id+"] | "+i.assunto+"</span>").appendTo(s),t=i.id),c.unbind("click").click(function(){View.loadReact(window.views.chamado.Detalhes.default,{chamadoId:t},function(a,i){},View.ABA.MULTIPLAS)}),e.appendTo(a)}(s):function(o){var t;t=o.solicitacao_atividade_id==o.cancelamento_solicitacao_atividade_id&&"S"==o.solicitacao_cancelada;var s=i.clone();s.removeAttr("template-row"),s.css("display",""),s.addClass("row_historico"),void 0===o.solicitacao_atividade_id?s.addClass("bg-warning"):o.solicitacao_atividade_id==o.cancelamento_solicitacao_atividade_id?s.addClass("bg-danger"):r.solicitacao_atividade.id==o.solicitacao_atividade_id&&r.tipo!=FORMULARIO.VISUALIZAR&&s.addClass("bg-info");var c=$(s.find("[template-field='atividade_descricao']"));t?c.text((o.versao_processo_atividade_descricao||o.mensagem_historico)+" (CANCELADO)"):c.text(o.versao_processo_atividade_descricao||o.mensagem_historico);var d=$(s.find(".span_type"));o.mensagem_historico?d.text(str_acao_historico_processo(o.acao)).addClass("label-info"):d.addClass("label-primary");var l=$(s.find(".div_atividades_pendentes"));null!=o.solicitacao_atividade_gateway_paralelo_id&&""!=o.solicitacao_atividade_gateway_paralelo_id?l.show():l.hide();var n=$(s.find(".div_retorno")),_=$(s.find("[template-field='retorno_motivo']")),p=$(s.find(".img_retorno"));o.retorno?(p.addClass("glyphicon-thumbs-down"),_.html(o.retorno_motivo?o.retorno_motivo:""),n.show()):t?(p.addClass("glyphicon-ban-circle"),_.html(o.cancelamento_motivo?o.cancelamento_motivo:"Motivo não definido.")):n.hide();var v=$(s.find(".div_executado"));o.executor_id||o.executor_email?v.show():v.hide();var u=$(s.find(".executor_foto"));t?o.usuario_cancelamento_foto&&u.attr("src",WS_URI+"documento/midia/?documento_id="+o.usuario_cancelamento_foto+"&tamanho=20&token_midia="+App.sessao.token_midia):o.executor_foto_id&&u.attr("src",WS_URI+"documento/midia/?documento_id="+o.executor_foto_id+"&tamanho=20&token_midia="+App.sessao.token_midia);var m=$(s.find("[template-field='executado_em']"));o.entrega?m.text(o.entrega.format_date_time()):o.retorno?m.text(o.retorno.format_date_time()):o.cancelamento_hora?m.text(o.cancelamento_hora.format_date_time()):(m.text(""),u.hide());var h=$(s.find("[template-field='executado_por']"));t?(h.find("span.txt_cancelado").html("<small>Cancelado por</small><br>"),h.find("span:not(.txt_cancelado)").text(o.usuario_cancelamento_nome)):h.find("span:not(.txt_cancelado)").text(o.executor_id?o.executor_nome:o.executor_email?o.executor_email:""),$(s.find("[template-field='observacoes']")).html(o.observacoes?nl2br(o.observacoes):"");var f=$(s.find(".div_observacoes"));o.observacoes?f.show():f.hide(),(o.observacoes||o.retorno||t)&&e++,$(s.find("[template-field='solicitado_em']")).text(o.data.format_date_time()),$("<div>").html("<b>Origem:</b>").appendTo(g),$(s.find("[template-field='solicitado_por']")).find("span").text(o.usuario_nome);var g=$('<div class="text-left" style="min-width: 180px;">');if($("<div>").html("<b>Origem:</b>").appendTo(g),o.origem_versao_processo_atividade_descricao&&$("<div>").text(o.origem_versao_processo_atividade_descricao).appendTo(g),o.usuario_nome){var b=null;o.usuario_foto_id&&(b=$('<img class="img-circle" width="20px" height="20px" src="assets/img/imagem_usuario_padrao.svg">')).attr("src",WS_URI+"documento/midia/?documento_id="+o.usuario_foto_id+"&tamanho=20&token_midia="+App.sessao.token_midia);var A=$("<div>");b&&A.append(b),A.append($("<span>").text(o.usuario_nome)),A.appendTo(g)}o.data&&$("<div>").text(o.data.format_date_time()).appendTo(g),$(s.find(".imginfo")).tooltip({title:g.html(),placement:"auto"}),s.appendTo(a)}(s)}),e>0?(r.observacao_historico.removeClass("hidden"),r.observacao_historico.text(e),r.observacao_historico.tooltip({title:"Existem observações",placement:"top"}),r.observacao_historico.tooltip()):r.observacao_historico.addClass("hidden")}},this.func_ordenacao=function(a,i){var o=r.tab_historico.find("tr:not(.hidden-xs):not([template-row])"),e=/[^a-zA-Z]/g,t=/[^0-9]/g,s=/[.](.+)/g;return $(o).sort(function(o,c){var r=$(o).find('[template-field="'+a+'"]').text().replace(s,""),d=$(c).find('[template-field="'+a+'"]').text().replace(s,"");return isNaN(parseInt(r.substr(0,3).replace(t,""),10))||isNaN(parseInt(d.substr(0,3).replace(t,""),10))||""==r.substr(0,3).replace(t,"")||""==d.substr(0,3).replace(t,"")?i?r.replace(e,"").toLowerCase().localeCompare(d.replace(e,"").toLowerCase()):d.replace(e,"").toLowerCase().localeCompare(r.replace(e,"").toLowerCase()):i?parseInt(r.replace(t,""))-parseInt(d.replace(t,"")):parseInt(d.replace(t,""))-parseInt(r.replace(t,""))})},this.byexecucao=function(a,i){return r.ordenacao.crscente_execucao?a.execucao>i.execucao?-1:1:a.execucao>i.execucao?1:-1},this.byorigem=function(a,i){return r.ordenacao.crscente_origem?a.origem>i.origem?-1:1:a.origem>i.origem?1:-1},this.render_atividades=function(){if(App.sessao.sessao_login_anonimo)return r.menu_fluxo.addClass("hidden"),void require(["./assets/view/processo/util"],function(a){(new a).atribuir_dados_elementos(r.solicitacao_atividade.solicitacao.versao_processo)});var a=r.solicitacao_atividade.solicitacao.formulario,i=[r.solicitacao_atividade.versao_processo_atividade_id];r.tipo==FORMULARIO.VISUALIZAR&&(a=r.solicitacao_atividade.solicitacao.formulario,i=[],$(r.solicitacao_atividade.solicitacao.historico).each(function(a,o){if(o.solicitacao_atividade_id>0&&o.versao_processo_atividade_id>0){var e={status:o.entrega?"concluido":"andamento",versao_processo_atividade_id:o.versao_processo_atividade_id};i.push(e)}})),require(["./assets/view/processo/util"],function(o){(new o).render_atividades(r.tab_atividades,r.solicitacao_atividade.solicitacao.versao_processo,a,null,i)})},this.mapear_obrigatorios=function(){$(r.solicitacao_atividade.formulario.grupos).each(function(a,i){$(i.elementos).each(function(i,o){if(o.tipo==ELEMENTO_TIPO.TABELA)$(o.campos).each(function(o,e){var t=r.dialog.find('[ref="'+e.elem_key+'"][set_obrigatorio]');t.length>0&&(r.solicitacao_atividade.formulario.grupos[a].elementos[i].campos[o].set_obrigatorio=$(t[0]).attr("set_obrigatorio"))});else{var e=r.dialog.find('[elem-key="'+o.elem_key+'"] [set_obrigatorio]');e.length>0&&(r.solicitacao_atividade.formulario.grupos[a].elementos[i].set_obrigatorio=$(e[0]).attr("set_obrigatorio"))}})})},this.validar_data_form=function(){var a=new Date,i=("0"+a.getDate()).slice(-2),o=("0"+(a.getMonth()+1)).slice(-2),e=a.getFullYear()+"-"+o+"-"+i,t=!0;if(r.form_editor.find('[type="date"]').each(function(a,i){var o=$(i);void 0===(o.attr("disabled")||o.attr("readonly"))&&"none"!=$(i).css("display")&&""!=i.value&&null!=i.value&&("S"==o.attr("data_retroativa")&&(get_datepicker(o)<e?(o.tooltip({title:"Data Inválida",placement:"auto"}),o.tooltip("show"),t=!1):o.tooltip("destroy")),"S"==o.attr("data_retroativa_igual")&&(get_datepicker(o)<=e?(o.tooltip({title:"Data Inválida",placement:"auto"}),o.tooltip("show"),t=!1):o.tooltip("destroy")))}),!t){var s=new Validation;s.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"Data informada fora do período válido.")),alert_modal("Data Inválida.",s)}return t},this.validar_campos_obrigatorios=function(){var a=!0;return r.form_editor.find("[required]").not(".selectpicker").each(function(i,o){var e=$(o);"text"==e.attr("type")&&void 0===e.attr("maskmoney")?void 0===e.attr("readonly")&&"none"!=$(o).css("display")||($(o).hasClass("input_consulta_integracao")||$(o).hasClass("input_doc"))&&void 0===e.attr("permissao")||e.attr("permissao")==PROCESSO_ATIVIDADE_FORMULARIO_PERMISSAO.EDITAR?void 0!==e.attr("maskmoney")?""!=o.value.trim()&&0!=e.maskMoney("unmasked")[0]||(a=!1,r.alerta_campo_obrigatorio(e)):""==o.value.trim()&&(a=!1,r.alerta_campo_obrigatorio(e)):e.tooltip("destroy"):void 0===e.attr("disabled")&&"none"!=$(o).css("display")?void 0!==e.attr("maskmoney")?""===o.value.trim()&&(a=!1,r.alerta_campo_obrigatorio(e)):"date"==e.attr("type")&&void 0===e.attr("disabled")&&void 0===e.attr("readonly")?""==o.value.trim()&&(a=!1,r.alerta_campo_obrigatorio(e)):""==o.value.trim()&&"date"!=e.attr("type")&&(a=!1,r.alerta_campo_obrigatorio(e)):"editor_texto"!=e.attr("type")||tinyMCE.get(e.attr("id")).readonly||""!=get_tinymce(e).trim()?e.tooltip("destroy"):(a=!1,r.alerta_campo_obrigatorio(e.parent()))}),r.form_editor.find(".vld_lista_check").each(function(i,o){var e=$(o);if(!e[0].children[0].disabled&&"none"!==e[0].children[0].style.display){var t=e.find("input:checked");t&&0!=t.length?e.tooltip("destroy"):(a=!1,r.alerta_campo_obrigatorio(e))}}),r.form_editor.find(".vld_lista_radio").each(function(i,o){var e=$(o);if(!e[0].children[0].disabled&&"none"!==e[0].children[0].style.display){var t=e.find("input:checked");t&&0!=t.length?e.tooltip("destroy"):(a=!1,r.alerta_campo_obrigatorio(e))}}),r.form_editor.find("select.selectpicker[required]").each(function(i,o){var e=$(o);if(!e[0].disabled&&"none"!==e[0].style.display){var t=e.val();t&&0!=t.length?e.tooltip("destroy"):(a=!1,r.alerta_campo_obrigatorio(e))}}),r.form_editor.find(".div_input_arquivo [required]").each(function(i,o){var e=$(o);"none"!==e[0].style.display&&""==e.val().trim()&&void 0===e.parent().find("button").attr("disabled")&&(a=!1,r.alerta_campo_obrigatorio(e))}),$("<div>").dxButton({onClick:function(i){let o=[];for(var e=0;e<i.validationGroup.validators.length;e++){let a=i.validationGroup.validators[e];a.$element().parent().attr("view_html_id")===r.html_id&&(o.push(i.validationGroup.validators[e]),a.option("adapter").editor.option("readOnly")&&a.option("validationRules",[]))}i.validationGroup.validators=o,i.validationGroup.validators.length&&(i.validationGroup.validate().isValid||(a=!1))}}).click(),a||alertaPopUp("Validação","Preencha o(s) campo(s) obrigatório(s)",null,null,null,null,"500px"),a},this.alerta_campo_obrigatorio=function(a,i){a.tooltip({title:"Campo obrigatorio",placement:void 0!==i?i:"auto"}),a.tooltip("show")},this.existe_projeto=function(){if(!r.versao_solicitacao_atividade.acao_projeto_template||null!=r.solicitacao_atividade.projeto_id&&""!=r.solicitacao_atividade.projeto_id)return!0;var a=new Validation;return a.add(new ValidationMessage(Validation.CODES.ERR_FIELD,"É obrigatório vincular um projeto na atividade!")),alert_modal("Validação",a),!1},this.salvar=function(a,i){require(["./assets/view/formulario/util"],function(o){var e=new o;void 0!==r.solicitacao_atividade&&void 0!==r.solicitacao_atividade.formulario&&e.persistir_styles(r,r.solicitacao_atividade.formulario),r.mapear_obrigatorios();for(var t={solicitacao_atividade_id:r.solicitacao_atividade.id,formulario:JSON.stringify(r.solicitacao_atividade.formulario),formulario_solicitacao:JSON.stringify(r.solicitacao_atividade.solicitacao.formulario),acao:i?SOLICITACAO_ATIVIDADE_ACAO.SALVAR_CANCELAR:SOLICITACAO_ATIVIDADE_ACAO.SALVAR,observacoes:r.edt_observacoes.val(),projeto_id:r.solicitacao_atividade.projeto_id,cliente_id:r.cliente_id,usuario_id:r.cbo_usuarios.val(),documento_pasta_id:r.documento_pasta_id,edicao_cabecalho:r.liberar_campos},s=r.tipo==FORMULARIO.VISUALIZAR||null!==r.solicitacao_atividade.entrega||"S"==r.solicitacao_atividade.cancelada||null!==r.solicitacao_atividade.cancelamento_hora_atividade?r.solicitacao_atividade.solicitacao.formulario:r.solicitacao_atividade.formulario,c=0;c<s.grupos.length;c++){var d=s.grupos[c];if(d.elementos)for(var l=0;l<d.elementos.length;l++){var n=d.elementos[l];if(n.tipo==ELEMENTO_TIPO.ANEXO&&n.anexo)t[n.elem_key]=n.anexo,App.is_nativo()&&(r.anexos.push(n.anexo),r.elem_keys.push(n.elem_key));else if(n.tipo==ELEMENTO_TIPO.TABELA&&n.valor)for(var _=n.valor,p=0;p<_.length;p++)_[p].anexo&&(t[_[p].elem_key+"_linha_"+_[p].linha]=_[p].anexo)}}WS.post("solicitacao/salvar",t,function(i){r.dados_modificados=!1,alert_saved(r.versao_solicitacao_atividade.descricao+" salvo com sucesso"),a&&a()},null,null,!0)})},this.salva_envia=function(){if(!r.solicitacao_atividade.solicitacao.versao_processo.escolher_pasta_solicitacao&&"S"!=r.solicitacao_atividade.solicitacao.versao_processo.escolher_pasta_solicitacao||r.documento_pasta_id){if(""==r.div_component_cbo_clientes.find(".edt_combobox").val()&&(r.cliente_id=null),r.existe_projeto()&&r.validar_campos_obrigatorios()&&r.validar_data_form()){var a=function(){r.mapear_obrigatorios(),require(["./assets/view/formulario/util"],function(a){var i=new a;void 0!==r.solicitacao_atividade&&void 0!==r.solicitacao_atividade.formulario&&i.persistir_styles(r,r.solicitacao_atividade.formulario),View.load("solicitacao/enviar",function(a,i){i.onconfirm=function(){App.sessao.sessao_login_anonimo?App.logout_anonimo():(r.dados_modificados=!1,alert_saved(r.versao_solicitacao_atividade.descricao+" salvo com sucesso"),r.unload())},i.show(r.solicitacao_atividade,r.versao_solicitacao_atividade,r.solicitacao_atividade.solicitacao.versao_processo.elementos,r.edt_observacoes.val(),r.cliente_id,r.form_grupos,r.cbo_usuarios.val(),r.documento_pasta_id,r)})})};if(App.PE.Solicitacao_Atividade_Salvar_Enviar_Antes)try{App.PE.Solicitacao_Atividade_Salvar_Enviar_Antes(r,a)}catch(a){console.log(a)}else a()}}else alert_modal("Atenção","Escolha uma pasta para armazenar os anexos da solicitação.","OK",function(){$("html, body").stop().animate({scrollTop:0},500,"swing",function(){r.div_seleciona_pasta.effect("shake")})})},this.edt_observacoes.keyup(function(){msg_count(r.edt_observacoes,r.contador_obs,5e3),r.dados_modificados=!0}),this.th_execucao.unbind("click"),this.th_execucao.click(function(){r.tab_historico.find("th").find("span").remove(),r.ordenacao.crscente_execucao?(r.ordenacao.crscente_execucao=!1,r.th_execucao.append('<span class="glyphicon glyphicon-arrow-up"></span>')):(r.ordenacao.crscente_execucao=!0,r.th_execucao.append('<span class="glyphicon glyphicon-arrow-down"></span>'));var a=r.func_ordenacao("executado_em",r.ordenacao.crscente_execucao);$(a).detach().appendTo(r.tab_historico)}),this.th_origem.unbind("click"),this.th_origem.click(function(){r.tab_historico.find("th").find("span").remove(),r.ordenacao.crscente_origem?(r.ordenacao.crscente_origem=!1,r.th_origem.append('<span class="glyphicon glyphicon-arrow-up"></span>')):(r.ordenacao.crscente_origem=!0,r.th_origem.append('<span class="glyphicon glyphicon-arrow-down"></span>'));var a=r.func_ordenacao("solicitado_em",r.ordenacao.crscente_origem);$(a).detach().appendTo(r.tab_historico)}),this.salvarClick=function(){r.validar_data_form()&&r.salvar(r.atualizar_listagens)},this.salvarSairClick=function(a){r.validar_data_form()&&r.salvar(function(){a&&"function"==typeof a?a():r.unload()})},this.handleAlterarProjetoVinculado=function(a,i){const o=()=>{r.solicitacao_atividade.projeto=i,r.solicitacao_atividade.projeto_id=a,r.solicitacao_atividade.cliente_id=i.cliente_id,r.salvar();let o=(null!==i.porcentagem_concluido?i.porcentagem_concluido:0)+"%";parseInt(i.porcentagem_concluido)<r.versao_solicitacao_atividade.acao_projeto_template_conclusao?(r.processoDetalharMenu.props.setProjetoVinculadoPendente(!0),r.processoDetalharMenu.props.setPorcentagemConcluido(o),r.processoDetalharMenu.props.setPorcentagemNecessario(r.versao_solicitacao_atividade.acao_projeto_template_conclusao+"%")):r.processoDetalharMenu.props.setProjetoVinculadoPendente(!1),r.processoDetalharMenu.props.setProjetoID(i.id),r.processoDetalharMenu.props.setProjetoTemplate(i.template),alert_saved("Projeto vinculado com sucesso")};+r.solicitacao_atividade.projeto_id>0?+r.solicitacao_atividade.projeto_id!=+a&&alertaPopUp("Validação","Já existe um projeto vinculado à esta atividade. Deseja substituir o projeto atualmente vinculado?","Sim",()=>{o()},"Não",()=>{}):o()},this.download_pdf=function(){var a=function(){var a=1;App.temp.empresa&&(a=App.temp.empresa),r.tipo==FORMULARIO.VISUALIZAR?App.obter_token_publico(function(i){WS.post("solicitacao/gerar_pdf_solicitacao",{solicitacao_id:r.solicitacao_atividade.solicitacao_id,empresa_filial_id:a,token_publico:i},function(a){download_arquivo(a.file,a.name)})}):App.obter_token_publico(function(i){WS.post("solicitacao/gerar_pdf_solicitacao_atividade",{solicitacao_atividade_id:r.solicitacao_atividade.id,empresa_filial_id:a,token_publico:i},function(a){download_arquivo(a.file,a.name)})})};r.solicitacao_atividade.situacao!=SOLICITACAO_STATUS.ATIVIDADE_ANDAMENTO&&r.solicitacao_atividade.situacao!=SOLICITACAO_STATUS.ATIVIDADE_ATRASADA||r.tipo==FORMULARIO.VISUALIZAR?a():r.salvar(function(){a()})},this.download_template=function(){const a={solicitacaoId:r.solicitacao_atividade.solicitacao_id,numero:r.solicitacao_atividade.numero,numeroSolicitacaoPorProcesso:r.solicitacao_atividade.numero_solicitacao_por_processo,solicitacaoAtividadeId:r.tipo==FORMULARIO.VISUALIZAR?null:r.solicitacao_atividade.id};View.loadReact(window.views.solicitacao_template_word.SolicitacaoTemplateWordListagem.default,a,a=>{},View.ABA.SIM)},this.imprimir_pdf=function(){if(App.PE.Imprimir_Formulario_Solicitacao)App.PE.Imprimir_Formulario_Solicitacao(r);else{var a=[];a.push(r.dialog.find(".div_topo").clone());var i=r.dialog.find(".aba_formulario").clone(),o=i.find("select");$(o).each(function(a){let o=$(r.dialog.find(".aba_formulario").find("select")).eq(a).val();i.find("select").eq(a).val(o)}),i.find(".dx-texteditor-input").addClass("form-control"),i.find(".dx-dropdowneditor-overlay").remove(),a.push(i),imprimir_div(!0,a)}},this.download_todos_anexos=function(){App.obter_token_publico(function(a){App.download(WS_URI+"solicitacao/download/?solicitacao_atividade_id="+r.solicitacao_atividade.id+"&token_publico="+a)})},this.habilitar_edicao_campos=function(){r.processoDetalharMenu.props.setDisplaySalvar(""),r.processoDetalharMenu.props.setDisplaySalvarSair(""),r.liberar_campos=!0,r.render_formulario()},this.setDisplayDownloadTodosAnexos=function(){for(var a=0;a<r.solicitacao_atividade.formulario.grupos.length;a++){var i=r.solicitacao_atividade.formulario.grupos[a];if(i.elementos)for(var o=0;o<i.elementos.length;o++){var e=i.elementos[o];if(e.tipo==ELEMENTO_TIPO.ANEXO&&e.valor)return void r.processoDetalharMenu.props.setDisplayDownloadTodosAnexos("")}}},this.retornarClick=function(){View.load("solicitacao/retornar",function(a,i){i.show(function(){alert_saved(r.versao_solicitacao_atividade.descricao+" retornou com sucesso"),r.unload()},r.solicitacao_atividade,r.versao_solicitacao_atividade,r.solicitacao_atividade.solicitacao.versao_processo.elementos,r.edt_observacoes.val(),d)})},this.btn_pesquisa_cliente.unbind("click"),this.btn_pesquisa_cliente.click(function(){View.load("cliente/selecionar",function(a,i){i.show(function(a){r.edt_cliente.val(a.nome_fantasia),r.cliente_id=a.cliente_id,r.nome_cliente=a.nome_fantasia,r.listar_filtro_usuarios(r.cliente_id)})})}),this.cancelar_solicitacaoClick=function(){r.salvar(function(){View.load("solicitacao/cancelar",function(a,i){i.show(function(){r.unload()},r.solicitacao_atividade)})},!0)},this.reabrir_solicitacaoClick=function(){WS.post("solicitacao/reabrir",{solicitacao_id:r.solicitacao_atividade.solicitacao_id},function(){alert_saved("Solicitação #"+r.solicitacao_atividade.solicitacao_id+" reaberta com sucesso"),r.unload(),r.onconfirm&&r.onconfirm()})},this.novo_chamado=function(){var a=r.solicitacao_atividade.solicitacao_id;"S"==r.solicitacao_atividade.numero_solicitacao_por_processo&&(a=r.solicitacao_atividade.numero);var i="Solicitação #"+a+" - "+r.solicitacao_atividade.solicitacao.versao_processo.nome,o={width:400,height:200,contentTemplate:function(){return $("<div />").append($("<div />").addClass("button-info").dxButton({text:"Somente com esta atividade",hint:r.versao_solicitacao_atividade.descricao,width:"100%",onClick:function(){t(r.solicitacao_atividade.solicitacao_id,r.solicitacao_atividade.id,i),e.hide()}}),$("<br />"),$("<div />").addClass("button-info").dxButton({text:"Com a solicitação #"+a,hint:r.solicitacao_atividade.solicitacao.versao_processo.nome,width:"100%",onClick:function(){t(r.solicitacao_atividade.solicitacao_id,null,i),e.hide()}}),$("<hr />"),$("<div />").addClass("button-info").dxButton({text:"Cancelar",width:"100%",onClick:function(){e.hide()}}))},showTitle:!0,title:"Referenciar novo chamado",visible:!1,dragEnabled:!1,hideOnOutsideClick:!0},e=$("<div/>").appendTo(r.dialog).dxPopup(o).dxPopup("instance");e.show();var t=function(a,i,o){+i>0&&(o+=" - "+r.versao_solicitacao_atividade.descricao);var e="";const t=a=>{e=""!=e?e+";"+a.email:a.email};"object"==typeof r.solicitacao_atividade.usuarios_responsaveis_atividade&&r.solicitacao_atividade.usuarios_responsaveis_atividade.length>0?r.solicitacao_atividade.usuarios_responsaveis_atividade.forEach(t):r.versao_solicitacao_atividade.todos_usuarios_responsaveis.forEach(t),View.loadReact(window.views.chamado.Detalhes.default,{onClose:r.atualizar_listagens,solicitacaoAtividadeId:i,solicitacaoId:a,entidadeId:r.cliente_id?r.cliente_id:App.sessao.dados.empresa_filial_id,entidadeTipo:r.cliente_id?TIPO_ENTIDADE.CLIENTE:TIPO_ENTIDADE.EMPRESA,assunto:o,emails:e},function(a,i){},View.ABA.MULTIPLAS)}},this.listar_filtro_usuarios=function(a){App.sessao.sessao_login_anonimo||(r.cbo_usuarios.find("option").remove(),WS.get("usuario/listar_por_cliente/",{cliente_id:a},function(a){for(var i=0;i<a.length;i++){var o=a[i];add_option(r.cbo_usuarios,o.id,o.nome)}r.cbo_usuarios.selectpicker("refresh"),r.callback_clientes.fire()}))},this.render_usuarios_por_cliente=function(){WS.get("solicitacao/usuario_acompanha/",{solicitacao_id:r.solicitacao_atividade.solicitacao_id},function(a){for(var i=r.cbo_usuarios.find("option"),o=!1,e=0;e<i.length;e++)a.filter(function(a){return a.usuario_id==i[e].value&&($(i[e]).attr("selected",!0),o=!0),o});r.cbo_usuarios.selectpicker("refresh")})},this.reprogramarClick=function(){View.load("solicitacao/reprogramar_prazo",function(a,i){i.show(function(a){r.solicitacao_atividade.tempo_restante=a.tempo_restante,r.solicitacao_atividade.percentual=a.percentual,r.solicitacao_atividade.diff_datas=a.diff_datas,r.solicitacao_atividade.prazo_execucao=a.prazo_execucao,r.atualizar_progress(),r.show(r.solicitacao_atividade.id,r.tipo)},r.solicitacao_atividade.id)})},this.alterar_responsavelClick=function(){View.load("solicitacao/alterar_responsavel",function(a,i){i.show(function(a){r.solicitacao_atividade.responsavel_id=a.responsavel_id,r.solicitacao_atividade.grupo_usuarios_responsaveis_id=a.grupo_usuarios_responsaveis_id,App.sessao.dados.admin||"S"==r.solicitacao_atividade.solicitacao.acesso_supervisor.supervisor_processo?r.show(r.solicitacao_atividade.id,r.tipo):r.unload()},r.solicitacao_atividade.id,r.versao_solicitacao_atividade.todos_usuarios_responsaveis,r.solicitacao_atividade.responsavel_id,r.versao_solicitacao_atividade.grupos_usuarios_responsaveis,r.solicitacao_atividade.grupo_usuarios_responsaveis_id,r.versao_atividade_tipo,r.versao_solicitacao_atividade.usuarios_responsaveis,r.versao_solicitacao_atividade.grupos_usuarios_responsaveis,r.solicitacao_atividade.multiplos_responsaveis)})},this.ValidarAssumirDesvincular=function(a){r.solicitacao_atividade.responsavel_id=a.responsavel_id,r.solicitacao_atividade.responsavel_nome=a.responsavel_nome,r.solicitacao_atividade.grupo_usuarios_responsaveis_id=a.grupo_usuarios_responsaveis_id,r.solicitacao_atividade.solicitacao.historico=a.solicitacao.historico,r.solicitacao_atividade.responsavel_id.length&&r.solicitacao_atividade.responsavel_id.includes(App.sessao.dados.usuario_id.toString())?(r.processoDetalharMenu.props.setDisplayAssumirAtividade("hidden"),r.processoDetalharMenu.props.setDisplayDesvincularResponsabilidade(""),void 0!==a.responsavel_falha&&!0===a.responsavel_falha||alert_saved("Alteração realizada com sucesso!")):r.solicitacao_atividade.responsavel_id.length?(r.processoDetalharMenu.props.setDisplayAssumirAtividade("hidden"),r.processoDetalharMenu.props.setDisplayDesvincularResponsabilidade("hidden")):(r.processoDetalharMenu.props.setDisplayAssumirAtividade(""),r.processoDetalharMenu.props.setDisplayDesvincularResponsabilidade("hidden"),void 0!==a.responsavel_falha&&!0===a.responsavel_falha||alert_saved("Alteração realizada com sucesso!")),r.solicitacao_atividade.responsavel_nome?(r.lbl_usuario_responsavel_atividade_nome.text(r.solicitacao_atividade.responsavel_nome),r.div_usuario_responsavel_atividade_nome.show()):r.div_usuario_responsavel_atividade_nome.hide(),r.render_historico()},this.AssumirAtividadeClick=function(){WS.post({route:"solicitacao/set_responsavel",data:{solicitacao_atividade_id:r.solicitacao_atividade.id,responsavel_id:App.sessao.dados.usuario_id,grupo_usuarios_responsaveis_id:null,ignorar_se_existir_responsavel:!0},func_response:function(a){r.ValidarAssumirDesvincular(a),void 0!==a.responsavel_falha&&1==a.responsavel_falha&&alert_modal("Ação inválida","Não foi possível assumir. <b>"+a.responsavel_nome+"</b> já o assumiu.")}})},this.DesvincularResponsabilidadeClick=function(){WS.post("solicitacao/set_responsavel",{solicitacao_atividade_id:r.solicitacao_atividade.id,responsavel_id:null,grupo_usuarios_responsaveis_id:null,ignorar_se_existir_responsavel:!0},function(a){r.ValidarAssumirDesvincular(a),void 0!==a.responsavel_falha&&1==a.responsavel_falha&&alert_modal("Ação inválida","Não foi possível desvincular. <b>"+a.responsavel_nome+"</b> é o responsável atual.")})},this.cancelarClick=function(){r.unload()},this.nova_solicitacao=function(){View.load("solicitacao/nova",function(a,i){var o={solicitacao_id:r.solicitacao_atividade.solicitacao_id,solicitacao_atividade_id:r.solicitacao_atividade.id};i.onclose=function(){r.atualizar_listagens()},i.show(o)})},this.menu_fluxo.unbind("click").click(function(){!r.menu_fluxo.parent().hasClass("active")&&r.renderizar_atividades&&(r.renderizar_atividades=!1,r.render_atividades())}),this.menu_diagrama.unbind("click").click(function(){r.menu_diagrama.parent().hasClass("active")||r.render_diagrama()}),this.menu_referencias_solicitacao.unbind("click").click(function(){App.sessao.sessao_login_anonimo||r.menu_referencias_solicitacao.parent().hasClass("active")||(ReactDOM.unmountComponentAtNode(r.div_componente_referencias_solicitacao[0]),ReactDOM.render(React.createElement(window.components.Referencias.default,{tabela:"solicitacao",id:r.solicitacao_atividade.solicitacao_id}),r.div_componente_referencias_solicitacao[0]))}),this.menu_referencias_atividade.unbind("click").click(function(){App.sessao.sessao_login_anonimo||r.menu_referencias_atividade.parent().hasClass("active")||(ReactDOM.unmountComponentAtNode(r.div_componente_referencias_atividade[0]),ReactDOM.render(React.createElement(window.components.Referencias.default,{tabela:"solicitacao_atividade",id:r.solicitacao_atividade.id}),r.div_componente_referencias_atividade[0]))}),this.atualizar_listagens=function(){var a;a=r.solicitacao_atividade.formulario,WS.get("solicitacao/objeto/",{solicitacao_atividade_id:r.solicitacao_atividade.id,tipo_visualizacao:r.tipo},function(i){r.solicitacao_atividade=i,r.solicitacao_atividade.formulario=a,r.arr_ignorar=[],r.arr_ignorar.push(r.solicitacao_atividade.solicitacao_id),r.render_historico()})},this.render_diagrama=function(){App.sessao.sessao_login_anonimo?r.menu_diagrama.addClass("hidden"):require(["./assets/view/processo/util"],function(a){var i=[],o=[];(new a).gerar_elem_key(r.solicitacao_atividade.solicitacao.versao_processo,i,o),r.diagram=dx_Diagrama({div_html:r.div_diagrama,elementos:i,conectores:o,somente_leitura:!0,on_content_ready:dx_Diagrama_Importar_Diagrama_Solicitacao(r),diferenca_altura:50}),View.setHideEvent(r.html_id,function(){setTimeout(function(){App.abas.find("[aba-id-md5="+r.html_id+"]").length&&r.diagram.repaint()})}),View.setShowEvent(r.html_id,function(){setTimeout(function(){r.diagram.repaint()})})})},$(document).scroll(function(){r.floating.css("top",$(this).scrollTop())})}});